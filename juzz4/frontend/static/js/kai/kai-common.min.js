angular.module("kai.common",["ngCookies"]),angular.module("kai.common").constant("KupOption",{"default":{theme:"black",language:"en",formatlDatetime:"MM/DD/YYYY HH:mm:ss",formatHourly:"dddd, MMM, DD, YYYY, hh:mmA",formatDaily:"dddd, MMM, DD, YYYY",formatWeekly:"MMM DD, YYYY",formatMonthly:"MMM DD, YYYY",formatAxisHourly:"hh:mm A",formatAxisDaily:"ddd, MMM DD",formatAxisWeekly:"dddd, MMM DD",formatAxisMonthly:"MMM, YYYY",isoWeekStart:7},sysApiRootUrl:window.location.origin,sysNgMessageUrl:"app/widgets/angular-message.tmpl.html",kendoTimeFormat:["yyyy/MM/dd HH:mm:ss","dd/MM/yyyy HH:mm:ss","ddMMyyyyHHmmss","yyyyMMdd_HHmmss"],momentTimeFormat:["YYYY/MM/DD HH:mm","DD/MM/YYYY HH:mm"],momentTimeFormatForStart:["YYYY/MM/DD 00:00","DD/MM/YYYY 00:00"],momentTimeFormatForEnd:["YYYY/MM/DD 23:59","DD/MM/YYYY 23:59"],jwplayerKey:"5Z17dqkPunTznQ1qVqS7HB3q4xFwVjzvWKGK9w==",jwplayerFlashPlayerUrl:"static/js/plugin/jwplayer/jwplayer.flash.swf",jwplayerHtml5PlayerUrl:"static/js/plugin/jwplayer/jwplayer.html5.js",jwplayerCustomSkinUrl:"static/js/plugin/jwplayer/skin/six.xml",jwplayerCustomSkinFullUrl:"static/js/plugin/jwplayer/skin/sixfull.xml",datatables:{displayLength:25,prcessingId:"DataTables_Table_0_processing"},deviceStatus:{unknown:"UNKNOWN",connected:"CONNECTED",disconnected:"DISCONNECTED"},language:[{name:"en",text:"english",value:"en"},{name:"zh-tw",text:"chinese-traditional",value:"zh-tw"},{name:"zh-cn",text:"chinese-simplified",value:"zh-cn"}],theme:[{name:"white",text:"white",value:"white"},{name:"black",text:"black",value:"black"}],age:[{name:"age1",text:"below20"},{name:"age2",text:"20-35"},{name:"age3",text:"36-55"},{name:"age4",text:"above55"}],label:[{name:"store",text:"store",value:"STORE","class":"kup-store"},{name:"geographic-area",text:"geographic-area",value:"REGION","class":"kup-GeographicArea"},{name:"other",text:"other",value:"OTHERS","class":"fa fa-tag"}],eventType:["event-vca-traffic","event-vca-people-counting","event-vca-crowd","event-vca-audienceprofiling","event-vca-intrusion","event-vca-perimeter","event-vca-loitering","event-vca-object-counting","event-vca-video-blur","event-vca-face","event-occupancy-limit"],vcaType:["business","security"],vca:{traffic:{name:"traffic",ngPreFix:"Traffic","class":"HumanTrafficFlow",eventType:"event-vca-traffic",analyticsType:"TRAFFIC",label:"HT",typeId:0},pcounting:{name:"pcounting",ngPreFix:"Pcounting","class":"PeopleCounting",eventType:"event-vca-people-counting",analyticsType:"PCOUNTING",label:"PC",typeId:0},crowd:{name:"crowd",ngPreFix:"Crowd","class":"CrowdDensity",eventType:"event-vca-crowd",analyticsType:"CROWD",label:"CD",typeId:0},profiling:{name:"profiling",ngPreFix:"Profiling","class":"AudienceProfiling",eventType:"event-vca-audienceprofiling",analyticsType:"PROFILING",label:"AP",typeId:0},attention:{name:"attention",ngPreFix:"Attention","class":"AudienceAttention",eventType:"event-vca-audienceprofiling",analyticsType:"PROFILING",label:"AA",typeId:0},intrusion:{name:"intrusion",ngPreFix:"Intrusion","class":"IntrusionDetection",eventType:"event-vca-intrusion",analyticsType:"INTRUSION",label:"ID",typeId:1},perimeter:{name:"perimeter",ngPreFix:"Perimeter","class":"PerimeterDefense",eventType:"event-vca-perimeter",analyticsType:"PERIMETER",label:"PD",typeId:1},loitering:{name:"loitering",ngPreFix:"Loitering","class":"LoiteringDetection",eventType:"event-vca-loitering",analyticsType:"LOITERING",label:"LD",typeId:1},objcounting:{name:"objcounting",ngPreFix:"Objcounting","class":"TripWireCounting",eventType:"event-vca-object-counting",analyticsType:"OBJCOUNTING",label:"TC",typeId:1},videoblur:{name:"videoblur",ngPreFix:"Videoblur","class":"CameraTampering",eventType:"event-vca-video-blur",analyticsType:"VIDEOBLUR",label:"CT",typeId:1},face:{name:"face",ngPreFix:"Face","class":"FaceIndexing",eventType:"event-vca-face",analyticsType:"FACE",label:"FI",typeId:1},passerby:{name:"passerby",ngPreFix:"PasserByCounting","class":"PasserBy",eventType:"event-vca-passerby",analyticsType:"PASSERBY",label:"PBC",typeId:1}},slide_images:[{image:"static/images/assets/common/login/slideshow/slide1.jpg"},{image:"static/images/assets/common/login/slideshow/slide2.jpg"},{image:"static/images/assets/common/login/slideshow/slide3.jpg"},{image:"static/images/assets/common/login/slideshow/slide4.jpg"},{image:"static/images/assets/common/login/slideshow/slide5.jpg"}],dateOfWeekStart:0,loadingTimer:1500}),function(){"use strict";function percentage($filter){return function(input,decimals){return input=$.isNumeric(input)?input:0,$filter("number")(100*input,decimals)+"%"}}function moment($filter){return function(date,format){return window.moment(date).format(format)}}percentage.$inject=["$filter"],moment.$inject=["$filter"],angular.module("kai.common").filter("percentage",percentage).filter("moment",moment)}(),function(){"use strict";function kupSidebarToggle(){return{restrict:"A",scope:{},link:function(scope,elem,attrs){jQuery(elem).on("click",function(e){e.preventDefault(),jQuery("#kupWrapper").toggleClass("toggled",400),setTimeout(function(){jQuery(document).resize()},400)})}}}function kupSelectpicker($parse){return{restrict:"A",link:function(scope,element,attrs){element.selectpicker($parse(attrs.selectpicker)()),element.selectpicker("refresh"),scope.$watch(attrs.ngModel,function(newVal,oldVal){scope.$parent[attrs.ngModel]=newVal,scope.$evalAsync(function(){attrs.ngOptions&&!/track by/.test(attrs.ngOptions)||element.val(newVal),element.selectpicker("refresh")})}),scope.$on("$destroy",function(){scope.$evalAsync(function(){element.selectpicker("destroy")})})}}}function kupOptionsClass($parse){return{require:"select",link:function(scope,elem,attrs,ngSelect){var optionsSourceStr=attrs.ngOptions.split(" ").pop(),getOptionsClass=$parse(attrs.kupOptionsClass);scope.$watch(optionsSourceStr,function(items){angular.forEach(items,function(item,index){var classes=getOptionsClass(item),option=elem.find("option[value="+index+"]");angular.isObject(classes)?angular.forEach(classes,function(add,className){add&&angular.element(option).addClass(className)}):angular.isString(classes)&&angular.element(option).addClass(classes)})})}}}function kupKeyEnter(){return function(scope,elem,attrs){elem.bind("keydown keypress",function(e){13===e.which&&(scope.$apply(function(){scope.$eval(attrs.kupKeyEnter)}),e.preventDefault())})}}function kupScrollButtom(){return function(scope,elm,attr){var funCheckBounds=function(evt){$("#kupContainer").find("div").height()+$("footer").height()<=$("#kupContainer").height()+$("#kupContainer").scrollTop()&&scope.$apply(attr.kupScrollButtom)};angular.element("#kupContainer").bind("scroll load",funCheckBounds)}}angular.module("kai.common").directive("kupSidebarToggle",kupSidebarToggle).directive("kupOptionsClass",["$parse",kupOptionsClass]).directive("kupSelectpicker",["$parse",kupSelectpicker]).directive("kupKeyEnter",kupKeyEnter).directive("kupScrollButtom",kupScrollButtom)}(),angular.module("kai.common").factory("AuthTokenFactory",["KupOption","$window",function(KupOption,$window){function getTheme(){return store.getItem(themeKey)||KupOption["default"].theme}function setTheme(themeKeyValue){themeKeyValue?store.setItem(themeKey,themeKeyValue):store.removeItem(themeKey)}function setUserLanguage(language){language?store.setItem(userLanguage,language):store.removeItem(userLanguage)}function getSessionKey(){return store.getItem(sessionKey)}function setSessionKey(sessionKeyValue){sessionKeyValue?store.setItem(sessionKey,sessionKeyValue):store.removeItem(sessionKey)}function getApiRootUrl(){return store.getItem(apiRootUrlKey)}function setApiRootUrl(apiRootUrl){apiRootUrl?store.setItem(apiRootUrlKey,apiRootUrl):store.removeItem(apiRootUrlKey)}function getBucket(){return store.getItem(bucketKey)}function setBucket(bucket){bucket?store.setItem(bucketKey,bucket):store.removeItem(bucketKey)}function getUserId(){return store.getItem(userIdKey)}function setUserId(userId){userId?store.setItem(userIdKey,userId):store.removeItem(userIdKey)}function setUserProfile(userProfile){userProfile?(store.setItem(userName,userProfile.name),store.setItem(userEmail,userProfile.email),store.setItem(userLanguage,userProfile.language)):(store.removeItem(userName),store.removeItem(userEmail))}function getUserLanguage(){return store.getItem(userLanguage)||KupOption["default"].language}function getUserProfile(){return{userName:store.getItem(userName),userEmail:store.getItem(userEmail)}}function setUserRole(userRoles){if(!userRoles)return store.setItem(userRole,""),!1;if(userRoles.length>1){roleDisplayText="Multiple Roles";_.map(userRoles,function(role){return role.name})}else roleDisplayText=userRoles[0].name;store.setItem(userRole,roleDisplayText)}function getUserRole(){return store.getItem(userRole)}function clearStore(){store.clear()}var store=$window.localStorage,sessionKey="session-key",apiRootUrlKey="api-root-url",bucketKey="bucket",userIdKey="user-id",themeKey="theme",userName="user-name",userEmail="user-email",userRole="user-role",userLanguage="user-language",data=store;return{data:data,getSessionKey:getSessionKey,setSessionKey:setSessionKey,getApiRootUrl:getApiRootUrl,setApiRootUrl:setApiRootUrl,getBucket:getBucket,setBucket:setBucket,getUserId:getUserId,setUserId:setUserId,getTheme:getTheme,setTheme:setTheme,setUserProfile:setUserProfile,getUserProfile:getUserProfile,setUserRole:setUserRole,getUserRole:getUserRole,getUserLanguage:getUserLanguage,setUserLanguage:setUserLanguage,clearStore:clearStore}}]),angular.module("kai.common").factory("DeviceTreeService",["KupOption","UtilsService","KupApiService","PromiseFactory","AuthTokenFactory","$q","$timeout",function(KupOption,UtilsService,KupApiService,PromiseFactory,AuthTokenFactory,$q,$timeout){function getDeviceTree(){return angular.copy(data.deviceTree)}function getDeviceTreeType(type,subType){var deviceType,opt=data;return $.each(opt.deviceTreeType,function(i,device){type===device.type&&subType===device.subType&&(deviceType=device)}),deviceType}function setDeviceTree(){var opt=data,deviceList=opt.apiUserDevices,labelList=opt.apiLabels,treeData=[],isActiveVcaForCamera=function(cameraData){var isActiveVca=!1,deviceId=cameraData.deviceId,cameraId=cameraData.cameraId;return $.each(opt.apiRunningAnalyticsList,function(i,vcaData){if(deviceId===parseInt(vcaData.coreDeviceId,10)&&cameraId===parseInt(vcaData.channelId,10)&&vcaData.enabled)return isActiveVca=!0,!1}),isActiveVca},isActiveVcaForDevice=function(cameraData){var isActiveVca=!1,isBreak=!1;return $.each(opt.apiRunningAnalyticsList,function(i,vcaData){if($.each(cameraData,function(j,camera){var deviceId=camera.deviceId,cameraId=camera.cameraId;if(deviceId===parseInt(vcaData.coreDeviceId,10)&&cameraId===parseInt(vcaData.channelId,10)&&vcaData.enabled)return isActiveVca=!0,isBreak=!0,!1}),isBreak)return!1}),isActiveVca},isActiveVcaForLabel=function(deviceData){var isActiveVca=!1,isBreak=!1;return $.each(opt.apiRunningAnalyticsList,function(i,vcaData){if($.each(deviceData,function(j,device){var cameraData=device.items;if($.each(cameraData,function(k,camera){var deviceId=camera.data.deviceId,cameraId=camera.data.channelId;if(deviceId===parseInt(vcaData.coreDeviceId,10)&&cameraId===parseInt(vcaData.channelId,10)&&vcaData.enabled)return isActiveVca=!0,isBreak=!0,!1}),isBreak)return!1}),isBreak)return!1}),isActiveVca},filterVcaForCamera=function(cameraData){var filterAry=[],deviceId=cameraData.deviceId,cameraId=cameraData.cameraId;return $.each(opt.apiRunningAnalyticsList,function(i,vcaData){if(deviceId===parseInt(vcaData.coreDeviceId,10)&&cameraId===parseInt(vcaData.channelId,10)&&vcaData.enabled){var vcaType=vcaData.type,flag=!0;$.each(filterAry,function(i,vca){if(vca===vcaType)return flag=!1,!1}),flag&&filterAry.push(vcaData.type)}}),filterAry.toString()},filterVcaForDevice=function(cameraData){var filterAry=[];return $.each(cameraData,function(i,camera){var deviceId=camera.deviceId,cameraId=camera.cameraId;$.each(opt.apiRunningAnalyticsList,function(j,vcaData){if(deviceId===parseInt(vcaData.coreDeviceId,10)&&cameraId===parseInt(vcaData.channelId,10)&&vcaData.enabled){var vcaType=vcaData.type,flag=!0;$.each(filterAry,function(i,vca){if(vca===vcaType)return flag=!1,!1}),flag&&filterAry.push(vcaData.type)}})}),filterAry.toString()},filterVcaForLabel=function(deviceData){var filterAry=[];return $.each(deviceData,function(i,device){var cameraData=device.items;$.each(cameraData,function(j,camera){var deviceId=camera.deviceId,cameraId=camera.cameraId;$.each(opt.apiRunningAnalyticsList,function(k,vcaData){if(deviceId===parseInt(vcaData.coreDeviceId,10)&&cameraId===parseInt(vcaData.channelId,10)&&vcaData.enabled){var vcaType=vcaData.type,flag=!0;$.each(filterAry,function(i,vca){if(vca===vcaType)return flag=!1,!1}),flag&&filterAry.push(vcaData.type)}})})}),filterAry.toString()},filterTextForCamera=function(cameraData){var filterAry=[cameraData.labelName,cameraData.deviceName,cameraData.cameraName];return filterAry.toString()},filterTextForDevice=function(daviceData,cameraData){var filterAry=[daviceData.labelName,daviceData.deviceName];return $.each(cameraData,function(i,camera){filterAry.push(camera.cameraName)}),filterAry.toString()},filterTextForLabel=function(labelData,deviceData){var filterAry=[labelData.labelName];return $.each(deviceData,function(i,device){var cameraData=device.items;filterAry.push(device.deviceName),$.each(cameraData,function(j,camera){filterAry.push(camera.cameraName)})}),filterAry.toString()},isDeviceInLabel=function(labelId,deviceId){var check=!1,isBreak=!1;return $.each(deviceList,function(i,device){if(parseInt(device.deviceId,10)===deviceId&&$.each(device.channelLabels,function(j,camera){if($.each(camera.labels,function(k,label){if(label===labelId)return check=!0,isBreak=!0,!1}),isBreak)return!1}),isBreak)return!1}),check},isCameraInLabel=function(labelId,deviceId,cameraId){var check=!1,isBreak=!1;return $.each(deviceList,function(i,device){if(parseInt(device.deviceId,10)===deviceId&&$.each(device.channelLabels,function(j,camera){if($.each(camera.labels,function(k,label){if(label===labelId&&parseInt(camera.channelId,10)===cameraId)return check=!0,isBreak=!0,!1}),isBreak)return!1}),isBreak)return!1}),check},isNodePower=function(capabilities){var check=!1;return capabilities.indexOf("node")!==-1&&(check=!0),check},isVideoPower=function(capabilities){var check=!1;return capabilities.indexOf("video")!==-1&&(check=!0),check},setBasicAll=function(label){var labelId=label.labelId,labelName=label.name,labelData={isAll:!0,labelId:labelId,labelName:labelName,text:labelName,items:[]};return labelData},setBasicLabel=function(label){var labelId=label.labelId,labelName=label.name,labelData={isLabel:!0,labelId:labelId,labelName:labelName,text:labelName,data:{type:label.type,info:label.info},items:[]};return labelData},setBasicDevice=function(label,device){var labelId=label.labelId,labelName=label.name,deviceId=parseInt(device.deviceId,10),platformDeviceId=parseInt(device.id,10),deviceName=device.name,isNode=isNodePower(device.model.capabilities),deviceData={isDevice:!0,isOnline:device.status!==kupOpt.deviceStatus.disconnected,isNode:isNode,labelId:labelId,labelName:labelName,deviceId:deviceId,platformDeviceId:platformDeviceId,deviceName:deviceName,text:deviceName,data:{capabilities:device.model.capabilities.split(" ")},items:[]};return deviceData},setBasicCamera=function(label,device,camera){var labelId=label.labelId,labelName=label.name,deviceId=parseInt(device.deviceId,10),platformDeviceId=parseInt(device.id,10),deviceName=device.name,cameraId=parseInt(camera.nodeCoreDeviceId,10),cameraName=camera.name,isNode=isNodePower(device.model.capabilities),cameraData={isCamera:!0,isOnline:device.status!==kupOpt.deviceStatus.disconnected,isNode:isNode,labelId:labelId,labelName:labelName,deviceId:deviceId,platformDeviceId:platformDeviceId,deviceName:deviceName,cameraId:cameraId,cameraName:cameraName,text:cameraName,data:{platformDeviceId:platformDeviceId,deviceId:deviceId,deviceName:deviceName,channelId:cameraId,channelName:cameraName,camera:camera},fullData:device};return cameraData};!function(){var label={labelId:"",name:"all"},labelData=setBasicAll(label);$.each(deviceList,function(j,device){parseInt(device.deviceId,10);if(!isVideoPower(device.model.capabilities))return!0;var deviceData=setBasicDevice(label,device);isNodePower(device.model.capabilities)&&$.each(device.node.cameras,function(k,camera){var cameraData=(parseInt(camera.nodeCoreDeviceId,10),setBasicCamera(label,device,camera));deviceData.items.push(cameraData)}),labelData.items.push(deviceData)}),treeData.push(labelData)}(),function(){$.each(labelList,function(i,label){var labelId=label.labelId,labelData=setBasicLabel(label);$.each(deviceList,function(j,device){var deviceId=parseInt(device.deviceId,10);if(!isVideoPower(device.model.capabilities))return!0;if(isDeviceInLabel(labelId,deviceId)){var deviceData=setBasicDevice(label,device);isNodePower(device.model.capabilities)&&$.each(device.node.cameras,function(k,camera){var cameraId=parseInt(camera.nodeCoreDeviceId,10);if(isCameraInLabel(labelId,deviceId,cameraId)){var cameraData=setBasicCamera(label,device,camera);deviceData.items.push(cameraData)}}),labelData.items.push(deviceData)}}),treeData.push(labelData)})}(),function(){$.each(treeData,function(i,label){var deviceData=label.items;label.filterText=filterTextForLabel(label,deviceData),label.filterVca=filterVcaForLabel(deviceData),label.isActiveVca=isActiveVcaForLabel(deviceData),label.spriteCssClass=function(){var className="";return label.isAll&&(className=getDeviceTreeType("all","all").spriteClass),label.isLabel&&(className=getDeviceTreeType("label",label.data.type).spriteClass),className}(),label.labelClass=label.spriteCssClass,label.expanded=!1,$.each(deviceData,function(j,device){var cameraData=device.items;device.filterText=filterTextForDevice(device,cameraData),device.filterVca=filterVcaForDevice(cameraData),device.isActiveVca=isActiveVcaForDevice(cameraData),device.spriteCssClass=getDeviceTreeType("node","node").spriteClass,device.labelClass=label.labelClass,device.expanded=!1,$.each(cameraData,function(k,camera){camera.filterText=filterTextForCamera(camera),camera.filterVca=filterVcaForCamera(camera),camera.isActiveVca=isActiveVcaForCamera(camera),camera.spriteCssClass=getDeviceTreeType("camera","camera").spriteClass,camera.labelClass=label.labelClass})})})}(),opt.deviceTree=treeData}function initDeviceTree(){var request=[listRunningAnalyticsApi(),getLabelsApi(),getUserDevicesApi()],promise=$q.all(request)["finally"](function(){setDeviceTree()});return promise}function listRunningAnalyticsApi(){var opt=data,analyticsType="ALL",param={"analytics-type":analyticsType},onSuccess=function(response){opt.apiRunningAnalyticsList=response.instances||[]},onFail=function(response){opt.apiRunningAnalyticsList=[]},onError=function(){opt.apiRunningAnalyticsList=[]};return ajaxPost("listrunninganalytics",param,onSuccess,onFail,onError,!0)}function getLabelsApi(){var opt=data,param={},onSuccess=function(response){opt.apiLabels=response.labels||[]},onFail=function(response){opt.apiLabels=[]},onError=function(){opt.apiLabels=[]};return ajaxPost("getlabels",param,onSuccess,onFail,onError,!0)}function getUserDevicesApi(){var opt=data,param={},onSuccess=function(response){opt.apiUserDevices=response.devices||[]},onFail=function(response){opt.apiUserDevices=[]},onError=function(){opt.apiUserDevices=[]};return ajaxPost("getuserdevices",param,onSuccess,onFail,onError,!0)}function getDeviceDetails(platformDeviceId,coreDeviceId,channelId){var opt=data,localizeResource=i18n,targetObj={};return targetObj.deviceName=localizeResource("n/a"),targetObj.channelName=localizeResource("n/a"),targetObj.nodeVersion=-1,$.each(opt.apiUserDevices,function(index,dvc){if(dvc.id==platformDeviceId||dvc.deviceId==coreDeviceId)return targetObj.deviceName=dvc.name,targetObj.address=dvc.address,targetObj.latitude=dvc.latitude,targetObj.longitude=dvc.longitude,targetObj.coreDeviceId=dvc.deviceId,targetObj.groupType="type-running-on-"+kupapi.applicationType,targetObj.deviceStatus=dvc.status,null==channelId||""===channelId?targetObj.channelName="":"node"==kupapi.applicationType||dvc.model.capabilities.indexOf("node")==-1?targetObj.channelName=parseInt(channelId)+1+"":($.each(dvc.node.cameras,function(index,cameraItem){if(cameraItem.nodeCoreDeviceId==channelId)return targetObj.channelName=cameraItem.name,targetObj.groupType="type-running-on-node",!1}),null==targetObj.channelName&&(console.log(targetObj.deviceName+" :node camera not found nodeCoreDeviceId="+channelId),targetObj.channelName=parseInt(channelId)+1+"",targetObj.groupType="unknown-type"),targetObj.nodeVersion=dvc.node.version),!1}),targetObj}function isEmptyDevice(){var opt=data,check=!1;return opt.apiUserDevices.length||(check=!0),check}var kupOpt=KupOption,i18n=UtilsService.i18n,ajaxPost=(UtilsService.notification,KupApiService.ajaxPost),data={deviceTree:[],deviceTreeType:[{type:"all",subType:"all",spriteClass:"fa fa-tag"},{type:"label",subType:"STORE",spriteClass:"kup-storeTiny"},{type:"label",subType:"REGION",spriteClass:"fa fa-tag"},{type:"label",subType:"OTHERS",spriteClass:"fa fa-tag"},{type:"node",subType:"node",spriteClass:"kup-node"},{type:"camera",subType:"camera",spriteClass:"fa fa-video-camera"}],apiRunningAnalyticsList:[],apiLabels:[],apiUserDevices:[]};return{data:data,getDeviceTree:getDeviceTree,setDeviceTree:setDeviceTree,initDeviceTree:initDeviceTree,getDeviceDetails:getDeviceDetails,isEmptyDevice:isEmptyDevice}}]),angular.module("kai.common").factory("GoogleMapService",["KupOption","LoaderService","UtilsService","KupApiService","PromiseFactory","AuthTokenFactory","$q","$rootScope","$timeout",function(KupOption,LoaderService,UtilsService,KupApiService,PromiseFactory,AuthTokenFactory,$q,$rootScope,$timeout){function setSearchMap(mapId,searchBoxId,defaultSearchText){if(!window.google.maps.Map||!window.google.maps.places)return!1;var opt=data,mapDom=document.getElementById(mapId),searchBoxDom=document.getElementById(searchBoxId),$searchBox=($("#"+mapId),$("#"+searchBoxId)),setSearch=function(location){$searchBox.val(location)},setLocation=function(location){location=location||"",opt.searchMap.location=location},setLatlng=function(latlng){opt.searchMap.lat=latlng?latlng.lat():0,opt.searchMap.lng=latlng?latlng.lng():0},setTimezone=function(latlng){latlng=latlng?latlng.lat()+","+latlng.lng():0,latlng?$.ajax({url:opt.timezoneApi+"?key="+opt.mapApiKey+"&location="+latlng+"&timestamp="+Math.round((new Date).getTime()/1e3).toString()}).done(function(response){opt.searchMap.timeZoneOffset=response.rawOffset,opt.searchMap.timeZoneId=response.timeZoneId}):(opt.searchMap.timeZoneOffset=0,opt.searchMap.timeZoneId="")},map=new google.maps.Map(mapDom,{center:opt.searchMap.center,zoom:opt.searchMap.zoom}),searchBox=new google.maps.places.Autocomplete(searchBoxDom,{types:["(regions)"]}),geocoder=new google.maps.Geocoder,marker=new google.maps.Marker,setMarker=function(opt){marker.setMap(null),marker=new google.maps.Marker(opt)},clearMarker=function(){marker.setMap(null)},searchChangeFn=function(){var place=searchBox.getPlace()||{},placeName=$searchBox.val(),placeIcon=(place.place_id||"",place.icon||"");({url:placeIcon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)});geocoder.geocode({address:placeName},function(results,status){$rootScope.$apply(function(){if(status===google.maps.GeocoderStatus.OK){var placeLatlng=results[0].geometry.location,placeViewport=results[0].geometry.viewport||"",bounds=new google.maps.LatLngBounds;map.setCenter(placeLatlng),setMarker({map:map,title:placeName,position:placeLatlng}),placeViewport?bounds.union(placeViewport):bounds.extend(placeLatlng),map.fitBounds(bounds),setLocation(placeName),setLatlng(placeLatlng),setTimezone(placeLatlng),opt.searchMap.isSuccessSearch=!0}else console.warn("Google Geocode Status: "+status),clearMarker(),map.setCenter(opt.searchMap.center),map.setZoom(opt.searchMap.zoom),setLocation(),setLatlng(),setTimezone(),opt.searchMap.isSuccessSearch=!1})})},boundsChangedFn=function(){searchBox.setBounds(map.getBounds())},mapClickFn=function(event){var placeLatlng=event.latLng;geocoder.geocode({latLng:event.latLng},function(results,status){$rootScope.$apply(function(){if(status===google.maps.GeocoderStatus.OK){var placeName=results&&results.length>0?results[0].formatted_address:"";setMarker({position:event.latLng,map:map}),setSearch(placeName),setLocation(placeName),setLatlng(placeLatlng),setTimezone(placeLatlng),opt.searchMap.isSuccessSearch=!0}else console.warn("Google Geocode Status: "+status)})})};opt.searchMap.isSuccessSearch=!1,map.controls[google.maps.ControlPosition.TOP_LEFT].push(searchBoxDom),map.addListener("bounds_changed",boundsChangedFn),searchBox.addListener("place_changed",searchChangeFn),google.maps.event.addListener(map,"click",mapClickFn),defaultSearchText&&$timeout(function(){$("#"+searchBoxId).val(defaultSearchText),google.maps.event.trigger(searchBox,"place_changed")})}function setSearchBox(searchBoxId){if(!window.google.maps.Map||!window.google.maps.places)return!1;var opt=data,searchBoxDom=document.getElementById(searchBoxId),$searchBox=$("#"+searchBoxId),setLocation=function(location){location=location||"",opt.searchBox.location=location},setLatlng=function(latlng){opt.searchBox.lat=latlng?latlng.lat():0,opt.searchBox.lng=latlng?latlng.lng():0},setTimezone=function(latlng){latlng=latlng?latlng.lat()+","+latlng.lng():0,latlng?$.ajax({url:opt.timezoneApi+"?key="+opt.mapApiKey+"&location="+latlng+"&timestamp="+Math.round((new Date).getTime()/1e3).toString()}).done(function(response){opt.searchBox.timeZoneOffset=response.rawOffset,opt.searchBox.timeZoneId=response.timeZoneId}):(opt.searchMap.timeZoneOffset=0,opt.searchMap.timeZoneId="")},searchBox=new google.maps.places.Autocomplete(searchBoxDom,{types:["(regions)"]}),geocoder=new google.maps.Geocoder,searchChangeFn=function(){var placeName=$searchBox.val();geocoder.geocode({address:placeName},function(results,status){$rootScope.$apply(function(){if(status===google.maps.GeocoderStatus.OK){var location=placeName,placeLatlng=results[0].geometry.location;setLocation(location),setLatlng(placeLatlng),setTimezone(placeLatlng),opt.searchBox.isTriggerSearch=!0,opt.searchBox.isSuccessSearch=!0}else console.warn("Google Geocode Status: "+status),setLocation(),setLatlng(),setTimezone(),opt.searchBox.isTriggerSearch=!0,opt.searchBox.isSuccessSearch=!1})})};opt.searchBox.isTriggerSearch=!1,opt.searchBox.isSuccessSearch=!1,searchBox.addListener("place_changed",searchChangeFn)}function loadSearchMap(mapId,searchBoxId,defaultSearchText){var opt=data;return window.initGoogleMap=function(){setSearchMap(mapId,searchBoxId,defaultSearchText)},LoaderService.loadScript(opt.mapApi).then(function(){opt.isSuccessLoad=!0,window.initGoogleMap()})["catch"](function(){opt.isSuccessLoad=!1,notification("error",i18n("google-map-load-error"))})}function loadSearchBox(searchBoxId){var opt=data;return window.initGoogleMap=function(){setSearchBox(searchBoxId)},LoaderService.loadScript(opt.mapApi).then(function(){opt.isSuccessLoad=!0,window.initGoogleMap()})["catch"](function(){opt.isSuccessLoad=!1,notification("error",i18n("google-map-load-error"))})}var i18n=UtilsService.i18n,notification=UtilsService.notification,data=(KupApiService.ajaxPost,{isSuccessLoad:!1,mapApiKey:"AIzaSyCv9ajgEy884HyIZKZkz-BtrXLQ_4XfDWU",mapApi:"https://maps.googleapis.com/maps/api/js?libraries=places&callback=initGoogleMap&key=AIzaSyCv9ajgEy884HyIZKZkz-BtrXLQ_4XfDWU",timezoneApi:"https://maps.googleapis.com/maps/api/timezone/json",geocodeApi:"https://maps.googleapis.com/maps/api/geocode/json?key=AIzaSyCv9ajgEy884HyIZKZkz-BtrXLQ_4XfDWU",searchMap:{isSuccessSearch:!1,center:{lat:34,lng:173},zoom:1,location:"",lat:0,lng:0,timeZoneOffset:0,timeZoneId:""},searchBox:{isTriggerSearch:!1,isSuccessSearch:!1,location:"",lat:0,lng:0,timeZoneOffset:0,timeZoneId:""}});return{data:data,setSearchMap:setSearchMap,setSearchBox:setSearchBox,loadSearchMap:loadSearchMap,loadSearchBox:loadSearchBox}}]),angular.module("kai.common").factory("KupApiService",["UtilsService","KupOption","AuthTokenFactory","RouterStateService","$http","$q","$location","$timeout",function(UtilsService,KupOption,AuthTokenFactory,RouterStateService,$http,$q,$location,$timeout){function setData(){data.sessionKey=AuthTokenFactory.getSessionKey(),data.rootUrl=KupOption.sysApiRootUrl+"/api/"}function getParam(param){return param=$.isPlainObject(param)?param:{},param["session-key"]=param["session-key"]?param["session-key"]:data.sessionKey,param}function getConfig(config){return config=$.isPlainObject(config)?config:{},config.headers=data.header,config}function exportDoc(params,url){var onSuccess=function(response){null!=response["download-url"]&&UtilsService.urlDownload(response["download-url"])},onFail=function(response){response.reason&&notification("error",i18n(response.reason))},onError=function(){notification("error",i18n("server-error"))};return ajaxPost(url,params,onSuccess,onFail,onError)}function ajaxPost(apiName,param,onSuccess,onFail,onError,isDefer){setData(),param=getParam(param),onSuccess=$.isFunction(onSuccess)?onSuccess:function(){},onFail=$.isFunction(onFail)?onFail:function(){},onError=$.isFunction(onError)?onError:function(){},isDefer=!!isDefer;var opt=data,apiUrl=data.rootUrl+AuthTokenFactory.getBucket()+"/"+apiName,dfd=$q.defer(),canceller=$q.defer(),config=getConfig({timeout:canceller.promise}),isCancel=!1,reguest=$http.post(apiUrl,$.param(param),config).success(function(response){"ok"===response.result?onSuccess(response):(console.warn("API Warning: "+apiUrl),console.warn(response.reason),response.reason&&"session-expired"===response.reason?onSessionExpired():onFail(response)),isDefer&&dfd.resolve(response)}).error(function(err,status){isCancel?console.warn("API Cancel: "+apiUrl):(console.error("API Error: "+apiUrl),onError(err)),isDefer&&dfd.resolve(err)});return isDefer?(dfd.promise.cancel=function(){isCancel=!0,canceller.resolve()},opt.apiList.push(dfd.promise)):(reguest.cancel=function(){isCancel=!0,canceller.resolve()},opt.apiList.push(reguest)),isDefer?dfd.promise:reguest}function ajaxCancel(){var opt=data;$.each(opt.apiList,function(i,request){request.cancel&&request.cancel()}),opt.apiList=[]}function apiDownload(apiName,param){setData(),param=getParam(param);var apiUrl=data.rootUrl+AuthTokenFactory.getBucket()+"/"+apiName;console.log(apiUrl);var link=apiUrl+"?"+$.param(param);window.open(link,"_blank")}function onSessionExpired(){ajaxCancel(),notification("error",i18n("session-expired-login")),AuthTokenFactory.clearStore(),$timeout(function(){$location.path("/login")},300)}var i18n=UtilsService.i18n,notification=UtilsService.notification,data={header:{Accept:"*/*","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"},timeZoneOffset:(new Date).getTimezoneOffset()*-1,sessionKey:"",rootUrl:"",apiList:[]};return{data:data,ajaxPost:ajaxPost,ajaxCancel:ajaxCancel,apiDownload:apiDownload,exportDoc:exportDoc}}]),angular.module("kai.common").service("LoaderService",["$document","$q","$timeout",function($document,$q,$timeout){function loader(createElement){var promises={};return function(url){if("undefined"==typeof promises[url]){var deferred=$q.defer(),element=createElement(url);element.onload=element.onreadystatechange=function(e){$timeout(function(){deferred.resolve(e)})},element.onerror=function(e){$timeout(function(){deferred.reject(e)})},promises[url]=deferred.promise}return promises[url]}}var document=$document[0];this.loadScript=loader(function(src){var script=document.createElement("script");return script.src=src,document.body.appendChild(script),script}),this.loadCSS=loader(function(href){var style=document.createElement("link");return style.rel="stylesheet",style.type="text/css",style.href=href,document.head.appendChild(style),
style})}]),angular.module("kai.common").factory("PromiseFactory",["$q",function($q){return{decorate:function(promise){promise.success=function(callback){return promise.then(callback),promise},promise.error=function(callback){return promise.then(null,callback),promise}},defer:function(){var deferred=$q.defer();return this.decorate(deferred.promise),deferred}}}]),angular.module("kai.common").factory("RouterStateService",["KupOption","$location",function(KupOption,$location){function setRouterState(routerInfo){return routerState=routerInfo}function getRouterState(){return routerState}function isCurrentPage(currectUrl){var currectUrl=currectUrl||$location.path(),routerState=getRouterState().toState,isCurrentPage=function(){var check=new RegExp(routerState.url);return check.test(currectUrl)}();return isCurrentPage}var routerState={};return{setRouterState:setRouterState,getRouterState:getRouterState,isCurrentPage:isCurrentPage}}]),angular.module("kai.common").factory("SoundManagerService",["$window",function($window){return $window.soundManager.initialize(),$window.soundManager}]),angular.module("kai.common").factory("_",["$window",function($window){return $window._}]),angular.module("kai.common").service("UserService",["$http","AuthTokenFactory","$cookies","$window","KupApiService","PromiseFactory","$state","KupOption","LoaderService",function($http,AuthTokenFactory,$cookies,$window,KupApiService,PromiseFactory,$state,KupOption,LoaderService){function login(company,username,password,rememberMe){AuthTokenFactory.setBucket(company);var params={"user-name":username,password:password,"remember-me":rememberMe},onSuccess=function(response){AuthTokenFactory.setSessionKey(response["session-key"]),AuthTokenFactory.setUserId(response["user-id"]),setUserTheme(),setUserProfile(),setUserRole()},onFail=function(response){},onError=function(){};return ajaxPost("login",params,onSuccess,onFail,onError,!1)}function setUserTheme(){var params={},onSuccess=function(response){var theme=response.prefs.theme?response.prefs.theme:KupOption["default"].theme;AuthTokenFactory.setTheme(theme)},onFail=function(){},onError=function(){};return ajaxPost("getuserprefs",params,onSuccess,onFail,onError)}function setUserProfile(){var params={},onSuccess=function(response){var data={name:response["user-name"],email:response.email,language:response.language?response.language:KupOption["default"].language};AuthTokenFactory.setUserProfile(data)},onFail=function(response){},onError=function(){};return ajaxPost("getuserprofile",params,onSuccess,onFail,onError,!1)}function logout(){var onSuccess=function(response){AuthTokenFactory.clearStore()},onFail=function(response){},onError=function(){};return ajaxPost("logout",{},onSuccess,onFail,onError)}function forgotPassword(rootUrl,company,username,email){var apiUrl=rootUrl+"/api";return $http.post(apiUrl+"/forgotpassword",$.param({bucket:company,"user-name":username,email:email}),{headers:{Accept:"*/*","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"}})}function setUserFeature(){var param={},onSuccess=function(response){var features=response.features||[];data.apiUserFeature=features},onFail=function(response){data.apiUserFeature=[]},onError=function(){data.apiUserFeature=[]};return ajaxPost("getuserfeatures",param,onSuccess,onFail,onError,!1)}function getUserFeature(){return data.apiUserFeature}function setUserRole(){var params={"user-id":AuthTokenFactory.getUserId()},onSuccess=function(response){AuthTokenFactory.setUserRole(response.roles)},onFail=function(response){AuthTokenFactory.setUserRole("")},onError=function(){AuthTokenFactory.setUserRole("")};return ajaxPost("getuserrolesbyuserid",params,onSuccess,onFail,onError,!1)}var ajaxPost=KupApiService.ajaxPost,data={apiUserFeature:[]};return{data:data,login:login,logout:logout,forgotPassword:forgotPassword,setUserFeature:setUserFeature,getUserFeature:getUserFeature,setUserProfile:setUserProfile,setUserTheme:setUserTheme}}]),angular.module("kai.common").factory("UtilsService",["KupOption","notify","$filter","$rootScope","AuthTokenFactory","$uibModal",function(KupOption,notify,$filter,$rootScope,AuthTokenFactory,$uibModal){function i18n(message){var message=$filter("translate")(message);if(arguments.length>1){for(var i=1;i<arguments.length;i++){var r=new RegExp("%"+i+"\\$\\w","g");message=message.replace(r,arguments[i])}for(var i=1;i<arguments.length;i++)message=message.replace(/%\w/,arguments[i])}message=message.replace("\0%\0","%");var imbricated=message.match(/&\{.*?\}/g);if(imbricated)for(var i=0;i<imbricated.length;i++){var imbricated_code=imbricated[i].substring(2,imbricated[i].length-1).replace(/^\s*(.*?)\s*$/,"$1");message=message.replace(imbricated[i],i18nMessages[imbricated_code]||"")}return message}function notification(type,message,delay){delay=delay||3e3;var typeList=[{name:"success",messageClass:"fa fa-check-circle",notifyClass:"alert-success"},{name:"error",messageClass:"fa fa-times-circle",notifyClass:"alert-danger"},{name:"warning",messageClass:"fa fa-exclamation-circle",notifyClass:"alert-warning"},{name:"info",messageClass:"fa fa-info-circle",notifyClass:"alert-info"}],typeInfo=function(){var typeInfo=typeList[0];return jQuery.each(typeList,function(i,data){if(type===data.name)return typeInfo=data,!1}),typeInfo}();return notify({messageTemplate:'<span class="'+typeInfo.messageClass+'"></span><span>'+message+"</span>",classes:typeInfo.notifyClass,duration:delay,position:"center"})}function block(promise,type){type=type||"component";var message=i18n("loading"),typeList=[{name:"login",message:message,backdrop:!1,templateUrl:"app/widgets/loading-login.tmpl.html",delay:300,minDuration:300},{name:"container",message:message,backdrop:!1,templateUrl:"app/widgets/loading.tmpl.html",delay:300,minDuration:300},{name:"component",message:message,backdrop:!1,delay:300,minDuration:300}],typeInfo=function(){var typeInfo=typeList[0];return jQuery.each(typeList,function(i,data){if(type===data.name)return typeInfo=data,!1}),typeInfo}(),config={promise:promise,message:typeInfo.message,backdrop:typeInfo.backdrop,templateUrl:typeInfo.templateUrl};return config}function blockPage(promise){return block(promise,"container")}function getAngularDatatablesI18n(){return{sEmptyTable:i18n("no-data-available-in-table"),sInfo:i18n("showing-_START_-to-_END_-of-_TOTAL_-entries"),sInfoEmpty:i18n("showing-0-to-0-of-0-entries"),sInfoFiltered:"( "+i18n("filtered-from-_MAX_-total-entries")+" )",sInfoPostFix:"",sInfoThousands:",",sLengthMenu:i18n("show-_MENU_-entries"),sLoadingRecords:i18n("loading")+"...",sProcessing:'<div class="kupLoading" style="height:100%;background-color: rgba(0, 0, 0, 0.2);"><div class="la-ball-beat kupLoadItem la-yellow"><div></div><div></div><div></div></div></div>',sSearch:i18n("search")+":",sZeroRecords:i18n("no-matching-records-found"),oPaginate:{sFirst:i18n("first"),sLast:i18n("last"),sNext:i18n("next"),sPrevious:i18n("previous")},oAria:{sSortAscending:": "+i18n("activate-to-sort-column-ascending"),sSortDescending:": "+i18n("activate-to-sort-column-descending")}}}function popupConfirm(title,confirmMsg,callback){var ctrl=function($scope,$uibModalInstance){$scope.title=title,$scope.text=confirmMsg,$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.yes=function(){$.isFunction(callback)?callback():null,$scope.cancel()}};ctrl.$inject=["$scope","$uibModalInstance"];$uibModal.open({animation:!0,templateUrl:"confirmModal.html",backdrop:"static",windowClass:"modal kupModal",controller:ctrl})}function localToUTC(dateOrTimestamp){var dateObj=new Date(dateOrTimestamp),dateUTC=new Date(dateObj.getUTCFullYear(),dateObj.getUTCMonth(),dateObj.getUTCDate(),dateObj.getUTCHours(),dateObj.getUTCMinutes(),dateObj.getUTCSeconds());return dateUTC}function UTCToLocal(dateOrTimestamp){var date=moment(dateOrTimestamp).format("YYYY-MM-DD HH:mm:ss");return date=moment.utc(date).local(),date=date.toDate()}function getFullScreenElement(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement||""}function getTimezoneOffset(){return(new Date).getTimezoneOffset()*-1}function getDateDifference(date1,date2){var date1Millis=date1.getTime(),date2Millis=date2.getTime(),differenceObject={},differenceMillis=date2Millis>date1Millis?date2Millis-date1Millis:date1Millis-date2Millis;return differenceObject.days=Math.floor(differenceMillis/36e5/24),differenceObject.hours=Math.floor(differenceMillis/36e5%24),differenceObject.minutes=Math.floor(differenceMillis/6e4%60),differenceObject.seconds=Math.floor(differenceMillis/1e3%24),differenceObject}function urlDownload(url){var sUrl=kupOpt.sysApiRootUrl+url,isChrome=navigator.userAgent.toLowerCase().indexOf("chrome")>-1,isSafari=navigator.userAgent.toLowerCase().indexOf("safari")>-1;if(/(iP)/g.test(navigator.userAgent))return notification("error",i18n("device-not-support-file-download")),!1;if(isChrome||isSafari){var link=document.createElement("a");if(link.href=sUrl,void 0!==link.download){var fileName=sUrl.substring(sUrl.lastIndexOf("/")+1,sUrl.length);link.download=fileName}if(document.createEvent){var e=document.createEvent("MouseEvents");return e.initEvent("click",!0,!0),link.dispatchEvent(e),!0}}window.open(sUrl,"_self")}var kupOpt=KupOption,utils={i18n:i18n,notification:notification,block:block,blockPage:blockPage,getAngularDatatablesI18n:getAngularDatatablesI18n,localToUTC:localToUTC,UTCToLocal:UTCToLocal,getFullScreenElement:getFullScreenElement,getTimezoneOffset:getTimezoneOffset,getDateDifference:getDateDifference,urlDownload:urlDownload,popupConfirm:popupConfirm},alertMsgTimeOut=null,infoMsgTimeOut=null,loadingTimer=null;return utils.throwServerError=function(responseData){utils.hideLoadingOverlay();var errorMsg="",redirect=!1;return null==responseData||null==responseData.reason?void console.warn("Server error! responseData:"+JSON.stringify(responseData)):("timeout"==responseData.reason?(errorMsg=localizeResource("session-expired")+"!",redirect=!0):errorMsg=localizeResource(responseData.reason),void utils.popupAlert(errorMsg,function(){redirect&&(document.getElementById("iframePopup")?window.parent.location.href="/"+kupBucket:window.location.href="/"+kupBucket)}))},utils.popupAlert=function(alertMsg,callback){var contentHtml='<div style="min-height:40px">'+alertMsg+"</div>",kendoWindow=$("<div />").kendoWindow({visible:!1,title:localizeResource("system-message"),resizable:!1,modal:!0,width:300,close:callback});kendoWindow.data("kendoWindow").content(contentHtml).center().open(),$(".k-window-title").css("height","30px")},utils.detectBrowser=function(){function testCSS(prop){return prop in document.documentElement.style}var isOpera=!(!window.opera||!window.opera.version),isFirefox=testCSS("MozBoxSizing"),isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,isChrome=!isSafari&&testCSS("WebkitTransform"),isIE=testCSS("msTransform"),browser="";return isOpera?browser="opera":isFirefox?browser="firefox":isSafari?browser="safari":isChrome?browser="chrome":isIE&&(browser="ie"),browser},utils.detectOS=function(){var OSName="Unknown OS";return navigator.appVersion.indexOf("Win")!=-1&&(OSName="Windows"),navigator.appVersion.indexOf("Mac")!=-1&&(OSName="MacOS"),navigator.appVersion.indexOf("X11")!=-1&&(OSName="UNIX"),navigator.appVersion.indexOf("Linux")!=-1&&(OSName="Linux"),OSName},utils.convertToUTC=function(dateObj){return new Date(dateObj.getUTCFullYear(),dateObj.getUTCMonth(),dateObj.getUTCDate(),dateObj.getUTCHours(),dateObj.getUTCMinutes(),dateObj.getUTCSeconds())},utils.convertUTCtoLocal=function(dateObj){if(null!=dateObj){var d=new Date;return dateObj.setMinutes(dateObj.getMinutes()-d.getTimezoneOffset()),dateObj}},utils.slideDownAlert=function(timestamp,alertType,deviceName){var localDt=utils.convertUTCtoLocal(kendo.parseDate(timestamp,kupapi.TIME_FORMAT));timestamp=kendo.toString(localDt,kupapi.TIME_FORMAT);var msgHtml='<div class="alert_box_title">'+timestamp+'</div><div class="alert_box_content"><label class="alert_box_label">'+localizeResource("device-name")+"</label>: "+deviceName+'<br/><label class="alert_box_label">'+localizeResource("event-type")+"</label>: "+localizeResource(alertType)+"<br/></div>",notifyBox=document.getElementById("notifyBox")?$("#notifyBox"):window.parent.$("#notifyBox"),alertBox=document.getElementById("alertBox")?$("#alertBox"):window.parent.$("#alertBox");clearTimeout(alertMsgTimeOut),clearTimeout(infoMsgTimeOut),notifyBox.hide(),alertBox.html(msgHtml),alertBox.show("slide",{direction:"up"},1e3),alertMsgTimeOut=setTimeout(function(){alertBox.hide("slide",{direction:"up"},1e3)},8e3)},utils.slideDownInfo=function(notifyMsg){var msgHtml='<div class="success_image"><span>'+notifyMsg+"</span></div>",notifyBox=null,alertBox=null;document.getElementById("notifyBox")?(notifyBox=$("#notifyBox"),alertBox=$("#alertBox"),clearTimeout(alertMsgTimeOut),clearTimeout(infoMsgTimeOut),alertBox.hide(),notifyBox.html(msgHtml),notifyBox.fadeIn(1e3),infoMsgTimeOut=setTimeout(function(){notifyBox.fadeOut(1e3)},3e3)):(notifyBox=window.parent.$("#notifyBox"),alertBox=window.parent.$("#alertBox"),clearTimeout(window.parent.alertMsgTimeOut),clearTimeout(window.parent.infoMsgTimeOut),alertBox.hide(),notifyBox.html(msgHtml),notifyBox.fadeIn(1e3),window.parent.infoMsgTimeOut=window.parent.setTimeout(function(){notifyBox.fadeOut(1e3)},3e3))},utils.removeLineBreaks=function(nlStr){return nlStr.replace(new RegExp("\n","g")," ")},utils.getJSonObject=function(value){return $.parseJSON(value.replace(/&quot;/gi,'"'))},utils.showLoadingOverlay=function(){$(".darkened-overlay").show(),$(".loading-icon-overlay").show(),kendo.ui.progress($(".k-window-content"),!0)},utils.showLoadingTextOverlay=function(displayText,showCloseButton){if($("#loadingText").html(displayText),$(".darkened-overlay").show(),$(".loading-text-overlay").show(),showCloseButton){$("#loadingTimeSeconds").html(""),$("#loadingTimeSeconds").show();var timeTaken=0;loadingTimer=setInterval(function(){timeTaken++,$("#loadingTimeSeconds").html(timeTaken+"s"),timeTaken>10&&$("#btnLoadingCancel").show()},1e3)}},utils.hideLoadingOverlay=function(){$(".darkened-overlay").hide(),$(".loading-icon-overlay").hide(),$(".loading-text-overlay").hide(),$("#btnLoadingCancel").hide(),$("#loadingTimeSeconds").hide(),kendo.ui.progress($(".k-window-content"),!1),loadingTimer&&clearInterval(loadingTimer)},utils.loadIframe=function(iframeName,url){var $iframe=$("#"+iframeName);if($iframe.length)return $iframe.attr("src",url),!1},utils.preloadImage=function(imgUrl,onSuccess,onFailure){var img=new Image;utils.showLoadingTextOverlay(localizeResource("loading-image"),!0),$(img).load(function(){utils.hideLoadingOverlay(),onSuccess()}).error(function(){utils.hideLoadingOverlay(),onFailure()}).attr("src",imgUrl)},utils.createTooltip=function(divId,position,content){var domElement,contentHtml="<span style='font-size:11px;text-align:left; display: inline-block; max-width:200px'>"+content+"</span>";domElement=document.getElementById(divId)?$("#"+divId):$("."+divId),domElement.kendoTooltip({position:position,content:contentHtml}).data("kendoTooltip")},utils.createDateTimeRangeSelection=function(fromDivId,toDivId){var today=new Date,start=$("#"+fromDivId).kendoDateTimePicker({interval:60,format:"dd/MM/yyyy HH:mm",timeFormat:"HH:mm",value:kendo.toString(today,"dd/MM/yyyy")+" 00:00",change:function(e){var startDate=start.value();utils.isNullOrEmpty(startDate)&&start.value(kendo.toString(today,"dd/MM/yyyy")+" 00:00"),startDate&&(startDate=new Date(startDate),startDate.setDate(startDate.getDate()),end.min(startDate))}}).data("kendoDateTimePicker"),end=$("#"+toDivId).kendoDateTimePicker({interval:60,format:"dd/MM/yyyy HH:mm",timeFormat:"HH:mm",value:kendo.toString(today,"dd/MM/yyyy")+" 23:59",change:function(e){var endDate=end.value();utils.isNullOrEmpty(endDate)&&end.value(kendo.toString(today,"dd/MM/yyyy")+" 23:59"),endDate&&(endDate=new Date(endDate),endDate.setDate(endDate.getDate()),endDate.setHours(endDate.getHours()),endDate.setMinutes(endDate.getMinutes()),start.max(endDate))}}).data("kendoDateTimePicker");start.max(end.value()),end.min(start.value())},utils.checkInternetAccess=function(onlineCallback,offlineCallback){var img=document.createElement("img");img.onload=onlineCallback,img.onerror=offlineCallback,img.src="http://pic2.pbsrc.com/navigation/brand-logo.png?v="+Math.random()},utils.getRandomInteger=function(min,max){return Math.floor(Math.random()*max+min)},utils.getRandomDecimal=function(min,max){return Math.random()*max+min},utils.getScript=function(src){document.write('<script type="text/javascript" src="'+src+'"></script>')},utils.captureEnterKey=function(divId,callback){$("#"+divId).bind("keypress",function(e){var code=e.keyCode?e.keyCode:e.which;13==code&&callback()})},utils.httpGet=function(theUrl){var xmlHttp=null;return xmlHttp=new XMLHttpRequest,xmlHttp.open("GET",theUrl,!1),xmlHttp.send(null),xmlHttp.responseText},utils.openPopup=function(title,contentUrl,width,height,isModel,onPopupClosed){function onClosed(e){$(".k-animation-container").css("display","none"),$(".k-list-container").css("display","none"),$(".pac-container").css("display","none"),$(".k-list-container").css("transform",""),$("#"+winId).html(""),onPopupClosed(e)}var winId=Math.random().toString(8).slice(2);$(document.body).append('<div id="'+winId+'" style="overflow: hidden"></div>');var winOptions={};winOptions.title=title,winOptions.content="/"+kupBucket+contentUrl,winOptions.resizable=!1,winOptions.modal=!0,winOptions.close=onClosed,winOptions.visible=!1,utils.isNullOrEmpty(width)||(winOptions.width=width),utils.isNullOrEmpty(height)||(winOptions.height=height);var autoAdjust=utils.isNullOrEmpty(width)||utils.isNullOrEmpty(height);autoAdjust&&(winOptions.refresh=function(){this.center()});$("#"+winId).kendoWindow(winOptions).data("kendoWindow").center().open()},utils.formatDrmsDate=function(datetime){var dateObj=new Date(datetime),hr=dateObj.getHours(),min=dateObj.getMinutes();hr<10&&(hr="0"+hr),min<10&&(min="0"+min);var dateStr=hr+":"+min;return dateStr},utils.formatDate=function(date){if(""!=date){var tempDate=date.split(" "),tempTime=tempDate[3].split(":");"Jan"==tempDate[1]?tempDate[1]="01":"Feb"==tempDate[1]?tempDate[1]="02":"Mar"==tempDate[1]?tempDate[1]="03":"Apr"==tempDate[1]?tempDate[1]="04":"May"==tempDate[1]?tempDate[1]="05":"Jun"==tempDate[1]?tempDate[1]="06":"Jul"==tempDate[1]?tempDate[1]="07":"Aug"==tempDate[1]?tempDate[1]="08":"Sep"==tempDate[1]?tempDate[1]="09":"Oct"==tempDate[1]?tempDate[1]="10":"Nov"==tempDate[1]?tempDate[1]="11":"Dec"==tempDate[1]&&(tempDate[1]="12");var formatedDate=tempDate[2]+tempDate[1]+tempDate[5]+tempTime[0]+tempTime[1]+tempTime[2];return formatedDate}return""},utils.convertDrmsDate=function(timeType,date,range){var tempDate=null;if(tempDate=date,"start"==range){if("daily"==timeType)return tempDate;if("weekly"==timeType)return new Date(tempDate-864e5*tempDate.getDay());if("monthly"==timeType)return tempDate.setMonth(tempDate.getMonth(),1),tempDate;if("yearly"==timeType)return tempDate.setMonth(0,1),tempDate}else if("end"==range){if("daily"==timeType)return tempDate.setHours(23,59,59),tempDate;if("weekly"==timeType)return tempDate.setDate(tempDate.getDate()+(6-tempDate.getDay())),tempDate.setHours(23,59,59),tempDate;if("monthly"==timeType)return tempDate.setMonth(tempDate.getMonth()+1,0),tempDate;if("yearly"==timeType)return tempDate.setMonth(11,31),tempDate.setHours(23,59,59),tempDate}},utils.populateChannels=function(channelCount,divId){for(var channelListId="#"+divId,channList=[],dataSource=null,i=0;i<channelCount;i++){var value=i+1;channList.push({name:value,nodeCoreDeviceId:i})}channList.length>0?(dataSource=new kendo.data.DataSource({data:channList}),$(channelListId).data("kendoDropDownList").setDataSource(dataSource)):(dataSource=new kendo.data.DataSource({data:[]}),$(channelListId).data("kendoDropDownList").setDataSource(dataSource),$(channelListId).data("kendoDropDownList").element.val(""),$(channelListId).data("kendoDropDownList").text(""))},utils.populateNodeNames=function(nodeList,divId){var channelListId="#"+divId,dataSource=null;nodeList.length>0?(dataSource=new kendo.data.DataSource({data:nodeList}),$(channelListId).data("kendoDropDownList").setDataSource(dataSource)):(dataSource=new kendo.data.DataSource({data:[]}),$(channelListId).data("kendoDropDownList").setDataSource(dataSource),$(channelListId).data("kendoDropDownList").element.val(""),$(channelListId).data("kendoDropDownList").text(""))},utils.collapseAllRows=function(gridId){var grid=$("#"+gridId).data("kendoGrid");grid.tbody.find(">tr.k-grouping-row").each(function(e){grid.collapseRow(this)})},utils.expandAllRows=function(gridId){var grid=$("#"+gridId).data("kendoGrid");grid.tbody.find(">tr.k-grouping-row").each(function(e){grid.expandRow(this)})},utils.isNullOrEmpty=function(str){return null==str||""==str},utils.popupAuthentication=function(presetCompanyId,allowOTP,callback){var presetInfo={companyId:presetCompanyId,allowOTP:allowOTP},url="/login/authenticate/"+JSON.stringify(presetInfo);utils.openPopup(localizeResource("authentication"),url,335,null,!0,function(){callback(authWin.sessionKeyResult)})},utils.centerDivObject=function(jqDivObject){var winWidth=$(window).width(),winHeight=$(window).height(),divWidth=jqDivObject.width(),divHeight=jqDivObject.height(),top=(winHeight-divHeight)/2,left=(winWidth-divWidth)/2;jqDivObject.css("position","absolute"),jqDivObject.css("top",top),jqDivObject.css("left",left)},utils.sameday=function(date1,date2){return date1.getUTCFullYear()==date2.getUTCFullYear()&&date1.getUTCMonth()==date2.getUTCMonth()&&date1.getUTCDate()==date2.getUTCDate()},utils.tryParseJson=function(str){try{var ret=JSON.parse(str);return""==ret&&(ret={}),ret}catch(e){return{}}},utils.getMapSize=function(map){return Object.keys(map).length},utils.modulo=function(number,divisor){return number%divisor},utils.checkFlashPlayer=function(browser){if("ie"==browser)try{new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(e){return!1}if("firefox"==browser||"chrome"==browser||"opera"==browser){var isExistFlashPlayer=navigator.plugins["Shockwave Flash"];if(!isExistFlashPlayer)return!1}return!0},utils.viewSnapshot=function(coreDeviceId,channelId){var contentPage="/device/viewsnapshot/"+coreDeviceId+"-"+channelId;utils.openPopup(localizeResource("view-snapshot"),contentPage,null,null,!0,function(){utils.hideLoadingOverlay()})},utils.checkDeviceCompleteInfo=function(device){return device.model.capabilities.indexOf("node")!=-1&&void 0===device.node?(console.log(device.name+" doesnot have node properties"),!1):!(device.model.capabilities.indexOf("node")===-1&&device.model.channels<1)||(console.log(device.name+" doesnot have channel on it"),!1)},utils.formatSerialNumber=function(serialNumber){for(var dashedNumber="",groupSize=5,i=0;i<serialNumber.length;i++)dashedNumber+=serialNumber[i],serialNumber.length!=i+1&&0==utils.modulo(i+1,groupSize)&&(dashedNumber+=" - ");return dashedNumber},utils.removeArrayEntry=function(value,Array){var index=$.inArray(value,Array);~index&&Array.splice(index,1)},utils.isValidEmail=function(emailAddress){var pattern=new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i);return pattern.test(emailAddress)},utils.convertToCurrency=function(value){if(isNaN(value))return value;var number=parseFloat(value);return number>=1e9?number/1e9+"BN":number>=1e6?number/1e5+"M":number>=1e3?number/1e3+"K":value},utils.getLatLngByAddress=function(address,callback,onError){reverseGeocode(address,function(responseData){if("ok"!=responseData.result)return void onError(responseData);var location={lng:responseData.lng,lat:responseData.lat};callback(location)},onError)},utils.getDateDifference=function(date1,date2){var date1Millis=date1.getTime(),date2Millis=date2.getTime(),differenceObject={},differenceMillis=date2Millis>date1Millis?date2Millis-date1Millis:date1Millis-date2Millis;return differenceObject.days=Math.floor(differenceMillis/36e5/24),differenceObject.hours=Math.floor(differenceMillis/36e5%24),differenceObject.minutes=Math.floor(differenceMillis/6e4%60),differenceObject.seconds=Math.floor(differenceMillis/1e3%24),differenceObject},utils.combineDeviceChannelIDs=function(deviceId,channelId){if(!utils.isNullOrEmpty(deviceId)&&!utils.isNullOrEmpty(channelId))return deviceId+"-"+channelId},utils.isValidDir=function(directoryString){var pattern=new RegExp(/^[0-9a-zA-Z\/\-_\s]+$/i);return pattern.test(directoryString)},utils.containsAll=function(array1,array2){for(var i=0,len=array1.length;i<len;i++)if($.inArray(array1[i],array2)==-1)return!1;return!0},utils.containsAny=function(array1,array2){for(var i=0,len=array1.length;i<len;i++)if($.inArray(array1[i],array2)!==-1)return!0;return!1},utils.permutate=function(list,length){var perm=list.map(function(val){return[val]}),generate=function(perm,maxLen,currLen){if(currLen===maxLen)return perm;for(var i=0,len=perm.length;i<len;i++)for(var currPerm=perm.shift(),k=0;k<list.length;k++)perm.push(currPerm.concat(list[k]));return generate(perm,maxLen,currLen+1)};return generate(perm,length,1)},utils.requestUserInput=function(inputName,callback){var saved=!1,inputText="",contentHtml=$(".input_request_win").html(),kendoWindow=$(".input_request_win").kendoWindow({visible:!1,title:inputName,resizable:!1,modal:!0,width:200,close:function(){callback(saved,inputText)}});kendoWindow.data("kendoWindow").content(contentHtml).center().open();var $inputBox=$(".input_request_win input[name=userInput]");$(".input_request_win .btn_save").click(function(){inputText=$inputBox.val(),utils.isNullOrEmpty(inputText)||(saved=!0,$(".input_request_win").data("kendoWindow").close())}),$(".input_request_win .btn_cancel").click(function(){saved=!1,$(".input_request_win").data("kendoWindow").close()})},utils.isListEmpty=function(list){return null==list||0==list.length},utils.browsingOnNode=function(){var hostname=window.location.hostname;return"localhost"==hostname||"127.0.0.1"==hostname},utils.toAPITimestamp=function(utcDate){return kendo.toString(utcDate,kupapi.API_TIME_FORMAT)},utils.getLocalTimestamp=function(millis){var localDt=new Date(millis);return kendo.toString(localDt,kupapi.TIME_FORMAT)},utils.getUTCTimestamp=function(millis){var localDt=new Date(millis),utcDt=utils.convertToUTC(localDt);return kendo.toString(utcDt,kupapi.TIME_FORMAT)},utils.replaceAll=function(str,find,replace){return str.replace(new RegExp(find,"g"),replace)},utils}]);