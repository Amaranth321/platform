angular.module("kai.dashboard",["ui.kendo","ui.morris"]),angular.module("kai.dashboard").factory("DashboardService",["KupOption","AuthTokenFactory","UtilsService","KupApiService","$http",function(KupOption,AuthTokenFactory,UtilsService,KupApiService,$http){function getData(){return data}function getAnalyticsData(isDefer){var params={"analytics-type":"ALL"},onSuccess=function(response){return response},onFail=function(response){},onError=function(){};return ajaxPost("listrunninganalytics",params,onSuccess,onFail,onError,isDefer)}function getOnlineNodesData(isDefer){var params={},onSuccess=function(response){return response},onFail=function(response){},onError=function(){};return ajaxPost("getuserdevices",params,onSuccess,onFail,onError,isDefer)}function getOnlineCamerasCount(devicesData){var count=0;return jQuery.each(devicesData,function(i,device){count+=device.node.cameras.length}),count}function getCurrentActiveSessions(isDefer){var params={"bucket-id":AuthTokenFactory.getBucket()},onSuccess=function(response){return response},onFail=function(response){},onError=function(){};return ajaxPost("getcurrentactivesessions",params,onSuccess,onFail,onError,isDefer)}function getDashboardData(isDefer){var params={days:data.dayRange,"time-zone-offset":KupApiService.data.timeZoneOffset},onSuccess=function(response){var securityAlerts=response.eventscount||[],peopleCounting=response.peoplecounting||{},genderProfiling=response.genderprofilingcount||{},genderProfilingToTal=genderProfiling.male+genderProfiling.female,securityAlertsText=function(data){for(var tmp=0,i=data.length-1;i>=0;i--)tmp+=parseInt(data[i],10);return tmp}(securityAlerts),getCommaNum=function(number){return window.numeral(number).format("0,0")},getPercentNum=function(number){return window.numeral(number).format("0%")};return data.chartData={peopleCounting:peopleCounting.counts,securityAlerts:securityAlerts,genderProfiling:genderProfiling},data.isEmptyChartData={peopleCounting:function(data){return data.total=data.total||0,0===parseInt(data.total,10)}(peopleCounting),securityAlerts:function(data){var tmp=0;return $.each(data,function(i,v){tmp+=parseInt(v,10)}),0===tmp}(securityAlerts),genderProfiling:function(data){return data.male=data.male||0,data.female=data.female||0,0===parseInt(data.male,10)&&0===parseInt(data.female,10)}(genderProfiling)},data.chartTextData={showPeoleVisite:getCommaNum(peopleCounting.total),showVisitedToday:getCommaNum(peopleCounting.today),showAlerts:getCommaNum(securityAlertsText),showMale:getCommaNum(genderProfiling.male),showFemale:getCommaNum(genderProfiling.female),showMalePercentage:getPercentNum(genderProfiling.male/genderProfilingToTal),showFemalePercentage:getPercentNum(genderProfiling.female/genderProfilingToTal)},response},onFail=function(response){},onError=function(){};return ajaxPost("getdashboard",params,onSuccess,onFail,onError,isDefer)}function getChartConfig(pdata){var theme=AuthTokenFactory.getTheme(),dataList=function(pdata){var list=angular.copy(pdata)||[];return list.unshift(null),list.push(null),list}(pdata),days=getData().dayRange,dateList=function(days){var list=function(days){for(var list=[],i=days-1;i>=0;i--){var date=new Date,formatD="";date.setDate(date.getDate()-i),formatD=date.getMonth()+1+"/"+date.getDate(),list.push(formatD)}return list.unshift(""),list.push(""),list}(days);return list}(days),valueAxisFormat=function(pdata){var min=0;return pdata.length>0&&(min=function(pdata){for(var tmp=pdata.length?pdata[0].counts:0,i=data.length-1;i>=0;i--)data[i]<=tmp&&(tmp=pdata[i]);return tmp}(pdata)),min>=1e3?"#= value/1000 #k":"#= value #"}(data),config={theme:theme,legend:{visible:!1,position:"top",labels:{font:"11px Muli, sans-serif"}},chartArea:{},seriesDefaults:{type:"area",line:{width:1},area:{line:{style:"smooth"}},tooltip:{visible:!0,template:"#= value #",font:"400 12px/ Myriad Pro, sans-serif",border:{width:1}}},series:[{data:dataList}],valueAxis:{labels:{template:valueAxisFormat,font:"400 12px Myriad Pro, sans-serif"},line:{visible:!1},minorGridLines:{visible:!1},majorGridLines:{visible:!0,width:.5}},categoryAxis:{categories:dateList,justified:!0,labels:{font:"400 12px Myriad Pro, sans-serif"},majorGridLines:{visible:!1,width:1}}};return config}function getPeopleCountingChartConfig(chartData){return chartData=chartData||data.chartData.peopleCounting,data.chartConfig.peopleCounting=getChartConfig(chartData),data.chartConfig.peopleCounting}function getSecurityAlertsChartConfig(chartData){return chartData=chartData||data.chartData.securityAlerts,data.chartConfig.securityAlerts=getChartConfig(chartData),data.chartConfig.securityAlerts}function getGenderProfilingsChartConfig(theme,pdata){pdata=pdata||data.chartData.genderProfiling,theme.colors=data.genderColor;var isEmpty=function(){var isEmpty=!0;return $.each(pdata,function(key,val){if(0!==val)return isEmpty=!1,!1}),isEmpty}(),dataList=function(data){var list=[],index=0;return $.each(data,function(k,v){list[index]={label:i18n(k),value:v},index++}),list}(pdata),config=isEmpty?{}:{data:dataList,colors:theme.colors,labelColor:theme.labelColor,formatter:function(val,data){var formatNum=window.numeral,total=0;return $.each(this.data,function(i,info){total+=info.value}),val=formatNum(val/total).format("0%")},fontFamily:"Muli",backgroundColor:theme.backgroundColor,resize:!0};return data.chartConfig.genderProfiling=config,data.chartConfig.genderProfiling}var i18n=UtilsService.i18n,ajaxPost=KupApiService.ajaxPost,data={defaultReloadTime:3e4,intervalApi:null,dayRange:7,countTextData:{analyticsCount:"...",activeNodesCount:"...",activeCamerasCount:"...",loggedInUsersCount:"..."},chartTextData:{showPeoleVisite:0,showVisitedToday:0,showAlerts:0,showMale:0,showFemale:0,showMalePercentage:"0%",showFemalePercentage:"0%"},isEmptyChartData:{peopleCounting:!1,securityAlerts:!1,genderProfiling:!1},chartData:{peopleCounting:[],securityAlerts:[],genderProfiling:[]},chartConfig:{peopleCounting:{},securityAlerts:{},genderProfiling:{}},chartTheme:{peopleCounting:{},securityAlerts:{},genderProfiling:{}},genderColor:["#32a8ad","#ff675d"]};return{data:data,getData:getData,getAnalyticsData:getAnalyticsData,getOnlineNodesData:getOnlineNodesData,getOnlineCamerasCount:getOnlineCamerasCount,getCurrentActiveSessions:getCurrentActiveSessions,getDashboardData:getDashboardData,getPeopleCountingChartConfig:getPeopleCountingChartConfig,getSecurityAlertsChartConfig:getSecurityAlertsChartConfig,getGenderProfilingsChartConfig:getGenderProfilingsChartConfig}}]),angular.module("kai.dashboard").controller("DashboardController",["KupOption","RouterStateService","UtilsService","PromiseFactory","AuthTokenFactory","DashboardService","KendoChartTheme","MorrisChartTheme","$http","$scope","$q","$rootScope","$interval",function(KupOption,RouterStateService,UtilsService,PromiseFactory,AuthTokenFactory,DashboardService,KendoChartTheme,MorrisChartTheme,$http,$scope,$q,$rootScope,$interval){function init(){initOpt(),mainCtrl.block.promise=loadUI(),setWatch()}function initOpt(){var opt=dashboardCtrl.data;opt.isEmptyChartData={peopleCounting:!1,securityAlerts:!1,genderProfiling:!1}}function loadUI(){var opt=dashboardCtrl.data,getAnalytics=function(isDefer){return DashboardService.getAnalyticsData(isDefer).then(function(response){if(response.instances){var analyticsCount=response.instances.length;dashboardCtrl.data.countTextData.analyticsCount=analyticsCount}})},getOnlineNodes=function(isDefer){return DashboardService.getOnlineNodesData(isDefer).then(function(response){if(response.devices){var activeNodesCount=0,activeCamerasCount=0;$.each(response.devices,function(i,dvc){return dvc.status===kupOpt.deviceStatus.disconnected||(activeNodesCount++,void $.each(dvc.node.cameras,function(j,cmr){return cmr.status===kupOpt.deviceStatus.disconnected||void activeCamerasCount++}))}),dashboardCtrl.data.countTextData.activeNodesCount=activeNodesCount,dashboardCtrl.data.countTextData.activeCamerasCount=activeCamerasCount}})},getDashboard=function(isDefer){return DashboardService.getDashboardData(isDefer).then(function(data){if(data){var theme=AuthTokenFactory.getTheme();kendo.dataviz.ui.registerTheme(theme,KendoChartTheme[theme]),DashboardService.getPeopleCountingChartConfig(),DashboardService.getSecurityAlertsChartConfig(),DashboardService.getGenderProfilingsChartConfig(MorrisChartTheme[theme]),dashboardCtrl.data.chartTextData=DashboardService.data.chartTextData}})};return opt.intervalApi&&$interval.cancel(opt.intervalApi),opt.intervalApi=$interval(function(){getAnalytics(!1),getOnlineNodes(!1)},opt.defaultReloadTime),$q.all([getAnalytics(!0),getOnlineNodes(!0),getDashboard(!0)])}function setWatch(){$scope.$watch(function(){return angular.toJson(RouterStateService.getRouterState())},function(newValue,oldValue){var opt=dashboardCtrl.data,routerState=angular.fromJson(newValue).toState,routerCheck=/\.dashboard/.test(routerState.name);routerCheck||$interval.cancel(opt.intervalApi)},!0),$scope.$watch(function(){return AuthTokenFactory.getTheme()},function(newVal,oldVal){if(newVal!=oldVal){var theme=newVal;kendo.dataviz.ui.registerTheme(theme,KendoChartTheme[theme]),DashboardService.getPeopleCountingChartConfig(),DashboardService.getSecurityAlertsChartConfig(),DashboardService.getGenderProfilingsChartConfig(MorrisChartTheme[theme])}},!0),$scope.$watch(function(){return AuthTokenFactory.getUserProfile().userName},function(newVal,oldVal){$rootScope.userName=oldVal,newVal!=oldVal&&($rootScope.userName=AuthTokenFactory.getUserProfile().userName)},!0),$scope.$watch(function(){return AuthTokenFactory.getUserRole()},function(newVal,oldVal){$rootScope.userRole=oldVal,newVal!=oldVal&&($rootScope.userRole=AuthTokenFactory.getUserRole())},!0)}var kupOpt=KupOption,mainCtrl=(UtilsService.i18n,UtilsService.notification,$scope.$parent.mainCtrl),dashboardCtrl=this;dashboardCtrl.data=DashboardService.data,init()}]);