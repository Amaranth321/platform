angular.module("kai.reports.profiling",["ui.morris","ui.amcharts","datatables"]),angular.module("kai.reports.profiling").factory("ProfilingService",["KupOption","AmchartsTheme","UtilsService","PromiseFactory","KupApiService","ReportsService","AuthTokenFactory","DTOptionsBuilder","DTColumnDefBuilder","DTColumnBuilder","MorrisChartTheme","$q","$filter","$timeout",function(KupOption,AmchartsTheme,UtilsService,PromiseFactory,KupApiService,ReportsService,AuthTokenFactory,DTOptionsBuilder,DTColumnDefBuilder,DTColumnBuilder,MorrisChartTheme,$q,$filter,$timeout){function getUiTimeunitData(){return[{name:"hours",text:"hourly",isActiveForChart:!0,isShowForChart:!0,chartPeriod:"hh"},{name:"days",text:"daily",isActiveForChart:!1,isShowForChart:!0,chartPeriod:"DD"},{name:"weeks",text:"weekly",isActiveForChart:!1,isShowForChart:!0,chartPeriod:"WW"},{name:"months",text:"monthly",isActiveForChart:!1,isShowForChart:!0,chartPeriod:"MM"},{name:"years",text:"yearly",isActiveForChart:!1,isShowForChart:!1,chartPeriod:"YYYY"}]}function getUiChartData(){return{options:{}}}function getUiPieData(){return{options:{}}}function getUiChartForPdf(){return{width:"900px",height:"400px",options:{}}}function setInitData(){data.currentTab="summary",data.currentTimeunitForChart={gender:"hours",emotion:"hours",age:"hours"},data.uiNodata.isShow=!0,setInitTab(),setInitTimeunit()}function setInitTab(){$.each(data.uiTab,function(i,tab){0==i?tab.isActive=!0:tab.isActive=!1})}function setInitTimeunit(){$.each(data.chartTypeList,function(i,type){$.each(data.uiTimeunit[type],function(j,unit){0==j?unit.isActiveForChart=!0:unit.isActiveForChart=!1})})}function setSelectedData(){var opt=data,reportsOpt=reports.data,selectedItemDataList=reportsOpt.selectedItemDataList||{},events=opt.apiAnalyticsReportList,dataFormat=(reports.data.dateRange.startDate,reports.data.dateRange.endDate,angular.copy(opt.dataFormat1)),tableList={},lineCountList=angular.copy(opt.dataFormat2),lineSeriesInfo=angular.copy(opt.dataFormat2),barCountList=angular.copy(opt.dataFormat2),barSeriesInfo=angular.copy(opt.dataFormat2),sitenameList=[],totalCount=0,getTableData=function(uid,itemName,evt){var tmpObj={};return evt=evt||angular.copy(opt.dataFormat0),tableList[uid]?(tmpObj=angular.copy(tableList[uid]),$.each(dataFormat,function(type,df){$.each(df,function(key,val){tmpObj[type][key]+=evt[key],tmpObj[type].total=tmpObj[type].total?tmpObj[type].total+evt[key]:evt[key]})})):(tmpObj=angular.copy(opt.dataFormat1),tmpObj.itemName=itemName,$.each(dataFormat,function(type,df){$.each(df,function(key,val){tmpObj[type][key]=evt[key],tmpObj[type].total=tmpObj[type].total?tmpObj[type].total+evt[key]:evt[key]})})),tmpObj};!function(){$.each(events,function(i,evt){$.each(selectedItemDataList,function(uid,itemData){if($.isEmptyObject(itemData))return!0;if((itemData.isAll||itemData.isLabel)&&$.each(itemData.items,function(j,device){$.each(device.items,function(k,camera){var cameraData=camera.data;evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId&&(totalCount+=evt.male,totalCount+=evt.female)})}),itemData.isDevice&&$.each(itemData.items,function(j,camera){var cameraData=camera.data;evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId&&(totalCount+=evt.male,totalCount+=evt.female)}),itemData.isCamera){var cameraData=itemData.data;evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId&&(totalCount+=evt.male,totalCount+=evt.female)}})})}(),function(){$.each(selectedItemDataList,function(uid,itemData){if($.isEmptyObject(itemData))return!0;if(itemData.isAll||itemData.isLabel){var name=itemData.text,deviceTimeList={};$.each(itemData.items,function(i,device){var deviceList=[];$.each(device.items,function(j,camera){var cameraData=camera.data;$.each(events,function(k,evt){if(evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId){var cameraList=[],countItem=angular.copy(opt.dataFormat3);countItem.gender.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),countItem.emotion.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),countItem.age.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),$.each(dataFormat,function(type,df){$.each(df,function(key,val){countItem[type][key]=evt[key]})}),cameraList.push(countItem),deviceList.push(cameraList),tableList[uid]=getTableData(uid,name,evt)}}),tableList[uid]=tableList[uid]||getTableData(uid,name)}),$.each(deviceList,function(j,cameraList){$.each(cameraList,function(k,camera){var timeIndex=kendo.toString(camera.gender.time,data.timeFormat2);deviceTimeList[timeIndex]=deviceTimeList[timeIndex]||{},$.each(camera,function(key1,type){deviceTimeList[timeIndex][key1]=deviceTimeList[timeIndex][key1]||{time:type.time},$.each(type,function(key2,detail){"time"!==key2&&(deviceTimeList[timeIndex][key1][key2]=(deviceTimeList[timeIndex][key1][key2]||0)+detail)})})})})}),$.each(deviceTimeList,function(i,deviceList){$.each(lineCountList,function(type,detail){lineCountList[type].push(deviceList[type])})})}if(itemData.isDevice){var name=itemData.labelName+" - "+itemData.text,deviceList=[],deviceTimeList={};$.each(itemData.items,function(i,camera){var cameraData=camera.data;$.each(events,function(j,evt){if(evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId){var cameraList=[],countItem=angular.copy(opt.dataFormat3);countItem.gender.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),countItem.emotion.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),countItem.age.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),$.each(dataFormat,function(type,df){$.each(df,function(key,val){countItem[type][key]=evt[key]})}),cameraList.push(countItem),deviceList.push(cameraList),tableList[uid]=getTableData(uid,name,evt)}}),tableList[uid]=tableList[uid]||getTableData(uid,name)}),$.each(deviceList,function(i,cameraList){$.each(cameraList,function(j,camera){var timeIndex=kendo.toString(camera.gender.time,data.timeFormat2);deviceTimeList[timeIndex]=deviceTimeList[timeIndex]||{},$.each(camera,function(key1,type){deviceTimeList[timeIndex][key1]=deviceTimeList[timeIndex][key1]||{time:type.time},$.each(type,function(key2,detail){"time"!==key2&&(deviceTimeList[timeIndex][key1][key2]=(deviceTimeList[timeIndex][key1][key2]||0)+detail)})})})}),$.each(deviceTimeList,function(i,deviceList){$.each(lineCountList,function(type,detail){lineCountList[type].push(deviceList[type])})})}if(itemData.isCamera){var cameraData=itemData.data,name=cameraData.deviceName+" - "+cameraData.channelName;$.each(events,function(i,evt){if(evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId){var countItem=angular.copy(opt.dataFormat3);countItem.gender.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),countItem.emotion.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),countItem.age.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),$.each(dataFormat,function(type,df){$.each(df,function(key,val){countItem[type][key]=evt[key]})}),lineCountList.gender.push(countItem.gender),lineCountList.emotion.push(countItem.emotion),lineCountList.age.push(countItem.age),tableList[uid]=getTableData(uid,name,evt)}}),tableList[uid]=tableList[uid]||getTableData(uid,name)}sitenameList.push(name)})}(),function(){var mergeCountList={};$.each(lineCountList,function(type,typeDataList){$.each(typeDataList,function(i,typeData){var timeIndex=kendo.toString(typeData.time,data.timeFormat2);mergeCountList[timeIndex]=mergeCountList[timeIndex]||{},mergeCountList[timeIndex][type]=mergeCountList[timeIndex][type]||{time:typeData.time},$.each(typeData,function(key,val){"time"!==key&&(mergeCountList[timeIndex][type][key]=(mergeCountList[timeIndex][type][key]||0)+val)})})}),lineCountList=angular.copy(opt.dataFormat2),$.each(mergeCountList,function(time,ds){$.each(ds,function(type,typeData){lineCountList[type]=lineCountList[type]||[],lineCountList[type].push(typeData)})})}(),function(){$.each(lineCountList,function(type,list){lineCountList[type].sort(function(a,b){return a.time-b.time})})}(),function(){var count,getGraphsInfo=function(count,fieldName){return{id:"g"+count,valueAxis:"v"+count,valueField:fieldName,type:"smoothedLine",bullet:"round",bulletBorderThickness:1,hideBulletsCount:30,title:i18n(fieldName),fillAlphas:0,lineThickness:2,balloonText:i18n(fieldName)+" :<b>[[value]]</b>"}};$.each(opt.dataFormat1,function(type,list){count=0,$.each(list,function(key,val){lineSeriesInfo[type].push(getGraphsInfo(count,key)),count++})})}(),function(){var tmpObj={};$.each(tableList,function(uid,list){$.each(list,function(type,val){tmpObj=val,tmpObj.itemName=list.itemName,barCountList[type]&&barCountList[type].push(tmpObj)})})}(),function(){var count,getGraphsInfo=function(count,fieldName){return{balloonText:i18n(fieldName)+" :<b>[[value]]</b>",fillAlphas:.8,labelText:"[[value]]",lineAlpha:.3,title:i18n(fieldName),type:"column",color:"#000000",valueField:fieldName}};$.each(opt.dataFormat1,function(type,list){count=0,$.each(list,function(key,val){barSeriesInfo[type].push(getGraphsInfo(count,key)),count++})})}(),opt.selectedDataSource=angular.copy(lineCountList),opt.selectedTableDataSource=angular.copy(tableList),opt.selectedChartDataSource=angular.copy(lineCountList),opt.selectedChartGraphs=angular.copy(lineSeriesInfo),opt.selectedBarDataSource=angular.copy(barCountList),opt.selectedBarGraphs=angular.copy(barSeriesInfo),opt.selectedPieDataSource=angular.copy(lineCountList),opt.selectedSitenameList=sitenameList,opt.selectedTotalCount=totalCount}function setChartData(type){var timeunit=data.currentTimeunitForChart[type],dataSource=angular.copy(data.selectedDataSource[type]),dataSourceByTimeunit=(reports.data.selectedSaveDataList.length,[]),dataFormat=angular.copy(data.dataFormat1[type]);!function(){if("hours"==timeunit){for(var start=moment(reports.data.dateRange.startDate),end=moment(reports.data.dateRange.endDate),countList=[],i=start;i<=end;i=moment(i).add(1,"hours")){var index=countList.length;countList[index]={},$.each(dataFormat,function(key,val){countList[index].time=i.format(),countList[index][key]=0})}$.each(dataSource,function(index,ds){var index=moment(ds.time).diff(start,"hours");countList[index]=ds}),dataSourceByTimeunit=countList}if("days"==timeunit){for(var start=moment(reports.data.dateRange.startDate),end=moment(reports.data.dateRange.endDate),countList=[],i=start;i<=end;i=moment(i).add(1,"days")){var index=countList.length;countList[index]={},$.each(dataFormat,function(key,val){countList[index].time=i.format(),countList[index][key]=0})}$.each(dataSource,function(index,ds){var index=moment(ds.time).diff(start,"days");$.each(dataFormat,function(key,val){countList[index][key]+=ds[key]})}),dataSourceByTimeunit=countList}if("weeks"==timeunit){for(var weekStart=kupOpt.dateOfWeekStart,start=moment(reports.data.dateRange.startDate).isoWeekday(weekStart),end=moment(reports.data.dateRange.endDate).isoWeekday(weekStart),countList=[],i=start;i<=end;i=moment(i).add(1,"weeks")){var index=countList.length;countList[index]={},$.each(dataFormat,function(key,val){countList[index].time=i.format(),countList[index][key]=0})}$.each(dataSource,function(i,ds){var index=moment(ds.time).diff(start,"weeks");$.each(dataFormat,function(key,val){countList[index][key]+=ds[key]})}),dataSourceByTimeunit=countList}if("months"==timeunit){for(var start=moment(reports.data.dateRange.startDate).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),end=moment(reports.data.dateRange.endDate).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),countList=[],i=start;i<=end;i=moment(i).add(1,"month")){var index=countList.length;countList[index]={},$.each(dataFormat,function(key,val){countList[index].time=i.format(),countList[index][key]=0})}$.each(dataSource,function(i,ds){var index=moment(ds.time).diff(start,"months");$.each(dataFormat,function(key,val){countList[index][key]+=ds[key]})}),dataSourceByTimeunit=countList}if("years"==timeunit){for(var start=moment(reports.data.dateRange.startDate).month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),end=moment(reports.data.dateRange.endDate).month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),countList=[],i=start;i<=end;i=moment(i).add(1,"years")){var index=countList.length;countList[index]={},$.each(dataFormat,function(key,val){countList[index].time=i.format(),countList[index][key]=0})}$.each(dataSource,function(i,ds){var index=moment(ds.time).diff(start,"years");$.each(dataFormat,function(key,val){countList[index][key]+=ds[key]})}),dataSourceByTimeunit=countList}}(),data.selectedChartDataSource[type]=dataSourceByTimeunit}function setChartOptions(type){var opt=data,chartSetting=function(){var setting={};return $.each(data.uiTimeunit[type],function(i,unit){if(unit.name===data.currentTimeunitForChart[type])return setting.minPeriod=unit.chartPeriod,!1}),setting}(),chartOptions={dataProvider:angular.copy(data.selectedChartDataSource[type]),graphs:angular.copy(data.selectedChartGraphs[type]),type:"serial",theme:AuthTokenFactory.getTheme(),colors:opt.colorTheme[type],zoomOutText:i18n("show-all"),valueAxes:[{axisColor:"chartCursor",axisThickness:2,axisAlpha:1,position:"left"}],chartScrollbar:{autoGridCount:!0,graph:"g0",scrollbarHeight:40},chartCursor:{cursorPosition:"mouse",categoryBalloonFunction:function(){var time=arguments[0];return setChartTimeunitLabel(time,type)}},categoryField:"time",categoryAxis:{firstDayOfWeek:kupOpt.dateOfWeekStart,gridAlpha:0,markPeriodChange:!0,boldLabels:!0,minPeriod:chartSetting.minPeriod,parseDates:!0,equalSpacing:!0,dateFormats:[{period:"fff",format:"JJ:NN:SS"},{period:"ss",format:"JJ:NN:SS"},{period:"mm",format:"JJ:NN"},{period:"hh",format:"JJ:NN"},{period:"DD",format:"MMM DD"},{period:"WW",format:"MMM DD"},{period:"MM",format:"MMM"},{period:"YYYY",format:"YYYY"}],labelFunction:function(dateText){var time=arguments[1];switch(chartSetting.minPeriod){case"hh":dateText=moment(time).format(kupOpt["default"].formatAxisHourly);break;case"DD":dateText=moment(time).format(kupOpt["default"].formatAxisDaily);break;case"WW":dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatAxisWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatAxisWeekly);break;case"MM":dateText=moment(time).format(kupOpt["default"].formatAxisMonthly)}return dateText}},legend:{useGraphSettings:!1,valueWidth:0,valueFunction:function(){return""}}};return data.uiChart[type].options=chartOptions,chartOptions}function setChartForPdfOptions(type){var opt=data,chartSetting=function(){var setting={};return $.each(data.uiTimeunit[type],function(i,unit){if(unit.name===data.currentTimeunitForChart[type])return setting.minPeriod=unit.chartPeriod,!1}),setting}(),chartOptions={dataProvider:angular.copy(data.selectedChartDataSource[type]),graphs:angular.copy(data.selectedChartGraphs[type]),type:"serial",theme:"white",colors:opt.colorTheme[type],titles:[{text:i18n("occurrence-vs-time")}],fontFamily:"Verdana",fontSize:11,valueAxes:[{axisColor:"chartCursor",axisThickness:2,axisAlpha:1,position:"left"}],chartCursor:{cursorPosition:"mouse",categoryBalloonFunction:function(){var time=arguments[0];return setChartTimeunitLabel(time,type)}},categoryField:"time",categoryAxis:{firstDayOfWeek:kupOpt.dateOfWeekStart,gridAlpha:0,markPeriodChange:!0,boldLabels:!0,minPeriod:chartSetting.minPeriod,parseDates:!0,equalSpacing:!0,dateFormats:[{period:"fff",format:"JJ:NN:SS"},{period:"ss",format:"JJ:NN:SS"},{period:"mm",format:"JJ:NN"},{period:"hh",format:"JJ:NN"},{period:"DD",format:"MMM DD"},{period:"WW",format:"MMM DD"},{period:"MM",format:"MMM"},{period:"YYYY",format:"YYYY"}],labelFunction:function(dateText){var time=arguments[1];switch(chartSetting.minPeriod){case"hh":dateText=moment(time).format(kupOpt["default"].formatAxisHourly);break;case"DD":dateText=moment(time).format(kupOpt["default"].formatAxisDaily);break;case"WW":dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatAxisWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatAxisWeekly);break;case"MM":dateText=moment(time).format(kupOpt["default"].formatAxisMonthly)}return dateText}},legend:{useGraphSettings:!1,valueWidth:0,valueFunction:function(){return""}}};return data.uiChartForPdf[type].options=chartOptions,chartOptions}function setBarData(type){}function setBarOptions(type){var opt=data,chartOptions={dataProvider:angular.copy(data.selectedBarDataSource[type]),graphs:angular.copy(data.selectedBarGraphs[type]),theme:AuthTokenFactory.getTheme(),colors:opt.colorTheme[type],categoryField:"itemName",type:"serial",rotate:!0,startDuration:1,categoryAxis:{gridPosition:"start"},trendLines:[],guides:[],valueAxes:[{stackType:"100%",title:""}],allLabels:[],balloon:{},legend:{useGraphSettings:!1,valueWidth:0,valueFunction:function(){return""}}};return data.uiBar[type].options=chartOptions,chartOptions}function setPieData(type){var opt=data,dataSource=angular.copy(opt.selectedDataSource[type]),dataSourceForPie={};$.each(dataSource,function(i,ds){$.each(ds,function(key,val){return"time"===key||void(dataSourceForPie[key]=dataSourceForPie[key]+val||val)})}),$.each(dataSourceForPie,function(key,val){dataSourceForPie.total=dataSourceForPie.total+val||val}),opt.selectedPieDataSource[type]=dataSourceForPie}function setPieOptions(type){var opt=data,theme=angular.copy(MorrisChartTheme[opt.pieTheme]),dataSource=opt.selectedPieDataSource[type],isEmpty=function(){var isEmpty=!0;return $.each(dataSource,function(key,val){if(0!==val)return isEmpty=!1,!1}),isEmpty}(),dataList=function(data){var list=[],index=0;return $.each(data,function(k,v){return"total"===k||(list[index]={label:i18n(k),value:v},void index++)}),list}(dataSource),config=isEmpty?{}:{data:dataList,colors:opt.colorTheme[type],labelColor:theme.labelColor,formatter:function(val,data){var total=0;return $.each(this.data,function(i,info){total+=info.value}),val=$filter("percentage")(val/total,2)},fontFamily:"Muli",backgroundColor:theme.backgroundColor,resize:!0};data.uiPie[type].options=config}function getAnalyticsReportApi(isDefer){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,selectedDeviceList=reportsOpt.selectedDevices[0].platformDeviceId,fromDateUTC=(reportsOpt.selectedDevices[0].channelId,kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),data.timeFormat2)),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),data.timeFormat2),param={"event-type":vcaEventType,"device-id":JSON.stringify(selectedDeviceList),"channel-id":"",from:fromDateUTC,to:toDateUTC,parameters:JSON.stringify({})},onSuccess=function(response){opt.apiAnalyticsReportList=response.data||[]},onFail=function(response){opt.apiAnalyticsReportList=[]},onError=function(){opt.apiAnalyticsReportList=[]};return ajaxPost("getanalyticsreport",param,onSuccess,onFail,onError,isDefer)}function exportAggregatedCsvReportApi(periodType){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,fromDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),opt.timeFormat2),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),opt.timeFormat2),baseUnit=periodType,selectedGroups=[],type=(AuthTokenFactory.getApiRootUrl(),"");$.each(reportsOpt.selectedItemDataList,function(uid,itemData){var devices=[];if($.isEmptyObject(itemData))return!0;if(itemData.isAll||itemData.isLabel){var device=itemData.items||[];$.each(device,function(i,deviceData){var camera=deviceData.items||[];$.each(camera,function(j,cameraData){devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId})})}),type="labels"}else if(itemData.isDevice){var camera=itemData.items||[];$.each(camera,function(i,cameraData){devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId})}),type="devices"}else if(itemData.isCamera){if(itemData.hasChildren)return;var cameraData=itemData;devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId}),type="devices"}!function(){var groupname="";(itemData.isLabel||itemData.isAll)&&(groupname=itemData.labelName),itemData.isDevice&&(groupname=itemData.labelName+" - "+itemData.text),itemData.isCamera&&(groupname=itemData.labelName+" - "+itemData.deviceName+" - "+itemData.text),selectedGroups.push({groupName:groupname,devicePairs:devices,type:type})}()});var param={"event-type":vcaEventType,"selected-groups":JSON.stringify(selectedGroups),"time-zone-offset":KupApiService.data.timeZoneOffset,from:fromDateUTC,to:toDateUTC,"base-unit":baseUnit};return KupApiService.exportDoc(param,"exportaggregatedcsvreport")}function exportVcaSecurityPdfApi(){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,svgData1=(AuthTokenFactory.getApiRootUrl(),function(){var svgData=[];return $.each($("#profillingPieGender").find("svg"),function(i,el){svgData.push("<svg version='1.1' width='"+$(el).css("width")+"' height='"+$(el).css("height")+"'>"+$(el).html()+"</svg>")}),$.each($("#profillingPieAge").find("svg"),function(i,el){svgData.push("<svg version='1.1' width='"+$(el).css("width")+"' height='"+$(el).css("height")+"'>"+$(el).html()+"</svg>")}),$.each($("#profillingPieEmotion").find("svg"),function(i,el){svgData.push("<svg version='1.1' width='"+$(el).css("width")+"' height='"+$(el).css("height")+"'>"+$(el).html()+"</svg>")}),svgData}()),svgData2=function(){var svgData=[];window.AmCharts.makeChart("profilingChartForPdfGender",setChartForPdfOptions("gender")),window.AmCharts.makeChart("profilingChartForPdfAge",setChartForPdfOptions("age")),window.AmCharts.makeChart("profilingChartForPdfEmotion",setChartForPdfOptions("emotion"));return $.each($("#profilingChartForPdfGender").find("svg"),function(i,el){svgData.push("<svg version='1.1' width='"+$(el).css("width")+"' height='"+$(el).css("height")+"'>"+$(el).html()+"</svg>")}),$.each($("#profilingChartForPdfAge").find("svg"),function(i,el){svgData.push("<svg version='1.1' width='"+$(el).css("width")+"' height='"+$(el).css("height")+"'>"+$(el).html()+"</svg>")}),$.each($("#profilingChartForPdfEmotion").find("svg"),function(i,el){svgData.push("<svg version='1.1' width='"+$(el).css("width")+"' height='"+$(el).css("height")+"'>"+$(el).html()+"</svg>")}),svgData}(),reportInfo={"event-type":vcaEventType,"site-name":opt.selectedSitenameList.toString(),from:kendo.toString(reportsOpt.dateRange.startDate,opt.timeFormat1),to:kendo.toString(reportsOpt.dateRange.endDate,opt.timeFormat1),"total-results":opt.selectedTotalCount+""},param={"time-zone-offset":KupApiService.data.timeZoneOffset,"svg-string1":svgData1.join(""),"svg-string2":svgData2.join(""),"report-info":angular.toJson(reportInfo)};return KupApiService.exportDoc(param,"exportaudienceprofilingpdf")}function setChartTimeunitLabel(dateFormat,type){var dateText="",time=new Date(dateFormat),dateLang=(kupOpt.dateOfWeekStart,"en-us"),dateOpt={weekday:"short",month:"short",day:"numeric",year:"numeric"};return"hours"==data.currentTimeunitForChart[type]&&(dateText=moment(time).format(kupOpt["default"].formatHourly)),"days"==data.currentTimeunitForChart[type]&&(dateText=moment(time).format(kupOpt["default"].formatDaily)),"weeks"==data.currentTimeunitForChart[type]&&(dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatWeekly)),"months"==data.currentTimeunitForChart[type]&&(dateText=moment(time).format(kupOpt["default"].formatMonthly)),"years"==data.currentTimeunitForChart[type]&&(dateOpt={year:"numeric"},dateText=time.toLocaleDateString(dateLang,dateOpt)),dateText}function setChartTheme(){var theme=AuthTokenFactory.getTheme();window.AmCharts.themes[theme]=AmchartsTheme[theme]}function setPieTheme(){var opt=data,theme=AuthTokenFactory.getTheme();opt.pieTheme=theme}function generateChart(type){var opt=data;setChartTheme(),type?(setChartData(type),setChartOptions(type)):$.each(opt.chartTypeList,function(i,chartType){setChartData(chartType),setChartOptions(chartType)})}function generateBar(type){var opt=data;setChartTheme(),type?(setBarData(type),setBarOptions(type)):$.each(opt.chartTypeList,function(i,chartType){setBarData(chartType),setBarOptions(chartType)})}function generatePie(){var opt=data;setPieTheme(),$.each(opt.chartTypeList,function(i,type){setPieData(type),setPieOptions(type)})}function generateReport(){setInitData();var opt=data;if($.each(opt.requestForReport,function(i,request){request.cancel&&request.cancel()}),!reports.isSelectCamera())return notification("error",i18n("no-channel-selected")),reports.isSuccessReport(!1),!1;opt.requestForReport=[getAnalyticsReportApi(!0)];var dfd=$q.defer();return $timeout(function(){$q.all(opt.requestForReport)["finally"](function(){return setSelectedData(),opt.apiAnalyticsReportList.length<=0?(reports.isSuccessReport(!1),void dfd.reject()):(reports.isSuccessReport(!0),generateChart(),generateBar(),generatePie(),void dfd.resolve())})},500),dfd.promise}var kupOpt=KupOption,utils=UtilsService,i18n=UtilsService.i18n,notification=UtilsService.notification,ajaxPost=KupApiService.ajaxPost,reports=ReportsService,data={timeFormat0:"yyyy/MM/dd HH:mm:ss",timeFormat1:"dd/MM/yyyy HH:mm:ss",timeFormat2:"ddMMyyyyHHmmss",dataFormat0:{male:0,female:0,happy:0,neutral:0,age1:0,age2:0,age3:0,age4:0},dataFormat1:{gender:{male:0,female:0},age:{age1:0,age2:0,age3:0,age4:0},emotion:{happy:0,neutral:0}},dataFormat2:{age:[],gender:[],emotion:[]},dataFormat3:{age:{},gender:{},emotion:{}},chartTypeList:["gender","emotion","age"],pieTheme:"",colorTheme:{gender:["#32a8ad","#ff675d"],emotion:["#f6ae40","#8aba50"],age:["#ff6530","#f6ae40","#8aba50","#337caf"]},ageList:KupOption.age,selectedDataSource:{gender:[],emotion:[],age:[]},selectedChartDataSource:{gender:[],emotion:[],age:[]},selectedChartGraphs:{gender:[],emotion:[],age:[]},selectedBarDataSource:{gender:[],emotion:[],age:[]},selectedBarGraphs:{gender:[],emotion:[],age:[]},selectedPieDataSource:{gender:{},emotion:{},age:{}},selectedTableDataSource:[],selectedTotalCount:0,selectedSitenameList:[],apiAnalyticsReportList:[],currentTab:"summary",currentTimeunitForChart:{gender:"hours",emotion:"hours",age:"hours"},requestForReport:[],uiTab:[{name:"summary",text:"summary","class":"kup-summary",isActive:!0},{name:"comparison",text:"comparison","class":"kup-comparison",isActive:!1}],uiExport:{isOpen:!1},uiNodata:{isShow:!0},uiTimeunit:{gender:getUiTimeunitData(),emotion:getUiTimeunitData(),age:getUiTimeunitData()},uiChart:{gender:getUiChartData(),emotion:getUiChartData(),age:getUiChartData()},uiBar:{gender:getUiChartData(),emotion:getUiChartData(),age:getUiChartData()},uiPie:{gender:getUiPieData(),emotion:getUiPieData(),age:getUiPieData()},uiChartForPdf:{gender:getUiChartForPdf(),emotion:getUiChartForPdf(),age:getUiChartForPdf()},uiTable:{options:DTOptionsBuilder.newOptions().withOption("paging",!1).withOption("info",!1).withOption("responsive",!0),columnDefs:[]}};return{data:data,setInitData:setInitData,setInitTab:setInitTab,setInitTimeunit:setInitTimeunit,setSelectedData:setSelectedData,setChartData:setChartData,setChartOptions:setChartOptions,setChartForPdfOptions:setChartForPdfOptions,setChartTimeunitLabel:setChartTimeunitLabel,setChartTheme:setChartTheme,setBarData:setBarData,setBarOptions:setBarOptions,setPieData:setPieData,setPieOptions:setPieOptions,setPieTheme:setPieTheme,getAnalyticsReportApi:getAnalyticsReportApi,exportAggregatedCsvReportApi:exportAggregatedCsvReportApi,exportVcaSecurityPdfApi:exportVcaSecurityPdfApi,generateReport:generateReport,generateChart:generateChart,generateBar:generateBar,generatePie:generatePie}}]),angular.module("kai.reports.profiling").controller("ProfilingController",["KupOption","RouterStateService","UtilsService","PromiseFactory","AuthTokenFactory","ReportsService","ProfilingService","DTOptionsBuilder","DTColumnDefBuilder","$scope","$timeout","$q","$rootScope",function(KupOption,RouterStateService,UtilsService,PromiseFactory,AuthTokenFactory,ReportsService,ProfilingService,DTOptionsBuilder,DTColumnDefBuilder,$scope,$timeout,$q,$rootScope){function init(){$scope.$watch(function(){return angular.toJson(reports.data)},function(newVal,oldVal){var reportsOpt=angular.fromJson(newVal);profilingCtrl.data.uiNodata.isShow=!reportsOpt.isSuccessReport},!0),$scope.$watch(function(){return AuthTokenFactory.getTheme()},function(newVal,oldVal){return newVal!=oldVal&&(ProfilingService.setChartTheme(),ProfilingService.generateChart(),ProfilingService.generateBar(),ProfilingService.setPieTheme(),void ProfilingService.generatePie())},!0),$scope.$watch(function(){return reports.data.selectedInstance},function(newVal,oldVal){updateUI()},!0)}function updateUI(){reports.data.selectedInstance.length>1?profilingCtrl.data.uiTab=[{name:"summary",text:"summary","class":"kup-summary",isActive:!0},{name:"comparison",text:"comparison","class":"kup-comparison",isActive:!1}]:profilingCtrl.data.uiTab=[{name:"summary",text:"summary","class":"kup-summary",isActive:!0}]}function setTab(tabName){var opt=profilingCtrl.data,tabData=opt.uiTab;$.each(tabData,function(i,data){data.isActive=tabName===data.name}),opt.currentTab=tabName}function setTimeunitForChart(unitName,type){var opt=profilingCtrl.data,timeunitData=opt.uiTimeunit[type];$.each(timeunitData,function(i,data){data.isActiveForChart=unitName===data.name}),opt.currentTimeunitForChart[type]=unitName,ProfilingService.generateChart(type)}function exportCsv(periodType){if(!reports.isSuccessReport())return notification("error",i18n("please-generate-reports")),!1;var warningNotify=notification("warning",i18n("exporting-to-csv"),0);ProfilingService.exportAggregatedCsvReportApi(periodType)["finally"](function(){warningNotify.close()})}function exportPdf(){if(!reports.isSuccessReport())return notification("error",i18n("please-generate-reports")),!1;var warningNotify=notification("warning",i18n("exporting-to-pdf"),0);ProfilingService.exportVcaSecurityPdfApi()["finally"](function(){warningNotify.close()})}var i18n=UtilsService.i18n,notification=UtilsService.notification,reports=ReportsService,profilingCtrl=this;profilingCtrl.data=ProfilingService.data,profilingCtrl.fn={setTab:setTab,setTimeunitForChart:setTimeunitForChart,exportPdf:exportPdf,exportCsv:exportCsv},init()}]);