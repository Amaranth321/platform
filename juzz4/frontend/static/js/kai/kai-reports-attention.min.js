angular.module("kai.reports.attention",["ui.amcharts"]),angular.module("kai.reports.attention").factory("AttentionService",["KupOption","AmchartsTheme","UtilsService","PromiseFactory","KupApiService","ReportsService","AuthTokenFactory","$filter","$q","$timeout",function(KupOption,AmchartsTheme,UtilsService,PromiseFactory,KupApiService,ReportsService,AuthTokenFactory,$filter,$q,$timeout){function setInitData(){data.currentTab="chart",data.currentTimeunitForLineChart="hours",data.uiNodata.isShow=!0,setInitTab(),setInitTimeunit()}function setInitTab(){$.each(data.uiTab,function(i,tab){0==i?tab.isActive=!0:tab.isActive=!1})}function setInitTimeunit(){$.each(data.uiTimeunit,function(i,unit){0==i?unit.isActiveForLineChart=!0:unit.isActiveForLineChart=!1})}function setChartData(){var opt=data,reportsOpt=reports.data,selectedItemDataList=reportsOpt.selectedItemDataList||{},events=opt.apiAnalyticsReportList,dbEvents=(reports.data.dateRange.startDate,reports.data.dateRange.endDate,angular.copy(opt.apiAnalyticsReportList)),categoryNames=["under 5s","5 to 10s","10 to 20s","20 to 30s","30 to 60s","1 to 3m","3 to 5m","5 to 8m","8 to 10m","10 to 15m","15 to 30m"],durValues=[0,0,0,0,0,0,0,0,0,0,0],countDurValues=function(eventData){$.each(eventData,function(key,value){switch(key){case"dur0_5s":durValues[0]=durValues[0]+value;break;case"dur5_10s":durValues[1]=durValues[1]+value;break;case"dur10_20s":durValues[2]=durValues[2]+value;break;case"dur20_30s":durValues[3]=durValues[3]+value;break;case"dur30_60s":durValues[4]=durValues[4]+value;break;case"dur1_3m":durValues[5]=durValues[5]+value;break;case"dur3_5m":durValues[6]=durValues[6]+value;break;case"dur5_8m":durValues[7]=durValues[7]+value;break;case"dur8_10m":durValues[8]=durValues[8]+value;break;case"dur10_15m":durValues[9]=durValues[9]+value;break;case"dur15_30m":durValues[10]=durValues[10]+value}})},durList=[],seriesInfo1=[],valueAxes1=[],attentionCountList=[],seriesInfo2=[],valueAxes2=[],sitenameList=[],totalCount=0;return function(){$.each(events,function(i,evt){$.each(selectedItemDataList,function(uid,itemData){if($.isEmptyObject(itemData))return!0;if((itemData.isAll||itemData.isLabel)&&$.each(itemData.items,function(j,device){$.each(device.items,function(k,camera){var cameraData=camera.data;evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId&&(totalCount+=evt.male,totalCount+=evt.female)})}),itemData.isDevice&&$.each(itemData.items,function(j,camera){var cameraData=camera.data;evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId&&(totalCount+=evt.male,totalCount+=evt.female)}),itemData.isCamera){var cameraData=itemData.data;evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId&&(totalCount+=evt.male,totalCount+=evt.female)}})})}(),function(){$.each(selectedItemDataList,function(uid,itemData){if($.isEmptyObject(itemData))return!0;if(itemData.isAll||itemData.isLabel){var name=itemData.text,deviceTimeList={};$.each(itemData.items,function(i,device){var deviceList=[];$.each(device.items,function(j,camera){var cameraData=camera.data,cameraList=[];$.each(dbEvents,function(k,event){if(event.deviceId==cameraData.deviceId&&event.channelId==cameraData.channelId){var countItem={};countItem.totalDuration=event.duration,countItem.eventNum=event.count,countItem.date=utils.convertUTCtoLocal(new Date(event.date)),cameraList.push(countItem),countDurValues(event)}}),deviceList.push(cameraList)}),$.each(deviceList,function(i,cameraList){$.each(cameraList,function(j,camera){var timeIndex=kendo.toString(camera.date,opt.timeFormat2);deviceTimeList[timeIndex]?(deviceTimeList[timeIndex].totalDuration+=camera.totalDuration,deviceTimeList[timeIndex].eventNum+=camera.eventNum):(deviceTimeList[timeIndex]={},deviceTimeList[timeIndex].totalDuration=camera.totalDuration,deviceTimeList[timeIndex].eventNum=camera.eventNum,deviceTimeList[timeIndex].date=camera.date)})})}),$.each(deviceTimeList,function(i,deviceList){attentionCountList.push(deviceList)})}else if(itemData.isDevice){var name=itemData.labelName+" - "+itemData.text,deviceList=[],deviceTimeList={};$.each(itemData.items,function(i,camera){var cameraData=camera.data,cameraList=[];$.each(dbEvents,function(j,event){if(event.deviceId==cameraData.deviceId&&event.channelId==cameraData.channelId){var countItem={};countItem.totalDuration=event.duration,countItem.eventNum=event.count,countItem.date=utils.convertUTCtoLocal(new Date(event.date)),cameraList.push(countItem),countDurValues(event)}}),deviceList.push(cameraList)}),$.each(deviceList,function(i,cameraList){$.each(cameraList,function(j,camera){var timeIndex=kendo.toString(camera.date,opt.timeFormat2);deviceTimeList[timeIndex]?(deviceTimeList[timeIndex].totalDuration+=camera.totalDuration,deviceTimeList[timeIndex].eventNum+=camera.eventNum):(deviceTimeList[timeIndex]={},deviceTimeList[timeIndex].totalDuration=camera.totalDuration,deviceTimeList[timeIndex].eventNum=camera.eventNum,deviceTimeList[timeIndex].date=camera.date)})}),$.each(deviceTimeList,function(i,deviceList){attentionCountList.push(deviceList)})}else if(itemData.isCamera){var cameraData=itemData.data,name=cameraData.deviceName+" - "+cameraData.channelName;$.each(dbEvents,function(i,event){if(event.deviceId==cameraData.deviceId&&event.channelId==cameraData.channelId){var countItem={};countItem.totalDuration=event.duration,countItem.eventNum=event.count,countItem.date=utils.convertUTCtoLocal(new Date(event.date)),attentionCountList.push(countItem),countDurValues(event)}})}sitenameList.push(name)})}(),function(){var mergeCountList={};$.each(attentionCountList,function(i,ds){var timeIndex=kendo.toString(ds.date,data.timeFormat2);mergeCountList[timeIndex]?(mergeCountList[timeIndex].eventNum+=ds.eventNum,mergeCountList[timeIndex].totalDuration+=ds.totalDuration):(mergeCountList[timeIndex]={},mergeCountList[timeIndex]=ds)}),attentionCountList=[],$.each(mergeCountList,function(time,ds){ds.time=ds.date,ds.avgDuration=ds.eventNum?parseFloat((ds.totalDuration/ds.eventNum).toFixed(2),10):0,attentionCountList.push(ds)}),attentionCountList.sort(function(a,b){return a.time-b.time})}(),function(){$.each(categoryNames,function(i,name){durList.push({category:name,value:0})}),$.each(durValues,function(i,value){durList[i].value=value})}(),function(){seriesInfo1=[{id:"g0",valueAxis:"v0",valueField:"value",type:"column",title:i18n("span-duration"),fillAlphas:1,lineThickness:2,balloonText:"[[category]]: <b>[[value]]</b>"}],seriesInfo2=[{id:"g0",valueAxis:"v0",valueField:"avgDuration",type:"column",title:i18n("average-duration"),fillAlphas:1,lineThickness:2,balloonText:i18n("average-duration")+": <b>[[avgDuration]]s</b>"},{id:"g1",valueAxis:"v1",valueField:"eventNum",type:"smoothedLine",bullet:"round",bulletBorderThickness:1,hideBulletsCount:30,title:i18n("number-of-faces"),fillAlphas:0,lineThickness:2,balloonText:i18n("number-of-faces")+": <b>[[eventNum]]</b>"}]}(),function(){valueAxes1=[{axisColor:"chartCursor",axisThickness:2,axisAlpha:1,position:"left"}],valueAxes2=[{id:"v0",axisColor:"chartCursor",axisThickness:2,axisAlpha:1,position:"left",duration:"ss",durationUnits:{hh:"h ",mm:"m",ss:"s"}},{id:"v1",axisColor:"chartCursor",axisThickness:2,gridAlpha:0,axisAlpha:1,position:"right"}]}(),function(){data.selectedBarChartDataSource=durList,data.selectedBarChartGraphs=seriesInfo1,data.selectedBarChartValueAxes=valueAxes1,data.selectedLineChartDataSource=attentionCountList,data.selectedLineChartGraphs=seriesInfo2,data.selectedLineChartValueAxes=valueAxes2,data.selectedSitenameList=sitenameList,data.selectedTotalCount=totalCount}(),data}function setBarChartData(){return data.selectedBarChartDataSourceByTimeunit=data.selectedBarChartDataSource,data.selectedBarChartDataSource}function setLineChartData(){var timeunit=data.currentTimeunitForLineChart,dataSource=angular.copy(data.selectedLineChartDataSource),dataSourceByTimeunit=(reports.data.selectedSaveDataList.length,[]);return function(){var tmp={avgDuration:0,eventNum:0,totalDuration:0};if("hours"==timeunit){for(var start=moment(reports.data.dateRange.startDate),end=moment(reports.data.dateRange.endDate),countList=[],i=start;i<=end;i=moment(i).add(1,"hours")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].date=i.toDate(),countList[index].time=i.toDate()}$.each(dataSource,function(index,ds){var index=moment(ds.time).diff(start,"hours");countList[index]=ds}),dataSourceByTimeunit=countList}if("days"==timeunit){for(var start=moment(reports.data.dateRange.startDate),end=moment(reports.data.dateRange.endDate),countList=[],i=start;i<=end;i=moment(i).add(1,"days")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].date=i.toDate(),countList[index].time=i.toDate()}$.each(dataSource,function(i,ds){var index=moment(ds.time).diff(start,"days");countList[index].eventNum+=ds.eventNum,countList[index].totalDuration+=ds.totalDuration}),$.each(countList,function(key,ds){var index=moment(ds.time).diff(start,"days");countList[index].avgDuration=!isNaN(ds.eventNum)&&!isNaN(ds.totalDuration)&&ds.eventNum>0?Math.round(ds.totalDuration/ds.eventNum*100)/100:0}),dataSourceByTimeunit=countList}if("weeks"==timeunit){for(var weekStart=kupOpt.dateOfWeekStart,start=moment(reports.data.dateRange.startDate).isoWeekday(weekStart),end=moment(reports.data.dateRange.endDate).isoWeekday(weekStart),countList=[],i=start;i<=end;i=moment(i).add(1,"weeks")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].date=i.toDate(),countList[index].time=i.toDate()}$.each(dataSource,function(i,ds){var index=moment(ds.time).diff(start,"weeks");countList[index].eventNum+=ds.eventNum,countList[index].totalDuration+=ds.totalDuration}),$.each(countList,function(key,ds){var index=moment(ds.time).diff(start,"weeks");countList[index].avgDuration=!isNaN(ds.eventNum)&&!isNaN(ds.totalDuration)&&ds.eventNum>0?Math.round(ds.totalDuration/ds.eventNum*100)/100:0}),dataSourceByTimeunit=countList}if("months"==timeunit){for(var start=moment(reports.data.dateRange.startDate).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),end=moment(reports.data.dateRange.endDate).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),countList=[],i=start;i<=end;i=moment(i).add(1,"month")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].date=i.toDate(),countList[index].time=i.toDate()}$.each(dataSource,function(i,ds){var index=moment(ds.time).diff(start,"month");countList[index].eventNum+=ds.eventNum,countList[index].totalDuration+=ds.totalDuration}),$.each(countList,function(key,ds){var index=moment(ds.time).diff(start,"month");countList[index].avgDuration=!isNaN(ds.eventNum)&&!isNaN(ds.totalDuration)&&ds.eventNum>0?Math.round(ds.totalDuration/ds.eventNum*100)/100:0}),dataSourceByTimeunit=countList}if("years"==timeunit){for(var start=moment(reports.data.dateRange.startDate).month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),end=moment(reports.data.dateRange.endDate).month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),countList=[],i=start;i<=end;i=moment(i).add(1,"years")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].date=i.toDate(),countList[index].time=i.toDate()}$.each(dataSource,function(i,ds){var index=moment(ds.time).diff(start,"years");countList[index].eventNum+=ds.eventNum,countList[index].totalDuration+=ds.totalDuration}),$.each(countList,function(key,ds){var index=moment(ds.time).diff(start,"years");countList[index].avgDuration=!isNaN(ds.eventNum)&&!isNaN(ds.totalDuration)&&ds.eventNum>0?Math.round(ds.totalDuration/ds.eventNum*100)/100:0}),dataSourceByTimeunit=countList}}(),data.selectedLineChartDataSourceByTimeunit=dataSourceByTimeunit,dataSourceByTimeunit}function setBarChartOptions(){var chartOptions={dataProvider:angular.copy(data.selectedBarChartDataSourceByTimeunit),graphs:angular.copy(data.selectedBarChartGraphs),valueAxes:angular.copy(data.selectedBarChartValueAxes),type:"serial",theme:AuthTokenFactory.getTheme(),zoomOutText:i18n("show-all"),chartScrollbar:{autoGridCount:!0,graph:"g0",scrollbarHeight:40},chartCursor:{cursorPosition:"mouse"},categoryField:"category",categoryAxis:{firstDayOfWeek:kupOpt.dateOfWeekStart,gridAlpha:0,minorGridEnabled:!0,markPeriodChange:!0,boldLabels:!0,equalSpacing:!0,categoryFunction:function(date){return arguments[1].category},labelFunction:function(dateText){return dateText}},legend:{useGraphSettings:!1,valueWidth:0,valueFunction:function(){return""}}};return data.uiBarChart.options=chartOptions,chartOptions}function setBarChartForPdfOptions(){var chartOptions={dataProvider:angular.copy(data.selectedBarChartDataSourceByTimeunit),graphs:angular.copy(data.selectedBarChartGraphs),valueAxes:angular.copy(data.selectedBarChartValueAxes),type:"serial",theme:"white",chartCursor:{cursorPosition:"mouse"},categoryField:"category",categoryAxis:{firstDayOfWeek:kupOpt.dateOfWeekStart,gridAlpha:0,minorGridEnabled:!0,markPeriodChange:!0,boldLabels:!0,equalSpacing:!0,categoryFunction:function(date){return arguments[1].category},labelFunction:function(dateText){return dateText}},legend:{useGraphSettings:!1,valueWidth:0,valueFunction:function(){return""}}};return data.uiBarChartForPdf.options=chartOptions,chartOptions}function setLineChartOptions(){var chartSetting=function(){var setting={};return $.each(data.uiTimeunit,function(i,unit){if(unit.name===data.currentTimeunitForLineChart)return setting.minPeriod=unit.chartPeriod,!1}),setting}(),chartOptions={dataProvider:angular.copy(data.selectedLineChartDataSourceByTimeunit),graphs:angular.copy(data.selectedLineChartGraphs),valueAxes:angular.copy(data.selectedLineChartValueAxes),type:"serial",theme:AuthTokenFactory.getTheme(),zoomOutText:i18n("show-all"),chartScrollbar:{autoGridCount:!0,graph:"g0",scrollbarHeight:40},chartCursor:{cursorPosition:"mouse",categoryBalloonFunction:function(){var time=arguments[0];return setLineChartTimeunitLabel(time)}},categoryField:"time",categoryAxis:{firstDayOfWeek:kupOpt.dateOfWeekStart,gridAlpha:0,minorGridEnabled:!0,markPeriodChange:!0,boldLabels:!0,minPeriod:chartSetting.minPeriod,parseDates:!0,equalSpacing:!0,categoryFunction:function(date){return arguments[1].time},labelFunction:function(dateText){var time=arguments[1];switch(chartSetting.minPeriod){case"hh":dateText=moment(time).format(kupOpt["default"].formatAxisHourly);break;case"DD":dateText=moment(time).format(kupOpt["default"].formatAxisDaily);break;case"WW":dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatAxisWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatAxisWeekly);break;case"MM":dateText=moment(time).format(kupOpt["default"].formatAxisMonthly)}return dateText}},legend:{useGraphSettings:!1,valueWidth:0,valueFunction:function(){return""}}};return data.uiLineChart.options=chartOptions,chartOptions}function setLineChartForPdfOptions(){var chartSetting=function(){var setting={};return $.each(data.uiTimeunit,function(i,unit){if(unit.name===data.currentTimeunitForLineChart)return setting.minPeriod=unit.chartPeriod,!1}),setting}(),chartOptions={dataProvider:angular.copy(data.selectedLineChartDataSourceByTimeunit),graphs:angular.copy(data.selectedLineChartGraphs),valueAxes:angular.copy(data.selectedLineChartValueAxes),type:"serial",theme:"white",chartCursor:{cursorPosition:"mouse",categoryBalloonFunction:function(){var time=arguments[0];return setLineChartTimeunitLabel(time)}},categoryField:"time",categoryAxis:{firstDayOfWeek:kupOpt.dateOfWeekStart,gridAlpha:0,minorGridEnabled:!0,markPeriodChange:!0,boldLabels:!0,minPeriod:chartSetting.minPeriod,parseDates:!0,equalSpacing:!0,dateFormats:[{period:"fff",format:"JJ:NN:SS"},{period:"ss",format:"JJ:NN:SS"},{period:"mm",format:"JJ:NN"},{period:"hh",format:"JJ:NN"},{period:"DD",format:"MMM DD"},{period:"WW",format:"MMM DD"},{period:"MM",format:"MMM"},{period:"YYYY",format:"YYYY"}],categoryFunction:function(date){return arguments[1].time},labelFunction:function(dateText){var time=arguments[1];switch(chartSetting.minPeriod){case"hh":dateText=moment(time).format(kupOpt["default"].formatAxisHourly);break;case"DD":dateText=moment(time).format(kupOpt["default"].formatAxisDaily);break;case"WW":dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatAxisWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatAxisWeekly);break;case"MM":dateText=moment(time).format(kupOpt["default"].formatAxisMonthly)}return dateText}},legend:{useGraphSettings:!1,valueWidth:0,valueFunction:function(){return""}}};return data.uiLineChartForPdf.options=chartOptions,chartOptions}function getAnalyticsReportApi(isDefer){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,selectedDeviceList=reportsOpt.selectedDevices[0].platformDeviceId,fromDateUTC=(reportsOpt.selectedDevices[0].channelId,kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),data.timeFormat2)),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),data.timeFormat2),param={"event-type":vcaEventType,"device-id-list":JSON.stringify(selectedDeviceList),"channel-id":"",from:fromDateUTC,to:toDateUTC,parameters:JSON.stringify({})},onSuccess=function(response){opt.apiAnalyticsReportList=response.data||[]},onFail=function(response){opt.apiAnalyticsReportList=[]},onError=function(){opt.apiAnalyticsReportList=[]};return ajaxPost("getanalyticsreport",param,onSuccess,onFail,onError,isDefer)}function setLineChartTimeunitLabel(dateFormat){var dateText="",time=new Date(dateFormat),dateLang=(kupOpt.dateOfWeekStart,"en-us"),dateOpt={weekday:"short",month:"short",day:"numeric",year:"numeric"};return"hours"==data.currentTimeunitForLineChart&&(dateText=moment(time).format(kupOpt["default"].formatHourly)),"days"==data.currentTimeunitForLineChart&&(dateText=moment(time).format(kupOpt["default"].formatDaily)),"weeks"==data.currentTimeunitForLineChart&&(dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatWeekly)),"months"==data.currentTimeunitForLineChart&&(dateText=moment(time).format(kupOpt["default"].formatAxisMonthly)),"years"==data.currentTimeunitForLineChart&&(dateOpt={year:"numeric"},dateText=time.toLocaleDateString(dateLang,dateOpt)),dateText}function setChartTheme(){var theme=AuthTokenFactory.getTheme();window.AmCharts.themes[theme]=AmchartsTheme[theme]}function exportAggregatedCsvReportApi(periodType){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,fromDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),opt.timeFormat2),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),opt.timeFormat2),baseUnit=periodType,selectedGroups=[],type=(AuthTokenFactory.getApiRootUrl(),"");$.each(reportsOpt.selectedItemDataList,function(uid,itemData){var devices=[];if($.isEmptyObject(itemData))return!0;if(itemData.isAll||itemData.isLabel){var device=itemData.items||[];$.each(device,function(i,deviceData){var camera=deviceData.items||[];$.each(camera,function(j,cameraData){devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId})})}),type="labels"}else if(itemData.isDevice){var camera=itemData.items||[];$.each(camera,function(i,cameraData){devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId})}),type="devices"}else if(itemData.isCamera){if(itemData.hasChildren)return;var cameraData=itemData;devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId}),type="devices"}!function(){var groupname="";(itemData.isLabel||itemData.isAll)&&(groupname=itemData.labelName),itemData.isDevice&&(groupname=itemData.labelName+" - "+itemData.text),itemData.isCamera&&(groupname=itemData.labelName+" - "+itemData.deviceName+" - "+itemData.text),selectedGroups.push({groupName:groupname,devicePairs:devices,type:type})}()});var param={"event-type":vcaEventType,"selected-groups":JSON.stringify(selectedGroups),"time-zone-offset":KupApiService.data.timeZoneOffset,from:fromDateUTC,to:toDateUTC,"base-unit":baseUnit};return KupApiService.exportDoc(param,"exportaggregatedcsvreport")}function exportVcaSecurityPdfApi(){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,lineSvgTitle="<svg version='1.1' width='900' height='30'><text y='15' x='0' transform='translate(450)' text-anchor='middle' font-size='20' font-weight='bold'>"+i18n("attention-span-variation-over-time")+"</text></svg>",lineChartOpt=setLineChartForPdfOptions(),barSvgTitle=(window.AmCharts.makeChart(opt.$lineChartForPdf.slice(1),lineChartOpt),"<svg version='1.1' width='900' height='30'><text y='15' x='0' transform='translate(450)' text-anchor='middle' font-size='20' font-weight='bold'>"+i18n("visitor-segmentation-by-attention-span")+"</text></svg>"),barChartOpt=setBarChartForPdfOptions(),svgData=(window.AmCharts.makeChart(opt.$barChartForPdf.slice(1),barChartOpt),function(){var svgData=[];return"chart"==opt.currentTab&&(svgData.push(barSvgTitle),$.each($(opt.$barChartForPdf).find("svg"),function(i,el){svgData.push("<svg version='1.1' width='"+$(el).css("width")+"' height='"+$(el).css("height")+"'>"+$(el).html()+"</svg>")}),svgData.push(lineSvgTitle),$.each($(opt.$lineChartForPdf).find("svg"),function(i,el){svgData.push("<svg version='1.1' width='"+$(el).css("width")+"' height='"+$(el).css("height")+"'>"+$(el).html()+"</svg>")})),svgData}()),reportInfo={"event-type":vcaEventType,"site-name":opt.selectedSitenameList.toString(),from:kendo.toString(reportsOpt.dateRange.startDate,opt.timeFormat1),to:kendo.toString(reportsOpt.dateRange.endDate,opt.timeFormat1),"total-results":opt.selectedTotalCount+""},param={"time-zone-offset":KupApiService.data.timeZoneOffset,"svg-string":svgData.join(""),"report-info":JSON.stringify(reportInfo)};return KupApiService.exportDoc(param,"exportvcasecuritypdf")}function generateBarChart(){setChartTheme(),setBarChartData(),setBarChartOptions()}function generateLineChart(){setChartTheme(),setLineChartData(),setLineChartOptions()}function generateReport(){setInitData();var opt=data;if($.each(opt.requestForReport,function(i,request){request.cancel&&request.cancel()}),!reports.isSelectCamera())return notification("error",i18n("no-channel-selected")),reports.isSuccessReport(!1),!1;opt.requestForReport=[getAnalyticsReportApi(!0)];var dfd=$q.defer();return $timeout(function(){$q.all(opt.requestForReport)["finally"](function(){return setChartData(),opt.apiAnalyticsReportList.length<=0?(reports.isSuccessReport(!1),void dfd.reject()):opt.selectedLineChartDataSource.length<=0?(reports.isSuccessReport(!1),void dfd.reject()):(reports.isSuccessReport(!0),generateBarChart(),generateLineChart(),void dfd.resolve())})},500),dfd.promise}var kupOpt=KupOption,utils=UtilsService,i18n=UtilsService.i18n,notification=UtilsService.notification,ajaxPost=KupApiService.ajaxPost,reports=ReportsService,data={timeFormat0:"yyyy/MM/dd HH:mm:ss",timeFormat1:"dd/MM/yyyy HH:mm:ss",timeFormat2:"ddMMyyyyHHmmss",selectedTotalCount:0,selectedSitenameList:[],selectedBarChartDataSource:[],selectedBarChartDataSourceByTimeunit:[],selectedBarChartValueAxes:[],selectedBarChartGraphs:[],selectedLineChartDataSource:[],selectedLineChartDataSourceByTimeunit:[],selectedLineChartValueAxes:[],selectedLineChartGraphs:[],apiAnalyticsReportList:[],currentTab:"chart",currentTimeunitForLineChart:"hours",requestForReport:[],$barChart:"#attentionBarChart",$barChartForPdf:"#attentionBarChartForPdf",$lineChart:"#attentionLineChart",$lineChartForPdf:"#attentionLineChartForPdf",uiTab:[{name:"chart",text:"charts",isActive:!0}],uiTimeunit:[{name:"hours",text:"hourly",isActiveForLineChart:!0,isShowForLineChart:!0,chartPeriod:"hh"},{name:"days",text:"daily",isActiveForLineChart:!1,isShowForLineChart:!0,chartPeriod:"DD"},{name:"weeks",text:"weekly",isActiveForLineChart:!1,isShowForLineChart:!0,chartPeriod:"WW"},{name:"months",text:"monthly",isActiveForLineChart:!1,isShowForLineChart:!0,chartPeriod:"MM"},{name:"years",text:"yearly",isActiveForLineChart:!1,isShowForLineChart:!1,chartPeriod:"YYYY"}],uiExport:{isOpen:!1},uiNodata:{isShow:!0},uiLineChart:{options:{}},uiBarChart:{options:{}},uiLineChartForPdf:{width:"900px",height:"400px",options:{}},uiBarChartForPdf:{width:"900px",height:"400px",options:{}}};return{data:data,setInitData:setInitData,setInitTab:setInitTab,setInitTimeunit:setInitTimeunit,setChartTheme:setChartTheme,setChartData:setChartData,setBarChartData:setBarChartData,setBarChartOptions:setBarChartOptions,setBarChartForPdfOptions:setBarChartForPdfOptions,setLineChartData:setLineChartData,setLineChartOptions:setLineChartOptions,setLineChartTimeunitLabel:setLineChartTimeunitLabel,setLineChartForPdfOptions:setLineChartForPdfOptions,getAnalyticsReportApi:getAnalyticsReportApi,exportAggregatedCsvReportApi:exportAggregatedCsvReportApi,exportVcaSecurityPdfApi:exportVcaSecurityPdfApi,generateReport:generateReport,generateBarChart:generateBarChart,generateLineChart:generateLineChart}}]),angular.module("kai.reports.attention").controller("AttentionController",["KupOption","RouterStateService","UtilsService","PromiseFactory","AuthTokenFactory","ReportsService","AttentionService","$scope","$timeout","$q",function(KupOption,RouterStateService,UtilsService,PromiseFactory,AuthTokenFactory,ReportsService,AttentionService,$scope,$timeout,$q){function init(){setWatch()}function setWatch(){$scope.$watch(function(){return angular.toJson(reports.data)},function(newVal,oldVal){var reportsOpt=angular.fromJson(newVal);attentionCtrl.data.uiNodata.isShow=!reportsOpt.isSuccessReport},!0),$scope.$watch(function(){return AuthTokenFactory.getTheme()},function(newVal,oldVal){return newVal!=oldVal&&(AttentionService.setChartTheme(),AttentionService.generateLineChart(),void AttentionService.generateBarChart())},!0)}function setTab(tabName){var opt=attentionCtrl.data,tabData=opt.uiTab;$.each(tabData,function(i,data){data.isActive=tabName===data.name}),opt.currentTab=tabName}function setTimeunitForLineChart(unitName){var opt=attentionCtrl.data,timeunitData=opt.uiTimeunit;$.each(timeunitData,function(i,data){data.isActiveForLineChart=unitName===data.name}),opt.currentTimeunitForLineChart=unitName,AttentionService.generateLineChart()}function exportCsv(periodType){if(!reports.isSuccessReport())return notification("error",i18n("please-generate-reports")),!1;var warningNotify=notification("warning",i18n("exporting-to-csv"),0);AttentionService.exportAggregatedCsvReportApi(periodType)["finally"](function(){warningNotify.close()})}function exportPdf(){if(!reports.isSuccessReport())return notification("error",i18n("please-generate-reports")),!1;var warningNotify=notification("warning",i18n("exporting-to-pdf"),0);AttentionService.exportVcaSecurityPdfApi()["finally"](function(){warningNotify.close()})}var i18n=UtilsService.i18n,notification=UtilsService.notification,reports=ReportsService,attentionCtrl=this;attentionCtrl.data=AttentionService.data,attentionCtrl.fn={setTab:setTab,setTimeunitForLineChart:setTimeunitForLineChart,exportPdf:exportPdf,exportCsv:exportCsv},init()}]);