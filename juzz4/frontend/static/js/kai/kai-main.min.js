angular.module("kai.main",[]),angular.module("kai.main"),angular.module("kai.main").service("AlertsNotificationService",["KupApiService","KupOption","AuthTokenFactory","poller",function(KupApiService,KupOption,AuthTokenFactory,poller){this.initAlertsNotificationSerice=function(){var apiUrl=KupOption.sysApiRootUrl+"/api/"+AuthTokenFactory.getBucket(),params=$.param({"session-key":AuthTokenFactory.getSessionKey()});return poller.get(apiUrl+"/recvcometnotification",{action:"post",argumentsArray:[params,{headers:{Accept:"*/*","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"}}],smart:!0,catchError:!0})}}]),angular.module("kai.main").factory("HeaderService",["AuthTokenFactory",function(AuthTokenFactory){function getUserRoles(){return AuthTokenFactory.getUserRole()}function getUserName(){return AuthTokenFactory.getUserProfile().userName}var data={};return data.isDropdownOpen={notification:!1,settings:!1,userState:!1},{data:data,getUserRoles:getUserRoles,getUserName:getUserName}}]),angular.module("kai.main").factory("MainService",["KupOption","UtilsService","KupApiService","$animate","$timeout",function(KupOption,UtilsService,KupApiService,$animate,$timeout){function showMainMenu(checkState){var opt=data;void 0===checkState?($(".sidebar-sub").toggleClass("sidebar-sub-animation"),opt.navbar.isIconLeftArrow=!opt.navbar.isIconLeftArrow):(checkState?$(".sidebar-sub").removeClass("sidebar-sub-animation"):$(".sidebar-sub").addClass("sidebar-sub-animation"),opt.navbar.isIconLeftArrow=checkState)}function getPlatformInformationApi(){var opt=data,param={},onSuccess=function(response){opt.apiPlatformInformation=response.info||{}},onFail=function(response){opt.apiPlatformInformation={}},onError=function(){opt.apiPlatformInformation={}};return ajaxPost("getplatforminformation",param,onSuccess,onFail,onError)}var ajaxPost=(UtilsService.i18n,UtilsService.notification,KupApiService.ajaxPost),data={};return data.header={},data.header.wrapperToggledMaxWidth=960,data.header.isWrapperToggled=$(window).width()<data.header.wrapperToggledMaxWidth,data.navbar={isShow:!0,isIconLeftArrow:!1,menu:{isShow:{},isOpen:{}}},data.block={options:{},promise:null},data.apiPlatformInformation={},{data:data,showMainMenu:showMainMenu,getPlatformInformationApi:getPlatformInformationApi}}]),angular.module("kai.main").controller("confirmGoAdminSetting",["$scope","data","$uibModalInstance","$window",function($scope,data,$uibModalInstance,$window){$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.yes=function(){$window.open(data.link,"_blank"),$scope.cancel()}}]),angular.module("kai.main").controller("HeaderController",["_","KupOption","UserService","HeaderService","SoundManagerService","UtilsService","AlertsNotificationService","$log","$window","$scope","AuthTokenFactory","$uibModal","$state",function(_,KupOption,UserService,HeaderService,SoundManagerService,UtilsService,AlertsNotificationService,$log,$window,$scope,AuthTokenFactory,$uibModal,$state){function convertUTCToLocal(time){var d=new Date,dateObj=$window.moment(time,"DD/MM/YYYY HH:mm:ss").toDate();return dateObj.setMinutes(dateObj.getMinutes()-d.getTimezoneOffset()),$window.moment(dateObj).format("DD/MM/YYYY HH:mm:ss")}function confirmGoAdminSetting(){var data={link:KupOption.sysApiRootUrl};$uibModal.open({animation:!0,templateUrl:"confirmGoAdminSetting.html",controller:"confirmGoAdminSetting",windowClass:"modal kupModal",resolve:{data:function(){return data}}})}function logout(){UserService.logout()["finally"](function(){window.location="/"})}var headerCtrl=this,i18n=UtilsService.i18n;headerCtrl.data=HeaderService.data,headerCtrl.count=$window.notification_count=0,headerCtrl.events=[],headerCtrl.fn={logout:logout,confirmGoAdminSetting:confirmGoAdminSetting};var eventTypeClasses={};eventTypeClasses["event-vca-intrusion"]="IntrusionDetection",eventTypeClasses["event-vca-perimeter"]="PerimeterDefense",eventTypeClasses["event-vca-loitering"]="LoiteringDetection",eventTypeClasses["event-vca-object-counting"]="TripWireCounting",eventTypeClasses["event-vca-video-blur"]="CameraTampering",headerCtrl.userInfo=function(){$scope.$watch(function(){return angular.toJson(AuthTokenFactory.data)},function(newVal,oldVal){headerCtrl.multipleRoles="",headerCtrl.userName=HeaderService.getUserName(),headerCtrl.roleDisplayText=HeaderService.getUserRoles()},!0)},headerCtrl.userInfo(),headerCtrl.getEventClass=function(event){var eventCSSClass=eventTypeClasses[event.typeKey];return eventCSSClass},headerCtrl.adjustAlertTime=function(){angular.forEach(headerCtrl.events,function(event){var differentObject=headerCtrl.getDateDifference(new Date,$window.moment(event.eventLocalTime,"DD/MM/YYYY HH:mm:ss").toDate()),displayTime="";displayTime=differentObject.days>0?differentObject.days+" "+i18n("day(s)-ago"):differentObject.hours>0?differentObject.hours+" "+i18n("hour(s)-ago"):differentObject.minutes>0?differentObject.minutes+" "+i18n("minute(s)-ago"):differentObject.seconds+" "+i18n("second(s)-ago"),event.eventDisplayTime=displayTime})},headerCtrl.cleanCount=function(){headerCtrl.showCount=0,headerCtrl.count=0,headerCtrl.events=[],$state.go("main.notification")},headerCtrl.getDateDifference=function(date1,date2){var date1Millis=date1.getTime(),date2Millis=date2.getTime(),differenceObject={},differenceMillis=date2Millis>date1Millis?date2Millis-date1Millis:date1Millis-date2Millis;return differenceObject.days=Math.floor(differenceMillis/36e5/24),differenceObject.hours=Math.floor(differenceMillis/36e5%24),differenceObject.minutes=Math.floor(differenceMillis/6e4%60),differenceObject.seconds=Math.floor(differenceMillis/1e3%24),differenceObject},headerCtrl.showCount="";var alertsNotificationPoller=AlertsNotificationService.initAlertsNotificationSerice();alertsNotificationPoller.promise.then(null,null,function(result){if(200===result.status){if("ok"==result.data.result&&null!=result.data.event){var eventObj=angular.fromJson(result.data.event),eventLocalTime=convertUTCToLocal(eventObj.time),newEvent={};newEvent.type=i18n(eventObj.type),newEvent.typeKey=eventObj.type,newEvent.deviceName=eventObj.deviceName,newEvent.eventTime=$window.moment(eventLocalTime,"DD/MM/YYYY HH:mm:ss").toDate(),newEvent.eventLocalTime=eventLocalTime,newEvent.deviceId=eventObj.deviceId,newEvent.eventId=eventObj.id,newEvent.eventDisplayTime="",headerCtrl.count>2&&headerCtrl.events.shift(),headerCtrl.count++,headerCtrl.showCount=headerCtrl.count>99?"99+":headerCtrl.count,headerCtrl.events.push(newEvent),headerCtrl.playSound()}}else $log.log("failure of notification "+result),503===result.status&&alertsNotificationPoller.stopAll()}),headerCtrl.playSound=function(){headerCtrl.soundOpen&&SoundManagerService.play()},headerCtrl.soundOpen=!0,headerCtrl.soundStatusMsg="notification-sound-on-label",headerCtrl.toggleNotificationSound=function(event){headerCtrl.soundOpen=!headerCtrl.soundOpen,headerCtrl.soundStatusMsg=headerCtrl.soundOpen?"notification-sound-on-label":"notification-sound-off-label",event.stopPropagation()},headerCtrl.getSoundOnOffClass=function(){return headerCtrl.soundOpen?"soundOn":"soundOff"},headerCtrl.getVolumnOnOffClass=function(){return headerCtrl.soundOpen?"fa-volume-up":"fa-volume-off"}}]),angular.module("kai.main").controller("MainCtrl",["KupOption","AuthTokenFactory","RouterStateService","UserService","UtilsService","PromiseFactory","KupApiService","MainService","NotificationService","$scope","$timeout","$uibModal",function(KupOption,AuthTokenFactory,RouterStateService,UserService,UtilsService,PromiseFactory,KupApiService,MainService,NotificationService,$scope,$timeout,$uibModal){function init(){$scope.$watch(function(){return angular.toJson(AuthTokenFactory.data)},function(newVal,oldVal){var authToken=angular.fromJson(newVal);authToken.bucket&&authToken["session-key"]||(window.location="#/login")},!0),$scope.$watch(function(){return angular.toJson(RouterStateService.getRouterState())},function(newVal,oldVal){var routerNameNew=angular.fromJson(newVal).toState.name,routerNameOld=angular.fromJson(oldVal).toState.name;$(".cg-busy").addClass("ng-hide"),function(){routerNameNew===routerNameOld?initLoadPage():KupApiService.ajaxCancel()}()},!0),$scope.$watch("mainCtrl.block.promise",function(newVal,oldVal){newVal&&(mainCtrl.block.options=UtilsService.blockPage(newVal),mainCtrl.block.promise=null)},!0)}function initLoadPage(){MainService.getPlatformInformationApi(),UserService.setUserFeature()["finally"](function(){mainCtrl.navbar.menu.isShow=getMenuStatus().showData,mainCtrl.navbar.menu.isOpen=getMenuStatus().openData}),UserService.setUserTheme()["finally"](function(){indexCtrl.currentTheme=AuthTokenFactory.getTheme()}),UserService.setUserProfile()["finally"](function(){indexCtrl.currentLanguage=AuthTokenFactory.getUserLanguage()})}function openMenu(openMenuName){var openMenuInfo=mainCtrl.navbar.menu.isOpen;$.each(openMenuInfo,function(menuName,value){openMenuName===menuName?mainCtrl.navbar.menu.isOpen[menuName]=!mainCtrl.navbar.menu.isOpen[menuName]:mainCtrl.navbar.menu.isOpen[menuName]=!1})}function getMenuStatus(){var userFeature=UserService.getUserFeature(),menu={showData:{},openData:{}};return $.each(userFeature,function(i,featureData){menu.showData[featureData.type]||(menu.showData[featureData.type]=!0,menu.openData[featureData.type]=!1),menu.showData[featureData.name]=!0}),menu}function toggleSideBar(callback){var headerOpt=mainCtrl.header;$("#kupWrapper").toggleClass("toggled",400),headerOpt.isWrapperToggled=$("#kupWrapper").hasClass("toggled"),setTimeout(function(){callback&&callback()},400)}function viewNotificationDetail(event){var pageParam={skip:0,take:50};NotificationService.getUserDevicesApi().then(function(){NotificationService.getAlertsApi(pageParam).then(function(response){var alerts=NotificationService.setTableData();angular.forEach(alerts,function(value,key){value.eventId==event.eventId&&(event.detail=value)}),angular.forEach(response.data.alerts,function(value,key){value.eventId==event.eventId&&(event.eventVideoUrl=value.eventVideoUrl)})})}),$uibModal.open({animation:!0,templateUrl:"viewNotificationDetail.html",controller:"viewNotificationDetailCtrl",windowClass:"modal kupModal",resolve:{event:function(){return{data:event}}}})}var indexCtrl=(UtilsService.i18n,UtilsService.block,UtilsService.notification,$scope.$parent.indexCtrl),mainCtrl=this;mainCtrl.data=MainService.data,mainCtrl.fn={openMenu:openMenu,showMainMenu:MainService.showMainMenu,toggleSideBar:toggleSideBar,viewNotificationDetail:viewNotificationDetail},mainCtrl.header=MainService.data.header,mainCtrl.navbar=MainService.data.navbar,mainCtrl.bucket=AuthTokenFactory.getBucket(),mainCtrl.block=MainService.data.block,init()}]),angular.module("kai.main").controller("viewNotificationDetailCtrl",["$scope","$uibModalInstance","event","NotificationService","KupOption","AuthTokenFactory","$timeout","UtilsService",function($scope,$uibModalInstance,event,NotificationService,KupOption,AuthTokenFactory,$timeout,UtilsService){$scope.event=event.data,$scope.close=function(){$uibModalInstance.dismiss("cancel")},$scope.getEventInfoByType=function(eventType){return NotificationService.getEventInfoByType(eventType)},$timeout(function(){window.jwplayer&&(window.jwplayer.key=KupOption.jwplayerKey);var url=$scope.event.eventVideoUrl,videoUrl=KupOption.sysApiRootUrl+url,playLink=videoUrl+"?action=play&session-key="+AuthTokenFactory.getSessionKey();url&&window.jwplayer("kupPlayer").setup({file:playLink,width:"100%",height:"100%",autostart:!1,mute:!0,flashplayer:KupOption.jwplayerFlashPlayerUrl,html5player:KupOption.jwplayerHtml5PlayerUrl})},1e3)}]);