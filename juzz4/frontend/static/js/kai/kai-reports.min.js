angular.module("kai.reports",["kendo.directives"]),angular.module("kai.reports").factory("ReportsService",["KupOption","UtilsService","PromiseFactory","AuthTokenFactory","KupApiService","DeviceTreeService","$http",function(KupOption,UtilsService,PromiseFactory,AuthTokenFactory,KupApiService,DeviceTreeService,$http){function getSelectedItemsLength(){var opt=data,count=0,selectedItemDataList=opt.selectedItemDataList;return $.each(selectedItemDataList,function(uid,itemData){return!!$.isEmptyObject(itemData)||void count++}),count}function getDeviceTreeData(){return DeviceTreeService.initDeviceTree()["finally"](function(){setDeviceTreeData()})}function setDeviceTreeData(){var opt=data,treeItems=DeviceTreeService.getDeviceTree();opt.deviceTreeData=function(){var tree=angular.copy(treeItems),treeList=[];return $.each(tree,function(i,label){var deviceData=label.items;$.each(deviceData,function(j,device){device.isNode||(device.items=[])}),treeList.push(label)}),treeList}()}function setSelectedInstance(){var opt=data,selectedItemDataList=opt.selectedItemDataList;return opt.selectedInstance=[],$.each(selectedItemDataList,function(uid,itemData){if($.isEmptyObject(itemData))return!0;if(itemData.isAll||itemData.isLabel){var device=itemData.items||[];$.each(device,function(i,deviceData){var camera=deviceData.items||[];$.each(camera,function(j,cameraData){opt.selectedInstance.push(cameraData.data)})})}else if(itemData.isDevice){var camera=itemData.items||[];$.each(camera,function(i,cameraData){opt.selectedInstance.push(cameraData.data)})}else if(itemData.isCamera){if(itemData.hasChildren)return;var cameraData=itemData;opt.selectedInstance.push(cameraData.data)}}),opt.selectedInstance}function setSelectedDevices(){var opt=data;return opt.selectedDevices=[],$.each(opt.selectedItemDataList,function(uid,itemData){var groupname=$('span[data-uid="'+uid+'"]').text()||"",devices=[],type="";if($.isEmptyObject(itemData))return!0;if(itemData.isAll||itemData.isLabel){var device=itemData.items||[];$.each(device,function(i,deviceData){var camera=deviceData.items||[];$.each(camera,function(j,cameraData){devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId})})}),type="labels"}else if(itemData.isDevice){var camera=itemData.items||[];$.each(camera,function(i,cameraData){devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId})}),type="devices"}else if(itemData.isCamera){if(itemData.hasChildren)return;var cameraData=itemData;devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId}),type="devices"}opt.selectedDevices.push({groupName:groupname,devicePairs:devices,type:type})}),opt.selectedDevices}function setSelectedSaveDataList(){var opt=data,selectedItemDataList=opt.selectedItemDataList;return opt.selectedSaveDataList=[],$.each(selectedItemDataList,function(uid,itemData){if($.isEmptyObject(itemData))return!0;if(itemData.isAll||itemData.isLabel)opt.selectedSaveDataList.push({label:itemData.labelName,deviceId:null,channelId:null});else if(itemData.isDevice)opt.selectedSaveDataList.push({label:itemData.labelName,deviceId:itemData.deviceId,channelId:null});else if(itemData.isCamera){if(itemData.hasChildren)return;opt.selectedSaveDataList.push({label:itemData.labelName,deviceId:itemData.deviceId,channelId:itemData.cameraId})}}),opt.selectedSaveDataList}function setSelectedGroupNames(){var opt=data,selectedItemDataList=opt.selectedItemDataList,groupNames=[];return $.each(selectedItemDataList,function(uid,itemData){return!!$.isEmptyObject(itemData)||(!itemData.isLabel||void groupNames.push(itemData.text))}),opt.selectedGroupNames=groupNames,opt.selectedGroupNames}function setListPosNamesApi(onSuccess,onFail,onError){var param={"session-key":AuthTokenFactory.getSessionKey(),"parser-type":""};return ajaxPost("listposnames",param,onSuccess,onFail,onError)}function setListRunningAnalyticsApi(onSuccess,onFail,onError){var analyticsType=kupOpt.vca[data.reportType].analyticsType,param={"session-key":AuthTokenFactory.getSessionKey(),"analytics-type":analyticsType};return ajaxPost("listrunninganalytics",param,onSuccess,onFail,onError)}function setSaveReportQueryHistoryApi(onSuccess,onFail,onError){var opt=data,vcaEventType=kupOpt.vca[data.reportType].eventType,param={"session-key":AuthTokenFactory.getSessionKey(),"event-type":vcaEventType,"date-from":kendo.toString(utils.convertToUTC(opt.dateRange.startDate),opt.dateFormat),"date-to":kendo.toString(utils.convertToUTC(opt.dateRange.endDate),opt.dateFormat),"device-selected":JSON.stringify(opt.selectedSaveDataList)};return ajaxPost("savereportqueryhistory",param,onSuccess,onFail,onError)}function setGetReportQueryHistoryApi(onSuccess,onFail,onError){var vcaEventType=kupOpt.vca[data.reportType].eventType,param={"session-key":AuthTokenFactory.getSessionKey(),"event-type":vcaEventType};return ajaxPost("getreportqueryhistory",param,onSuccess,onFail,onError)}function setDefaultItemDataList(){var opt=data,itemDataQuery=opt.apiQueryHistoryData.deviceSelected||[],itemData=$(opt.$treeview).data("kendoTreeView").dataSource.data()||[];return opt.defaultItemDataList={},$.each(itemDataQuery,function(i,queryData){""!==queryData.label&&""!==queryData.deviceId&&""!==queryData.channelId?$.each(itemData,function(j,labelData){if(labelData.labelName===queryData.label)return $.each(labelData.items,function(k,deviceData){if(deviceData.deviceId===parseInt(queryData.deviceId,10)){var uid="";return $.each(deviceData.items,function(l,cameraData){if(cameraData.cameraId===parseInt(queryData.channelId,10))return uid=cameraData.uid,opt.defaultItemDataList[uid]=cameraData,!1}),!1}}),!1}):""!==queryData.deviceId?$.each(itemData,function(j,labelData){if(labelData.labelName===queryData.label)return $.each(labelData.items,function(k,deviceData){if(deviceData.deviceId===parseInt(queryData.deviceId,10)){var uid=deviceData.uid;return opt.defaultItemDataList[uid]=deviceData,!1}}),!1}):$.each(itemData,function(j,labelData){if(labelData.labelName===queryData.label){var uid=labelData.uid;return opt.defaultItemDataList[uid]=labelData,!1}})}),opt.defaultItemDataList}function setDefaultDateRange(){var opt=data,apiQueryHistoryData=opt.apiQueryHistoryData,startDateForDefaultRange=new Date(moment().subtract(opt.dateRange.days-1,"days").format("YYYY/MM/DD 00:00:00")),endDateForDefaultRange=new Date(moment().format("YYYY/MM/DD 23:59:59"));return opt.defaultDateRange.startDate=function(){var startDate=kendo.parseDate(apiQueryHistoryData.dateFrom||"",opt.dateFormat),startDateToLocal=startDate?utils.convertUTCtoLocal(startDate):startDateForDefaultRange;return startDateToLocal}(),opt.defaultDateRange.endDate=function(){var endDate=kendo.parseDate(apiQueryHistoryData.dateTo||"",opt.dateFormat),endDateToLocal=endDate?utils.convertUTCtoLocal(endDate):endDateForDefaultRange;return endDateToLocal}(),opt.defaultDateRange}function initListPosNamesApi(){var opt=data,onSuccess=function(response){var names=response.names||[];$.each(names,function(i,obj){opt.apiPosNamesList.push(obj.name)})},onFail=function(response){},onError=function(){};return setListPosNamesApi(onSuccess,onFail,onError)}function initListRunningAnalyticsApi(){var opt=data,onSuccess=function(response){opt.apiRunningAnalyticsList=response.instances||[]},onFail=function(response){},onError=function(){};return setListRunningAnalyticsApi(onSuccess,onFail,onError)}function initSaveReportQueryHistoryApi(){var onSuccess=function(response){},onFail=function(response){},onError=function(){};return setSaveReportQueryHistoryApi(onSuccess,onFail,onError)}function initGetReportQueryHistoryApi(){var opt=data,onSuccess=function(response){opt.apiQueryHistoryData=response.query||{}},onFail=function(response){},onError=function(){};return setGetReportQueryHistoryApi(onSuccess,onFail,onError)}function execSaveReportQueryHistoryApi(){var onSuccess=function(response){},onFail=function(response){},onError=function(){};return setSaveReportQueryHistoryApi(onSuccess,onFail,onError)}function execGetReportQueryHistoryApi(){var opt=data,onSuccess=function(response){opt.apiQueryHistoryData=response.query||{},setDefaultItemDataList(),setDefaultDateRange()},onFail=function(response){},onError=function(){};return setGetReportQueryHistoryApi(onSuccess,onFail,onError)}function isSelectCamera(){var opt=data,selectedDeviceList=opt.selectedDevices,selectedChannelList=opt.selectedDevices,check=!0;return selectedDeviceList.length<=0&&selectedChannelList.length<=0&&(check=!1),check}function isSuccessReport(isSuccess){var opt=data,check=opt.isSuccessReport=void 0===isSuccess?opt.isSuccessReport:isSuccess;return check}function isSingleCamera(){var opt=data,check=!1;return 1===opt.selectedInstance.length&&(check=!0),check}function isSelectItem(){var opt=data,check=!1;return $.each(opt.selectedItemDataList,function(uid,dataList){if(!$.isEmptyObject(dataList))return check=!0,!1}),check}function isUpdateSelectedItem(){var opt=data;return opt.isUpdateSelectedItem}function isShowNoDataGuide(){var opt=data;return opt.isDoneReport&&isSelectItem()}var kupOpt=KupOption,utils=UtilsService,i18n=UtilsService.i18n,ajaxPost=(UtilsService.notification,KupApiService.ajaxPost),data={$section:"#reportsSection",$treeview:"#reportsTreeview",$search:"#reportsSearch",$dragTarget:"#reportsDragTarget",$dropHere:"#reportsDropHere",$daterange:"#kupDaterange",$applyBtn:"#applyBtn",$cancelBtn:"#cancelBtn",reportType:"",isSuccessDrag:!1,isDoneReport:!0,isSuccessReport:!1,isDefaultDropData:!1,isUpdateSelectedItem:!1,dateFormat:"ddMMyyyyHHmmss",dateRange:{days:7,startDate:"",endDate:""},defaultItemDataList:{},defaultDateRange:{startDate:"",endDate:""},draggedItemDataList:{},selectedItemDataList:{},selectedSaveDataList:[],selectedGroupNames:[],selectedInstance:[],selectedDevices:[],apiPosNamesList:[],apiRunningAnalyticsList:[],apiQueryHistoryData:{},deviceTreeData:[],uiDateRangesList:[{name:i18n("today"),data:[moment(),moment()]},{name:i18n("yesterday"),data:[moment().subtract(1,"days"),moment().subtract(1,"days")]},{name:i18n("last-7-days"),data:[moment().subtract(6,"days"),moment()]},{name:i18n("last-30-days"),data:[moment().subtract(29,"days"),moment()]},{name:i18n("this-month"),data:[moment().startOf("month"),moment().endOf("month")]},{name:i18n("last-month"),data:[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]}]},menuData={isShow:!0},searchData={value:""},optionsData={isOpen:!1,isOnlyShowVca:!0};return{data:data,menuData:menuData,searchData:searchData,optionsData:optionsData,setDeviceTreeData:setDeviceTreeData,setSelectedInstance:setSelectedInstance,setSelectedDevices:setSelectedDevices,setSelectedSaveDataList:setSelectedSaveDataList,setSelectedGroupNames:setSelectedGroupNames,setDefaultItemDataList:setDefaultItemDataList,setDefaultDateRange:setDefaultDateRange,getDeviceTreeData:getDeviceTreeData,getSelectedItemsLength:getSelectedItemsLength,setListPosNamesApi:setListPosNamesApi,setListRunningAnalyticsApi:setListRunningAnalyticsApi,setSaveReportQueryHistoryApi:setSaveReportQueryHistoryApi,setGetReportQueryHistoryApi:setGetReportQueryHistoryApi,initListPosNamesApi:initListPosNamesApi,initListRunningAnalyticsApi:initListRunningAnalyticsApi,initSaveReportQueryHistoryApi:initSaveReportQueryHistoryApi,initGetReportQueryHistoryApi:initGetReportQueryHistoryApi,execSaveReportQueryHistoryApi:execSaveReportQueryHistoryApi,execGetReportQueryHistoryApi:execGetReportQueryHistoryApi,isSelectCamera:isSelectCamera,isSuccessReport:isSuccessReport,isSingleCamera:isSingleCamera,isSelectItem:isSelectItem,isUpdateSelectedItem:isUpdateSelectedItem,isShowNoDataGuide:isShowNoDataGuide}}]),angular.module("kai.reports").controller("ReportsController",["KupOption","RouterStateService","ReportsService","UtilsService","PromiseFactory","MainService","DeviceTreeService","AuthTokenFactory","$scope","$timeout","$q","$location","$animate",function(KupOption,RouterStateService,ReportsService,UtilsService,PromiseFactory,MainService,DeviceTreeService,AuthTokenFactory,$scope,$timeout,$q,$location,$animate){function init(){$scope.$watch(function(){return angular.toJson(RouterStateService.getRouterState())},function(newValue,oldValue){var routerState=angular.fromJson(newValue).toState,routerCheck=/\.reports/.test(routerState.name),reportType=routerCheck?/\.reports\.(\S*)/.exec(routerState.name)[1]:"";return!!routerCheck&&(initOpt(),reportsCtrl.data.reportType=reportType,reportsCtrl.content.title=reportType,reportsCtrl.menu.data.isShow=!0,reportsCtrl.menu.title=reportType,reportsCtrl.menu["class"]=kupOpt.vca[reportType]["class"],reportsCtrl.search.data.value="",reportsCtrl.options.data.isOpen=!1,reportsCtrl.options.data.isOnlyShowVca=!0,void(mainCtrl.block.promise=loadUI()))},!0),$scope.$watch("reportsCtrl.options.data",function(newVal,oldVal){reportsCtrl.data;newVal.isOnlyShowVca!==oldVal.isOnlyShowVca&&setTreeviewForFilter()},!0),$scope.$watch("reportsCtrl.search.data",function(newVal,oldVal){reportsCtrl.data;newVal.value!==oldVal.value&&$timeout(function(){setTreeviewForFilter()},300)},!0)}function loadUI(){var dfd=$q.defer();return $timeout(function(){ReportsService.getDeviceTreeData()["finally"](function(){setUI(),loadReportInfo()["finally"](function(){dfd.resolve()})})}),dfd.promise}function loadReportInfo(){var pageUrl=$location.path();return $q.all([ReportsService.initListPosNamesApi(),ReportsService.initGetReportQueryHistoryApi()]).then(function(data){var opt=reportsCtrl.data;ReportsService.setDefaultItemDataList(),ReportsService.setDefaultDateRange(),updateUI(),opt.selectedInstance.length>0&&generateReport()},function(data){isCurrentPage(pageUrl)&&notification("error",i18n("server-error"))})["finally"](function(){isCurrentPage(pageUrl)&&setTreeviewForFilter()})}function setUI(){setTreeview(),setDateRangePicker()}function updateUI(){updateDateRangePicker(),updateRemoveDropPlace(),updateDefaultDropPlace(),defaultExpandTreeview()}function initOpt(){var opt=reportsCtrl.data;opt.isDoneReport=!0,opt.isSuccessReport=!1,opt.isDefaultDropData=!0,opt.isUpdateSelectedItem=!1,opt.draggedItemDataList={},opt.selectedItemDataList={}}function setTreeview(){var opt=reportsCtrl.data,treeview=$(opt.$treeview).data("kendoTreeView");treeview.dataSource.filter({}),treeview.dataSource.data(opt.deviceTreeData)}function setDateRangePicker(){var opt=reportsCtrl.data,days=opt.dateRange.days,showDefaultDate=function(start,end){$scope.$apply(function(){var opt=reportsCtrl.data;opt.dateRange.startDate=new Date(start.format("YYYY/MM/DD HH:mm:ss")),opt.dateRange.endDate=new Date(end.format("YYYY/MM/DD HH:mm:ss")),$(opt.$daterange).find("span").text(moment(start).locale(AuthTokenFactory.getUserLanguage()).format(KupOption["default"].formatMonthly)+" - "+moment(end).locale(AuthTokenFactory.getUserLanguage()).format(KupOption["default"].formatMonthly))})},ranges=function(){var obj={};return $.each(opt.uiDateRangesList,function(i,range){obj[range.name]=range.data}),obj}(),pickerData=$(opt.$daterange).daterangepicker({showDropdowns:!0,opens:"left",drops:"down",buttonClasses:["btn","btn-sm"],applyClass:"btn-warning",cancelClass:"btn-link cancel",maxDate:moment(),ranges:ranges,startDate:moment().subtract(days-1,"days"),endDate:moment()},showDefaultDate).data("daterangepicker"),customRangeBtn=pickerData.locale.customRangeLabel;$(opt.$daterange).find("span").text(moment(pickerData.startDate).locale(AuthTokenFactory.getUserLanguage()).format(KupOption["default"].formatMonthly)+" - "+moment(pickerData.endDate).locale(AuthTokenFactory.getUserLanguage()).format(KupOption["default"].formatMonthly)),$(".daterangepicker .ranges ul li:contains('"+customRangeBtn+"')").on("click",function(e){var $calendarControl=$(".daterangepicker.dropdown-menu");$calendarControl.hasClass("show-calendar")&&(e.stopPropagation(),$calendarControl.removeClass("show-calendar"))})}function updateDateRangePicker(){var opt=reportsCtrl.data,startDate=opt.defaultDateRange.startDate,endDate=opt.defaultDateRange.endDate,$picker=$(opt.$daterange),pickerData=$picker.data("daterangepicker");opt.dateRange.startDate=opt.defaultDateRange.startDate,opt.dateRange.endDate=opt.defaultDateRange.endDate,pickerData.setStartDate(startDate),pickerData.setEndDate(endDate),$(opt.$daterange).find("span").text(moment(pickerData.startDate).locale(AuthTokenFactory.getUserLanguage()).format(KupOption["default"].formatMonthly)+" - "+moment(pickerData.endDate).locale(AuthTokenFactory.getUserLanguage()).format(KupOption["default"].formatMonthly)),$picker.off("apply.daterangepicker").on("apply.daterangepicker",function(event){$scope.$apply(function(){event.preventDefault(),ReportsService.execSaveReportQueryHistoryApi(),generateReport()})})}function updateRemoveDropPlace(uid){var $selector=uid?$('.kupDropItem[data-uid="'+uid+'"] > button'):$(".kupDropItem");$selector.remove()}function updateDefaultDropPlace(){var opt=reportsCtrl.data;Object.keys(opt.defaultItemDataList).length;$(reportsCtrl.data.$treeview).data("kendoTreeView").trigger("dragstart"),$(reportsCtrl.data.$treeview).data("kendoTreeView").trigger("drag"),$(reportsCtrl.data.$treeview).data("kendoTreeView").trigger("drop"),$(reportsCtrl.data.$section).data("kendoDropTarget").trigger("drop"),opt.isDefaultDropData=!1}function showSelectedDevice(e){$(e.currentTarget).children("span:eq(0)").toggle(),$(e.currentTarget).children("span:eq(1)").toggle()}function removeSelectedDevice(e){e.preventDefault();var opt=reportsCtrl.data,selectedDevice=$(e.currentTarget).parent("span"),uid=(selectedDevice.attr("deviceId").split(","),selectedDevice.attr("channelId"),selectedDevice.attr("data-uid"));(function(){$(selectedDevice).remove(),removeDragActiveState(uid),opt.draggedItemDataList[uid]={},opt.selectedItemDataList[uid]={},opt.isUpdateSelectedItem=!0})(),function(){ReportsService.setSelectedInstance(),ReportsService.setSelectedDevices(),ReportsService.setSelectedSaveDataList(),ReportsService.setSelectedGroupNames()}(),function(){showUpdateBtn()}()}function saveReportsInfo(){ReportsService.execSaveReportQueryHistoryApi(),generateReport()}function cancelReportsInfo(){var opt=reportsCtrl.data;return opt.isDefaultDropData=!0,ReportsService.execGetReportQueryHistoryApi().success(function(){updateDateRangePicker(),updateRemoveDropPlace(),updateDefaultDropPlace(),generateReport()}).error(function(){notification("error",i18n("server-error"))})}function getTreeviewOptions(){return{dragAndDrop:!0,template:"# if(item.isOnline == false){ ##=item.text # <i class='fa fa-times-circle-o' uib-tooltip='"+i18n("offline")+"' tooltip-placement='right'></i># } else { ##=item.text ## } #",dataSource:reportsCtrl.data.deviceTreeData,expand:OnKendoExpand,dragstart:function(e){var opt=reportsCtrl.data,treeview=$(reportsCtrl.data.$treeview).data("kendoTreeView"),path=$location.path();if($(opt.$dropHere).show(),opt.isSuccessDrag=!0,opt.draggedItemDataList={},opt.isDefaultDropData&&(opt.draggedItemDataList=opt.defaultItemDataList),!opt.isDefaultDropData){var uid=treeview.dataItem(e.sourceNode).uid,draggedItem=treeview.dataItem(e.sourceNode);if(draggedItem.isLabel&&!draggedItem.items.length)return notification("warning","<a ui-sref='main.label' style='text-decoration: underline;'>"+i18n("select-empty-label-error-information")+"</a>",5e3),opt.isSuccessDrag=!1,!1;if("/main/reports/attention"===path&&ReportsService.isSelectItem())return notification("warning",i18n("multiple-device-not-supported")),opt.isSuccessDrag=!1,!1;if(("/main/reports/traffic"===path||"/main/reports/crowd"===path||"/main/reports/face"===path)&&(opt.selectedDevices.length>=1||!treeview.dataItem(e.sourceNode).isCamera))return notification("warning",i18n("multiple-device-channel-not-supported")),opt.isSuccessDrag=!1,!1;opt.draggedItemDataList[uid]=draggedItem}$.each(opt.draggedItemDataList,function(uid,dataList){if(checkDragActiveState(uid))return e.preventDefault(),!1})},drag:function(e){var opt=reportsCtrl.data;opt.isDefaultDropData||"reportsSection"!==$(e.dropTarget).attr("id")&&"reportsSection"!==$(e.dropTarget).parents(opt.$section).attr("id")||!opt.isSuccessDrag||e.setStatusClass("k-add")},drop:function(e){e.preventDefault();var opt=reportsCtrl.data;$(opt.$dropHere).hide(),opt.isDefaultDropData||("reportsSection"!==$(e.dropTarget).attr("id")&&"reportsSection"!==$(e.dropTarget).parents(opt.$section).attr("id")||!opt.isSuccessDrag)&&e.setValid(!1)}}}function getDragTargetOptions(){return{drop:function(e){var opt=reportsCtrl.data;if(!opt.isSuccessDrag)return!1;$(opt.$treeview).data("kendoTreeView"),function(){$.each(opt.draggedItemDataList,function(uid,draggedDevice){var deviceId="",channelId="",nameTag="";if(draggedDevice.isAll||draggedDevice.isLabel){var len=draggedDevice.items.length,deviceDragged=draggedDevice.items;$.each(deviceDragged,function(index,device){deviceId+=index==len-1?device.deviceId:device.deviceId+","}),nameTag='<span style="display:none;"><span class="kupLabel"><i class="'+draggedDevice.labelClass+'"></i>'+draggedDevice.labelName+"</span></span>",nameTag+='<span><span class="kupLabel"><i class="'+draggedDevice.labelClass+'"></i>'+draggedDevice.text+"</span></span>"}if(draggedDevice.isDevice&&(deviceId=draggedDevice.deviceId,nameTag='<span style="display:none;"><span class="kupLabel"><i class="'+draggedDevice.labelClass+'"></i>'+draggedDevice.labelName+'</span><span class="kupDragLine">|</span><span class="kupNode"><i class="kup-node"></i>'+draggedDevice.text+"</span></span>",nameTag+='<span><span class="kupNode"><i class="kup-node"></i>'+draggedDevice.text+"</span></span>"),draggedDevice.isCamera){if(draggedDevice.hasChildren)return;deviceId=draggedDevice.deviceId,channelId=draggedDevice.cameraId,nameTag='<span style="display:none;"><span class="kupLabel"><i class="'+draggedDevice.labelClass+'"></i>'+draggedDevice.labelName+'</span><span class="kupDragLine">|</span><span class="kupNode"><i class="kup-node"></i>'+draggedDevice.deviceName+'</span><span class="kupDragLine">|</span><span class="kupCamera"><i class="fa fa-video-camera"></i>'+draggedDevice.text+"</span></span>",nameTag+='<span><span class="kupCamera"><i class="fa fa-video-camera"></i>'+draggedDevice.text+"</span></span>"}opt.selectedItemDataList[uid]=opt.draggedItemDataList[uid],opt.isUpdateSelectedItem=!0,opt.isDoneReport=!1;var htmlString="<span class='kupDropItem' data-uid='"+uid+"' deviceId='"+deviceId+"' channelId='"+channelId+"'>"+nameTag+"<button class='btn btn-link'><i class='fa fa-times'></i></button></span>";$(htmlString).insertBefore(reportsCtrl.data.$dropHere)})}(),function(){ReportsService.setSelectedInstance(),ReportsService.setSelectedDevices(),ReportsService.setSelectedSaveDataList(),ReportsService.setSelectedGroupNames()}(),function(){$(opt.$dragTarget+" > span.kupDropItem").off("click").on("click",function(e){showSelectedDevice(e)}),$(opt.$dragTarget+" button").off("click").on("click",function(e){removeSelectedDevice(e)}),addDragActiveState()}(),function(){showUpdateBtn()}()}}}function generateReport(){var opt=reportsCtrl.data,reportType=opt.reportType,serviceName=kupOpt.vca[reportType].ngPreFix+"Service",execGenerateReports=function(){$timeout(function(){return angular.element(document.getElementsByTagName("html")[0]).injector().has(serviceName)?(showUpdateBtn(),void(mainCtrl.block.promise=angular.element(document.getElementsByTagName("html")[0]).injector().get(serviceName).generateReport())):(execGenerateReports(),!1)},300)};opt.isUpdateSelectedItem=!1,opt.isSuccessReport=!1,opt.isDoneReport=!0,execGenerateReports()}function showUpdateBtn(){var opt=reportsCtrl.data,selectedItemsLength=ReportsService.getSelectedItemsLength(),isUpdateSelectedItem=opt.isUpdateSelectedItem,$applyBtn=$(opt.$applyBtn),$cancelBtn=$(opt.$cancelBtn);isUpdateSelectedItem&&selectedItemsLength>0?$applyBtn.show():$applyBtn.hide(),isUpdateSelectedItem?$cancelBtn.show():$cancelBtn.hide()}function setTreeviewForFilter(){var opt=reportsCtrl.data,optionsData=reportsCtrl.options.data,isOnlyShowVca=optionsData.isOnlyShowVca,filterSearchVal=$.trim(reportsCtrl.search.data.value),treeview=$(opt.$treeview).data("kendoTreeView"),analyticsType=kupOpt.vca[opt.reportType].analyticsType,filterVca=isOnlyShowVca?{field:"filterVca",operator:"contains",value:analyticsType}:{},filterSearch=""===filterSearchVal?{}:{field:"filterText",operator:"contains",value:filterSearchVal},filterConfig=function(filterAry){var filter=[];return $.each(filterAry,function(i,data){$.isEmptyObject(data)||filter.push(data)}),0===filter.length&&(filter={}),filter}([filterVca,filterSearch]),filterSearchCheck=new RegExp(filterSearchVal,"i"),uidExpandList=[],execFilter=function(){treeview.collapse(".k-item"),$.each(treeview.dataSource.data(),function(i,labelData){if(labelData.children){var labelFilterText=function(){var tmpAry=labelData.filterText.split(",");return tmpAry.splice(0,1),tmpAry.toString(",")}();!function(){""!==filterSearchVal&&filterSearchCheck.test($.trim(labelFilterText))&&uidExpandList.push(labelData.uid)}(),labelData.children.filter(filterConfig),$.each(labelData.children.data(),function(j,deviceData){if(deviceData.children){var deviceFilterText=function(){var tmpAry=deviceData.filterText.split(",");return tmpAry.splice(0,2),tmpAry.toString(",")}();!function(){""!==filterSearchVal&&filterSearchCheck.test($.trim(deviceFilterText))&&uidExpandList.push(deviceData.uid)}(),deviceData.children.filter(filterConfig)}})}}),treeview.dataSource.filter(filterConfig),$.each(uidExpandList,function(i,uid){treeview.expand('[data-uid="'+uid+'"]')}),addDragActiveState()};$timeout(function(){execFilter()})}function checkDragActiveState(uid){var opt=reportsCtrl.data,check=!1;return $(opt.$treeview).find('[data-uid="'+uid+'"]').children("div").children("span.k-in").hasClass("kupDragActive")&&(check=!0),check}function addDragActiveState(uid){var opt=reportsCtrl.data;uid&&$(opt.$treeview).find('[data-uid="'+uid+'"]').children("div").children("span.k-in").addClass("kupDragActive"),uid||$.each(opt.draggedItemDataList,function(uid,dataList){$.isEmptyObject(dataList)||$(opt.$treeview).find('[data-uid="'+uid+'"]').children("div").children("span.k-in").addClass("kupDragActive")})}function removeDragActiveState(uid){var opt=reportsCtrl.data;uid&&$(opt.$treeview).find('[data-uid="'+uid+'"]').children("div").children("span.k-in").removeClass("kupDragActive"),uid||$.each(opt.draggedItemDataList,function(uid,dataList){$.isEmptyObject(dataList)||$(opt.$treeview).find('[data-uid="'+uid+'"]').children("div").children("span.k-in").removeClass("kupDragActive")})}function defaultExpandTreeview(){var opt=reportsCtrl.data,treeview=$(opt.$treeview).data("kendoTreeView"),expandUidList=[];$.each(opt.defaultItemDataList,function(uid,dataList){if(!$.isEmptyObject(dataList))for(var parent=treeview.parent(treeview.findByUid(uid));parent.length>0;){var parentUid=parent.attr("data-uid");expandUidList.push(parentUid),parent=treeview.parent(treeview.findByUid(parentUid))}}),$.each(expandUidList,function(i,uid){treeview.expand('[data-uid="'+uid+'"]')})}function OnKendoExpand(e){}var kupOpt=KupOption,i18n=UtilsService.i18n,notification=UtilsService.notification,isCurrentPage=(UtilsService.block,RouterStateService.isCurrentPage),mainCtrl=$scope.$parent.mainCtrl,reportsCtrl=this;reportsCtrl.data=ReportsService.data,reportsCtrl.fn={showMainMenu:MainService.showMainMenu,saveReportsInfo:saveReportsInfo,cancelReportsInfo:cancelReportsInfo,isEmptyDevice:DeviceTreeService.isEmptyDevice,isSelectItem:ReportsService.isSelectItem,isSuccessReport:ReportsService.isSuccessReport,isUpdateSelectedItem:ReportsService.isUpdateSelectedItem,isShowNoDataGuide:ReportsService.isShowNoDataGuide,getTheme:AuthTokenFactory.getTheme},reportsCtrl.content={},reportsCtrl.menu={},reportsCtrl.menu.data=ReportsService.menuData,reportsCtrl.search={},reportsCtrl.search.data=ReportsService.searchData,reportsCtrl.options={},reportsCtrl.options.data=ReportsService.optionsData,reportsCtrl.treeview={},reportsCtrl.treeview.data={},reportsCtrl.treeview.options=getTreeviewOptions(),reportsCtrl.dragTarget={},reportsCtrl.dragTarget.data={},reportsCtrl.dragTarget.options=getDragTargetOptions(),init()}]);