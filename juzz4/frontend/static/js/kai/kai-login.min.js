angular.module("kai.login",[]),angular.module("kai.login").factory("LoginService",["KupOption","AuthTokenFactory","$http","KupApiService",function(KupOption,AuthTokenFactory,$http,KupApiService){function getData(key){var deepCopy=angular.copy(data);return key?deepCopy[key]:deepCopy}function login(api_name,param,onSuccess,onFail,onError,isDefer){return ajaxPost(api_name,param,onSuccess,onFail,onError,isDefer)}var ajaxPost=KupApiService.ajaxPost,data={alertList:[],alertIndex:0,loginForm:{company:"",username:"",password:"",rememberMe:!1},resetForm:{company:"",username:"",email:""},showStatus:{loginForm:!0,resetForm:!1,alertList:!1},termsUrl:KupOption.sysApiRootUrl+"/kaisquare/footer/index"};return{data:data,getData:getData,login:login}}]),angular.module("kai.login").controller("LoginCtrl",["KupOption","AuthTokenFactory","UserService","UtilsService","LoginService","$scope","$state","$http","$interval","$timeout","$q","$filter",function(KupOption,AuthTokenFactory,UserService,UtilsService,LoginService,$scope,$state,$http,$interval,$timeout,$q,$filter){function init(){getAnnouncementList(),slideInit(),rememberMe()}function cleanResetForm(type){"comany"===type&&(loginCtrl.resetForm.email=""),"email"===type&&(loginCtrl.resetForm.username="",loginCtrl.resetForm.company="")}function slideInit(){$scope.slides=KupOption.slide_images,$(".carousel").carousel()}function getAnnouncementList(){var apiUrl=loginCtrl.server+"/api/superadmin";return $http.post(apiUrl+"/getannouncementlist",$.param({"session-key":""}),{headers:{Accept:"*/*","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"}}).then(function(response){var data=response.data;"ok"===data.result&&(data.announcements.length>0&&(loginCtrl.alertList=data.announcements,loginCtrl.showStatus.alertList=!0),$interval(switchAlert,3e3))},function(){console.error("api-error")})}function switchAlert(){var length=loginCtrl.alertList.length;loginCtrl.alertIndex==length-1?loginCtrl.alertIndex=0:loginCtrl.alertIndex++}function closeAlert(){loginCtrl.showStatus.alertList=!1}function changeValidStatus(inputName){$scope.loginForm[inputName].$invalid&&($scope.loginForm[inputName].$dirty=!0)}function login(){if($scope.loginForm.$invalid)return changeValidStatus("company"),changeValidStatus("username"),changeValidStatus("password"),!1;var loginInfo=loginCtrl.loginForm,loginPromise=function(){loginCtrl.isSubmit=1,UserService.login(loginInfo.company,loginInfo.username,loginInfo.password,loginInfo.rememberMe).then(function(response){var data=response.data;"ok"===data.result?($state.go("main.dashboard"),$timeout(function(){loginCtrl.isSubmit=0},5e3)):("error"===data.result&&"msg-account-locked"===data.reason?(loginCtrl.locked_time_remaining=parseInt(data["locked-time-remaining"]/60/1e3),loginCtrl.login_error_msg=i18n("msg-account-locked").replace("%s",loginCtrl.locked_time_remaining)):("error"===data.result&&data["login-attempt-remaining"]>0&&(loginCtrl.locked_time_remaining=data["login-attempt-remaining"],loginCtrl.login_error_msg=i18n("msg-incorrect-login").replace("%s",parseInt(loginCtrl.locked_time_remaining))),notification("error",i18n("information-not-verified"))),loginCtrl.isSubmit=0)},function(){notification("error",i18n("server-error")),loginCtrl.isSubmit=0})["finally"]()};loginPromise()}function resetPassword(){var loginInfo=loginCtrl.resetForm;return $scope.resetForm.email.$invalid&&($scope.resetForm.company.$invalid||$scope.resetForm.username.$invalid)?(changeValidStatus("company"),changeValidStatus("username"),!1):($scope.resetForm.email.$valid&&(loginInfo.company="",loginInfo.username=""),void UserService.forgotPassword(loginCtrl.server,loginInfo.company,loginInfo.username,loginInfo.email).then(function(response){var data=response.data;"ok"===data.result?notification("success",i18n("msg-reset-email-sent")):notification("error",i18n("information-not-verified"))},function(){notification("error",i18n("server-error"))}))}function showLoginForm(){loginCtrl.showStatus.loginForm=!0,loginCtrl.showStatus.resetForm=!1}function showResetForm(){loginCtrl.showStatus.loginForm=!1,loginCtrl.showStatus.resetForm=!0}function rememberMe(){var sessionKey=AuthTokenFactory.getSessionKey();sessionKey&&$state.go("main.dashboard")}var loginCtrl=this,i18n=UtilsService.i18n,notification=UtilsService.notification,getData=(UtilsService.block,LoginService.getData);loginCtrl.server=KupOption.sysApiRootUrl,loginCtrl.alertList=getData("alertList"),loginCtrl.alertIndex=getData("alertIndex"),loginCtrl.loginForm=getData("loginForm"),loginCtrl.resetForm=getData("resetForm"),loginCtrl.showStatus=getData("showStatus"),loginCtrl.locked_time_remaining=0,loginCtrl.login_attempt_remaining=0,loginCtrl.events={login:login,resetPassword:resetPassword,showLoginForm:showLoginForm,showResetForm:showResetForm,closeAlert:closeAlert,switchAlert:switchAlert,cleanResetForm:cleanResetForm},loginCtrl.block={options:{},timer:KupOption.loadingTimer},loginCtrl.data=LoginService.data,init()}]);