angular.module("kai.pos",["datatables"]),angular.module("kai.pos").factory("PosService",["KupOption","UtilsService","KupApiService","AuthTokenFactory","DTOptionsBuilder","DTColumnDefBuilder","DTColumnBuilder","$q","$filter","$timeout",function(KupOption,UtilsService,KupApiService,AuthTokenFactory,DTOptionsBuilder,DTColumnDefBuilder,DTColumnBuilder,$q,$filter,$timeout){function setFtpData(){var opt=data;opt.ftpInfo=angular.copy(opt.apiGetPosSettings.ftpDetails),opt.ftpInfo.enabled=opt.apiGetPosSettings.enabled||!1}function setLabelData(){var opt=data,labelList=angular.copy(opt.apiGetLabels),labelList=function(){var labelList=angular.copy(opt.apiGetLabels);return $.each(labelList,function(i,label){label["class"]="",$.each(kupOpt.label,function(j,labelOpt){if(label.type===labelOpt.value)return label["class"]=labelOpt["class"],!1})}),labelList}();opt.uiLabel=labelList,opt.searchInfo.label=labelList[0]||{}}function setReportData(){var opt=data,apiReporeList=angular.copy(opt.apiGetPosSalesReport),dateRangeList=function(){var acc=[];return moment.range(opt.searchInfo.startDate,new Date(moment(moment(opt.searchInfo.endDate).format(opt.dateFormat)).add(1,"h"))).by("h",function(moment){acc.push(new Date(moment))},!0),acc}(),reportList=[],reportInputList={};!function(){$.each(dateRangeList,function(i,time){var isPush=!0;$.each(apiReporeList,function(j,report){if(time.getTime()===report.sales.time.getTime())return reportList.push({time:time,amount:report.sales.amount,count:report.sales.count}),isPush=!1,!1}),isPush&&reportList.push({time:time,amount:0,count:0})})}(),function(){$.each(reportList,function(i,report){reportInputList[report.time]={amount:report.amount,count:report.count,amountId:"posReportAmount"+report.time.getTime(),countId:"posReportCount"+report.time.getTime(),isShowCount:!1,isShowAmount:!1}})}(),opt.reportList=reportList,opt.reportInputList=reportInputList}function getLabelsApi(isDefer){var opt=data,param={},onSuccess=function(response){opt.apiGetLabels=$filter("orderBy")(response.labels,"+name")||[]},onFail=function(response){opt.apiGetLabels=[]},onError=function(){opt.apiGetLabels=[]};return ajaxPost("getlabels",param,onSuccess,onFail,onError,isDefer)}function getPosSalesReportApi(isDefer){var opt=data,labelName=opt.searchInfo.label.name||"",fromDateUTC=kendo.toString(utils.localToUTC(opt.searchInfo.startDate),opt.timeFormat[2]),toDateUTC=kendo.toString(utils.localToUTC(opt.searchInfo.endDate),opt.timeFormat[2]),param={from:fromDateUTC,to:toDateUTC,name:labelName,"parser-type":""},onSuccess=function(response){$.each(response.sales||[],function(i,report){response.sales[i].sales.time=UtilsService.UTCToLocal(kendo.parseDate(report.sales.time,opt.timeFormat[1]))}),opt.apiGetPosSalesReport=response.sales||[]},onFail=function(response){opt.apiGetPosSalesReport=[]},onError=function(){opt.apiGetPosSalesReport=[]};return ajaxPost("getpossalesreport",param,onSuccess,onFail,onError,isDefer)}function updatePosSalesDataApi(isDefer){var opt=data,fromDateUTC=kendo.toString(utils.localToUTC(opt.searchInfo.startDate),opt.timeFormat[2]),toDateUTC=kendo.toString(utils.localToUTC(opt.searchInfo.endDate),opt.timeFormat[2]),posName=opt.searchInfo.label.name||"",posData=function(){var reportList=opt.reportInputList,posData=[];return $.each(reportList,function(time,report){posData.push({time:kendo.toString(utils.localToUTC(time),opt.timeFormat[2]),count:report.count,amount:report.amount})}),angular.toJson(posData)}(),param={from:fromDateUTC,to:toDateUTC,POSName:posName,POSData:posData},onSuccess=function(response){},onFail=function(response){},onError=function(){};return ajaxPost("updatepossalesdata",param,onSuccess,onFail,onError,isDefer)}function getPosSettingsApi(isDefer){var opt=data,param={},onSuccess=function(response){opt.apiGetPosSettings=response.settings||{}},onFail=function(response){opt.apiGetPosSettings={}},onError=function(){opt.apiGetPosSettings=[]};return ajaxPost("getpossettings",param,onSuccess,onFail,onError,isDefer)}function updatePosSettingsApi(isDefer){var opt=data,isEnabled=opt.ftpInfo.enabled,ftpInfo=function(){var ftpInfo=angular.copy(opt.ftpInfo);return delete ftpInfo.enabled,angular.toJson(ftpInfo)}(),param={"import-enabled":isEnabled,"ftp-details":ftpInfo},onSuccess=function(response){notification("success",i18n("saved-successfully"))},onFail=function(response){notification("error",i18n("saved-failed"))},onError=function(){notification("error",i18n("saved-failed"))};return ajaxPost("updatepossettings",param,onSuccess,onFail,onError,isDefer)}function switchTab(tabName){var opt=data;$.each(opt.uiTab,function(i,tab){tab.isActive=tabName===tab.name})}var kupOpt=KupOption,utils=UtilsService,i18n=UtilsService.i18n,notification=UtilsService.notification,ajaxPost=KupApiService.ajaxPost,data={};return data.timeFormat=kupOpt.kendoTimeFormat,data.dateRange=1,data.dateFormat=kupOpt.momentTimeFormat[0],data.startDateFormat=kupOpt.momentTimeFormatForStart[0],data.endDateFormat=kupOpt.momentTimeFormatForEnd[0],data.searchInfo={label:{},startDate:new Date(moment(moment().format(data.startDateFormat)).subtract(data.dateRange-1,"days")),endDate:new Date(moment(moment().format(data.endDateFormat)))},data.ftpInfo={},data.reportList=[],data.reportInputList={},data.requestList=[],data.apiGetLabels=[],data.apiGetPosSalesReport=[],data.apiGetPosSettings={},data.$daterange="#kupDaterange",data.uiTab=[{name:"automated",text:"automated",isActive:!0,"class":"fa-repeat"},{name:"manual",text:"manual",isActive:!1,"class":"fa-hand-o-up"}],data.uiLabel=[],data.uiDateRangesList=[{name:i18n("today"),data:[moment(new Date(moment().format(data.startDateFormat))),moment(new Date(moment().format(data.endDateFormat)))]},{name:i18n("yesterday"),data:[moment(new Date(moment().subtract(1,"days").format(data.startDateFormat))),moment(new Date(moment().subtract(1,"days").format(data.endDateFormat)))]},{name:i18n("last-2-days"),data:[moment(new Date(moment().subtract(2,"days").format(data.startDateFormat))),moment(new Date(moment().format(data.endDateFormat)))]}],data.uiTable={options:DTOptionsBuilder.newOptions().withLanguage(UtilsService.getAngularDatatablesI18n()).withPaginationType("full_numbers").withOption("paging",!0).withOption("info",!0).withOption("responsive",!1).withOption("ordering",!1).withOption("processing",!0).withDisplayLength(25),columnDefs:[DTColumnDefBuilder.newColumnDef(0),DTColumnDefBuilder.newColumnDef(1),DTColumnDefBuilder.newColumnDef(2)]},{data:data,setFtpData:setFtpData,setLabelData:setLabelData,setReportData:setReportData,getLabelsApi:getLabelsApi,getPosSettingsApi:getPosSettingsApi,getPosSalesReportApi:getPosSalesReportApi,updatePosSalesDataApi:updatePosSalesDataApi,updatePosSettingsApi:updatePosSettingsApi,switchTab:switchTab}}]),angular.module("kai.pos").controller("PosController",["KupOption","RouterStateService","UtilsService","AuthTokenFactory","PosService","$scope","$q","$filter","$timeout",function(KupOption,RouterStateService,UtilsService,AuthTokenFactory,PosService,$scope,$q,$filter,$timeout){function init(){mainCtrl.block.promise=loadUI()}function loadUI(){var getPosSettings=PosService.getPosSettingsApi(!0),getLabels=PosService.getLabelsApi(!0);return $q.all([getPosSettings,getLabels])["finally"](function(){setFtpUI(),setFtpWatch(),setTableUI(),setTableWatch()})}function switchTab(tabName){PosService.switchTab(tabName)}function setFtpWatch(){$scope.$watch("posCtrl.data.ftpInfo.enabled",function(newVal,oldVal){posCtrl.data;newVal!==oldVal&&updateFtp()},!0)}function setFtpUI(){PosService.setFtpData()}function updateFtp(){var promise=(posCtrl.data,function(){return PosService.updatePosSettingsApi()});mainCtrl.block.promise=promise()}function setTableWatch(){$scope.$watch("posCtrl.data.searchInfo",function(newVal,oldVal){generateReport()},!0)}function setTableUI(){setLabelSelect(),setDateRangePicker()}function generateReport(){var dbPrcessingId=(posCtrl.data,kupOpt.datatables.prcessingId);$("#"+dbPrcessingId).show(),PosService.getPosSalesReportApi()["finally"](function(){$("#"+dbPrcessingId).hide(),PosService.setReportData()})}function saveReport(){var promise=(posCtrl.data,function(){return PosService.updatePosSalesDataApi()});mainCtrl.block.promise=promise()}function setLabelSelect(){PosService.setLabelData()}function setDateRangePicker(){var opt=posCtrl.data,dateFormat=opt.dateFormat,defaultDate=(opt.startDateFormat,opt.endDateFormat,{startDate:moment(opt.searchInfo.startDate),endDate:moment(opt.searchInfo.endDate)}),showDate=function(start,end){$scope.$apply(function(){var opt=posCtrl.data;opt.searchInfo.startDate=new Date(start.format(dateFormat)),opt.searchInfo.endDate=new Date(end.format(dateFormat)),$(opt.$daterange).find("span").html(moment(start).locale(AuthTokenFactory.getUserLanguage()).format(KupOption["default"].formatMonthly)+" - "+moment(end).locale(AuthTokenFactory.getUserLanguage()).format(KupOption["default"].formatMonthly))})},rangesList=opt.uiDateRangesList,ranges=function(){var obj={};return $.each(rangesList,function(i,range){obj[range.name]=range.data}),obj}(),locale={customRangeLabel:i18n("custom-range")},pickerData=$(opt.$daterange).daterangepicker({showDropdowns:!0,timePicker:!0,timePickerIncrement:60,timePicker24Hour:!0,opens:"left",drops:"down",buttonClasses:["btn","btn-sm"],applyClass:"btn-warning",cancelClass:"btn-link cancel",minDate:moment(new Date(moment().subtract(1,"days").format(opt.startDateFormat))),maxDate:moment(new Date(moment().format(opt.endDateFormat))),ranges:ranges,locale:locale,startDate:defaultDate.startDate,endDate:defaultDate.endDate},showDate).data("daterangepicker"),customRangeBtn=pickerData.locale.customRangeLabel;$(opt.$daterange).find("span").html(moment(pickerData.startDate).locale(AuthTokenFactory.getUserLanguage()).format(KupOption["default"].formatMonthly)+" - "+moment(pickerData.endDate).locale(AuthTokenFactory.getUserLanguage()).format(KupOption["default"].formatMonthly)),$(".daterangepicker .ranges ul li:contains('"+customRangeBtn+"')").on("click",function(e){var $calendarControl=$(".daterangepicker.dropdown-menu");$calendarControl.hasClass("show-calendar")&&(e.stopPropagation(),$calendarControl.removeClass("show-calendar"))}).hide()}function showInput(time,key,inputId){var opt=posCtrl.data;opt.reportInputList[time][key]=!0,$timeout(function(){$("#"+inputId).focus()})}function hideInput(time,key){var opt=posCtrl.data;opt.reportInputList[time][key]=!1}function hideAllInput(){var opt=posCtrl.data;$.each(opt.reportInputList,function(time,report){report.isShowCount=!1,report.isShowAmount=!1})}var kupOpt=KupOption,i18n=UtilsService.i18n,mainCtrl=(UtilsService.notification,UtilsService.block,$scope.$parent.mainCtrl),posCtrl=this;posCtrl.data=PosService.data,posCtrl.data.tableTimeFormat=KupOption["default"].formatlDatetime,posCtrl.fn={switchTab:switchTab,updateFtp:updateFtp,saveReport:saveReport,showInput:showInput,hideInput:hideInput,hideAllInput:hideAllInput},posCtrl.ngMessageUrl=kupOpt.sysNgMessageUrl,init()}]);