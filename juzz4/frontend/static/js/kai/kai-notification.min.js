angular.module("kai.notification",["datatables"]),angular.module("kai.notification").factory("NotificationModalService",["KupOption","UtilsService","KupApiService",function(KupOption,UtilsService,KupApiService){var data=(UtilsService.i18n,UtilsService.notification,KupApiService.ajaxPost,{isLoadVideo:!1,isOpenModal:!1});return{data:data}}]),angular.module("kai.notification").factory("NotificationService",["KupOption","UtilsService","KupApiService","AuthTokenFactory","DTOptionsBuilder","DTColumnDefBuilder","DTColumnBuilder","$q","$filter","$timeout",function(KupOption,UtilsService,KupApiService,AuthTokenFactory,DTOptionsBuilder,DTColumnDefBuilder,DTColumnBuilder,$q,$filter,$timeout){function initSearchData(){var opt=data;opt.searchInfo.keyword="",opt.searchInfo.device=opt.deviceDataSource[0],opt.searchInfo.camera=opt.searchInfo.device.cameraData[0],opt.searchInfo.location=opt.locationDataSource[0],opt.searchInfo.limit=0}function setSearchData(){var opt=data,deviceDataSource=[],locationDataSource=[{locationId:"",locationName:opt.defaultSelectLocationText}],getDefaultCamera=function(isEmpty){var defaultCamera={};return defaultCamera=isEmpty?{cameraId:"",cameraName:opt.defaultSelectCameraTextForEmpty}:{cameraId:"",cameraName:opt.defaultSelectCameraText}};deviceDataSource.push({deviceId:"",deviceName:opt.defaultSelectDeviceText,cameraData:[getDefaultCamera(!1)]}),$.each(opt.apiUserDevices,function(i,device){var carmeraData=device.node?device.node.cameras:[];locationDataSource=function(){var tmpAry=angular.copy(locationDataSource),isPush=!1;return $.each(tmpAry,function(j,location){return location.locationName===device.address?(isPush=!1,!1):void(isPush=!0)}),isPush&&tmpAry.push({locationId:i,locationName:device.address}),tmpAry}(),deviceDataSource.push({deviceId:device.id,deviceName:device.name,cameraData:function(){var isEmpty=!carmeraData.length,cameraInfo=[];return cameraInfo.push(getDefaultCamera(isEmpty)),$.each(carmeraData,function(j,camera){cameraInfo.push({cameraId:camera.nodeCoreDeviceId,cameraName:camera.name})}),cameraInfo}(),fullData:device})}),opt.deviceDataSource=deviceDataSource,opt.locationDataSource=locationDataSource,opt.searchInfo.device=deviceDataSource[0],opt.searchInfo.camera=deviceDataSource[0].cameraData,opt.searchInfo.location=locationDataSource[0]}function setTableData(){var opt=data;return opt.tableDataSource=angular.copy(opt.apiAlerts),$.each(opt.tableDataSource,function(i,alert){alert.deviceInfo=function(){var deviceInfo={};return $.each(opt.apiUserDevices,function(j,device){if(device.deviceId===alert.deviceId)return deviceInfo=device,!1}),deviceInfo}(),alert.deviceInfo=function(){var deviceInfo={};return $.each(opt.apiUserDevices,function(j,device){if(device.deviceId===alert.deviceId)return deviceInfo=device,!1}),deviceInfo}(),alert.cameraInfo=function(){var cameraInfo={};return $.each(opt.apiUserDevices,function(j,device){return device.deviceId!==alert.deviceId||void $.each(device.node.cameras,function(k,camera){if(camera.nodeCoreDeviceId===alert.channelId)return cameraInfo=camera,!1})}),cameraInfo}(),alert.isMapping=!$.isEmptyObject(alert.deviceInfo)&&!$.isEmptyObject(alert.cameraInfo),alert.isOccupancy="event-occupancy-limit"===alert.eventType,alert.timeLocal=kendo.toString(UtilsService.UTCToLocal(new Date(alert.time)),opt.timeFormat[0]),alert.timeLocal=moment(alert.timeLocal).format(KupOption["default"].formatlDatetime),alert.alertTypeText=function(){var text="",labelId="";return alert.isOccupancy?$.each(opt.apiUserDevices,function(j,device){return device.deviceId!==alert.deviceId||void $.each(device.channelLabels,function(k,cLabel){return cLabel.channelId!==alert.channelId||(labelId=cLabel.labels[0]||"",void $.each(opt.apiLabels,function(l,label){return labelId!==label.labelId||void(text='<span><span><i class="kup-store"></i>'+label.name+"</span></span>")}))})}):text=alert.isMapping?'<span><span class="kupNode"><i class="kup-node"></i>'+alert.deviceInfo.name+'</span><span class="kupDragLine"> | </span><span class="kupCamera"><i class="fa fa-video-camera"></i>'+alert.cameraInfo.name+"</span></span>":"<span>"+opt.notMappingDeviceText+"</span>",text}(),alert.eventTypeText=i18n(getEventInfoByType(alert.eventType).text)||"",alert.location=alert.deviceInfo.address||"",alert.timeLocalShortText=function(){var displayTime="",differentObject=UtilsService.getDateDifference(new Date,new Date(alert.timeLocal));return displayTime=differentObject.days>0?differentObject.days+" "+i18n("day(s)-ago"):differentObject.hours>0?differentObject.hours+" "+i18n("hour(s)-ago"):differentObject.minutes>0?differentObject.minutes+" "+i18n("minute(s)-ago"):differentObject.seconds+" "+i18n("second(s)-ago")}()}),opt.tableDataSource}function getEventInfoByType(eventType){var opt=data,eventInfo={};return $.each(opt.uiType,function(i,type){if(type.value===eventType)return eventInfo=type,!1}),eventInfo}function getUserDevicesApi(isDefer){var opt=data,param={},onSuccess=function(response){opt.apiUserDevices=response.devices||[]},onFail=function(response){opt.apiUserDevices=[]},onError=function(){opt.apiUserDevices=[]};return ajaxPost("getuserdevices",param,onSuccess,onFail,onError,isDefer)}function getAlertsApi(pageParam,isDefer){var opt=data,eventType=opt.searchInfo.type.value||"",eventId="",deviceId=opt.searchInfo.device&&opt.searchInfo.device.deviceId?opt.searchInfo.device.deviceId:"",channelId=opt.searchInfo.camera&&opt.searchInfo.camera.cameraId?opt.searchInfo.camera.cameraId:"",fromDateUTC=kendo.toString(utils.localToUTC(opt.searchInfo.startDate),data.timeFormat[2]),toDateUTC=kendo.toString(utils.localToUTC(opt.searchInfo.endDate),data.timeFormat[2]),param={skip:pageParam.skip,take:pageParam.take,from:fromDateUTC,to:toDateUTC,"device-id":deviceId,"channel-id":channelId,"event-id":eventId,"event-type":eventType},onSuccess=function(response){opt.apiAlerts=response.alerts||[],opt.apiAlertsTotal=response.totalcount||0},onFail=function(response){opt.apiAlerts=[],opt.apiAlertsTotal=opt.apiAlertsTotal||0},onError=function(){opt.apiAlerts=[],opt.apiAlertsTotal=opt.apiAlertsTotal||0};return ajaxPost("getalerts",param,onSuccess,onFail,onError,isDefer)}function exportAlertsApi(format,isDefer){format=format||"";var opt=data,eventType=opt.searchInfo.type.value||"",deviceId=opt.searchInfo.device&&opt.searchInfo.device.deviceId?opt.searchInfo.device.deviceId:"",channelId=opt.searchInfo.camera&&opt.searchInfo.camera.cameraId?opt.searchInfo.camera.cameraId:"",fromDateUTC=kendo.toString(utils.localToUTC(opt.searchInfo.startDate),data.timeFormat[2]),toDateUTC=kendo.toString(utils.localToUTC(opt.searchInfo.endDate),data.timeFormat[2]),param={"file-format":format,"time-zone-offset":UtilsService.getTimezoneOffset(),"device-id":deviceId,"channel-id":channelId,"event-type":eventType,from:fromDateUTC,to:toDateUTC};return KupApiService.exportDoc(param,"exportalerts")}function getLabelsApi(isDefer){var opt=data,param={},onSuccess=function(response){opt.apiLabels=response.labels||[]},onFail=function(response){opt.apiLabels=[]},onError=function(){opt.apiLabels=[]};return ajaxPost("getlabels",param,onSuccess,onFail,onError,isDefer)}var kupOpt=KupOption,utils=UtilsService,i18n=UtilsService.i18n,ajaxPost=(UtilsService.notification,KupApiService.ajaxPost),data={};return data.timeFormat=kupOpt.kendoTimeFormat,data.dateRange=7,data.dateFormat=kupOpt.momentTimeFormat[0],data.startDateFormat=kupOpt.momentTimeFormatForStart[0],data.endDateFormat=kupOpt.momentTimeFormatForEnd[0],data.defaultSelectDeviceText=i18n("please-select-device"),data.defaultSelectCameraText=i18n("please-select-camera"),data.defaultSelectCameraTextForEmpty=i18n("no-cameras"),data.defaultSelectLocationText=i18n("please-select-location"),data.notMappingDeviceText=i18n("there-is-no-matching-device"),data.deviceDataSource=[],data.locationDataSource=[],data.tableDataSource=[],data.selectTableData=[],data.apiUserDevices=[],data.apiAlerts=[],data.apiAlertsTotal=0,data.apiExportAlerts="",data.apiLabels=[],data.requestForReport=[],data.$daterange="#kupDaterange",data.uiType=function(){var type=[],allEventType=[],occupancyEvent="event-occupancy-limit";return $.each(kupOpt.vca,function(key,vca){return 1!==vca.typeId||(type.push({name:vca.name,text:vca.name,value:vca.eventType,"class":vca["class"]}),void allEventType.push(vca.eventType))}),allEventType.push(occupancyEvent),type.unshift({name:"all",text:"all-security-events",value:allEventType.toString(",")}),type.push({name:"occupancy",text:"occupancy-limit",value:occupancyEvent,"class":""}),type}(),data.uiDateRangesList=[{name:i18n("today"),data:[moment(new Date(moment().format(data.startDateFormat))),moment(new Date(moment().format(data.endDateFormat)))]},{name:i18n("yesterday"),data:[moment(new Date(moment().subtract(1,"days").format(data.startDateFormat))),moment(new Date(moment().subtract(1,"days").format(data.endDateFormat)))]},{name:i18n("last-7-days"),data:[moment(new Date(moment().subtract(6,"days").format(data.startDateFormat))),moment(new Date(moment().format(data.endDateFormat)))]},{name:i18n("last-30-days"),data:[moment(new Date(moment().subtract(29,"days").format(data.startDateFormat))),moment(new Date(moment().format(data.endDateFormat)))]},{name:i18n("this-month"),data:[moment(new Date(moment().startOf("month").format(data.startDateFormat))),moment(new Date(moment().endOf("month").format(data.endDateFormat)))]},{name:i18n("last-month"),data:[moment(new Date(moment().subtract(1,"month").startOf("month").format(data.startDateFormat))),moment(new Date(moment().subtract(1,"month").endOf("month").format(data.endDateFormat)))]}],data.uiTable={},data.uiTableBlock={options:{}},data.searchInfo={type:data.uiType[0],startDate:new Date(moment().format(data.startDateFormat)),endDate:new Date(moment().format(data.endDateFormat)),keyword:"",device:{},camera:{},location:{},limit:0},{data:data,initSearchData:initSearchData,setSearchData:setSearchData,setTableData:setTableData,getEventInfoByType:getEventInfoByType,getUserDevicesApi:getUserDevicesApi,getAlertsApi:getAlertsApi,exportAlertsApi:exportAlertsApi,getLabelsApi:getLabelsApi}}]),angular.module("kai.notification").controller("NotificationModalController",["KupOption","RouterStateService","UtilsService","PromiseFactory","AuthTokenFactory","NotificationService","NotificationModalService","$scope","$rootScope","$timeout","$uibModalInstance","selectTableData",function(KupOption,RouterStateService,UtilsService,PromiseFactory,AuthTokenFactory,NotificationService,NotificationModalService,$scope,$rootScope,$timeout,$uibModalInstance,selectTableData){function init(){setWatch()}function setWatch(){$scope.$watch("notificationModalCtrl.data.isOpenModal",function(newVal,oldVal){var opt=notificationModalCtrl.data;newVal&&(opt.isLoadVideo=!1,setPlayer("kupPlayer"),$timeout(function(){opt.isLoadVideo=!0},500))},!0)}function setPlayer(playerId){notificationModalCtrl.data;window.jwplayer&&(window.jwplayer.key=kupOpt.jwplayerKey);var url=selectTableData.eventVideoUrl,videoUrl=kupOpt.sysApiRootUrl+url,playLink=videoUrl+"?action=play";url&&window.jwplayer(playerId).setup({file:playLink,width:"100%",height:"100%",autostart:!1,mute:!0,primary:"firefox"==utils.detectBrowser()?"flash":"html5",flashplayer:kupOpt.jwplayerFlashPlayerUrl,html5player:kupOpt.jwplayerHtml5PlayerUrl})}function closeModal(){$uibModalInstance.close()}function cancelModal(){$uibModalInstance.dismiss("cancel")}function getEventInfoByType(eventType){return NotificationService.getEventInfoByType(eventType)}function downloadVideo(){var url=selectTableData.eventVideoUrl,downloadUrl=url+"?action=download&customName="+kendo.toString(new Date(selectTableData.timeMillis),kupOpt.kendoTimeFormat[3])+"_"+selectTableData.eventType+"_"+selectTableData.deviceId+"_"+selectTableData.channelId+".mp4";url&&UtilsService.urlDownload(downloadUrl)}var kupOpt=KupOption,utils=UtilsService,notificationModalCtrl=(UtilsService.i18n,UtilsService.notification,this);notificationModalCtrl.data=NotificationModalService.data,notificationModalCtrl.selectTableData=selectTableData,notificationModalCtrl.fn={closeModal:closeModal,cancelModal:cancelModal,getEventInfoByType:getEventInfoByType,downloadVideo:downloadVideo},init()}]),angular.module("kai.notification").controller("NotificationController",["KupOption","RouterStateService","UtilsService","AuthTokenFactory","NotificationService","NotificationModalService","DTOptionsBuilder","DTColumnBuilder","$scope","$q","$timeout","$uibModal","$rootScope",function(KupOption,RouterStateService,UtilsService,AuthTokenFactory,NotificationService,NotificationModalService,DTOptionsBuilder,DTColumnBuilder,$scope,$q,$timeout,$uibModal,$rootScope){function init(){mainCtrl.block.promise=setUI(),setWatch()}function setWatch(){$scope.$watch("notificationCtrl.data.searchInfo",function(newVal,oldVal){angular.toJson(newVal)!==angular.toJson(oldVal)&&generateReport()},!0)}function setUI(){var requestAll=(notificationCtrl.data,[NotificationService.getUserDevicesApi(!0),NotificationService.getLabelsApi(!0)]);return setDateRangePicker(),$q.all(requestAll)["finally"](function(){setSearchData()})}function generateReport(){var opt=notificationCtrl.data;opt.uiTable.dtInstance.DataTable.ajax.reload()}function exportReport(format){var opt=notificationCtrl.data,warningNotify=notification("warning",i18n("exporting-to-"+format),0);NotificationService.exportAlertsApi(format)["finally"](function(){warningNotify.close(),opt.apiExportAlerts&&UtilsService.urlDownload(opt.apiExportAlerts)})}function setTableData(){NotificationService.setTableData()}function clearSearch(){NotificationService.initSearchData()}function setSearchData(){NotificationService.setSearchData()}function setDateRangePicker(){var opt=notificationCtrl.data,dateFormat=opt.dateFormat,startDateFormat=opt.startDateFormat,endDateFormat=opt.endDateFormat,defaultDate={startDate:moment(opt.searchInfo.startDate),endDate:moment(opt.searchInfo.endDate)},showDate=function(start,end){$scope.$apply(function(){var opt=notificationCtrl.data;opt.searchInfo.startDate=new Date(start.format(dateFormat)),opt.searchInfo.endDate=new Date(end.format(dateFormat)),$(opt.$daterange).find("span").html(start.format(dateFormat)+" - "+end.format(dateFormat))})},rangesList=opt.uiDateRangesList,ranges=function(){var obj={};return $.each(rangesList,function(i,range){obj[range.name]=range.data}),obj}(),locale={customRangeLabel:i18n("custom-range")},pickerData=$(opt.$daterange).daterangepicker({showDropdowns:!0,timePicker:!0,timePickerIncrement:59,timePicker24Hour:!0,timePickerSeconds:!1,opens:"left",drops:"down",buttonClasses:["btn","btn-sm"],applyClass:"btn-warning",cancelClass:"btn-link cancel",ranges:ranges,locale:locale,startDate:defaultDate.startDate,endDate:defaultDate.endDate},showDate).data("daterangepicker"),customRangeBtn=pickerData.locale.customRangeLabel;$(opt.$daterange).find("span").html(pickerData.startDate.format(startDateFormat)+" - "+pickerData.endDate.format(endDateFormat)),$(".daterangepicker .ranges ul li:contains('"+customRangeBtn+"')").on("click",function(e){var $calendarControl=$(".daterangepicker.dropdown-menu");$calendarControl.hasClass("show-calendar")&&(e.stopPropagation(),$calendarControl.removeClass("show-calendar"))})}function addLimit(){var opt=notificationCtrl.data;opt.searchInfo.limit++}function subLimit(){var opt=notificationCtrl.data;opt.searchInfo.limit>0&&opt.searchInfo.limit--}function showDialog(index){var opt=notificationCtrl.data,optModal=NotificationModalService.data,modalInstance=$uibModal.open({animation:!0,templateUrl:"notificationModal.tmpl.html",controller:"NotificationModalController",controllerAs:"notificationModalCtrl",windowClass:"modal kupModal",size:"",resolve:{selectTableData:function(){return opt.tableDataSource[index]}}});modalInstance.opened.then(function(){optModal.isOpenModal=!0}),modalInstance.result.then(function(){optModal.isOpenModal=!1},function(){optModal.isOpenModal=!1})}var kupOpt=KupOption,i18n=UtilsService.i18n,notification=UtilsService.notification,mainCtrl=(UtilsService.block,$scope.$parent.mainCtrl),notificationCtrl=this;notificationCtrl.data=NotificationService.data,notificationCtrl.data.uiTable={dtInstance:{},options:DTOptionsBuilder.newOptions().withLanguage(UtilsService.getAngularDatatablesI18n()).withPaginationType("full_numbers").withOption("paging",!0).withOption("info",!0).withOption("responsive",!0).withOption("ordering",!1).withOption("processing",!0).withDisplayLength(kupOpt.datatables.displayLength).withOption("fnRowCallback",function(nRow,aData,iDisplayIndex,iDisplayIndexFull){return $("td",nRow).bind("click",function(){var $tbody=$(this).parents("tbody"),index=$tbody.find("tr").index($(this).parent("tr"));$tbody.find("tr").removeClass("kupActive"),$(this).parent("tr").addClass("kupActive"),$scope.$apply(function(){showDialog(index)})}),nRow}).withOption("serverSide",!0).withDataProp("data").withFnServerData(function(sSource,aoData,fnCallback,oSettings){var draw=aoData[0].value,start=(aoData[2].value,aoData[3].value),length=aoData[4].value,pageParam={skip:start,take:length};oSettings.jqXHR=NotificationService.getAlertsApi(pageParam)["finally"](function(){setTableData();var opt=notificationCtrl.data,records={draw:draw,recordsTotal:opt.apiAlertsTotal,recordsFiltered:opt.apiAlertsTotal,data:opt.tableDataSource};fnCallback(records)})}),columnDefs:[DTColumnBuilder.newColumn("timeLocal").withTitle(i18n("date-time")),DTColumnBuilder.newColumn("alertTypeText").withTitle(i18n("device-label")),DTColumnBuilder.newColumn("eventTypeText").withTitle(i18n("event-type")),DTColumnBuilder.newColumn("location").withTitle(i18n("happened-at"))]},notificationCtrl.fn={exportReport:exportReport,generateReport:generateReport,clearSearch:clearSearch,addLimit:addLimit,subLimit:subLimit},init()}]);