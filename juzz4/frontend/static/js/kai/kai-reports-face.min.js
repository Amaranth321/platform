angular.module("kai.reports.face",[]),angular.module("kai.reports.face").factory("FaceService",["KupOption","UtilsService","PromiseFactory","KupApiService","ReportsService","AuthTokenFactory","$filter","$q","$timeout",function(KupOption,UtilsService,PromiseFactory,KupApiService,ReportsService,AuthTokenFactory,$filter,$q,$timeout){function setInitData(){data.isScrollingload=!1,data.eventsCountTotal=0,data.eventsCountCurrect=0,data.uiSelectionBar.isShow=!1,data.uiNodata.isShow=!0,data.uiSortItems.isShow=!1,data.uiGridList={total:[],select:[],img:{}}}function getAnalyticsReportApi(isDefer){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,selectedDeviceList=reportsOpt.selectedDevices[0].platformDeviceId,fromDateUTC=(reportsOpt.selectedDevices[0].channelId,kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),data.timeFormat2)),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),data.timeFormat2),param={"event-type":vcaEventType,"device-id":JSON.stringify(selectedDeviceList),"channel-id":"",from:fromDateUTC,to:toDateUTC,parameters:JSON.stringify({})},onSuccess=function(response){opt.apiAnalyticsReportList=response.data||[]},onFail=function(response){opt.apiAnalyticsReportList=[]},onError=function(){opt.apiAnalyticsReportList=[]};return ajaxPost("getanalyticsreport",param,onSuccess,onFail,onError,isDefer)}function getEventsApi(isDefer,isAll){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,selectedDeviceList=reportsOpt.selectedDevices[0].devicePairs[0].coreDeviceId,selectedChannelList=reportsOpt.selectedDevices[0].devicePairs[0].channelId,fromDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),data.timeFormat2),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),data.timeFormat2),fieldList=["time","deviceName","deviceId","channelId","blobId","data"],take=isAll?0:opt.eventsCountRange,skip=isAll?0:opt.eventsCountCurrect,param={"event-type":vcaEventType,"event-id":"",skip:skip,take:take,"device-id":selectedDeviceList.toString(),"channel-id":selectedChannelList.toString(),bound:null,rad:null,from:fromDateUTC,to:toDateUTC,fields:fieldList.join()},onSuccess=function(response){isAll?(opt.apiAllEventsList=response.events||[],opt.apiAllEventsCount=response.totalcount||0):(opt.apiEventsList=response.events||[],opt.apiEventsCount=response.totalcount||0)},onFail=function(response){isAll?(opt.apiAllEventsList=[],opt.apiAllEventsCount=0):(opt.apiEventsList=[],opt.apiEventsCount=0)},onError=function(){isAll?(opt.apiAllEventsList=[],opt.apiAllEventsCount=0):(opt.apiEventsList=[],opt.apiEventsCount=0)};return ajaxPost("getevents",param,onSuccess,onFail,onError,isDefer)}function getEventBlobApi(eventData){var opt=data,eventId=eventData.id,blobId=eventData.blobId,param={"event-id":eventId,"blob-id":blobId},onSuccess=(reports.data,function(response){null!=response["image-base64"]&&response["image-base64"].length>100?opt.apiEventBlobBase64Img="data:image/jpeg;base64,"+response["image-base64"]:opt.apiEventBlobBase64Img="",opt.uiGridList.img[eventData.id]&&(opt.uiGridList.img[eventData.id].isLoading=!1,opt.uiGridList.img[eventData.id].url=opt.apiEventBlobBase64Img)}),onFail=function(response){opt.uiGridList.img[eventData.id]&&(opt.uiGridList.img[eventData.id].isLoading=!1,opt.uiGridList.img[eventData.id].url="")},onError=function(){opt.uiGridList.img[eventData.id]&&(opt.uiGridList.img[eventData.id].isLoading=!1,opt.uiGridList.img[eventData.id].url="")};return ajaxPost("geteventbinarydata",param,onSuccess,onFail,onError)}function setGridListData(){var opt=data,tmpGridList=angular.copy(opt.apiEventsList),tmpGridListForImg={};opt.eventsCountTotal=opt.apiEventsCount,$.each(tmpGridList,function(i,grid){grid.data&&(grid.data=angular.fromJson(grid.data),grid.duration=parseInt(grid.data.duration,10),grid.durationSec=parseFloat((grid.data.duration/1e3).toFixed(1),10)),grid.time&&(grid.timeStamp=function(){var time=grid.time.split(/\D/),timeStamp="";return timeStamp=new Date(time[2],time[1]-1,time[0],time[3],time[4],time[5]).getTime()}(),grid.timeLocal=UtilsService.UTCToLocal(grid.timeStamp),grid.timeLocalStamp=grid.timeLocal.getTime(),grid.dateFormat=kendo.toString(grid.timeLocal,opt.timeFormat1).split(" ")[0],grid.timeFormat=kendo.toString(grid.timeLocal,opt.timeFormat1).split(" ")[1]),grid.isSelect||(grid.isSelect=!1),tmpGridListForImg[grid.id]={eventId:grid.id,blobId:grid.blobId,url:"",isLoading:!0}}),opt.isScrollingload?(opt.eventsCountCurrect=function(){var all=opt.eventsCountCurrect+tmpGridList.length,count=0;return count=all>opt.apiEventsCount?opt.eventsCountTotal:all}(),opt.uiGridList.total=opt.uiGridList.total.concat(tmpGridList),opt.uiGridList.img=$.extend(opt.uiGridList.img,tmpGridListForImg)):(opt.eventsCountCurrect=function(){var all=opt.eventsCountTotal,count=0;return count=all>opt.eventsCountRange?opt.eventsCountRange:all}(),opt.uiGridList.total=tmpGridList,opt.uiGridList.img=tmpGridListForImg)}function sortGridList(){var sortType=getCurrectSortItems().name;"new-to-old"==sortType&&(data.uiGridList.total=$filter("orderBy")(data.uiGridList.total,["-timeLocalStamp"])),"old-to-new"==sortType&&(data.uiGridList.total=$filter("orderBy")(data.uiGridList.total,["+timeLocalStamp"])),"low-to-high"==sortType&&(data.uiGridList.total=$filter("orderBy")(data.uiGridList.total,["+duration"])),"high-to-low"==sortType&&(data.uiGridList.total=$filter("orderBy")(data.uiGridList.total,["-duration"]))}function exportCsvApi(periodType){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,dvcId=reportsOpt.selectedInstance,fromDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),opt.timeFormat2),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),opt.timeFormat2),param={"file-format":"csv","event-type":vcaEventType,from:fromDateUTC,to:toDateUTC,"time-zone-offset":KupApiService.data.timeZoneOffset,"device-id":dvcId[0].platformDeviceId,"channel-id":dvcId[0].channelId};return KupApiService.exportDoc(param,"exportdatalogs")}function exportPdfApi(){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,deviceName=function(){var name="";return $.each(reportsOpt.selectedItemDataList,function(uid,itemData){return!!$.isEmptyObject(itemData)||void(itemData.isCamera&&(name=itemData.deviceName))}),name}(),channelName=function(){var name="";return $.each(reportsOpt.selectedItemDataList,function(uid,itemData){return!!$.isEmptyObject(itemData)||void(itemData.isCamera&&(name=itemData.cameraName))}),name}(),eventIds=function(){var idList=[];return $.each(opt.apiAllEventsList,function(i,eventData){idList.push(eventData.id)}),idList}(),reportInfo={"event-type":vcaEventType,"device-name":deviceName,channel:channelName,from:kendo.toString(reportsOpt.dateRange.startDate,opt.timeFormat1),to:kendo.toString(reportsOpt.dateRange.endDate,opt.timeFormat1),"total-results":opt.apiAllEventsCount+""},param={"time-zone-offset":KupApiService.data.timeZoneOffset,"svg-string":"","report-info":JSON.stringify(reportInfo),"event-ids":JSON.stringify(eventIds)};return KupApiService.exportDoc(param,"exportfaceindexingpdf")}function getCurrectSortItems(){var sortItems=[];return $.each(data.uiSortItems.list,function(i,list){if(list.isActive)return sortItems=list,!1}),sortItems}function generateGridList(){var opt=data;return getEventsApi(!0)["finally"](function(){setGridListData(),sortGridList(),$.each(opt.apiEventsList,function(i,et){getEventBlobApi(et)})})}function generateReport(){setInitData();var opt=data;if($.each(opt.requestForReport,function(i,request){request.cancel&&request.cancel()}),!reports.isSelectCamera())return notification("error",i18n("no-channel-selected")),reports.isSuccessReport(!1),!1;if(!reports.isSingleCamera())return notification("error",i18n("multiple-device-channel-not-supported")),reports.isSuccessReport(!1),!1;opt.requestForReport=[getAnalyticsReportApi(!0),generateGridList()];var dfd=$q.defer();return $timeout(function(){$q.all(opt.requestForReport)["finally"](function(){return opt.apiEventsList.length<=0?(reports.isSuccessReport(!1),opt.uiSortItems.isShow=!1,void dfd.reject()):(reports.isSuccessReport(!0),opt.uiSortItems.isShow=!0,void dfd.resolve())})},500),dfd.promise}var kupOpt=KupOption,utils=UtilsService,i18n=UtilsService.i18n,notification=UtilsService.notification,ajaxPost=KupApiService.ajaxPost,reports=ReportsService,data={isScrollingload:!1,timeFormat0:"yyyy/MM/dd HH:mm:ss",timeFormat1:"dd/MM/yyyy HH:mm:ss",timeFormat2:"ddMMyyyyHHmmss",apiAnalyticsReportList:[],apiEventsList:[],apiEventsCount:0,apiEventBlobBase64Img:"",apiAllEventsList:[],apiAllEventsCount:0,eventsCountTotal:0,eventsCountCurrect:0,eventsCountRange:18,requestForReport:[],uiGridList:{total:[],select:[],img:{}},uiSelectionBar:{isShow:!1},uiLoading:{isShow:!1},uiNodata:{isShow:!0},uiSortItems:{isShow:!1,isDropdownOpen:!1,list:[{name:"new-to-old",type:"date",isActive:!0},{name:"old-to-new",type:"date",isActive:!1},{name:"low-to-high",type:"duration",isActive:!1},{name:"high-to-low",type:"duration",isActive:!1}]},uiExport:{isOpen:!1}};return{data:data,getAnalyticsReportApi:getAnalyticsReportApi,getEventsApi:getEventsApi,getEventBlobApi:getEventBlobApi,exportCsvApi:exportCsvApi,exportPdfApi:exportPdfApi,generateReport:generateReport,generateGridList:generateGridList,setInitData:setInitData,setGridListData:setGridListData,sortGridList:sortGridList,getCurrectSortItems:getCurrectSortItems}}]),angular.module("kai.reports.face").controller("FaceController",["KupOption","RouterStateService","UtilsService","PromiseFactory","AuthTokenFactory","ReportsService","FaceService","$scope","$window","$q",function(KupOption,RouterStateService,UtilsService,PromiseFactory,AuthTokenFactory,ReportsService,FaceService,$scope,$window,$q){function init(){$scope.$watch(function(){return angular.toJson(reports.data)},function(newVal,oldVal){var reportsOpt=angular.fromJson(newVal);faceCtrl.data.uiNodata.isShow=!reportsOpt.isSuccessReport},!0),FaceService.setInitData()}function selectGridList(id){var gridList=faceCtrl.data.uiGridList.total;if(id){if(faceCtrl.data.uiGridList.img[id].isLoading)return!1;if(!faceCtrl.data.uiGridList.img[id].url)return!1;$.each(gridList,function(i,grid){return grid.id!=id||void(grid.isSelect=!grid.isSelect)})}id||$.each(gridList,function(i,grid){grid.isSelect=!1}),$.each(gridList,function(i,grid){grid.isSelect?($("#"+grid.id).addClass("kupItemSelected"),$("#"+grid.id).find(".fa-circle-thin").addClass("fa-check")):($("#"+grid.id).removeClass("kupItemSelected"),$("#"+grid.id).find(".fa-circle-thin").removeClass("fa-check"))}),setSelectedGridData(),showSelection()}function showSelection(){var check=faceCtrl.data.uiGridList.select.length>0;faceCtrl.data.uiSelectionBar.isShow=check}function setSelectedGridData(){var selectedGrid=[];return $.each(faceCtrl.data.uiGridList.total,function(i,grid){$.each(faceCtrl.data.uiGridList.img,function(id,imgData){if(id==grid.id&&grid.isSelect){var tmpData=angular.copy(grid);return tmpData.imgUrl=imgData.url,selectedGrid.push(tmpData),!1}})}),faceCtrl.data.uiGridList.select=selectedGrid,selectedGrid}function clearSelection(){selectGridList()}function setCurrectSortItems(index){$.each(faceCtrl.data.uiSortItems.list,function(i,list){list.isActive=index==i})}function getCurrectSortItems(){return FaceService.getCurrectSortItems()}function sortGridList(){FaceService.sortGridList()}function scrollingloadGridList(){var opt=faceCtrl.data;return!!reports.isSuccessReport()&&(!opt.uiLoading.isShow&&(!(opt.eventsCountCurrect>=opt.eventsCountTotal)&&(opt.isScrollingload=!0,opt.uiLoading.isShow=!0,void FaceService.generateGridList()["finally"](function(){opt.isScrollingload=!1,opt.uiLoading.isShow=!1}))))}function downloadImg(){var zip=new JSZip,imgData=faceCtrl.data.uiGridList.select,zipName=i18n("download")+".zip",dirName=i18n("images"),zipData=zip.folder(dirName);$.each(imgData,function(i,img){var imgName=function(){var time=img.time.split(/\D/),imgName=time[2]+time[1]+time[0]+"_"+time[3]+time[4]+time[5]+".jpg";return imgName}(),imgData=img.imgUrl?img.imgUrl.substr(img.imgUrl.indexOf(",")+1):"";zipData.file(imgName,imgData,{base64:!0})}),window.location="data:application/zip;base64,"+zip.generate({type:"base64"}+zipName)}function exportCsv(){if(!reports.isSuccessReport())return notification("error",i18n("please-generate-reports")),!1;var warningNotify=notification("warning",i18n("exporting-to-csv"),0);FaceService.exportCsvApi()["finally"](function(){warningNotify.close()})}function exportPdf(){var opt=faceCtrl.data;if(!reports.isSuccessReport())return notification("error",i18n("please-generate-reports")),!1;var warningNotify=notification("warning",i18n("exporting-to-pdf"),0);opt.apiAllEventsCount?FaceService.exportPdfApi()["finally"](function(){warningNotify.close()}):FaceService.getEventsApi(!1,!0)["finally"](function(){FaceService.exportPdfApi()["finally"](function(){warningNotify.close()})})}var i18n=UtilsService.i18n,notification=UtilsService.notification,reports=ReportsService,faceCtrl=this;faceCtrl.data=FaceService.data,faceCtrl.fn={showSelection:showSelection,clearSelection:clearSelection,downloadImg:downloadImg,setCurrectSortItems:setCurrectSortItems,getCurrectSortItems:getCurrectSortItems,sortGridList:sortGridList,selectGridList:selectGridList,scrollingloadGridList:scrollingloadGridList,exportPdf:exportPdf,exportCsv:exportCsv},init()}]);