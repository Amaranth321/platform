angular.module("kai.label",["kendo.directives"]),angular.module("kai.label").factory("LabelModalService",["KupOption","UtilsService","KupApiService","PromiseFactory","AuthTokenFactory","DeviceTreeService",function(KupOption,UtilsService,KupApiService,PromiseFactory,AuthTokenFactory,DeviceTreeService){function setLabelType(selectData){var labelType=[{name:"store",value:"STORE","class":"kup-store",isSelect:!0,isShow:!0},{name:"geographic-area",value:"REGION","class":"kup-GeographicArea",isSelect:!1,isShow:!1},{name:"other",value:"OTHERS","class":"fa-tag",isSelect:!1,isShow:!0}];return selectData&&$.each(labelType,function(i,type){type.value===selectData?type.isSelect=!0:type.isSelect=!1}),labelType}function setLabelFormLocation(selectData){var location={address:"",lat:0,lng:0,timeZoneId:""};return selectData&&(location=selectData),location}function setLabelFormOccupancy(selectData){var occupancy={isSelect:!1,rule:[{value:100,msg:""}],ruleDefault:{value:100,msg:""}};return selectData&&(occupancy.isSelect=selectData.enabled,selectData.limits&&(occupancy.rule=function(){var tmpAry=[];return $.each(selectData.limits,function(i,limit){tmpAry.push({value:limit.limit,msg:limit.alertMessage})}),tmpAry}())),occupancy}function setLabelFormHolidays(selectData){var holidays=[{name:"mon",nameFull:"monday",value:1,isSelect:!1},{name:"tue",nameFull:"tuesday",value:2,isSelect:!1},{name:"wed",nameFull:"wednesday",value:3,isSelect:!1},{name:"thu",nameFull:"thursday",value:4,isSelect:!1},{name:"fri",nameFull:"friday",value:5,isSelect:!1},{name:"sat",nameFull:"saturday",value:6,isSelect:!1},{name:"sun",nameFull:"sunday",value:7,isSelect:!1}];return selectData&&$.each(holidays,function(i,day){$.each(selectData,function(j,val){if(day.value===val)return day.isSelect=!0,!1})}),holidays}function setLabelFormPeriods(selectData){var periods={everyday:{value:"EVERYDAY",isSelect:!0,rule:[{weekStart:1,weekEnd:7,timeStart:28800,timeEnd:64800}]},nonStop:{value:"NON_STOP",isSelect:!1,rule:{timeLowest:28800}},custom:{value:"CUSTOM",isSelect:!1,rule:[{weekStart:1,weekEnd:5,timeStart:28800,timeEnd:64800}],ruleDefault:{weekStart:1,weekEnd:5,timeStart:28800,timeEnd:64800}}};return selectData&&$.each(periods,function(type,periodData){periodData.value===selectData.repeat?(periodData.isSelect=!0,"NON_STOP"===selectData.repeat?periodData.rule={timeLowest:parseInt(60*selectData.lowestTrafficHour*60)}:(periodData.rule=[],$.each(selectData.periods,function(i,periodData2){periodData.rule.push({weekStart:periodData2.from,weekEnd:periodData2.to,timeStart:60*periodData2.period.startMinutes,timeEnd:60*periodData2.period.endMinutes})}))):periodData.isSelect=!1}),periods}function initLabelForm(){var opt=data;opt.uiLabelForm={labelName:"",labelType:setLabelType(),location:setLabelFormLocation(),occupancy:setLabelFormOccupancy(),holidays:setLabelFormHolidays(),periods:setLabelFormPeriods()},console.log(opt.uiLabelForm)}function updateLabelForm(labelData){var opt=data;labelData?opt.uiLabelForm={labelName:labelData.labelName,labelType:setLabelType(labelData.data.type),location:setLabelFormLocation(labelData.data.info.location||!1),occupancy:setLabelFormOccupancy(labelData.data.info.occupancySettings||!1),holidays:setLabelFormHolidays(labelData.data.info.schedule&&labelData.data.info.schedule.holidays||[]),periods:setLabelFormPeriods(labelData.data.info.schedule&&labelData.data.info.schedule.weeklyPeriods)}:initLabelForm()}function setTimePicker(){for(var timePicker=[],config={},hours=24,padLeft=function(str,len){return str=""+str,str.length>=len?str:new Array(len-str.length+1).join("0")+str},timeToSec=function(hour,min,sec){return hour=parseInt(hour,10)||0,min=parseInt(min,10)||0,sec=parseInt(sec,10)||0,60*hour*60+60*min+sec},i=0;i<hours;i++)config={name:padLeft(i,2)+" : 00",value:timeToSec(i)},timePicker.push(config);return timePicker}function getSelectLabelType(){var opt=data,labelType={};return $.each(opt.uiLabelForm.labelType,function(i,type){if(type.isSelect)return labelType=type.value,!1}),labelType}function getSelectPeriodsType(){var opt=data,periodsType={};return $.each(opt.uiLabelForm.periods,function(type,time){if(time.isSelect)return periodsType=type,!1}),periodsType}function getSelectHolidays(){var opt=data,holidays=[];return $.each(opt.uiLabelForm.holidays,function(i,dayData){dayData.isSelect&&holidays.push(dayData.value)}),holidays}function getPeriodsOfDays(){var opt=data,periodsType=getSelectPeriodsType(),periodsOfDays=[],secToMin=function(sec){return Math.round(sec/60)};return $.each(opt.uiLabelForm.periods[periodsType].rule,function(i,rule){var config={from:rule.weekStart,to:rule.weekEnd,period:{startMinutes:secToMin(rule.timeStart),endMinutes:secToMin(rule.timeEnd)}};periodsOfDays.push(config)}),periodsOfDays}var data=(UtilsService.i18n,UtilsService.notification,KupApiService.ajaxPost,{currectStep:0,isOpenModal:!1,isUpdateMode:!1,isMapSuccessLoad:!1,timePicker:setTimePicker(),uiLabelForm:{labelName:"",labelType:setLabelType(),location:setLabelFormLocation(),occupancy:setLabelFormOccupancy(),holidays:setLabelFormHolidays(),periods:setLabelFormPeriods()},uiModal:{isShowSaveMap:!1,isShowCancel:!1,isShowSave:!1,isShowNext:!1,isSshowPrev:!1}});return{data:data,initLabelForm:initLabelForm,updateLabelForm:updateLabelForm,setTimePicker:setTimePicker,getSelectLabelType:getSelectLabelType,getSelectPeriodsType:getSelectPeriodsType,getSelectHolidays:getSelectHolidays,getPeriodsOfDays:getPeriodsOfDays}}]),angular.module("kai.label").factory("LabelService",["KupOption","UtilsService","KupApiService","PromiseFactory","AuthTokenFactory","DeviceTreeService","LabelModalService","$filter",function(KupOption,UtilsService,KupApiService,PromiseFactory,AuthTokenFactory,DeviceTreeService,LabelModalService,$filter){function setInitData(){return data=angular.copy(initData)}function getDeviceTree(){return DeviceTreeService.initDeviceTree()["finally"](function(){setTreeList(),setLabelList()})}function getSelectLabel(){var opt=data,labelData="";return $.each(opt.uiLabels.listByFilter,function(i,label){if(label.isSelect)return labelData=label,!1}),labelData}function getLabelById(id){var labelData,opt=data;return $.each(opt.uiLabels.listByFilter,function(i,label){id===label.labelId&&(labelData=label)}),labelData}function setTreeList(){var opt=data,treeItems=DeviceTreeService.getDeviceTree();opt.uiTreeview.list=function(){var tree=angular.copy(treeItems),treeList=[];return $.each(tree,function(i,label){if(label.isAll){var deviceData=label.items;$.each(deviceData,function(j,device){!device.isNode}),treeList.push(label)}}),treeList}()}function setLabelList(){var opt=data,treeItems=DeviceTreeService.getDeviceTree();opt.uiLabels.list=function(){var tree=angular.copy(treeItems),labelList=[];return $.each(tree,function(i,label){label.isLabel&&labelList.push(label)}),$.each(labelList,function(i,label){label.isSelect=!1,label.isUpdateShow=!1}),labelList}(),opt.uiLabels.list=$filter("orderBy")(opt.uiLabels.list,"+text")}function setSelectLabel(index){index=index||0;var opt=data;$.each(opt.uiLabels.listByFilter,function(i,label){label.isSelect=i===index})}function setSelectLabelById(id){var opt=data;$.each(opt.uiLabels.listByFilter,function(i,label){label.labelId===id?label.isSelect=!0:label.isSelect=!1})}function setCameraList(index){index=index||0;var opt=data;opt.uiLabels.selectCameraList=[],opt.uiLabels.selectCameraListByFilter=[],$.each(opt.uiLabels.listByFilter,function(i,label){var labelData=label.items;i===index&&$.each(labelData,function(j,device){var deviceData=device.items;$.each(deviceData,function(k,camera){var cameraData=camera,vcaData=cameraData.filterVca.split(",");cameraData.vca=[],$.each(vcaData,function(k,vcaName){$.each(KupOption.vca,function(key,vcaOpt){if(vcaOpt.analyticsType===vcaName)return cameraData.vca.push(vcaOpt),!1})}),opt.uiLabels.selectCameraList.push(cameraData)})})}),opt.uiLabels.selectCameraList=$filter("orderBy")(opt.uiLabels.selectCameraList,["+data.deviceName","+text"]),opt.uiLabels.selectCameraListByFilter=angular.copy(opt.uiLabels.selectCameraList)}function setCameraListById(id){var opt=data;opt.uiLabels.selectCameraList=[],opt.uiLabels.selectCameraListByFilter=[],$.each(opt.uiLabels.listByFilter,function(i,label){var labelData=label.items;label.labelId===id&&$.each(labelData,function(j,device){var deviceData=device.items;$.each(deviceData,function(k,camera){var cameraData=camera,vcaData=cameraData.filterVca.split(",");cameraData.vca=[],$.each(vcaData,function(k,vcaName){$.each(KupOption.vca,function(key,vcaOpt){if(vcaOpt.analyticsType===vcaName)return cameraData.vca.push(vcaOpt),!1})}),opt.uiLabels.selectCameraList.push(cameraData)})})}),opt.uiLabels.selectCameraList=$filter("orderBy")(opt.uiLabels.selectCameraList,["+data.deviceName","+text"]),opt.uiLabels.selectCameraListByFilter=angular.copy(opt.uiLabels.selectCameraList)}function filterLabelList(searchVal){var opt=data;opt.uiLabels.listByFilter=$filter("filter")(opt.uiLabels.list,{text:searchVal})}function filterCameraList(searchVal){var opt=data;opt.uiLabels.selectCameraListByFilter=$filter("filter")(opt.uiLabels.selectCameraList,function(value,index,array){var check1=!1,check2=!1,filterRegExp=new RegExp(searchVal,"i");return value.text&&(check1=filterRegExp.test(value.text)),value.data&&(check2=filterRegExp.test(value.data.deviceName)),check1||check2})}function addLabelApi(){var optModal=LabelModalService.data,optModalForm=optModal.uiLabelForm,labelName=optModal.uiLabelForm.labelName,labelType=LabelModalService.getSelectLabelType(),periodsType=LabelModalService.getSelectPeriodsType(),labelInfo={};!function(){"OTHERS"!==labelType&&(labelInfo={location:{},schedule:{}},labelInfo.location=optModalForm.location,labelInfo.schedule.holidays=LabelModalService.getSelectHolidays(),labelInfo.schedule.weeklyPeriods={},labelInfo.schedule.weeklyPeriods.repeat=optModalForm.periods[periodsType].value,"nonStop"===periodsType?labelInfo.schedule.weeklyPeriods.lowestTrafficHour=parseInt(optModalForm.periods[periodsType].rule.timeLowest/60/60,10):(labelInfo.schedule.weeklyPeriods.periods=LabelModalService.getPeriodsOfDays(),labelInfo.schedule.weeklyPeriods.lowestTrafficHour=0))}();var param={"label-name":labelName,"label-type":labelType,"label-info":JSON.stringify(labelInfo)},onSuccess=function(response){},onFail=function(response){},onError=function(){};return ajaxPost("addlabel",param,onSuccess,onFail,onError)}function updateLabelApi(param){var optModal=LabelModalService.data,optModalForm=optModal.uiLabelForm,labelId=param.labelId,labelName=optModal.uiLabelForm.labelName,labelType=LabelModalService.getSelectLabelType(),periodsType=LabelModalService.getSelectPeriodsType(),labelInfo={};!function(){"OTHERS"!==labelType&&(labelInfo={location:{},schedule:{}},labelInfo.location=optModalForm.location,labelInfo.schedule.holidays=LabelModalService.getSelectHolidays(),labelInfo.schedule.weeklyPeriods={},labelInfo.schedule.weeklyPeriods.repeat=optModalForm.periods[periodsType].value,"nonStop"===periodsType?labelInfo.schedule.weeklyPeriods.lowestTrafficHour=parseInt(optModalForm.periods[periodsType].rule.timeLowest/60/60,10):(labelInfo.schedule.weeklyPeriods.periods=LabelModalService.getPeriodsOfDays(),labelInfo.schedule.weeklyPeriods.lowestTrafficHour=0))}();var param={"label-id":labelId,"label-name":labelName,"label-type":labelType,"label-info":JSON.stringify(labelInfo)},onSuccess=function(response){},onFail=function(response){},onError=function(){};return ajaxPost("updatelabel",param,onSuccess,onFail,onError)}function removeLabelApi(param){var labelId=param.labelId,param={"label-id":labelId},onSuccess=function(response){},onFail=function(response){},onError=function(){};return ajaxPost("removelabel",param,onSuccess,onFail,onError)}function assignChannelLabelApi(param){var param={"label-id":param.labelId,"platform-device-id":param.platformDeviceId,"channel-id":param.cameraId},onSuccess=function(response){},onFail=function(response){},onError=function(){};return ajaxPost("assignchannellabel",param,onSuccess,onFail,onError)}function unassignChannelLabelApi(param){var param={"label-id":param.labelId,"platform-device-id":param.platformDeviceId,"channel-id":param.cameraId},onSuccess=function(response){},onFail=function(response){},onError=function(){};return ajaxPost("unassignchannellabel",param,onSuccess,onFail,onError)}function selectLabel(index){setSelectLabel(index),setCameraList(index)}function selectLabelById(id){setSelectLabelById(id),setCameraListById(id)}function setFilterLabelCamera(){filterLabelList(),filterCameraList()}var kupOpt=KupOption,ajaxPost=(UtilsService.i18n,UtilsService.notification,KupApiService.ajaxPost),data={$section:"#labelSection",$treeview:"#labelTreeview",$search:"#labelSearch",$dragTarget:"#labelDragTarget",uiMenu:{isShow:!0},uiFilterVca:{isOpen:!1,list:function(){var list=[];return $.each(kupOpt.vca,function(i,vca){list.push({name:vca.name,type:vca.analyticsType,isActive:!1})}),list.unshift({name:"all",type:"ALL",isActive:!0}),list}()},uiTreeview:{data:{},options:{},list:[],searchValue:""},uiDragTarget:{data:{},options:{},list:[],isShow:!1},uiLabels:{list:[],listByFilter:[],searchLabelValue:"",selectCameraList:[],selectCameraListByFilter:[],searchCameraValue:"",isAddShow:!1,updateValue:"",addValue:"",classCount:5},uiGuider:{isShow:!0}},initData=angular.copy(data);return{data:data,initData:initData,setInitData:setInitData,setTreeList:setTreeList,setLabelList:setLabelList,setSelectLabel:setSelectLabel,setSelectLabelById:setSelectLabelById,setCameraList:setCameraList,setCameraListById:setCameraListById,filterLabelList:filterLabelList,filterCameraList:filterCameraList,getDeviceTree:getDeviceTree,getSelectLabel:getSelectLabel,getLabelById:getLabelById,selectLabel:selectLabel,selectLabelById:selectLabelById,setFilterLabelCamera:setFilterLabelCamera,addLabelApi:addLabelApi,removeLabelApi:removeLabelApi,updateLabelApi:updateLabelApi,assignChannelLabelApi:assignChannelLabelApi,unassignChannelLabelApi:unassignChannelLabelApi}}]),angular.module("kai.label").controller("LabelModalController",["KupOption","RouterStateService","UtilsService","PromiseFactory","AuthTokenFactory","LabelService","LabelModalService","GoogleMapService","$scope","$rootScope","$timeout","$uibModalInstance","updateLabelData",function(KupOption,RouterStateService,UtilsService,PromiseFactory,AuthTokenFactory,LabelService,LabelModalService,GoogleMapService,$scope,$rootScope,$timeout,$uibModalInstance,updateLabelData){function init(){var opt=labelModalCtrl.data;opt.currectStep=1,opt.isUpdateMode=!!updateLabelData,LabelModalService.updateLabelForm(updateLabelData),setWatch()}function setWatch(){$scope.$watch("labelModalCtrl.data.uiLabelForm.location",function(newVal,oldVal){console.warn(newVal)},!0),$scope.$watch("labelModalCtrl.data.uiLabelForm.occupancy.value",function(newVal,oldVal){/\D/.test(newVal)&&(labelModalCtrl.data.uiLabelForm.occupancy.value=0)},!0),$scope.$watch("labelModalCtrl.data.uiLabelForm.labelType",function(newVal,oldVal){showBtn()},!0),$scope.$watch(function(){return GoogleMapService.data.isSuccessLoad},function(newVal,oldVal){var opt=labelModalCtrl.data;opt.isMapSuccessLoad=newVal},!0),$scope.$watch(function(){return GoogleMapService.data.searchMap},function(newVal,oldVal){newVal.isSuccessSearch!==oldVal.isSuccessSearch&&showBtn()},!0),$scope.$watch(function(){return GoogleMapService.data.searchBox},function(newVal,oldVal){var opt=labelModalCtrl.data;newVal.isTriggerSearch&&(""!=oldVal.location&&(newVal.isTriggerSearch=!1),opt.uiLabelForm.location={address:newVal.location,lat:newVal.lat,lng:newVal.lng,timeZoneId:newVal.timeZoneId})},!0),$scope.$watch("labelModalCtrl.data.currectStep",function(newVal,oldVal){var opt=labelModalCtrl.data,searchBoxTimer=function(){$timeout(function(){return $(".pac-container").length<=0?(searchBoxTimer(),!1):void $(".pac-container").css("z-index",1e5)},300)};if(2===newVal){var loadSearchBoxTimer=function(){$timeout(function(){return"none"===$("#labelStep2").css("display")?(loadSearchBoxTimer(),!1):(GoogleMapService.loadSearchBox("labelSearchBox"),void searchBoxTimer())},300)};loadSearchBoxTimer()}if(3===newVal){var loadSearchMapTimer=function(){$timeout(function(){return"none"===$("#labelStep3").css("display")?(loadSearchMapTimer(),!1):(GoogleMapService.loadSearchMap("labelSearchMap","labelSearchBoxForMap",opt.uiLabelForm.location.address),void searchBoxTimer())},300)};loadSearchMapTimer()}showBtn()},!0)}function closeModal(){$uibModalInstance.close()}function cancelModal(){$uibModalInstance.dismiss("cancel")}function selectLabelType(index){var opt=labelModalCtrl.data;$.each(opt.uiLabelForm.labelType,function(i,type){type.isSelect=i===index})}function selectOccupancy(isSelect){var opt=labelModalCtrl.data;opt.uiLabelForm.occupancy.isSelect=isSelect}function addOccupancy(index){var opt=labelModalCtrl.data,rangeNum=100,occupancy=parseInt(opt.uiLabelForm.occupancy.rule[index].value,10);opt.uiLabelForm.occupancy.rule[index].value=occupancy+rangeNum}function subOccupancy(index){var opt=labelModalCtrl.data,rangeNum=100,occupancy=parseInt(opt.uiLabelForm.occupancy.rule[index].value,10);occupancy>=rangeNum?opt.uiLabelForm.occupancy.rule[index].value=occupancy-rangeNum:opt.uiLabelForm.occupancy.rule[index].value=0}function addOccupancyItem(){var opt=labelModalCtrl.data,addItems=angular.copy(opt.uiLabelForm.occupancy.ruleDefault);opt.uiLabelForm.occupancy.rule.push(addItems)}function delOccupancyItem(index){var opt=labelModalCtrl.data;0!==index&&opt.uiLabelForm.occupancy.rule.splice(index,1)}function selectPeriods(periodsType){var opt=labelModalCtrl.data;$.each(opt.uiLabelForm.periods,function(type,data){type===periodsType?data.isSelect||(data.isSelect=!0):data.isSelect=!1})}function addCustomized(){var opt=labelModalCtrl.data,addItems=angular.copy(opt.uiLabelForm.periods.custom.ruleDefault);opt.uiLabelForm.periods.custom.rule.push(addItems)}function delCustomized(index){var opt=labelModalCtrl.data;0!==index&&opt.uiLabelForm.periods.custom.rule.splice(index,1)}function saveModal(){var labelId=updateLabelData.labelId||"",selectLabelType=LabelModalService.getSelectLabelType();return"OTHERS"!==selectLabelType&&$scope.labelForm.labelSearchBox.$invalid?(changeValidStatus("labelSearchBox"),!1):"OTHERS"!==selectLabelType&&$scope.labelForm.labelTimeZoneId.$invalid&&labelModalCtrl.data.isMapSuccessLoad?(changeValidStatus("labelTimeZoneId"),!1):void(labelId?updateLabel(labelId):addLabel())}function addLabel(){return $scope.labelForm.labelName.$invalid?(changeValidStatus("labelName"),!1):void LabelService.addLabelApi().error(function(){notification("error",i18n("server-error"))}).success(function(response){response.reason?notification("error",i18n(response.reason)):(closeModal(),LabelModalService.initLabelForm(),LabelService.getDeviceTree()["finally"](function(){LabelService.setFilterLabelCamera(),LabelService.selectLabelById(response["label-id"])}))})["finally"](function(){})}function updateLabel(labelId){if($scope.labelForm.labelName.$invalid)return changeValidStatus("labelName"),!1;var param={labelId:labelId};LabelService.updateLabelApi(param).error(function(){notification("error",i18n("server-error"))}).success(function(response){response.reason?notification("error",i18n(response.reason)):(closeModal(),LabelModalService.initLabelForm(),LabelService.getDeviceTree()["finally"](function(){LabelService.setFilterLabelCamera(),LabelService.selectLabelById(labelId)}))})["finally"](function(){})}function showBtn(){showPrev(),showNext(),showSave(),showSaveMap(),showCancel()}function showPrev(){var opt=labelModalCtrl.data,isShow=!1;return 2===opt.currectStep&&(isShow=!0),opt.uiModal.isShowPrev=isShow,isShow}function showNext(){var opt=labelModalCtrl.data,isShow=!1;return 1===opt.currectStep&&"OTHERS"!==LabelModalService.getSelectLabelType()&&(isShow=!0),opt.uiModal.isShowNext=isShow,isShow}function showSave(){var opt=labelModalCtrl.data,isShow=!1;return 1===opt.currectStep&&"OTHERS"===LabelModalService.getSelectLabelType()&&(isShow=!0),2===opt.currectStep&&(isShow=!0),opt.uiModal.isShowSave=isShow,isShow}function showSaveMap(){var opt=labelModalCtrl.data,isShow=!1;return 3===opt.currectStep&&GoogleMapService.data.searchMap.isSuccessSearch&&(isShow=!0),opt.uiModal.isShowSaveMap=isShow,isShow}function showCancel(){var opt=labelModalCtrl.data,isShow=!1;return 1===opt.currectStep&&(isShow=!0),opt.uiModal.isShowCancel=isShow,isShow}function changeValidStatus(inputName){$scope.labelForm[inputName].$invalid&&($scope.labelForm[inputName].$dirty=!0)}function goStep(step){var opt=labelModalCtrl.data;return $scope.labelForm.labelName.$invalid?(changeValidStatus("labelName"),!1):void(opt.currectStep=step)}function getSelectLabelType(){return LabelModalService.getSelectLabelType()}function saveMap(){var opt=labelModalCtrl.data,optMap=GoogleMapService.data;opt.currectStep=2,opt.uiLabelForm.location={address:optMap.searchMap.location,lat:optMap.searchMap.lat,lng:optMap.searchMap.lng,timeZoneId:optMap.searchMap.timeZoneId}}function isLabelExist(){var labelOpt=LabelService.data,opt=labelModalCtrl.data,isExist=!1;return opt.isUpdateMode||$.each(labelOpt.uiLabels.list,function(i,label){if(label.labelName===opt.uiLabelForm.labelName)return isExist=!0,!1}),isExist}function isCustomOperationHourInvalid(){var isInvalid=!1;return 2==labelModalCtrl.data.currectStep&&(!!labelModalCtrl.data.uiLabelForm.periods.custom.isSelect&&($.each(labelModalCtrl.data.uiLabelForm.periods.custom.rule,function(index,rule){if(rule.timeEnd<=rule.timeStart)return void(isInvalid=!0)}),isInvalid))}var i18n=UtilsService.i18n,notification=UtilsService.notification,labelModalCtrl=this;labelModalCtrl.data=LabelModalService.data,labelModalCtrl.fn={isLabelExist:isLabelExist,isCustomOperationHourInvalid:isCustomOperationHourInvalid,closeModal:closeModal,cancelModal:cancelModal,saveModal:saveModal,selectLabelType:selectLabelType,selectOccupancy:selectOccupancy,addOccupancy:addOccupancy,subOccupancy:subOccupancy,addOccupancyItem:addOccupancyItem,delOccupancyItem:delOccupancyItem,selectPeriods:selectPeriods,addCustomized:addCustomized,delCustomized:delCustomized,showPrev:showPrev,showNext:showNext,showSave:showSave,showSaveMap:showSaveMap,showCancel:showCancel,goStep:goStep,addLabel:addLabel,updateLabel:updateLabel,getSelectLabelType:getSelectLabelType,saveMap:saveMap},init()}]),angular.module("kai.label").controller("LabelController",["KupOption","RouterStateService","UtilsService","PromiseFactory","AuthTokenFactory","DeviceTreeService","LabelService","LabelModalService","MainService","$scope","$timeout","$q","$location","$uibModal","$log","$animate",function(KupOption,RouterStateService,UtilsService,PromiseFactory,AuthTokenFactory,DeviceTreeService,LabelService,LabelModalService,MainService,$scope,$timeout,$q,$location,$uibModal,$log,$animate){function init(){setWatch()}function setWatch(){$scope.$watch(function(){return angular.toJson(RouterStateService.getRouterState())},function(newVal,oldVal){var routerState=angular.fromJson(newVal).toState,routerCheck=/\.label/.test(routerState.name);return!!routerCheck&&void(mainCtrl.block.promise=loadUI())},!0),$scope.$watch("labelCtrl.data.uiFilterVca.list",function(newVal,oldVal){labelCtrl.data;newVal!==oldVal&&$timeout(function(){setTreeviewForFilter()},300)},!0),$scope.$watch("labelCtrl.data.uiTreeview.searchValue",function(newVal,oldVal){labelCtrl.data;newVal!==oldVal&&$timeout(function(){setTreeviewForFilter()},300)},!0),$scope.$watch("labelCtrl.data.uiLabels.list",function(newVal,oldVal){var opt=labelCtrl.data,searchVal=$.trim(opt.uiLabels.searchLabelValue);newVal!==oldVal&&$timeout(function(){LabelService.filterLabelList(searchVal)},300)},!0),$scope.$watch("labelCtrl.data.uiLabels.selectCameraList",function(newVal,oldVal){var opt=labelCtrl.data,searchVal=$.trim(opt.uiLabels.searchCameraValue);newVal!==oldVal&&$timeout(function(){LabelService.filterCameraList(searchVal)},300)},!0),$scope.$watch("labelCtrl.data.uiLabels.searchLabelValue",function(newVal,oldVal){var searchVal=(labelCtrl.data,$.trim(newVal));newVal!==oldVal&&$timeout(function(){LabelService.filterLabelList(searchVal),LabelService.selectLabel()},300)},!0),$scope.$watch("labelCtrl.data.uiLabels.searchCameraValue",function(newVal,oldVal){var searchVal=(labelCtrl.data,$.trim(newVal));newVal!==oldVal&&$timeout(function(){LabelService.filterCameraList(searchVal)},300)},!0),$scope.$watch("mainCtrl.header.isWrapperToggled",function(newVal,oldVal){var opt=labelCtrl.data;newVal&&(opt.uiGuider.isShow=!1)},!0)}function showMainMenu(checkState){var opt=labelCtrl.data;opt.uiGuider.isShow=!1,MainService.showMainMenu(checkState)}function loadUI(){var dfd=$q.defer();return $timeout(function(){LabelService.getDeviceTree()["finally"](function(){setUI(),dfd.resolve()})}),dfd.promise}function setUI(){setTreeview(),LabelService.setFilterLabelCamera(),LabelService.selectLabel()}function setTreeview(){var opt=labelCtrl.data,treeview=$(opt.$treeview).data("kendoTreeView");treeview.dataSource.filter({}),treeview.dataSource.data(opt.uiTreeview.list)}function getTreeviewOptions(){return{dragAndDrop:!0,template:"# if(item.isOnline == false){ ##=item.text # <i class='fa fa-times-circle-o' uib-tooltip='"+i18n("offline")+"' tooltip-placement='right'></i># } else { ##=item.text ## } #",dataSource:labelCtrl.data.uiTreeview.list,dragstart:function(e){var opt=labelCtrl.data,treeview=$(opt.$treeview).data("kendoTreeView");treeview.dataItem(e.sourceNode).uid;$scope.$apply(function(){opt.uiDragTarget.list=[],opt.uiDragTarget.list.push(treeview.dataItem(e.sourceNode)),LabelService.getSelectLabel()&&(opt.uiDragTarget.isShow=!0)})},drag:function(e){var opt=labelCtrl.data;"labelDragTarget"!==$(e.dropTarget).attr("id")&&"labelDragTarget"!==$(e.dropTarget).parents(opt.$dragTarget).attr("id")||e.setStatusClass("k-add")},drop:function(e){e.preventDefault();var opt=labelCtrl.data;"labelDragTarget"!==$(e.dropTarget).attr("id")&&"labelDragTarget"!==$(e.dropTarget).parents(opt.$dragTarget).attr("id")&&e.setValid(!1),$scope.$apply(function(){opt.uiDragTarget.isShow=!1})}}}function getDragTargetOptions(){return{drop:function(e){var opt=labelCtrl.data;$(opt.$treeview).data("kendoTreeView");$scope.$apply(function(){LabelService.getSelectLabel()&&opt.uiDragTarget.isShow&&addCamera()})}}}function setTreeviewForFilter(){var opt=labelCtrl.data,treeview=$(opt.$treeview).data("kendoTreeView"),filterVcaVal=getCurrectFilterVca(),filterSearchVal=$.trim(labelCtrl.data.uiTreeview.searchValue),filterVca="all"===filterVcaVal.name?{}:{field:"filterVca",operator:"contains",value:filterVcaVal.type},filterSearch=""===filterSearchVal?{}:{field:"filterText",operator:"contains",value:filterSearchVal},filterConfig=function(filterAry){var filter=[];return $.each(filterAry,function(i,data){$.isEmptyObject(data)||filter.push(data)}),0===filter.length&&(filter={}),filter}([filterVca,filterSearch]),filterVcaCheck="all"==filterVcaVal.name?new RegExp(""):new RegExp(filterVcaVal.type),filterSearchCheck=new RegExp(filterSearchVal,"i"),uidExpandList=[],execFilter=function(){treeview.collapse(".k-item"),$.each(treeview.dataSource.data(),function(i,labelData){if(labelData.children){var labelFilterText=function(){var tmpAry=labelData.filterText.split(",");return tmpAry.splice(0,1),tmpAry.toString(",")}();!function(){""===filterSearchVal&&("all"===filterVcaVal.name,"all"!==filterVcaVal.name&&filterVcaCheck.test($.trim(labelData.filterVca))&&uidExpandList.push(labelData.uid)),""!==filterSearchVal&&("all"===filterVcaVal.name&&filterSearchCheck.test($.trim(labelFilterText))&&uidExpandList.push(labelData.uid),"all"!==filterVcaVal.name&&filterSearchCheck.test($.trim(labelFilterText))&&filterVcaCheck.test($.trim(labelData.filterVca))&&uidExpandList.push(labelData.uid))}(),labelData.children.filter(filterConfig),$.each(labelData.children.data(),function(j,deviceData){if(deviceData.children){var deviceFilterText=function(){var tmpAry=deviceData.filterText.split(",");return tmpAry.splice(0,2),tmpAry.toString(",")}();!function(){""===filterSearchVal&&"all"!==filterVcaCheck&&filterVcaCheck.test($.trim(deviceData.filterVca))&&uidExpandList.push(deviceData.uid),""!==filterSearchVal&&("all"===filterVcaCheck&&filterSearchCheck.test($.trim(deviceFilterText))&&uidExpandList.push(deviceData.uid),"all"!==filterVcaCheck&&filterSearchCheck.test($.trim(deviceFilterText))&&filterVcaCheck.test($.trim(deviceData.filterVca))&&uidExpandList.push(deviceData.uid))}(),deviceData.children.filter(filterConfig)}})}}),treeview.dataSource.filter(filterConfig),$.each(uidExpandList,function(i,uid){treeview.expand('[data-uid="'+uid+'"]')})};$timeout(function(){execFilter()})}function setCurrectFilterVca(index){$.each(labelCtrl.data.uiFilterVca.list,function(i,list){list.isActive=index==i})}function getCurrectFilterVca(){var sortItems=[];return $.each(labelCtrl.data.uiFilterVca.list,function(i,list){if(list.isActive)return sortItems=list,!1}),sortItems}function getLabelClass(id){var opt=labelCtrl.data,list=opt.uiLabels.listByFilter,maxNum=opt.uiLabels.classCount,index=function(){var index;return $.each(list,function(i,label){id===label.labelId&&(index=i)}),index}(),classNum=function(){var num=index+1;return num>maxNum&&(num=num%maxNum==0?maxNum:num%maxNum),num}(),key="kupColor"+classNum,tmpObj={};return tmpObj[key]="$index",tmpObj.kupActive=list[index].isSelect,tmpObj}function getLabelTagClass(type){var className;return $.each(LabelModalService.data.uiLabelForm.labelType,function(i,label){type===label.value&&(className=label["class"])}),className}function deleteLabel(labelData,e){e.preventDefault(),e.stopPropagation();var deleteCtrl=function(){var param=(labelCtrl.data,{labelId:labelData.labelId});LabelService.removeLabelApi(param).success(function(){LabelService.getDeviceTree()["finally"](function(){LabelService.setFilterLabelCamera(),LabelService.selectLabel()})}).error(function(response){notification("error",i18n("server-error"))})},msg=i18n("are-you-sure-want-to-delete-label").replace("%s",labelData.labelName);utils.popupConfirm(i18n("confirm-delete-label"),msg,deleteCtrl)}function deleteCamera(cameraData){var labelData=(cameraData.isNode,LabelService.getSelectLabel()),param=function(){var param={};return param={labelId:labelData.labelId,deviceId:cameraData.deviceId,platformDeviceId:cameraData.platformDeviceId,cameraId:cameraData.cameraId}}(),deleteNodeCameraApi=function(){LabelService.unassignChannelLabelApi(param).success(function(){LabelService.getDeviceTree()["finally"](function(){LabelService.setFilterLabelCamera(),LabelService.selectLabelById(labelData.labelId)})}).error(function(response){notification("error",i18n("server-error"))})};deleteNodeCameraApi()}function addCamera(){setDragTargetList();var requestCount=(labelCtrl.data,0),cameraList=angular.copy(labelCtrl.data.uiDragTarget.list),requestTotal=cameraList.length,labelData=LabelService.getSelectLabel(),addNodeCameraApi=function(cameraData){LabelService.assignChannelLabelApi(cameraData).success(function(response){response.reason&&notification("error",i18n(response.reason)+"<br>[ "+i18n("camera-name")+": "+cameraData.cameraName+" ]",5e3)})["finally"](function(){requestCount++,requestCount<requestTotal&&addNodeCameraApi(cameraList[requestCount]),requestCount==requestTotal&&LabelService.getDeviceTree()["finally"](function(){LabelService.setFilterLabelCamera(),LabelService.selectLabelById(labelData.labelId)}).error(function(response){notification("error",i18n("server-error"))})})};requestTotal&&addNodeCameraApi(cameraList[requestCount])}function showAddLabel(){showUpdateLabel()}function showUpdateLabel(id){var optModal=(labelCtrl.data,LabelModalService.data),modalInstance=$uibModal.open({animation:!0,templateUrl:"labelModal.tmpl.html",controller:"LabelModalController",controllerAs:"labelModalCtrl",windowClass:"modal kupModal",size:"",resolve:{updateLabelData:function(){return id?LabelService.getLabelById(id):""}}});modalInstance.opened.then(function(){optModal.isOpenModal=!0}),modalInstance.result.then(function(){
optModal.currectStep=0,optModal.isOpenModal=!1},function(){optModal.currectStep=0,optModal.isOpenModal=!1})}function setDragTargetList(){var opt=labelCtrl.data,cameraList=[],labelData=LabelService.getSelectLabel(),obj={};$.each(opt.uiDragTarget.list,function(i,item){if(item.isAll){var deviceData=item.items;$.each(deviceData,function(j,device){var cameraData=device.items;$.each(cameraData,function(k,camera){obj={},obj.labelId=labelData.labelId,obj.deviceId=camera.deviceId,obj.platformDeviceId=camera.platformDeviceId,obj.cameraId=camera.cameraId,obj.cameraName=camera.cameraName,obj.isNode=device.isNode,cameraList.push(obj)})})}if(item.isDevice){var cameraData=item.items;$.each(cameraData,function(j,camera){obj={},obj.labelId=labelData.labelId,obj.deviceId=camera.deviceId,obj.platformDeviceId=camera.platformDeviceId,obj.cameraId=camera.cameraId,obj.cameraName=camera.cameraName,obj.isNode=item.isNode,cameraList.push(obj)})}item.isCamera&&(obj={},obj.labelId=labelData.labelId,obj.deviceId=item.deviceId,obj.platformDeviceId=item.platformDeviceId,obj.cameraId=item.cameraId,obj.cameraName=item.cameraName,obj.isNode=item.isNode,cameraList.push(obj))}),opt.uiDragTarget.list=cameraList}function getSelectLabel(){return LabelService.getSelectLabel()}function showGuider(isShow){var opt=labelCtrl.data;opt.uiGuider.isShow=isShow}function showGuiderCheck(){var opt=labelCtrl.data,optModal=LabelModalService.data;return!DeviceTreeService.isEmptyDevice()&&!opt.uiDragTarget.isShow&&!opt.uiLabels.selectCameraList.length&&getSelectLabel()&&opt.uiGuider.isShow&&!opt.uiLabels.isAddShow&&!optModal.currectStep}function selectLabel(index){LabelService.selectLabel(index)}function selectLabelById(id){LabelService.selectLabelById(id)}var utils=UtilsService,i18n=UtilsService.i18n,notification=UtilsService.notification,mainCtrl=(RouterStateService.isCurrentPage,$scope.$parent.mainCtrl),labelCtrl=this;labelCtrl.data=LabelService.data=LabelService.setInitData(),labelCtrl.data.uiTreeview.options=getTreeviewOptions(),labelCtrl.data.uiDragTarget.options=getDragTargetOptions(),labelCtrl.fn={isEmptyDevice:DeviceTreeService.isEmptyDevice,showMainMenu:showMainMenu,showGuider:showGuider,showGuiderCheck:showGuiderCheck,setCurrectFilterVca:setCurrectFilterVca,getCurrectFilterVca:getCurrectFilterVca,selectLabelById:selectLabelById,getLabelClass:getLabelClass,getLabelTagClass:getLabelTagClass,getSelectLabel:getSelectLabel,showAddLabel:showAddLabel,showUpdateLabel:showUpdateLabel,selectLabel:selectLabel,deleteLabel:deleteLabel,deleteCamera:deleteCamera},init()}]);