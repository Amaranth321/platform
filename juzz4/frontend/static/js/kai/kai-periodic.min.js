angular.module("kai.periodic",["datatables"]),angular.module("kai.periodic").factory("PeriodicService",["KupOption","UtilsService","KupApiService","AuthTokenFactory","DTOptionsBuilder","DTColumnDefBuilder","DTColumnBuilder","$q","$filter","$timeout",function(KupOption,UtilsService,KupApiService,AuthTokenFactory,DTOptionsBuilder,DTColumnDefBuilder,DTColumnBuilder,$q,$filter,$timeout){function setTableData(){var opt=data;opt.tableDataSource=angular.copy(opt.apiPeriodicreports),$.each(opt.tableDataSource,function(i,ds){ds.fromDateLocal=moment(ds.reportInfo.period.from).format(kupOpt["default"].formatlDatetime),ds.type=function(){var dsType=ds.reportInfo.frequency;return $.each(opt.uiType,function(i,uiType){if(uiType.value===dsType)return dsType=i18n(uiType.text),!1}),dsType}()})}function setSelectTableData(index){var opt=data;if(void 0===index)opt.selectTableData=[];else{var tableData=opt.tableDataSource[index];opt.selectTableData=tableData?[tableData]:[]}}function setUiExport(index){var opt=data;if($.each(opt.uiExport,function(i,ep){ep.isShow=!1}),void 0===index);else{var tableData=opt.tableDataSource[index];$.each(tableData.gridFsList,function(i,ls){$.each(opt.uiExport,function(j,ep){ep.value===ls.format&&(ep.isShow=!0)})})}}function getPeriodicReportApi(pageParam,isDefer){var opt=data,frequency=opt.searchInfo.type.value||"",fromDateUTC=kendo.toString(utils.localToUTC(opt.searchInfo.startDate),data.timeFormat[2]),toDateUTC=kendo.toString(utils.localToUTC(opt.searchInfo.endDate),data.timeFormat[2]),param={skip:pageParam.skip,take:pageParam.take,frequency:frequency,from:fromDateUTC,to:toDateUTC},onSuccess=function(response){opt.apiPeriodicreports=response.reports||[],opt.apiPeriodicreportsTotal=response.totalCount||0},onFail=function(response){opt.apiPeriodicreports=[],opt.apiPeriodicreportsTotal=opt.apiPeriodicreportsTotal||0},onError=function(){opt.apiPeriodicreports=[],opt.apiPeriodicreportsTotal=opt.apiPeriodicreportsTotal||0};return ajaxPost("getperiodicreports",param,onSuccess,onFail,onError,isDefer)}function downloadPeriodicPeportApi(format){format=format||"";var opt=data,selectData=opt.selectTableData[0],param={"report-id":selectData._id,format:format};KupApiService.apiDownload("downloadperiodicreport",param)}var kupOpt=KupOption,utils=UtilsService,i18n=UtilsService.i18n,ajaxPost=(UtilsService.notification,KupApiService.ajaxPost),data={};return data.timeFormat=kupOpt.kendoTimeFormat,data.dateRange=7,data.dateFormat=kupOpt.momentTimeFormat[0],data.startDateFormat=kupOpt.momentTimeFormatForStart[0],data.endDateFormat=kupOpt.momentTimeFormatForEnd[0],data.tableDataSource=[],data.selectTableData=[],data.apiPeriodicreports=[],data.apiPeriodicreportsTotal=0,data.requestForReport=[],data.$daterange="#kupDaterange",data.uiType=[{name:"all",text:"all",value:""},{name:"hourly",text:"hourly",value:"HOURLY"},{name:"daily",text:"daily",value:"DAILY"},{name:"weekly",text:"weekly",value:"WEEKLY"},{name:"monthly",text:"monthly",value:"MONTHLY"}],data.uiExport=[{name:"pdf",text:"download-pdf",value:"PDF","class":"fa fa-file-pdf-o pdf",isShow:!1},{name:"excel",text:"download-excel",value:"EXCEL","class":"fa fa-file-excel-o excel",isShow:!1},{name:"csv",text:"download-csv",value:"CSV","class":"kup-csv csv",isShow:!1}],data.uiDateRangesList=[{name:i18n("today"),data:[moment(new Date(moment().format(data.startDateFormat))),moment(new Date(moment().format(data.endDateFormat)))]},{name:i18n("yesterday"),data:[moment(new Date(moment().subtract(1,"days").format(data.startDateFormat))),moment(new Date(moment().subtract(1,"days").format(data.endDateFormat)))]},{name:i18n("last-7-days"),data:[moment(new Date(moment().subtract(6,"days").format(data.startDateFormat))),moment(new Date(moment().format(data.endDateFormat)))]},{name:i18n("last-30-days"),data:[moment(new Date(moment().subtract(29,"days").format(data.startDateFormat))),moment(new Date(moment().format(data.endDateFormat)))]},{name:i18n("this-month"),data:[moment(new Date(moment().startOf("month").format(data.startDateFormat))),moment(new Date(moment().endOf("month").format(data.endDateFormat)))]},{name:i18n("last-month"),data:[moment(new Date(moment().subtract(1,"month").startOf("month").format(data.startDateFormat))),moment(new Date(moment().subtract(1,"month").endOf("month").format(data.endDateFormat)))]}],data.uiTable={},data.uiTableBlock={options:{}},data.searchInfo={type:{},startDate:new Date(moment().format(data.startDateFormat)),endDate:new Date(moment().format(data.endDateFormat))},{data:data,setTableData:setTableData,setUiExport:setUiExport,setSelectTableData:setSelectTableData,getPeriodicReportApi:getPeriodicReportApi,downloadPeriodicPeportApi:downloadPeriodicPeportApi}}]),angular.module("kai.periodic").controller("PeriodicController",["KupOption","RouterStateService","UtilsService","AuthTokenFactory","PeriodicService","DTOptionsBuilder","DTColumnBuilder","$scope","$q","$timeout",function(KupOption,RouterStateService,UtilsService,AuthTokenFactory,PeriodicService,DTOptionsBuilder,DTColumnBuilder,$scope,$q,$timeout){function init(){mainCtrl.block.promise=setUI(),setWatch()}function setUI(){var promise=function(){var dfd=$q.defer();return $timeout(function(){setDateRangePicker(),dfd.resolve()}),dfd.promise};return promise()}function setWatch(){$scope.$watch("periodicCtrl.data.searchInfo",function(newVal,oldVal){angular.toJson(newVal)!==angular.toJson(oldVal)&&generateReport()},!0)}function generateReport(){var opt=periodicCtrl.data;opt.uiTable.dtInstance.DataTable.ajax.reload()}function setDateRangePicker(){var opt=periodicCtrl.data,dateFormat=opt.dateFormat,startDateFormat=opt.startDateFormat,endDateFormat=opt.endDateFormat,defaultDate={startDate:moment(opt.searchInfo.startDate),endDate:moment(opt.searchInfo.endDate)},showDate=function(start,end){$scope.$apply(function(){var opt=periodicCtrl.data;opt.searchInfo.startDate=new Date(start.format(dateFormat)),opt.searchInfo.endDate=new Date(end.format(dateFormat)),$(opt.$daterange).find("span").html(start.format(dateFormat)+" - "+end.format(dateFormat))})},rangesList=opt.uiDateRangesList,ranges=function(){var obj={};return $.each(rangesList,function(i,range){obj[range.name]=range.data}),obj}(),locale={customRangeLabel:i18n("custom-range")},pickerData=$(opt.$daterange).daterangepicker({showDropdowns:!0,timePicker:!0,timePickerIncrement:59,timePicker24Hour:!0,timePickerSeconds:!1,opens:"left",drops:"down",buttonClasses:["btn","btn-sm"],applyClass:"btn-warning",cancelClass:"btn-link cancel",maxDate:moment(new Date(moment().format(opt.endDateFormat))),ranges:ranges,locale:locale,startDate:defaultDate.startDate,endDate:defaultDate.endDate},showDate).data("daterangepicker"),customRangeBtn=pickerData.locale.customRangeLabel;$(opt.$daterange).find("span").html(pickerData.startDate.format(startDateFormat)+" - "+pickerData.endDate.format(endDateFormat)),$(".daterangepicker .ranges ul li:contains('"+customRangeBtn+"')").on("click",function(e){var $calendarControl=$(".daterangepicker.dropdown-menu");$calendarControl.hasClass("show-calendar")&&(e.stopPropagation(),$calendarControl.removeClass("show-calendar"))})}function selectTableData(index){PeriodicService.setUiExport(index),PeriodicService.setSelectTableData(index)}function exportReport(format){PeriodicService.downloadPeriodicPeportApi(format)}var kupOpt=KupOption,i18n=UtilsService.i18n,mainCtrl=(UtilsService.notification,UtilsService.block,$scope.$parent.mainCtrl),periodicCtrl=this;periodicCtrl.data=PeriodicService.data,periodicCtrl.data.uiTable={dtInstance:{},options:DTOptionsBuilder.newOptions().withLanguage(UtilsService.getAngularDatatablesI18n()).withPaginationType("full_numbers").withOption("paging",!0).withOption("info",!0).withOption("responsive",!0).withOption("ordering",!1).withOption("processing",!0).withDisplayLength(kupOpt.datatables.displayLength).withOption("fnRowCallback",function(nRow,aData,iDisplayIndex,iDisplayIndexFull){return $("td",nRow).bind("click",function(){var $tbody=$(this).parents("tbody"),index=$tbody.find("tr").index($(this).parent("tr"));$tbody.find("tr").removeClass("kupActive"),$(this).parent("tr").addClass("kupActive"),$scope.$apply(function(){selectTableData(index)})}),nRow}).withOption("serverSide",!0).withDataProp("data").withFnServerData(function(sSource,aoData,fnCallback,oSettings){var draw=aoData[0].value,start=(aoData[2].value,aoData[3].value),length=aoData[4].value,pageParam={skip:start,take:length};oSettings.jqXHR=PeriodicService.getPeriodicReportApi(pageParam)["finally"](function(){PeriodicService.setTableData();var opt=periodicCtrl.data,records={draw:draw,recordsTotal:opt.apiPeriodicreportsTotal,recordsFiltered:opt.apiPeriodicreportsTotal,data:opt.tableDataSource};fnCallback(records),selectTableData()})}),columnDefs:[DTColumnBuilder.newColumn("fromDateLocal").withTitle(i18n("date-time")),DTColumnBuilder.newColumn("type").withTitle("type")]},periodicCtrl.fn={exportReport:exportReport},init()}]);