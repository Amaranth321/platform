angular.module("kai.reports.pcounting",["ui.amcharts"]),angular.module("kai.reports.pcounting").directive("timecard",["UtilsService","$window","$document",function(UtilsService,$window,$document){var localizeResource=UtilsService.i18n,notification=UtilsService.notification,d3=$window.d3,tip=d3.tip().attr("class","detailed-stat-box").html(function(data){var detailStatBox="   <label>"+localizeResource("no-people-in")+"</label>   <span class='people-in'>"+data.count+"</span><br/>",conversionRate=data.receipts/data.count*100;return detailStatBox+="   <label>"+localizeResource("conversion-rate")+"</label>   <span class='conversion-rate'> "+conversionRate.toFixed(1)+"% </span><br/>   <label>"+localizeResource("receipt")+"</label>   <span class='receipt'> "+data.receipts.toFixed()+" </span><br/>   <label>"+localizeResource("sales-amount")+"</label>   <span class='sales-amount'> "+(data.sales/1e3).toFixed(1)+"K</span><br/>"}),timeCard={monthNames:[localizeResource("january"),localizeResource("february"),localizeResource("march"),localizeResource("april"),localizeResource("may"),localizeResource("june"),localizeResource("july"),localizeResource("august"),localizeResource("september"),localizeResource("october"),localizeResource("november"),localizeResource("december")],dayOfWeekNames:[localizeResource("sunday"),localizeResource("monday"),localizeResource("tuesday"),localizeResource("wednesday"),localizeResource("thursday"),localizeResource("friday"),localizeResource("saturday")],shortDayOfWeekNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],cardType:{COUNTING:"COUNTING",CONVERSION:"CONVERSION"},periodType:{WEEKLY:"WEEKS",MONTHLY:"MONTHS",YEARLY:"YEARS"},cardBoxId:"timeCardBox",cardWidth:900,cardHeight:700,legend:{height:40,width:400,blockHeight:18,blockWidth:40,textWidth:40},formatter:{hour:d3.time.format("%Y%m%d%H"),day:d3.time.format("%Y%m%d"),week:d3.time.format("%Y%U"),month:d3.time.format("%Y%m")},theme:{SUNSHINE:{colorRanges:["#FBD19B","#F8C06C","#F6AD10","#EA981D","#D07C00"],hoverColor:"gray",noDataColor:"#FBD19B",cellBorderColor:"#eee"},INDIGO:{colorRanges:["#C7CBE5","#99A3CF","#7081BB","#4666AA","#034EA2"],hoverColor:"gray",noDataColor:"#C7CBE5",cellBorderColor:"#eee"}},_current:{theme:null,cardType:null,periodType:"WEEKS",consolidatedData:null,compiledData:null},animation:{enabled:!0,easing:"linear",duration:{weekly:130,monthly:30,yearly:150}},posTimeFormat:"dd/MM/yyyy HH:mm:ss",isPosData:!1};timeCard.generateCard=function(containerId,cardType,periodType,peopleCountingData,posData){this._initUi(containerId),timeCard._setPeriodType(periodType),timeCard._setCardType(cardType),timeCard._consolidateData(peopleCountingData,posData),timeCard._prepareDataByPeriod(),timeCard._draw()},timeCard.switchCartType=function(targetCardType){return null==timeCard._current.compiledData?void console.log("card not initialized."):targetCardType==timeCard._current.cardType?void console.log("Already selected: "+targetCardType):(timeCard._clearChildElements(timeCard.cardBoxId),timeCard._setCardType(targetCardType),void timeCard._draw())},timeCard.switchPeriodType=function(targetPeriodType){return null==timeCard._current.compiledData?void console.log("card not initialized."):targetPeriodType==timeCard._current.periodType?void console.log("already selected: "+targetPeriodType):(timeCard._clearChildElements(timeCard.cardBoxId),timeCard._setPeriodType(targetPeriodType),timeCard._prepareDataByPeriod(),void timeCard._draw())},timeCard.removeCard=function(){timeCard._current={theme:null,cardType:null,periodType:null,consolidatedData:null,compiledData:null},timeCard._clearChildElements($("#"+timeCard.cardBoxId).parent().attr("id"))},timeCard.getSvgList=function(containerId){var svgList=$("#"+containerId+" svg"),serializedList=[],xmlSerializer=new XMLSerializer;return svgList.each(function(idx,svgObj){serializedList.push(xmlSerializer.serializeToString(svgObj))}),serializedList},timeCard._initUi=function(containerId){timeCard._clearChildElements(containerId),$("#"+containerId).addClass("time-card"),$("#"+containerId).append('<div class="timecardbox" id="'+timeCard.cardBoxId+'"></div>'),d3.selectAll("div.timecard-tooltip").empty(),$("#"+containerId+" .card_type_selector input:radio[name='cardChartType']").change(function(){timeCard.switchCartType(this.value)}),$("#"+containerId+" .card_period_selector input:radio[name='cardPeriodType']").change(function(){$(this).parents("li").addClass("selected"),$(this).parents().siblings("li").removeClass("selected"),timeCard.switchPeriodType(this.value)})},timeCard._setCardType=function(cardType){timeCard._current.cardType=cardType,$(".detailed-stat-box").removeClass("theme-sunshine"),$(".detailed-stat-box").removeClass("theme-indigo"),cardType==timeCard.cardType.COUNTING?(timeCard._current.theme=timeCard.theme.SUNSHINE,$(".detailed-stat-box").addClass("theme-sunshine")):(timeCard._current.theme=timeCard.theme.INDIGO,$(".detailed-stat-box").addClass("theme-indigo"))},timeCard._setPeriodType=function(periodType){timeCard._current.periodType=periodType},timeCard._consolidateData=function(peopleCountingData,posData){var posHourlyMap={};null==posData||0==posData.length?$(".card_type_selector").hide():$.each(posData,function(idx,hourlyData){var posLocalTime=UtilsService.convertUTCtoLocal(kendo.parseDate(hourlyData.sales.time,timeCard.posTimeFormat)),hourSpecifier=timeCard.formatter.hour(posLocalTime);posHourlyMap[hourSpecifier]={date:posLocalTime,sales:hourlyData.sales.amount,receipts:hourlyData.sales.count}});var countHourlyMap={};$.each(peopleCountingData,function(idx,countData){var pLocalTime=UtilsService.convertUTCtoLocal(new Date(countData.date)),hourSpecifier=timeCard.formatter.hour(pLocalTime),hourlyTotal=countHourlyMap[hourSpecifier];null==hourlyTotal&&(hourlyTotal=0),hourlyTotal+=countData["in"],countHourlyMap[hourSpecifier]=hourlyTotal});var combinedList=[];$.each(countHourlyMap,function(hourSpecifier,hourlyTotal){if(0==hourlyTotal)return!0;var localTime=timeCard.formatter.hour.parse(hourSpecifier),combinedData=posHourlyMap[hourSpecifier];null==combinedData&&(combinedData={sales:0,receipts:0}),combinedData.date=localTime,combinedData.count=hourlyTotal,combinedList.push(combinedData)}),combinedList.sort(function(a,b){return a.date-b.date}),timeCard._current.consolidatedData=combinedList},timeCard._prepareDataByPeriod=function(){var periodType=timeCard._current.periodType,consolidatedData=timeCard._current.consolidatedData;switch(periodType){case timeCard.periodType.WEEKLY:timeCard._current.compiledData=timeCard._separateDataByWeek(consolidatedData);break;case timeCard.periodType.MONTHLY:timeCard._current.compiledData=timeCard._separateDataByMonth(consolidatedData);break;case timeCard.periodType.YEARLY:timeCard._current.compiledData=timeCard._separateDataByYear(consolidatedData);break;default:console.log("unknown period")}},timeCard._draw=function(){var cardType=timeCard._current.cardType,periodType=timeCard._current.periodType;switch(periodType){case timeCard.periodType.WEEKLY:$.each(timeCard._current.compiledData.weeklyDataSet,function(weekSpecifier,weekDataSet){timeCard._generateOneWeek(timeCard.cardBoxId,cardType,weekSpecifier,weekDataSet,timeCard._current.compiledData.minCount,timeCard._current.compiledData.maxCount)});break;case timeCard.periodType.MONTHLY:$.each(timeCard._current.compiledData.monthlyDataSet,function(monthSpecifier,monthDataSet){var monthDate=timeCard.formatter.month.parse(monthSpecifier),monthDetails=timeCard._getMonthDateDetails(monthDate);timeCard._generateOneMonth(timeCard.cardBoxId,cardType,monthDetails,monthDataSet,timeCard._current.compiledData.minCount,timeCard._current.compiledData.maxCount)});break;case timeCard.periodType.YEARLY:$.each(timeCard._current.compiledData.yearlyDataSet,function(year,yearDataSet){timeCard._generateOneYear(timeCard.cardBoxId,cardType,year,yearDataSet,timeCard._current.compiledData.minCount,timeCard._current.compiledData.maxCount)});break;default:console.log("unknown period")}},timeCard._generateOneWeek=function(cardContainerId,cardType,weekSpecifier,hourlyDataSet,minCount,maxCount){var bgColorFn=timeCard._getBgColoringFn(minCount,maxCount),dateFormatter=d3.time.format("%Y-%m-%d"),weekDates=timeCard._getWeekStartEndDates(weekSpecifier),strWeekStart=dateFormatter(weekDates.startDate),strWeekEnd=dateFormatter(weekDates.endDate),weekTitle=strWeekStart+" "+localizeResource("to")+" "+strWeekEnd,margin={top:20,right:10,bottom:0,left:10},innerWidth=timeCard.cardWidth-margin.left-margin.right,innerHeight=timeCard.cardHeight-margin.top-margin.bottom,headerHeight=25,periodGroupWidth=60,numOfCols=7,numOfRows=24,colWidth=(innerWidth-periodGroupWidth)/numOfCols,rowHeight=(innerHeight-timeCard.legend.height-headerHeight)/numOfRows,svgContainer=d3.select("#"+cardContainerId).append("svg").attr("width",timeCard.cardWidth).attr("height",timeCard.cardHeight);svgContainer.call(tip);var mainWrapper=svgContainer.append("g").attr("transform",function(d,i){var xOffset=margin.left,yOffset=margin.top;return"translate("+xOffset+", "+yOffset+")"});timeCard._attachLegend(mainWrapper,cardType);var mainCardBox=(mainWrapper.append("text").attr("class","month_year_indicator").attr("font-size","14px").attr("font-weight","bold").attr("x",function(){var posX=innerWidth-200;return posX}).attr("y",function(d,i){var posY=15;return posY}).text(function(d,i){return weekTitle}),mainWrapper.append("g").attr("transform",function(d,i){var xOffset=0,yOffset=timeCard.legend.height;return"translate("+xOffset+", "+yOffset+")"})),colHeaderBox=mainCardBox.append("g").attr("transform",function(d,i){var xOffset=periodGroupWidth,yOffset=0;return"translate("+xOffset+", "+yOffset+")"}),periodBox=(colHeaderBox.selectAll("text").data(timeCard.dayOfWeekNames).enter().append("text").attr("class","column_header").attr("text-anchor","middle").attr("font-size","12px").attr("x",function(d,i){var offset=colWidth/2,posX=i*colWidth;return posX+offset}).attr("y",function(d,i){var offset=rowHeight/2+3,posY=0;return posY+offset}).text(function(d,i){return d}),mainCardBox.append("g").attr("transform",function(d,i){var xOffset=0,yOffset=headerHeight;return"translate("+xOffset+", "+yOffset+")"})),dataCellBox=(periodBox.selectAll("text").data(timeCard._getHourlyPeriods()).enter().append("text").attr("class","label_period").attr("font-size","12px").attr("x",function(d,i){var offset=10,posX=0;return posX+offset}).attr("y",function(d,i){var offset=rowHeight/2+3,posY=i*rowHeight;return posY+offset}).text(function(d,i){return d}),mainCardBox.append("g").attr("transform",function(d,i){var xOffset=periodGroupWidth,yOffset=headerHeight;return"translate("+xOffset+", "+yOffset+")"}));dataCellBox.selectAll("g").data(timeCard._getWeekSlots(weekDates.startDate)).enter().append("g").on("mouseenter",function(hourSpecifier){var data=hourlyDataSet[hourSpecifier];timeCard._handleMouseEnter(d3.select(this),data)}).on("mouseleave",function(hourSpecifier){var data=hourlyDataSet[hourSpecifier];timeCard._handleMouseLeave(d3.select(this),data,bgColorFn)}),dataCellBox.selectAll("g").append("rect").attr("class","hourly_rect").attr("width",colWidth).attr("height",rowHeight).attr("stroke-width","1").attr("stroke",timeCard._current.theme.cellBorderColor).attr("x","0").attr("y","0").attr("fill",function(hourSpecifier,i){var data=hourlyDataSet[hourSpecifier];return bgColorFn(data)}),dataCellBox.selectAll("g").append("text").attr("text-anchor","middle").attr("font-size","12px").attr("fill","#000").attr("x",colWidth/2).attr("y",rowHeight/2+4).text(function(hourSpecifier,i){var data=hourlyDataSet[hourSpecifier];return null==data?"":timeCard._getWeeklyCellContent(data)}),dataCellBox.selectAll("g").attr("transform",function(hourSpecifier,i){var posY=Math.floor(i/7),xOffset=0,yOffset=posY*rowHeight;return"translate("+xOffset+", "+yOffset+")"}).transition().ease(timeCard.animation.easing).duration(function(hourSpecifier,i){var posX=i%7,duration=(Math.floor(i/7),timeCard.animation.enabled?timeCard.animation.duration.weekly:0);return duration*posX}).attr("transform",function(hourSpecifier,i){var posX=i%7,posY=Math.floor(i/7),xOffset=posX*colWidth,yOffset=posY*rowHeight;return"translate("+xOffset+", "+yOffset+")"})},timeCard._generateOneMonth=function(cardContainerId,cardType,monthDetails,dailyDataSet,minCount,maxCount){var bgColorFn=timeCard._getBgColoringFn(minCount,maxCount),margin={top:20,right:10,bottom:0,left:10},innerWidth=timeCard.cardWidth-margin.left-margin.right,innerHeight=timeCard.cardHeight-margin.top-margin.bottom,numOfCols=7,numOfRows=6,headerHeight=75,colWidth=innerWidth/numOfCols,rowHeight=(innerHeight-timeCard.legend.height-headerHeight)/numOfRows,cellPadding={top:5,right:5,bottom:5,left:5},monthTitleWidth=(colWidth-cellPadding.left-cellPadding.right,rowHeight-cellPadding.top-cellPadding.bottom,150),svgContainer=d3.select("#"+cardContainerId).append("svg").attr("width",timeCard.cardWidth).attr("height",timeCard.cardHeight),mainWrapper=svgContainer.append("g").attr("transform",function(d,i){var xOffset=margin.left,yOffset=margin.top;return"translate("+xOffset+", "+yOffset+")"});timeCard._attachLegend(mainWrapper,cardType);var mainCardBox=(mainWrapper.append("text").attr("class","month_year_indicator").attr("font-size","15px").attr("font-weight","bold").attr("x",function(){var posX=innerWidth-monthTitleWidth;return posX}).attr("y",function(d,i){var posY=15;return posY}).text(function(d,i){var monthTitle=timeCard.monthNames[monthDetails.monthNumber]+" "+monthDetails.year;return monthTitle}),mainWrapper.append("g").attr("transform",function(d,i){var xOffset=0,yOffset=0;return"translate("+xOffset+", "+yOffset+")"})),colHeaderBox=mainCardBox.append("g").attr("transform",function(d,i){var xOffset=0,yOffset=10;return"translate("+xOffset+", "+yOffset+")"}),dayGroup=(colHeaderBox.selectAll("text").data(timeCard.dayOfWeekNames).enter().append("text").attr("class","column_header").attr("text-anchor","middle").style("font-size","12px").attr("x",function(d,i){var offset=colWidth/2,posX=i*colWidth;return posX+offset}).attr("y",function(d,i){var offset=rowHeight/2+3,posY=0;return posY+offset}).text(function(d,i){return d}),mainCardBox.append("g").attr("transform",function(d,i){var xOffset=0,yOffset=headerHeight;return"translate("+xOffset+", "+yOffset+")"}));dayGroup.selectAll("g").data(timeCard._getMonthSlots(monthDetails.monthNumber,monthDetails.year)).enter().append("g").on("mouseenter",function(daySpecifier){var data=dailyDataSet[daySpecifier];timeCard._handleMouseEnter(d3.select(this),data)}).on("mouseleave",function(daySpecifier){var data=dailyDataSet[daySpecifier];timeCard._handleMouseLeave(d3.select(this),data,bgColorFn)}),dayGroup.selectAll("g").append("rect").attr("class","hourly_rect").attr("width",colWidth).attr("height",rowHeight).attr("stroke-width","1").attr("stroke",timeCard._current.theme.cellBorderColor).attr("x","0").attr("y","0").attr("fill",function(daySpecifier,i){var data=dailyDataSet[daySpecifier];return bgColorFn(data)}),dayGroup.selectAll("g").append("text").attr("text-anchor","middle").attr("font-size","12px").attr("fill","#000").attr("x",colWidth/2).attr("y",rowHeight/2+4).text(function(daySpecifier,i){var date=timeCard.formatter.day.parse(daySpecifier),data=dailyDataSet[daySpecifier];return timeCard._getMonthlyCellContent(date,data)}),dayGroup.selectAll("g").append("text").attr("text-anchor","right").attr("font-size","12px").attr("fill","#000").attr("x",colWidth-24).attr("y",20).text(function(daySpecifier,i){var date=timeCard.formatter.day.parse(daySpecifier);return date.getDate()}),dayGroup.selectAll("g").attr("transform",function(daySpecifier,i){var date=timeCard.formatter.day.parse(daySpecifier),dayOfWeek=date.getDay(),xOffset=(Math.floor((date.getDate()-1+monthDetails.week1EmptySlots)/7),dayOfWeek*colWidth),yOffset=0;return"translate("+xOffset+", "+yOffset+")"}).transition().ease(timeCard.animation.easing).duration(function(daySpecifier,i){var date=timeCard.formatter.day.parse(daySpecifier),duration=timeCard.animation.enabled?timeCard.animation.duration.monthly:0;return duration*date.getDate()}).attr("transform",function(daySpecifier,i){var date=timeCard.formatter.day.parse(daySpecifier),dayOfWeek=date.getDay(),weekOfMonth=Math.floor((date.getDate()-1+monthDetails.week1EmptySlots)/7),xOffset=dayOfWeek*colWidth,yOffset=weekOfMonth*rowHeight;return"translate("+xOffset+", "+yOffset+")"})},timeCard._generateOneYear=function(cardContainerId,cardType,year,monthlyDataSet,minCount,maxCount){var bgColorFn=timeCard._getBgColoringFn(minCount,maxCount),margin={top:20,right:10,bottom:0,left:10},innerWidth=timeCard.cardWidth-margin.left-margin.right,innerHeight=timeCard.cardHeight-margin.top-margin.bottom,headerHeight=25,numOfCols=4,numOfRows=3,colWidth=innerWidth/numOfCols,rowHeight=(innerHeight-timeCard.legend.height-headerHeight)/numOfRows,svgContainer=d3.select("#"+cardContainerId).append("svg").attr("width",timeCard.cardWidth).attr("height",timeCard.cardHeight),mainWrapper=svgContainer.append("g").attr("transform",function(d,i){var xOffset=margin.left,yOffset=margin.top;return"translate("+xOffset+", "+yOffset+")"});mainWrapper.append("text").attr("class","month_year_indicator").attr("font-size","17px").attr("font-weight","bold").attr("x",function(){var posX=innerWidth-60;return posX}).attr("y",function(d,i){var posY=15;return posY}).text(function(d,i){return year});timeCard._attachLegend(mainWrapper,cardType);for(var mainCardBox=mainWrapper.append("g").attr("transform",function(d,i){var xOffset=0,yOffset=timeCard.legend.height;return"translate("+xOffset+", "+yOffset+")"}),i=0;i<12;i++){var monthNumber=i,monthDetails=timeCard._getMonthDateDetails(new Date(year,monthNumber,1)),monthDataSet=monthlyDataSet[monthNumber];null==monthDataSet&&(monthDataSet={}),timeCard._generateMiniMonth(mainCardBox,colWidth,rowHeight,monthDetails,monthDataSet,bgColorFn)}},timeCard._generateMiniMonth=function(parent,width,height,monthDetails,dailyDataSet,bgColorFn){var listOfDays=timeCard._getMonthSlots(monthDetails.monthNumber,monthDetails.year),margin={top:8,right:5,bottom:8,left:5},innerWidth=width-margin.left-margin.right,innerHeight=height-margin.top-margin.bottom,monthTitleHeight=15,headerHeight=22,numOfCols=7,numOfRows=6,colWidth=innerWidth/numOfCols,rowHeight=(innerHeight-monthTitleHeight-headerHeight)/numOfRows,location={x:monthDetails.monthNumber%4,y:Math.floor(monthDetails.monthNumber/4)},miniMonth=parent.append("g").attr("transform",function(d,i){var xOffset=location.x*width+margin.left,yOffset=location.y*height+margin.top;return"translate("+xOffset+", "+yOffset+")"}),monthContainer=(miniMonth.append("text").attr("class","month_year_indicator").attr("font-size","14px").attr("font-weight","bold").attr("x",function(){var posX=2;return posX}).attr("y",function(d,i){var posY=10;return posY}).text(function(d,i){return timeCard.monthNames[monthDetails.monthNumber]}),miniMonth.append("g").attr("transform",function(d,i){return"translate(0, "+monthTitleHeight+")"})),headerGroup=monthContainer.append("g").attr("transform",function(d,i){return"translate(0, 0)"}),dayGroup=(headerGroup.selectAll("text").data(timeCard.shortDayOfWeekNames).enter().append("text").attr("class","column_header").attr("text-anchor","middle").style("font-size","12px").attr("x",function(d,i){var offset=colWidth/2,posX=i*colWidth;return posX+offset}).attr("y",function(d,i){var offset=rowHeight/2+3,posY=0;return posY+offset}).text(function(d,i){return d}),monthContainer.append("g").attr("transform",function(d,i){return"translate(0, "+headerHeight+")"}));dayGroup.selectAll("g").data(listOfDays).enter().append("g").on("mouseenter",function(daySpecifier){var data=dailyDataSet[daySpecifier];timeCard._handleMouseEnter(d3.select(this),data)}).on("mouseleave",function(daySpecifier){var data=dailyDataSet[daySpecifier];timeCard._handleMouseLeave(d3.select(this),data,bgColorFn)}),dayGroup.selectAll("g").append("rect").attr("class","hourly_rect").attr("width",colWidth).attr("height",rowHeight).attr("stroke-width",1).attr("stroke",timeCard._current.theme.cellBorderColor).attr("x","0").attr("y","0").attr("fill",function(daySpecifier,i){var data=dailyDataSet[daySpecifier];return bgColorFn(data)}),dayGroup.selectAll("g").append("text").attr("text-anchor","middle").attr("font-size","11px").attr("fill","#000").attr("x",colWidth/2).attr("y",rowHeight/2+4).text(function(daySpecifier,i){var date=timeCard.formatter.day.parse(daySpecifier);return date.getDate()}),dayGroup.selectAll("g").attr("transform",function(daySpecifier,i){var date=timeCard.formatter.day.parse(daySpecifier),dayOfWeek=date.getDay(),xOffset=(Math.floor((date.getDate()-1+monthDetails.week1EmptySlots)/7),dayOfWeek*colWidth),yOffset=0;return"translate("+xOffset+", "+yOffset+")"}).transition().ease(timeCard.animation.easing).duration(function(daySpecifier,i){var date=timeCard.formatter.day.parse(daySpecifier),weekOfMonth=Math.floor((date.getDate()-1+monthDetails.week1EmptySlots)/7),duration=timeCard.animation.enabled?timeCard.animation.duration.yearly:0;return duration*weekOfMonth}).attr("transform",function(daySpecifier,i){var date=timeCard.formatter.day.parse(daySpecifier),dayOfWeek=date.getDay(),weekOfMonth=Math.floor((date.getDate()-1+monthDetails.week1EmptySlots)/7),xOffset=dayOfWeek*colWidth,yOffset=weekOfMonth*rowHeight;return"translate("+xOffset+", "+yOffset+")"})},timeCard._compileDataByDay=function(hourlyDataSet){var dailyMap={},dayFormatter=d3.time.format("%Y%m%d");$.each(hourlyDataSet,function(idx,hourlyData){var year=hourlyData.date.getFullYear(),month=hourlyData.date.getMonth(),day=hourlyData.date.getDate(),daySpecifier=dayFormatter(hourlyData.date),targetDay=dailyMap[daySpecifier];null==targetDay?targetDay={date:new Date(year,month,day,1),count:hourlyData.count,receipts:hourlyData.receipts,sales:hourlyData.sales}:(targetDay.count+=hourlyData.count,targetDay.receipts+=hourlyData.receipts,targetDay.sales+=hourlyData.sales),dailyMap[daySpecifier]=targetDay});var compiledList=[];return $.each(dailyMap,function(idx,dayData){compiledList.push(dayData)}),compiledList},timeCard._separateDataByWeek=function(hourlyDataSet){var compiledData={weeklyDataSet:{},minCount:0,maxCount:0};if(null==hourlyDataSet||0==hourlyDataSet.length)return notification("success",localizeResource("no-data")),compiledData;var weeklyDataSet={},minCount=hourlyDataSet[0].count,maxCount=hourlyDataSet[0].count;return $.each(hourlyDataSet,function(idx,hourlyData){var weekSpecifier=parseInt(timeCard.formatter.week(hourlyData.date));null==weeklyDataSet[weekSpecifier]&&(weeklyDataSet[weekSpecifier]={});var hourSpecifier=timeCard.formatter.hour(hourlyData.date);weeklyDataSet[weekSpecifier][hourSpecifier]=hourlyData,hourlyData.count<minCount?minCount=hourlyData.count:hourlyData.count>maxCount&&(maxCount=hourlyData.count)}),compiledData.weeklyDataSet=weeklyDataSet,compiledData.minCount=minCount,compiledData.maxCount=maxCount,compiledData},timeCard._separateDataByMonth=function(hourlyDataSet){var compiledData={monthlyDataSet:{},minCount:0,maxCount:0};if(null==hourlyDataSet||0==hourlyDataSet.length)return notification.popupAlert(localizeResource("no-data")),compiledData;var dailyDataSet=timeCard._compileDataByDay(hourlyDataSet),monthlyDataSet={},minCount=dailyDataSet[0].count,maxCount=dailyDataSet[0].count;return $.each(dailyDataSet,function(idx,dailyData){var monthSpecifier=parseInt(timeCard.formatter.month(dailyData.date));null==monthlyDataSet[monthSpecifier]&&(monthlyDataSet[monthSpecifier]=[]);var daySpecifier=timeCard.formatter.day(dailyData.date);monthlyDataSet[monthSpecifier][daySpecifier]=dailyData,dailyData.count<minCount?minCount=dailyData.count:dailyData.count>maxCount&&(maxCount=dailyData.count)}),compiledData.monthlyDataSet=monthlyDataSet,compiledData.minCount=minCount,compiledData.maxCount=maxCount,compiledData},timeCard._separateDataByYear=function(hourlyDataSet){var compiledData={yearlyDataSet:{},minCount:0,maxCount:0};if(null==hourlyDataSet||0==hourlyDataSet.length)return notification.popupAlert(localizeResource("no-data")),compiledData;var monthlyCompiledData=timeCard._separateDataByMonth(hourlyDataSet),yearlyDataSet={};return $.each(monthlyCompiledData.monthlyDataSet,function(monthSpecifier,monthlyData){var monthDate=timeCard.formatter.month.parse(monthSpecifier),year=monthDate.getFullYear();null==yearlyDataSet[year]&&(yearlyDataSet[year]=[]),yearlyDataSet[year][monthDate.getMonth()]=monthlyData}),compiledData.yearlyDataSet=yearlyDataSet,compiledData.minCount=monthlyCompiledData.minCount,compiledData.maxCount=monthlyCompiledData.maxCount,compiledData},timeCard._getHourlyPeriods=function(){var hourList=["12","1","2","3","4","5","6","7","8","9","10","11"],fullDay=[];return $.each(hourList,function(idx,hr){fullDay.push(hr+" "+localizeResource("am"))}),$.each(hourList,function(idx,hr){fullDay.push(hr+" "+localizeResource("pm"))}),fullDay},timeCard._getWeekSlots=function(startDate){for(var oneFullWeekSlots=[],year=startDate.getFullYear(),month=startDate.getMonth(),firstDate=startDate.getDate(),hour=0;hour<24;hour++)for(var day=0;day<7;day++){var hourObj=new Date(year,month,firstDate+day,hour);oneFullWeekSlots.push(timeCard.formatter.hour(hourObj))}return oneFullWeekSlots},timeCard._getMonthSlots=function(monthNumber,year){for(var lastDate=new Date(year,monthNumber+1,0),fullMonthSlots=[],dayNumber=1;dayNumber<=lastDate.getDate();){var dayObj=new Date(year,monthNumber,dayNumber);fullMonthSlots.push(timeCard.formatter.day(dayObj)),dayNumber++}return fullMonthSlots},timeCard._showPopover=function(data){var conversionRate=data.receipts/data.count*100;$(".detailed-stat-box .people-in").html(data.count),$(".detailed-stat-box .conversion-rate").html(conversionRate.toFixed(1)+"%"),$(".detailed-stat-box .receipt").html(data.receipts),$(".detailed-stat-box .sales-amount").html((data.sales/1e3).toFixed(1)+"K"),d3.select(".detailed-stat-box").style("left",d3.event.pageX+"px"),d3.select(".detailed-stat-box").style("top",d3.event.pageY-50+"px")},timeCard._hidePopover=function(){},timeCard._attachLegend=function(parent,cardType){var currentTheme=this._current.theme,lowLabel=localizeResource("low"),highLabel=localizeResource("high"),legendGroup=parent.append("g");legendGroup.selectAll("rect").data(currentTheme.colorRanges).enter().append("rect").attr("width",timeCard.legend.blockWidth).attr("height",timeCard.legend.blockHeight).attr("fill",function(d,i){return d}).attr("x",function(d,i){var posX=timeCard.legend.textWidth+i*timeCard.legend.blockWidth;return posX}).attr("y",function(d,i){var posY=0;return posY}).text(function(d,i){return d}),legendGroup.append("text").attr("class","label_legend").attr("text-anchor","middle").attr("font-size","12px").attr("x",function(d,i){var posX=timeCard.legend.textWidth/2;return posX}).attr("y",function(d,i){var posY=12;return posY}).text(lowLabel),legendGroup.append("text").attr("class","label_legend").attr("text-anchor","middle").attr("font-size","12px").attr("x",function(){var offset=timeCard.legend.textWidth/2,posX=timeCard.legend.textWidth+currentTheme.colorRanges.length*timeCard.legend.blockWidth;return posX+offset}).attr("y",function(d,i){var posY=12;return posY}).text(highLabel)},timeCard._getMonthDateDetails=function(targetDate){var targetYear=targetDate.getFullYear(),targetMonth=targetDate.getMonth(),firstDate=new Date(targetYear,targetMonth,1),lastDate=new Date(targetYear,targetMonth+1,0),week1EmptySlots=firstDate.getDay();return{firstDate:firstDate,lastDate:lastDate,week1EmptySlots:week1EmptySlots,monthNumber:targetMonth,year:targetYear}},timeCard._getBgColoringFn=function(minCount,maxCount){minCount==maxCount&&(minCount=0);var currentTheme=timeCard._current.theme,minVal=0,maxVal=100;timeCard._current.cardType==timeCard.cardType.COUNTING&&(minVal=minCount,maxVal=maxCount);var d3scale=d3.scale.quantize().domain([minVal,maxVal]).range(d3.range(currentTheme.colorRanges.length));return function(data){var bgColor=currentTheme.noDataColor;if(null==data)return bgColor;var conversionRate=data.receipts/data.count*100;conversionRate=conversionRate>100?100:conversionRate;var pCount=data.count,value=timeCard._current.cardType==timeCard.cardType.COUNTING?pCount:conversionRate,colorIndex=d3scale(value);return currentTheme.colorRanges[colorIndex]}},timeCard._getWeeklyCellContent=function(data){var conversionRate=data.receipts/data.count*100,pCount=data.count,primaryVal="",secondaryVal="";if(this._current.cardType==timeCard.cardType.COUNTING){var template,template="val1 (val2)";return primaryVal=pCount,secondaryVal=conversionRate.toFixed(0)+"%",template.replace("val1",primaryVal).replace("val2",secondaryVal)}var template="val1 (val2)";return primaryVal=conversionRate.toFixed(0)+"%",secondaryVal=pCount,template.replace("val1",primaryVal).replace("val2",secondaryVal)},timeCard._getMonthlyCellContent=function(date,data){var displayValue="";return null!=data&&(displayValue=timeCard._getWeeklyCellContent(data)),displayValue},timeCard._getWeekStartEndDates=function(weekSpecifier){var weekDates={startDate:null,endDate:null},weekNumber=parseInt(weekSpecifier.substring(4)),dayOfYear=7*weekNumber,weekStartDate=timeCard.formatter.week.parse(weekSpecifier),missingDayCount=weekStartDate.getDay();weekStartDate.setDate(weekStartDate.getDate()+(dayOfYear-missingDayCount)),weekDates.startDate=weekStartDate;var weekEndDate=new Date(weekStartDate.getFullYear(),weekStartDate.getMonth(),weekStartDate.getDate()+6);return weekDates.endDate=weekEndDate,weekDates},timeCard._handleMouseEnter=function(targetElement,data){null!=data&&(tip.show(data),targetElement.style("background",timeCard._current.theme.hoverColor))},timeCard._handleMouseLeave=function(targetElement,data,bgColorFn){tip.hide(data),targetElement.style("background",bgColorFn(data))},timeCard._clearChildElements=function(divId){var container=document.getElementById(divId);if(null!=container)for(;container.firstChild;)container.removeChild(container.firstChild)};var link=function(scope,elem,attrs){scope.$watch("timecardOptions",function(newVal,oldVal,scope){var id=(angular.fromJson(newVal),$(elem).attr("id")),posData=[];scope.timecardOptions.peopleCountingData&&(scope.timecardOptions.isShowDemo?(timeCard.isPosData=!0,posData=scope.timecardOptions.posData):(timeCard.isPosData=!1,posData=[]),timeCard.generateCard(id,timeCard.cardType.COUNTING,timeCard._current.periodType,scope.timecardOptions.peopleCountingData,posData))},!0),scope.$watch("cartType",function(newVal,oldVal,scope){timeCard.switchCartType(newVal)}),scope.$watch("timeUnit",function(newVal,oldVal,scope){timeCard.switchPeriodType(newVal.toUpperCase())})};return{restrict:"A",scope:{timecardOptions:"=",cartType:"=",timeUnit:"="},link:link}}]),angular.module("kai.reports.pcounting").factory("PcountingService",["KupOption","AmchartsTheme","UtilsService","PromiseFactory","KupApiService","ReportsService","AuthTokenFactory","$q","$timeout",function(KupOption,AmchartsTheme,UtilsService,PromiseFactory,KupApiService,ReportsService,AuthTokenFactory,$q,$timeout){function setSelectedChartData(){var opt=data,reportsOpt=reports.data,selectedItemDataList=reportsOpt.selectedItemDataList||{},events=opt.apiAnalyticsReportList,seriesInfo=(reports.data.dateRange.startDate,reports.data.dateRange.endDate,[]),eventDetails=[],count=0,totalPlpVisit=0,countList=[],filterEvents=[],sitenameList=[];return function(){$.each(selectedItemDataList,function(uid,itemData){var totalInPerSelection=0;if($.isEmptyObject(itemData))return!0;if(itemData.isAll||itemData.isLabel){var name=itemData.text,deviceTimeList={};$.each(itemData.items,function(i,device){var deviceList=[];$.each(device.items,function(j,camera){var cameraData=camera.data,cameraList=[];$.each(events,function(k,evt){if(evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId){var countItem={};countItem.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),countItem["count"+count]=parseInt(evt["in"],10),cameraList.push(countItem),totalPlpVisit+=parseInt(evt["in"],10),
totalInPerSelection+=parseInt(evt["in"],10),filterEvents.push(evt)}}),deviceList.push(cameraList)}),$.each(deviceList,function(j,cameraList){$.each(cameraList,function(j,camera){var timeIndex=kendo.toString(camera.time,data.timeFormat2);deviceTimeList[timeIndex]?deviceTimeList[timeIndex]["count"+count]+=camera["count"+count]:(deviceTimeList[timeIndex]={},deviceTimeList[timeIndex]["count"+count]=camera["count"+count],deviceTimeList[timeIndex].time=camera.time)})})}),$.each(deviceTimeList,function(i,deviceList){countList.push(deviceList)})}if(itemData.isDevice){var name=itemData.labelName+" - "+itemData.text,deviceList=[],deviceTimeList={};$.each(itemData.items,function(i,camera){var cameraData=camera.data,cameraList=[];$.each(events,function(j,evt){if(evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId){var countItem={};countItem.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),countItem["count"+count]=parseInt(evt["in"],10),cameraList.push(countItem),totalPlpVisit+=parseInt(evt["in"],10),totalInPerSelection+=parseInt(evt["in"],10),filterEvents.push(evt)}}),deviceList.push(cameraList)}),$.each(deviceList,function(i,cameraList){$.each(cameraList,function(j,camera){var timeIndex=kendo.toString(camera.time,data.timeFormat2);deviceTimeList[timeIndex]?deviceTimeList[timeIndex]["count"+count]+=camera["count"+count]:(deviceTimeList[timeIndex]={},deviceTimeList[timeIndex]["count"+count]=camera["count"+count],deviceTimeList[timeIndex].time=camera.time)})}),$.each(deviceTimeList,function(i,deviceList){countList.push(deviceList)})}if(itemData.isCamera){var cameraData=itemData.data,name=cameraData.deviceName+" - "+cameraData.channelName;$.each(events,function(i,evt){if(evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId){var countItem={};countItem.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),countItem["count"+count]=parseInt(evt["in"],10),totalPlpVisit+=parseInt(evt["in"],10),totalInPerSelection+=parseInt(evt["in"],10),countList.push(countItem),filterEvents.push(evt)}})}sitenameList.push(name),eventDetails.push({uid:uid,totalPerSelection:totalInPerSelection,spriteCssClass:itemData.spriteCssClass}),seriesInfo.push({id:"g"+count,valueAxis:"v"+count,valueField:"count"+count,type:"smoothedLine",bullet:"round",bulletBorderThickness:1,hideBulletsCount:30,title:name,fillAlphas:0,lineThickness:2,balloonText:name+" :<b>[[value]]</b>"}),count++})}(),function(){$.each(reports.data.selectedItemDataList,function(uid,item){$.each(eventDetails,function(i,grid){return grid.uid!=uid||((item.isLabel||item.isAll)&&(grid.labelText=item.text),item.isDevice&&(grid.labelText=item.labelName,grid.deviceText=item.text),void(item.isCamera&&(grid.labelText=item.labelName,grid.deviceText=item.deviceName,grid.cameraText=item.text)))})})}(),opt.selectedGridList=eventDetails,opt.selectedChartDataSource=countList,opt.selectedChartGraphs=seriesInfo,opt.filterEvents=filterEvents,opt.selectedSitenameList=sitenameList,opt}function setSelectedPosDataList(){var sales=angular.copy(data.apiPosSalesReportList);data.selectedPosDataList=[],data.posFakeData=[],sales.length||(setPosFakeData(),$.each(data.posFakeData,function(i,salesData){var localTime=salesData.time,obj={name:data.selectedSitenameList[0],sales:{time:kendo.toString(utils.convertToUTC(localTime),data.timeFormat1),count:salesData.count,amount:salesData.amount}};sales.push(obj)})),data.selectedPosDataList=sales}function setSelectedPosChartData(){var countList=angular.copy(data.selectedChartDataSource),sales=angular.copy(data.selectedPosDataList),seriesInfo=[],valueAxes=[],dataSales=[],dataCount=[],dataList=[],mergeDataList={};return function(){$.each(countList,function(i,cl){dataCount.push({time:cl.time,count:cl.count0})}),$.each(sales,function(i,obj){dataSales.push({time:utils.UTCToLocal(kendo.parseDate(obj.sales.time,data.timeFormat1)),amount:obj.sales.amount,receipt:obj.sales.count})}),$.each(dataCount,function(i,ds){var timeIndex=kendo.toString(ds.time,data.timeFormat2);mergeDataList[timeIndex]?(mergeDataList[timeIndex].time=ds.time,mergeDataList[timeIndex].count+=ds.count,mergeDataList[timeIndex].amount=0,mergeDataList[timeIndex].receipt=0):(mergeDataList[timeIndex]={},mergeDataList[timeIndex].time=ds.time,mergeDataList[timeIndex].count=ds.count,mergeDataList[timeIndex].amount=0,mergeDataList[timeIndex].receipt=0)}),$.each(dataSales,function(i,ds){var timeIndex=kendo.toString(ds.time,data.timeFormat2);mergeDataList[timeIndex]?(mergeDataList[timeIndex].count=mergeDataList[timeIndex].count,mergeDataList[timeIndex].amount=(mergeDataList[timeIndex].amount||0)+ds.amount,mergeDataList[timeIndex].receipt=(mergeDataList[timeIndex].receipt||0)+ds.receipt):(mergeDataList[timeIndex]={},mergeDataList[timeIndex].time=ds.time,mergeDataList[timeIndex].count=mergeDataList[timeIndex].count||0,mergeDataList[timeIndex].amount=ds.amount,mergeDataList[timeIndex].receipt=ds.receipt)}),$.each(mergeDataList,function(time,ds){ds.count=ds.count||0,ds.amount=ds.amount||0,ds.receipt=ds.receipt||0,ds.conversion=ds.receipt>0&&ds.count>0?Math.round(ds.receipt/ds.count*100)/100:0,dataList.push(ds)}),dataList.sort(function(a,b){return a.time-b.time})}(),function(){valueAxes=[{id:"v0",position:"left",title:i18n("no-people-in")},{id:"v1",position:"right",title:i18n("sales-amount")},{id:"v2",position:"right",title:i18n("receipt"),offset:50},{id:"v3",position:"left",title:i18n("conversion-rate")}]}(),function(){seriesInfo=[{id:"g0",valueAxis:"v0",valueField:"count",type:"smoothedLine",bullet:"round",bulletBorderThickness:1,hideBulletsCount:30,title:i18n("no-people-in"),fillAlphas:0,lineThickness:2,balloonText:i18n("no-people-in")+" :<b>[[value]]</b>",useDataSetColors:!1},{id:"g1",valueAxis:"v1",valueField:"amount",type:"smoothedLine",bullet:"round",bulletBorderThickness:1,hideBulletsCount:30,title:i18n("sales-amount"),fillAlphas:0,lineThickness:2,balloonText:i18n("sales-amount")+" :<b>[[value]]</b>",useDataSetColors:!1},{id:"g2",valueAxis:"v2",valueField:"receipt",type:"smoothedLine",bullet:"round",bulletBorderThickness:1,hideBulletsCount:30,title:i18n("receipt"),fillAlphas:0,lineThickness:2,balloonText:i18n("receipt")+" :<b>[[value]]</b>",useDataSetColors:!1},{id:"g3",valueAxis:"v3",valueField:"conversion",type:"column",cornerRadiusTop:2,title:i18n("conversion-rate"),fillAlphas:1,balloonText:i18n("conversion-rate")+":<b>[[value]]</b>",useDataSetColors:!1}]}(),data.selectedPosChartDataSource=dataList,data.selectedPosChartValueAxes1=[valueAxes[0],valueAxes[1],valueAxes[2]],data.selectedPosChartValueAxes2=[valueAxes[3]],data.selectedPosChartGraphs1=[seriesInfo[0],seriesInfo[1],seriesInfo[2]],data.selectedPosChartGraphs2=[seriesInfo[3]],data}function setPosData(){var selectedSaveDataList=reports.data.selectedSaveDataList,selectedGroupNames=reports.data.selectedGroupNames,selectedItemDataList=reports.data.selectedItemDataList;posData.isShow=1==selectedGroupNames.length&&1==selectedSaveDataList.length,posData.isShowDemo=function(){var check=!1,count=0,countLabel=0;return $.each(selectedItemDataList,function(uid,item){return!!$.isEmptyObject(item)||(item.isLabel&&countLabel++,void count++)}),check=1===count&&1===countLabel}()}function setTimeunitData(){var fromDate=reports.data.dateRange.startDate,toDate=reports.data.dateRange.endDate;utils.getDateDifference(fromDate,toDate);$.each(timeunitData,function(i,unit){unit.isActiveForChart=!1,unit.isActiveForTimecard=!1}),$.each(timeunitData,function(i,unit){if(unit.isShowForChart)return unit.isActiveForChart=!0,!1}),$.each(timeunitData,function(i,unit){if(unit.isShowForTimecard)return unit.isActiveForTimecard=!0,!1}),$.each(timeunitData,function(i,unit){if(unit.isActiveForChart)return data.currentTimeunitForChart=unit.name,!1}),$.each(timeunitData,function(i,unit){if(unit.isActiveForTimecard)return data.currentTimeunitForTimecard=unit.name,!1})}function setGridData(){var opt=data,totalVisits=function(){var count=0;return $.each(opt.selectedGridList,function(i,grid){count+=grid.totalPerSelection}),count}(),selectedDeviceLength=opt.selectedGridList.length,selectedChartSortByDate=(angular.copy(opt.selectedChartDataSource),angular.copy(opt.selectedChartDataSourceByTimeunit));return function(){$.each(selectedChartSortByDate,function(i,ds){ds.aggregate=function(){for(var count=0,j=0;j<selectedDeviceLength;j++)ds["count"+j]=ds["count"+j]||0,count+=ds["count"+j];return count}()}),selectedChartSortByDate.sort(function(a,b){return b.aggregate-a.aggregate}),opt.selectedChartSortByDate=selectedChartSortByDate}(),function(){var highestInfo=angular.copy(opt.selectedChartSortByDate).shift(),lowestInfo=function(){var ds=angular.copy(opt.selectedChartSortByDate),lowestInfo={};return $.each(ds,function(i,info){if(info.aggregate&&(lowestInfo=info),!info.aggregate)return!1}),lowestInfo}();gridData.topEventBox=function(){var data=angular.copy(opt.selectedGridList);return data.sort(function(a,b){return b.totalPerSelection-a.totalPerSelection})}(),gridData.leastEventBox=function(){var data=angular.copy(opt.selectedGridList);return data.sort(function(a,b){return a.totalPerSelection-b.totalPerSelection})}(),gridData.totalEventBox=function(){var data=angular.copy(opt.selectedGridList);return data}(),gridData.totalVisit=kendo.toString(totalVisits,"n0"),gridData.avgVisit=kendo.toString(Math.round(totalVisits/selectedDeviceLength),"n0"),gridData.highestVisit=highestInfo?kendo.toString(highestInfo.aggregate,"n0"):0,gridData.lowestVisit=lowestInfo?kendo.toString(lowestInfo.aggregate,"n0"):0,gridData.highestVisitDate=function(){var returnData="";return returnData=highestInfo?i18n("on")+" "+setChartTimeunitLabel(highestInfo.time):"..."}(),gridData.lowestVisitDate=function(){var returnData="";return returnData=lowestInfo?i18n("on")+" "+setChartTimeunitLabel(lowestInfo.time):"..."}()}(),gridData}function setChartData(){var timeunit=data.currentTimeunitForChart,dataSource=angular.copy(data.selectedChartDataSource),selectedItemLength=reports.data.selectedSaveDataList.length,fromDate=reports.data.dateRange.startDate,toDate=reports.data.dateRange.endDate,dataSourceByTimeunit=[];return function(){for(var tmp={},i=0;i<selectedItemLength;i++)tmp["count"+i]=0;if("hours"==timeunit){for(var start=moment(fromDate),end=moment(toDate),countList=[],i=start;i<=end;i=moment(i).add(1,"hours")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=i.format()}$.each(dataSource,function(index,ds){var index=moment(ds.time).diff(start,"hours");countList[index]=ds}),dataSourceByTimeunit=countList}if("days"==timeunit){for(var start=moment(fromDate),end=moment(toDate),countList=[],i=start;i<=end;i=moment(i).add(1,"days")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=new Date(i)}$.each(dataSource,function(i,ds){for(var index=moment(ds.time).diff(start,"days"),j=0;j<selectedItemLength;j++)void 0!=ds["count"+j]&&(countList[index]["count"+j]+=ds["count"+j])}),dataSourceByTimeunit=countList}if("weeks"==timeunit){for(var weekStart=kupOpt.dateOfWeekStart,start=moment(fromDate).isoWeekday(weekStart),end=moment(toDate).isoWeekday(weekStart),countList=[],i=start;i<=end;i=moment(i).add(1,"weeks")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=new Date(i)}$.each(dataSource,function(i,ds){for(var index=moment(ds.time).diff(start,"weeks"),j=0;j<selectedItemLength;j++)void 0!=ds["count"+j]&&(countList[index]["count"+j]+=ds["count"+j])}),dataSourceByTimeunit=countList}if("months"==timeunit){for(var start=moment(fromDate).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),end=moment(toDate).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),countList=[],i=start;i<=end;i=moment(i).add(1,"month")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=i.format()}$.each(dataSource,function(i,ds){for(var index=moment(ds.time).diff(start,"months"),j=0;j<selectedItemLength;j++)void 0!=ds["count"+j]&&(countList[index]["count"+j]+=ds["count"+j])}),dataSourceByTimeunit=countList}if("years"==timeunit){for(var start=moment(fromDate).month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),end=moment(toDate).month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),countList=[],i=start;i<=end;i=moment(i).add(1,"years")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=i.format()}$.each(dataSource,function(i,ds){for(var index=moment(ds.time).diff(start,"year"),j=0;j<selectedItemLength;j++)void 0!=ds["count"+j]&&(countList[index]["count"+j]+=ds["count"+j])}),dataSourceByTimeunit=countList}}(),function(){$.each(dataSourceByTimeunit,function(i,ds){"string"==typeof ds.time&&(ds.time=moment(ds.time).toDate())})}(),data.selectedChartDataSourceByTimeunit=dataSourceByTimeunit,dataSourceByTimeunit}function setPosChartData(){var timeunit=data.currentTimeunitForChart,dataSource=angular.copy(data.selectedPosChartDataSource),dataSourceByTimeunit=(reports.data.selectedSaveDataList.length,[]);return function(){if("hours"==timeunit){for(var countList=[],start=moment(reports.data.dateRange.startDate),end=moment(reports.data.dateRange.endDate),i=start;i<=end;i=moment(i).add(1,"hours"))countList.push({time:i.format(),count:0,amount:0,receipt:0});$.each(dataSource,function(index,ds){var index=moment(ds.time).diff(start,"hours");countList[index]=ds,countList[index].conversion=ds.receipt>0&&ds.count>0?Math.round(ds.receipt/ds.count*100)/100:0}),dataSourceByTimeunit=countList}if("days"==timeunit){for(var countList=[],start=moment(reports.data.dateRange.startDate),end=moment(reports.data.dateRange.endDate),i=start;i<=end;i=moment(i).add(1,"days"))countList.push({time:i.format(),count:0,amount:0,receipt:0});$.each(dataSource,function(i,ds){var index=moment(ds.time).diff(start,"days");countList[index].count+=ds.count,countList[index].amount+=ds.amount,countList[index].receipt+=ds.receipt,countList[index].conversion=countList[index].receipt>0&&countList[index].count>0?Math.round(countList[index].receipt/countList[index].count*100)/100:0}),dataSourceByTimeunit=countList}if("weeks"==timeunit){for(var weekStart=kupOpt.dateOfWeekStart,start=moment(reports.data.dateRange.startDate).isoWeekday(weekStart),end=moment(reports.data.dateRange.endDate).isoWeekday(weekStart),countList=[],i=start;i<=end;i=moment(i).add(1,"weeks"))countList.push({time:i.format(),count:0,amount:0,receipt:0});$.each(dataSource,function(i,ds){var index=moment(ds.time).diff(start,"weeks");countList[index].count+=ds.count,countList[index].amount+=ds.amount,countList[index].receipt+=ds.receipt,countList[index].conversion=countList[index].receipt>0&&countList[index].count>0?Math.round(countList[index].receipt/countList[index].count*100)/100:0}),dataSourceByTimeunit=countList}if("months"==timeunit){for(var start=moment(reports.data.dateRange.startDate).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),end=moment(reports.data.dateRange.endDate).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),countList=[],i=start;i<=end;i=moment(i).add(1,"month"))countList.push({time:i.format(),count:0,amount:0,receipt:0});$.each(dataSource,function(i,ds){var index=moment(ds.time).diff(start,"month");countList[index].count+=ds.count,countList[index].amount+=ds.amount,countList[index].receipt+=ds.receipt,countList[index].conversion=countList[index].receipt>0&&countList[index].count>0?Math.round(countList[index].receipt/countList[index].count*100)/100:0}),dataSourceByTimeunit=countList}if("years"==timeunit){for(var start=moment(reports.data.dateRange.startDate).month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),end=moment(reports.data.dateRange.endDate).month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),countList=[],i=start;i<=end;i=moment(i).add(1,"years"))countList.push({time:i.format(),count:0,amount:0,receipt:0});$.each(dataSource,function(i,ds){var index=moment(ds.time).diff(start,"years");countList[index].count+=ds.count,countList[index].amount+=ds.amount,countList[index].receipt+=ds.receipt,countList[index].conversion=countList[index].receipt>0&&countList[index].count>0?Math.round(countList[index].receipt/countList[index].count*100)/100:0}),dataSourceByTimeunit=countList}}(),function(){$.each(dataSourceByTimeunit,function(i,ds){"string"==typeof ds.time&&(ds.time=moment(ds.time).toDate())})}(),data.selectedPosChartDataSourceByTimeunit=dataSourceByTimeunit,dataSourceByTimeunit}function setChartOptions(){var chartSetting=function(){var setting={};return $.each(timeunitData,function(i,unit){if(unit.name===data.currentTimeunitForChart)return setting.minPeriod=unit.chartPeriod,!1}),setting}(),chartOptions={dataProvider:angular.copy(data.selectedChartDataSourceByTimeunit),graphs:angular.copy(data.selectedChartGraphs),type:"serial",theme:AuthTokenFactory.getTheme(),zoomOutText:i18n("show-all"),valueAxes:[{axisColor:"chartCursor",axisThickness:2,axisAlpha:1,position:"left"}],chartScrollbar:{autoGridCount:!0,graph:"g0",scrollbarHeight:40},chartCursor:{cursorPosition:"mouse",categoryBalloonFunction:function(){var time=arguments[0];return setChartTimeunitLabel(time)}},categoryField:"time",categoryAxis:{firstDayOfWeek:kupOpt.dateOfWeekStart,gridAlpha:0,markPeriodChange:!0,boldLabels:!0,minPeriod:chartSetting.minPeriod,parseDates:!0,equalSpacing:!0,dateFormats:[{period:"fff",format:"JJ:NN:SS"},{period:"ss",format:"JJ:NN:SS"},{period:"mm",format:"JJ:NN"},{period:"hh",format:"JJ:NN"},{period:"DD",format:"MMM DD"},{period:"WW",format:"MMM DD"},{period:"MM",format:"MMM"},{period:"YYYY",format:"YYYY"}],labelFunction:function(dateText){var time=arguments[1];switch(chartSetting.minPeriod){case"hh":dateText=moment(time).format(kupOpt["default"].formatAxisHourly);break;case"DD":dateText=moment(time).format(kupOpt["default"].formatAxisDaily);break;case"WW":dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatAxisWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatAxisWeekly);break;case"MM":dateText=moment(time).format(kupOpt["default"].formatAxisMonthly)}return dateText}},legend:{useGraphSettings:!1,valueWidth:0,valueFunction:function(){return""}}};return chartData.options=chartOptions,chartOptions}function setChartForPdfOptions(){var chartSetting=function(){var setting={};return $.each(timeunitData,function(i,unit){if(unit.name===data.currentTimeunitForChart)return setting.minPeriod=unit.chartPeriod,!1}),setting}(),chartOptions={dataProvider:angular.copy(data.selectedChartDataSourceByTimeunit),graphs:angular.copy(data.selectedChartGraphs),type:"serial",theme:"white",zoomOutText:i18n("show-all"),valueAxes:[{axisColor:"chartCursor",axisThickness:2,axisAlpha:1,position:"left"}],chartCursor:{cursorPosition:"mouse",categoryBalloonFunction:function(){var time=arguments[0];return setChartTimeunitLabel(time)}},categoryField:"time",categoryAxis:{firstDayOfWeek:kupOpt.dateOfWeekStart,gridAlpha:0,markPeriodChange:!0,boldLabels:!0,minPeriod:chartSetting.minPeriod,parseDates:!0,equalSpacing:!0,dateFormats:[{period:"fff",format:"JJ:NN:SS"},{period:"ss",format:"JJ:NN:SS"},{period:"mm",format:"JJ:NN"},{period:"hh",format:"JJ:NN"},{period:"DD",format:"MMM DD"},{period:"WW",format:"MMM DD"},{period:"MM",format:"MMM"},{period:"YYYY",format:"YYYY"}],labelFunction:function(dateText){var time=arguments[1];switch(chartSetting.minPeriod){case"hh":dateText=moment(time).format(kupOpt["default"].formatAxisHourly);break;case"DD":dateText=moment(time).format(kupOpt["default"].formatAxisDaily);break;case"WW":dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatAxisWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatAxisWeekly);break;case"MM":dateText=moment(time).format(kupOpt["default"].formatAxisMonthly)}return dateText}},legend:{useGraphSettings:!1,valueWidth:0,valueFunction:function(){return""}}};return chartForPdfData.options=chartOptions,chartForPdfData}function setPosChartOptions(){var chartSetting=function(){var setting={};return $.each(timeunitData,function(i,unit){if(unit.name===data.currentTimeunitForChart)return setting.minPeriod=unit.chartPeriod,!1}),setting}(),posChartOptions={type:"stock",theme:AuthTokenFactory.getTheme(),firstDayOfWeek:kupOpt.dateOfWeekStart,dataSets:[{fieldMappings:[{fromField:"count",toField:"count"},{fromField:"amount",toField:"amount"},{fromField:"receipt",toField:"receipt"},{fromField:"conversion",toField:"conversion"}],dataProvider:angular.copy(data.selectedPosChartDataSourceByTimeunit),categoryField:"time"}],categoryAxesSettings:{minPeriod:chartSetting.minPeriod,equalSpacing:!0},valueAxesSettings:{inside:!0,axisAlpha:1,tickLength:5,gridAlpha:0,axisThickness:2},chartScrollbarSettings:{graph:"g3",usePeriod:chartSetting.minPeriod,position:"top"},chartCursorSettings:{cursorPosition:"mouse",valueBalloonsEnabled:!0},panelsSettings:{usePrefixes:!0,marginLeft:50,marginRight:100},panels:[{showCategoryAxis:!1,percentHeight:60,valueAxes:angular.copy(data.selectedPosChartValueAxes1),stockGraphs:angular.copy(data.selectedPosChartGraphs1),stockLegend:{periodValueTextComparing:"[[percents.value.close]]%",periodValueTextRegular:"[[value.close]]"}},{percentHeight:40,valueAxes:angular.copy(data.selectedPosChartValueAxes2),stockGraphs:angular.copy(data.selectedPosChartGraphs2),stockLegend:{periodValueTextComparing:"[[percents.value.close]]%",periodValueTextRegular:"[[value.close]]"},chartCursor:{categoryBalloonFunction:function(){var time=arguments[0];return setChartTimeunitLabel(time)}},categoryAxis:{markPeriodChange:!0,boldLabels:!0,minPeriod:chartSetting.minPeriod,parseDates:!0,equalSpacing:!0,dateFormats:[{period:"fff",format:"JJ:NN:SS"},{period:"ss",format:"JJ:NN:SS"},{period:"mm",format:"JJ:NN"},{period:"hh",format:"JJ:NN"},{period:"DD",format:"MMM DD"},{period:"WW",format:"MMM DD"},{period:"MM",format:"MMM"},{period:"YYYY",format:"YYYY"}],labelFunction:function(dateText){var time=arguments[1];switch(chartSetting.minPeriod){case"hh":dateText=moment(time).format(kupOpt["default"].formatAxisHourly);break;case"DD":dateText=moment(time).format(kupOpt["default"].formatAxisDaily);break;case"WW":dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatAxisWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatAxisWeekly);break;case"MM":dateText=moment(time).format(kupOpt["default"].formatAxisMonthly)}return dateText}}}]};return posChartData.options=posChartOptions,posChartOptions}function setPosChartForPdfOptions(){var chartSetting=function(){var setting={};return $.each(timeunitData,function(i,unit){if(unit.name===data.currentTimeunitForChart)return setting.minPeriod=unit.chartPeriod,!1}),setting}(),posChartOptions={type:"stock",theme:"white",dataSets:[{fieldMappings:[{fromField:"count",toField:"count"},{fromField:"amount",toField:"amount"},{fromField:"receipt",toField:"receipt"},{fromField:"conversion",toField:"conversion"}],dataProvider:angular.copy(data.selectedPosChartDataSourceByTimeunit),categoryField:"time"}],categoryAxesSettings:{minPeriod:chartSetting.minPeriod,equalSpacing:!0},valueAxesSettings:{inside:!0,axisAlpha:1,tickLength:5,gridAlpha:0,axisThickness:2},chartScrollbarSettings:{graph:"g3",usePeriod:chartSetting.minPeriod,position:"top"},chartCursorSettings:{cursorPosition:"mouse",valueBalloonsEnabled:!0},panelsSettings:{usePrefixes:!0,marginLeft:50,marginRight:100},panels:[{showCategoryAxis:!1,percentHeight:60,valueAxes:angular.copy(data.selectedPosChartValueAxes1),stockGraphs:angular.copy(data.selectedPosChartGraphs1),stockLegend:{periodValueTextComparing:"[[percents.value.close]]%",periodValueTextRegular:"[[value.close]]"}},{percentHeight:40,valueAxes:angular.copy(data.selectedPosChartValueAxes2),stockGraphs:angular.copy(data.selectedPosChartGraphs2),stockLegend:{periodValueTextComparing:"[[percents.value.close]]%",periodValueTextRegular:"[[value.close]]"},chartCursor:{categoryBalloonFunction:function(){var time=arguments[0];return setChartTimeunitLabel(time)}},categoryAxis:{markPeriodChange:!0,boldLabels:!0,minPeriod:chartSetting.minPeriod,parseDates:!0,equalSpacing:!0,dateFormats:[{period:"fff",format:"JJ:NN:SS"},{period:"ss",format:"JJ:NN:SS"},{period:"mm",format:"JJ:NN"},{period:"hh",format:"JJ:NN"},{period:"DD",format:"MMM DD"},{period:"WW",format:"MMM DD"},{period:"MM",format:"MMM"},{period:"YYYY",format:"YYYY"}],labelFunction:function(dateText){var time=arguments[1];switch(chartSetting.minPeriod){case"hh":dateText=moment(time).format(kupOpt["default"].formatAxisHourly);break;case"DD":dateText=moment(time).format(kupOpt["default"].formatAxisDaily);break;case"WW":dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatAxisWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatAxisWeekly);break;case"MM":dateText=moment(time).format(kupOpt["default"].formatAxisMonthly)}return dateText}}}]};return posChartForPdfData.options=posChartOptions,posChartForPdfData}function setTimecardData(isShowDemo){return posData.isShowDemo=isShowDemo,timecardData.options.peopleCountingData=data.filterEvents,timecardData.options.posData=isShowDemo?data.selectedPosDataList:[],timecardData}function setPosFakeData(){var countList=angular.copy(data.selectedChartDataSource),posFakeData=[];return $.each(countList,function(index,data){var randomConversionRate=utils.getRandomDecimal(.1,.4),POSData={time:kendo.toString(data.time,data.timeFormat1),count:data.count0?parseInt(randomConversionRate*data.count0,10):0,amount:data.count0?data.count0*utils.getRandomInteger(0,100):0};posFakeData.push(POSData)}),data.posFakeData=posFakeData,posFakeData}function getPosSalesReportApi(isDefer){var opt=data,groupNames=(reports.data,reports.data.selectedGroupNames),siteName=$.isArray(groupNames)&&groupNames.length>0?groupNames[0]:"",fromDate=reports.data.dateRange.startDate,toDate=reports.data.dateRange.endDate,UTCFrom=utils.convertToUTC(fromDate),UTCTo=utils.convertToUTC(toDate),fromStr=kendo.toString(UTCFrom,data.timeFormat2),toStr=kendo.toString(UTCTo,data.timeFormat2),param={from:fromStr,to:toStr,name:siteName,"parser-type":""},onSuccess=function(response){opt.apiPosSalesReportList=response.sales||[]},onFail=function(response){opt.apiPosSalesReportList=[]},onError=function(){opt.apiPosSalesReportList=[]};return ajaxPost("getpossalesreport",param,onSuccess,onFail,onError,isDefer)}function getAnalyticsReportApi(isDefer){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,selectedDeviceList=reportsOpt.selectedDevices[0].platformDeviceId,fromDateUTC=(reportsOpt.selectedDevices[0].channelId,kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),data.timeFormat2)),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),data.timeFormat2),param={"event-type":vcaEventType,"device-id":JSON.stringify(selectedDeviceList),"channel-id":"",from:fromDateUTC,to:toDateUTC,parameters:JSON.stringify({})},onSuccess=function(response){opt.apiAnalyticsReportList=response.data||[]},onFail=function(response){opt.apiAnalyticsReportList=[]},onError=function(){opt.apiAnalyticsReportList=[]};return ajaxPost("getanalyticsreport",param,onSuccess,onFail,onError,isDefer)}function exportSecurityCrossSiteCSVApi(){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,dvcId=reportsOpt.selectedInstance,groupNames=(reportsOpt.selectedDevices,reportsOpt.selectedGroupNames),fromDateUTC=(reportsOpt.apiPosNamesList,kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),opt.timeFormat2)),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),opt.timeFormat2),baseUnit=opt.currentTimeunitForChart,siteName=$.isArray(groupNames)&&groupNames.length>0?groupNames[0]:"",devices=function(){var devices=[];return $.each(dvcId,function(i,dv){if(devices.length<1)devices.push([dv.platformDeviceId+"-"+dv.channelId]);else{var flag=!0;$.each(devices,function(i,t){if(0===$.inArray(dv.platformDeviceId+"-"+dv.channelId,t))return flag=!1,!1}),flag&&devices.push([dv.platformDeviceId+"-"+dv.channelId])}}),devices}(),totalVisits=function(){var count=0;return $.each(opt.selectedGridList,function(i,grid){count+=grid.totalPerSelection}),count}(),reportInfo={"event-type":vcaEventType,"site-name":opt.selectedSitenameList.toString(),from:kendo.toString(reportsOpt.dateRange.startDate,opt.timeFormat1),to:kendo.toString(reportsOpt.dateRange.endDate,opt.timeFormat1),"total-results":totalVisits+""},param={"device-id":devices.toString(),"time-zone-offset":KupApiService.data.timeZoneOffset,from:fromDateUTC,to:toDateUTC,"base-unit":baseUnit,"report-info":JSON.stringify(reportInfo),sitename:siteName},onSuccess=function(response){if(null!=response["download-url"]){var openUrl=apiServerUrl+response["download-url"];window.open(openUrl,"_blank"),window.focus()}},onFail=function(response){},onError=function(){};return ajaxPost("exportsecuritycrosssitecsv",param,onSuccess,onFail,onError)}function exportAggregatedCsvReportApi(periodType){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,fromDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),opt.timeFormat2),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),opt.timeFormat2),baseUnit=periodType,selectedGroups=[],type="";$.each(reportsOpt.selectedItemDataList,function(uid,itemData){var devices=[];if($.isEmptyObject(itemData))return!0;if(itemData.isAll||itemData.isLabel){var device=itemData.items||[];$.each(device,function(i,deviceData){var camera=deviceData.items||[];$.each(camera,function(j,cameraData){devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId})})}),type="labels"}else if(itemData.isDevice){var camera=itemData.items||[];$.each(camera,function(i,cameraData){devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId})}),type="devices"}else if(itemData.isCamera){if(itemData.hasChildren)return;var cameraData=itemData;devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId}),type="devices"}!function(){var groupname="";(itemData.isLabel||itemData.isAll)&&(groupname=itemData.labelName),itemData.isDevice&&(groupname=itemData.labelName+" - "+itemData.text),itemData.isCamera&&(groupname=itemData.labelName+" - "+itemData.deviceName+" - "+itemData.text),selectedGroups.push({groupName:groupname,devicePairs:devices,type:type})}()});var param={"event-type":vcaEventType,"selected-groups":JSON.stringify(selectedGroups),"time-zone-offset":KupApiService.data.timeZoneOffset,from:fromDateUTC,to:toDateUTC,"base-unit":baseUnit};return KupApiService.exportDoc(param,"exportaggregatedcsvreport")}function exportPeopleCountingPdfApi(){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,svgTitle="<svg version='1.1' width='900' height='30'><text y='15' x='0' transform='translate(450)' text-anchor='middle' font-size='20' font-weight='bold'>"+i18n("vistors-vs-time")+"</text></svg>",svgData=function(){var svgData=[];if(svgData.push(svgTitle),"chart"==opt.currentTab){if(posData.isShowDemo){var chartOpt=setPosChartForPdfOptions().options;window.AmCharts.makeChart(opt.$posChartForPdf.slice(1),chartOpt);$.each($(opt.$posChartForPdf).find("svg"),function(i,el){svgData.push("<svg version='1.1' width='"+$(el).css("width")+"' height='"+$(el).css("height")+"'>"+$(el).html()+"</svg>")})}if(!posData.isShowDemo){var chartOpt=setChartForPdfOptions().options;window.AmCharts.makeChart(opt.$chartForPdf.slice(1),chartOpt);$.each($(opt.$chartForPdf).find("svg"),function(i,el){svgData.push("<svg version='1.1' width='"+$(el).css("width")+"' height='"+$(el).css("height")+"'>"+$(el).html()+"</svg>");
})}}return"timecard"==opt.currentTab&&$.each($(opt.$timeCard),function(i,el){svgData.push($(el).html())}),svgData}(),totalVisits=function(){var count=0;return $.each(opt.selectedGridList,function(i,grid){count+=grid.totalPerSelection}),count}(),reportInfo={"event-type":vcaEventType,"site-name":opt.selectedSitenameList.toString(),from:kendo.toString(reportsOpt.dateRange.startDate,opt.timeFormat1),to:kendo.toString(reportsOpt.dateRange.endDate,opt.timeFormat1),"total-results":totalVisits+""},param={"time-zone-offset":KupApiService.data.timeZoneOffset,"svg-string":svgData.join(""),"report-info":JSON.stringify(reportInfo)};return KupApiService.exportDoc(param,"exportpeoplecountingpdf")}function setChartTimeunitLabel(dateFormat){var dateText="",time=new Date(dateFormat),dateLang=(kupOpt.dateOfWeekStart,"en-us"),dateOpt={weekday:"short",month:"short",day:"numeric",year:"numeric"};return"hours"==data.currentTimeunitForChart&&(dateText=moment(time).format(kupOpt["default"].formatHourly)),"days"==data.currentTimeunitForChart&&(dateText=moment(time).format(kupOpt["default"].formatDaily)),"weeks"==data.currentTimeunitForChart&&(dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatWeekly)),"months"==data.currentTimeunitForChart&&(dateText=moment(time).format(kupOpt["default"].formatMonthly)),"years"==data.currentTimeunitForChart&&(dateOpt={year:"numeric"},dateText=time.toLocaleDateString(dateLang,dateOpt)),dateText}function setChartTheme(){var theme=AuthTokenFactory.getTheme();window.AmCharts.themes[theme]=AmchartsTheme[theme]}function generateChart(){setChartTheme(),setChartData(),setChartOptions(),setGridData()}function generatePosChart(){setChartTheme(),setPosChartData(),setPosChartOptions()}function generateReport(){var opt=data,reportsOpt=reports.data;if(opt.cardType="COUNTING",$.each(opt.requestForReport,function(i,request){request.cancel&&request.cancel()}),!reports.isSelectCamera())return notification("error",i18n("no-channel-selected")),reports.isSuccessReport(!1),!1;opt.requestForReport=[getAnalyticsReportApi(!0),getPosSalesReportApi(!0)];var dfd=$q.defer();return $timeout(function(){$q.all(opt.requestForReport)["finally"](function(){return setSelectedChartData(),setSelectedPosDataList(),setSelectedPosChartData(),setPosData(),setTimeunitData(),reportsOpt.selectedDevices.length>1&&($timeout(function(){angular.element("#pcountingTabChart").triggerHandler("click")}),tabData[1].isShow=!1),reportsOpt.selectedDevices.length<=1&&(tabData[1].isShow=!0),opt.selectedChartDataSource.length<=0?(reports.isSuccessReport(!1),void dfd.reject()):(reports.isSuccessReport(!0),generateChart(),generatePosChart(),setTimecardData(posData.isShowDemo),void dfd.resolve())})},500),dfd.promise}var kupOpt=KupOption,utils=UtilsService,i18n=UtilsService.i18n,notification=UtilsService.notification,ajaxPost=KupApiService.ajaxPost,reports=ReportsService,apiServerUrl=AuthTokenFactory.getApiRootUrl(),data={$chart:"#pcountingChart",$chartForPdf:"#pcountingChartForPdf",$posChart:"#pcountingPosChart",$posChartForPdf:"#pcountingPosChartForPdf",$timeCard:"#timeCardBox",timeFormat0:"yyyy/MM/dd HH:mm:ss",timeFormat1:"dd/MM/yyyy HH:mm:ss",timeFormat2:"ddMMyyyyHHmmss",selectedGridList:{},selectedSitenameList:[],selectedChartDataSource:[],selectedChartDataSourceByTimeunit:[],selectedChartGraphs:[{connect:!0,valueField:"count0"}],selectedChartSortByDate:[],filterEvents:[],selectedPosChartDataSource:[],selectedPosChartDataSourceByTimeunit:[],selectedPosChartValueAxes1:[],selectedPosChartValueAxes2:[],selectedPosChartGraphs1:[],selectedPosChartGraphs2:[],selectedPosDataList:[],apiAnalyticsReportList:[],apiPosSalesReportList:[],currentTab:"chart",currentTimeunitForChart:"hours",currentTimeunitForTimecard:"weeks",posFakeData:[],cardType:"COUNTING",requestForReport:[],dataSourceByTimeunit:[]},timeunitData=[{name:"hours",text:"hourly",isActiveForChart:!0,isActiveForTimecard:!1,isShowForChart:!0,isShowForTimecard:!1,chartPeriod:"hh"},{name:"days",text:"daily",isActiveForChart:!1,isActiveForTimecard:!1,isShowForChart:!0,isShowForTimecard:!1,chartPeriod:"DD"},{name:"weeks",text:"weekly",isActiveForChart:!1,isActiveForTimecard:!0,isShowForChart:!0,isShowForTimecard:!0,chartPeriod:"WW"},{name:"months",text:"monthly",isActiveForChart:!1,isActiveForTimecard:!1,isShowForChart:!0,isShowForTimecard:!0,chartPeriod:"MM"},{name:"years",text:"yearly",isActiveForChart:!1,isActiveForTimecard:!1,isShowForChart:!1,isShowForTimecard:!0,chartPeriod:"YYYY"}],tabData=[{id:"pcountingTabChart",name:"chart",text:"charts",isActive:!0,isShow:!0,className:"fa-bar-chart"},{id:"pcountingTabTimecard",name:"timecard",text:"time-card",isActive:!1,isShow:!0,className:"fa-clock-o"}],exportData={isOpen:!1},posData={isShow:!0,isShowDemo:!1},chartData={options:{}},chartForPdfData={width:"900px",height:"400px",options:{}},posChartData={options:{}},posChartForPdfData={width:"900px",height:"600px",options:{}},timecardData={options:{}},gridData={isShow:!0,totalVisit:"...",avgVisit:"...",highestVisit:"...",lowestVisit:"...",leastEventBox:[],topEventBox:[],totalEventBox:[]};return{data:data,timeunitData:timeunitData,tabData:tabData,exportData:exportData,posData:posData,chartData:chartData,chartForPdfData:chartForPdfData,posChartData:posChartData,posChartForPdfData:posChartForPdfData,timecardData:timecardData,gridData:gridData,setSelectedChartData:setSelectedChartData,setSelectedPosChartData:setSelectedPosChartData,setSelectedPosDataList:setSelectedPosDataList,setGridData:setGridData,setPosData:setPosData,setTimeunitData:setTimeunitData,setTimecardData:setTimecardData,setPosFakeData:setPosFakeData,setChartTimeunitLabel:setChartTimeunitLabel,setChartTheme:setChartTheme,setChartData:setChartData,setChartOptions:setChartOptions,setChartForPdfOptions:setChartForPdfOptions,setPosChartData:setPosChartData,setPosChartOptions:setPosChartOptions,setPosChartForPdfOptions:setPosChartForPdfOptions,getAnalyticsReportApi:getAnalyticsReportApi,getPosSalesReportApi:getPosSalesReportApi,exportSecurityCrossSiteCSVApi:exportSecurityCrossSiteCSVApi,exportAggregatedCsvReportApi:exportAggregatedCsvReportApi,exportPeopleCountingPdfApi:exportPeopleCountingPdfApi,generateReport:generateReport,generateChart:generateChart,generatePosChart:generatePosChart}}]),angular.module("kai.reports.pcounting").controller("PcountingController",["KupOption","RouterStateService","UtilsService","PromiseFactory","AuthTokenFactory","ReportsService","PcountingService","$scope","$timeout","$q","$rootScope",function(KupOption,RouterStateService,UtilsService,PromiseFactory,AuthTokenFactory,ReportsService,PcountingService,$scope,$timeout,$q,$rootScope){function init(){$scope.$watch(function(){return angular.toJson(reports.data)},function(newVal,oldVal){var reportsOpt=angular.fromJson(newVal);pcountingCtrl.noData.data.isShow=!reportsOpt.isSuccessReport},!0),$scope.$watch(function(){return AuthTokenFactory.getTheme()},function(newVal,oldVal){return newVal!=oldVal&&(PcountingService.setChartTheme(),PcountingService.generateChart(),void PcountingService.generatePosChart())},!0),$scope.$watch("pcountingCtrl.pos.data.isShowDemo",function(newVal,oldVal){pcountingCtrl.timecard.data.options.isShowDemo=newVal},!0)}function setTab(tabName){var opt=pcountingCtrl.data,tabData=pcountingCtrl.tab.data;$.each(tabData,function(i,data){data.isActive=tabName===data.name}),opt.currentTab=tabName}function setPosData(isShowDemo){var opt=pcountingCtrl.data,posData=pcountingCtrl.pos.data;posData.isShowDemo=isShowDemo,pcountingCtrl.timecard.data=PcountingService.timecardData,isShowDemo||(opt.cardType="COUNTING")}function setTimeunitForChart(unitName){var opt=pcountingCtrl.data,timeunitData=pcountingCtrl.timeunit.data;$.each(timeunitData,function(i,data){data.isActiveForChart=unitName===data.name}),opt.currentTimeunitForChart=unitName,PcountingService.generateChart(),PcountingService.generatePosChart()}function setTimeunitForTimecard(unitName){var opt=pcountingCtrl.data,posData=pcountingCtrl.pos.data,timeunitData=pcountingCtrl.timeunit.data;$.each(timeunitData,function(i,data){data.isActiveForTimecard=unitName===data.name}),opt.currentTimeunitForTimecard=unitName,PcountingService.setTimecardData(posData.isShowDemo)}function exportCsv(periodType){if(!reports.isSuccessReport())return notification("error",i18n("please-generate-reports")),!1;var warningNotify=notification("warning",i18n("exporting-to-csv"),0);PcountingService.exportAggregatedCsvReportApi(periodType)["finally"](function(){warningNotify.close()})}function exportPdf(){if(!reports.isSuccessReport())return notification("error",i18n("please-generate-reports")),!1;var warningNotify=notification("warning",i18n("exporting-to-pdf"),0);PcountingService.exportPeopleCountingPdfApi()["finally"](function(){warningNotify.close()})}function downloadPosFile(){var openUrl="static/files/download/userguide.zip";window.open(openUrl,"_blank"),window.focus()}var i18n=UtilsService.i18n,notification=UtilsService.notification,reports=ReportsService,pcountingCtrl=this;pcountingCtrl.data=PcountingService.data,pcountingCtrl.fn={setTab:setTab,setTimeunitForChart:setTimeunitForChart,setTimeunitForTimecard:setTimeunitForTimecard,setPosData:setPosData,exportPdf:exportPdf,exportCsv:exportCsv,downloadPosFile:downloadPosFile},pcountingCtrl.isPOSDataAvailable=PcountingService.data.isPOSDataAvailable,pcountingCtrl.tab={},pcountingCtrl.tab.data=PcountingService.tabData,pcountingCtrl.timeunit={},pcountingCtrl.timeunit.data=PcountingService.timeunitData,pcountingCtrl["export"]={},pcountingCtrl["export"].data=PcountingService.exportData,pcountingCtrl.pos={},pcountingCtrl.pos.data=PcountingService.posData,pcountingCtrl.chart={},pcountingCtrl.chart.data=PcountingService.chartData,pcountingCtrl.chartForPdf={},pcountingCtrl.chartForPdf.data=PcountingService.chartForPdfData,pcountingCtrl.posChart={},pcountingCtrl.posChart.data=PcountingService.posChartData,pcountingCtrl.posChartForPdf={},pcountingCtrl.posChartForPdf.data=PcountingService.posChartForPdfData,pcountingCtrl.timecard={},pcountingCtrl.timecard.data=PcountingService.timecardData,pcountingCtrl.grid={},pcountingCtrl.grid.data=PcountingService.gridData,pcountingCtrl.data=PcountingService.data,pcountingCtrl.noData={},pcountingCtrl.noData.data={isShow:!0},init()}]);