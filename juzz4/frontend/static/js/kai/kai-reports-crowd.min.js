angular.module("kai.reports.crowd",["ui.amcharts"]),angular.module("kai.reports.crowd").factory("CrowdMapManagerService",["UtilsService",function(UtilsService){var utils=UtilsService,i18n=UtilsService.i18n,mapManager={};return mapManager.map=null,mapManager.mapWidth=null,mapManager.mapHeight=null,mapManager.backgroundImage=null,mapManager.drawnItems=null,mapManager.bgImageLoaded=!1,mapManager.initialize=function(divId,zoomLvl,zoomControl,canPan){mapManager.map=new L.Map(divId,{layers:[new L.TileLayer("",{maxZoom:18})],center:new L.LatLng(0,0),zoom:zoomLvl,zoomControl:zoomControl,dragging:canPan}),mapManager.mapWidth=$("#"+divId).width(),mapManager.mapHeight=$("#"+divId).height()},mapManager.addImageOverlay=function(imageUrl){mapManager.removeImageOverlay();var bgImage=L.imageOverlay(imageUrl,mapManager.map.getBounds());mapManager.backgroundImage=bgImage,bgImage.addTo(mapManager.map),bgImage.bringToBack()},mapManager.setBackgroundImage=function(url){null!=url&&0!=url.length&&(mapManager.addImageOverlay(url),mapManager.bgImageLoaded=!0)},mapManager.setEmptyBackground=function(){mapManager.removeImageOverlay();var bgImage=L.imageOverlay("/public/css/common/images/empty_background.jpg",mapManager.map.getBounds());mapManager.backgroundImage=bgImage,bgImage.addTo(mapManager.map),bgImage.bringToBack()},mapManager.setLiveSnapshotBackground=function(coreDeviceId,channelId){mapManager.bgImageLoaded=!1,utils.showLoadingOverlay(),vca.getCameraSnapshot(coreDeviceId,channelId,function(jpegUrl){null==jpegUrl?(utils.popupAlert(i18n("error-loading-image")),mapManager.setEmptyBackground()):mapManager.setBackgroundImage(jpegUrl),utils.hideLoadingOverlay()})},mapManager.removeImageOverlay=function(){mapManager.backgroundImage&&(mapManager.map.removeLayer(mapManager.backgroundImage),mapManager.backgroundImage=null)},mapManager.initializeDrawingTools=function(marker,polyline,polygon,circle,rectangle,showEditOptions){mapManager.drawnItems=new L.FeatureGroup,mapManager.map.addLayer(mapManager.drawnItems);var editOptions={featureGroup:mapManager.drawnItems,edit:{selectedPathOptions:{stroke:!0,color:"red",weight:2,opacity:.8}}};if(showEditOptions){var drawControl=new L.Control.Draw({position:"topleft",draw:{marker:marker,polyline:polyline,polygon:polygon,circle:circle,rectangle:rectangle},edit:editOptions});mapManager.map.addControl(drawControl),mapManager.customizeDeleteFunction()}},mapManager.removeDrawnItems=function(){null!=mapManager.drawnItems&&mapManager.drawnItems.eachLayer(function(layer){null!=layer.arrows&&mapManager.map.removeLayer(layer.arrows),null!=layer.label&&mapManager.map.removeLayer(layer.label),mapManager.map.removeLayer(layer),mapManager.drawnItems.removeLayer(layer)}),"undefined"!=typeof peopleCounting&&null!=peopleCounting&&peopleCounting.mapLayersRemoved(),"undefined"!=typeof trafficflow&&null!=trafficflow&&trafficflow.mapLayersRemoved(),"undefined"!=typeof crowddensity&&null!=crowddensity&&crowddensity.mapLayersRemoved()},mapManager.removeDrawnLayerByLayerName=function(layerName){mapManager.drawnItems.eachLayer(function(layer){layer.name==layerName&&(null!=layer.arrows&&mapManager.map.removeLayer(layer.arrows),null!=layer.label&&mapManager.map.removeLayer(layer.label),mapManager.map.removeLayer(layer),mapManager.drawnItems.removeLayer(layer))}),"undefined"!=typeof crowddensity&&null!=crowddensity&&crowddensity.mapLayersRemoved()},mapManager.removeDrawnLayerByLayer=function(removeLayer){mapManager.drawnItems.eachLayer(function(layer){layer==removeLayer&&(null!=layer.arrows&&mapManager.map.removeLayer(layer.arrows),null!=layer.label&&mapManager.map.removeLayer(layer.label),mapManager.map.removeLayer(layer),mapManager.drawnItems.removeLayer(layer))}),"undefined"!=typeof crowddensity&&null!=crowddensity&&crowddensity.mapLayersRemoved()},mapManager.customizeDeleteFunction=function(){$(".leaflet-draw-edit-remove").hide(),$(".leaflet-draw-edit-edit").attr("title",i18n("edit")),$(".leaflet-draw-edit-edit").parent().append('<a class="leaflet-draw-edit-remove" href="javascript:mapManager.removeDrawnItems()" title="'+i18n("delete-all")+'"></a>')},mapManager.getEstimatedCenter=function(layer){var bounds=layer.getBounds(),pSW=mapManager.map.latLngToContainerPoint(bounds.getSouthWest()),pNE=mapManager.map.latLngToContainerPoint(bounds.getNorthEast()),centX=(pNE.x-pSW.x)/2+pSW.x,centY=(pSW.y-pNE.y)/2+pNE.y,centLatLng=mapManager.map.containerPointToLatLng(new L.Point(centX,centY));return centLatLng},mapManager.enableDrawingTools=function(flag){null!=mapManager&&(flag?$(".leaflet-control").show("slide",{direction:"left"}):$(".leaflet-control").hide("slide",{direction:"left"}))},mapManager.addLabel=function(text,latLng,className){if(null!=text){var horizontalPadding=5,charWidth=8,charHeight=19,totalWidth=charWidth*text.length+2*horizontalPadding;return L.marker(latLng,{icon:L.divIcon({className:className,iconSize:[totalWidth,charHeight],html:text}),draggable:!1,zIndexOffset:1e3}).addTo(mapManager.map)}},mapManager.bgImageExists=function(){return mapManager.bgImageLoaded},mapManager}]),angular.module("kai.reports.crowd").factory("CrowdSvgService",["UtilsService","CrowdDensityService","CrowdMapManagerService",function(UtilsService,CrowdDensityService,CrowdMapManagerService){function showCrowdHeatmap(heatmapBase64Image,maximum){maximum=100,$("#heatmapSnapshot").html('<img src="'+heatmapBase64Image+'" width="100%" height="100%" />'),showHeatmapLegend(maximum)}function drawRegions(divId,regions){var shapeOptions={stroke:!0,color:"#CD1625",weight:1,opacity:.7,fillColor:"#CD1625",fillOpacity:.35,clickable:!1};void 0!=mapManager.map&&mapManager.map.remove(),crowddensity.initDrawingCanvas(divId,"",shapeOptions),crowddensity.addExistingAreas(regions)}function showHeatmapLegend(maximum){var mark1=maximum/5,mark2=2*mark1,mark3=3*mark1,mark4=4*mark1;$("#mark0").html(0),$("#mark1").html(mark1.toFixed(0)),$("#mark2").html(mark2.toFixed(0)),$("#mark3").html(mark3.toFixed(0)),$("#mark4").html(mark4.toFixed(0)),$("#mark5").html(maximum)}function toggleRegions(){$(".leaflet-zoom-animated").toggle()}var crowddensity=CrowdDensityService,mapManager=CrowdMapManagerService;UtilsService.i18n;return{showCrowdHeatmap:showCrowdHeatmap,drawRegions:drawRegions,showHeatmapLegend:showHeatmapLegend,toggleRegions:toggleRegions}}]),angular.module("kai.reports.crowd").factory("CrowdService",["KupOption","AmchartsTheme","UtilsService","PromiseFactory","KupApiService","ReportsService","AuthTokenFactory","CrowdSvgService","$q","$timeout",function(KupOption,AmchartsTheme,UtilsService,PromiseFactory,KupApiService,ReportsService,AuthTokenFactory,CrowdSvgService,$q,$timeout){function setInitData(){data.currentTab="chart",data.currentTimeunitForChart="hours",data.uiNodata.isShow=!0,setInitTab(),setInitTimeunit()}function setInitTab(){$.each(data.uiTab,function(i,tab){0==i?tab.isActive=!0:tab.isActive=!1})}function setInitTimeunit(){$.each(data.uiTimeunit,function(i,unit){0==i?unit.isActiveForChart=!0:unit.isActiveForChart=!1})}function setSelectedChartData(){var opt=data,events=(reports.data,opt.apiAnalyticsReportList),vcaList=JSON.parse(opt.selectedVcaData.thresholds||"{}").regions||[],seriesInfo=[],countList=[],countTimeList={},width=jQuery(opt.$heatmap).width(),height=jQuery(opt.$heatmap).height(),heatmapColumns=events.length?events[0].columns:0,heatmapRows=events.length?events[0].rows:0,colWidth=width/heatmapColumns||0,rowHeight=height/heatmapRows||0;!function(){$.each(vcaList,function(i,region){var name=region.name,vertexX=[],vertexY=[],vertexN=region.points.length,getTotalValues=function(trackData){var totalValues=0;return $.each(trackData,function(i,d){var i,j,trackX=d.x*colWidth,trackY=d.y*rowHeight,c=0;for(i=0,j=vertexN-1;i<vertexN;j=i++)vertexY[i]>trackY!=vertexY[j]>trackY&&trackX<(vertexX[j]-vertexX[i])*(trackY-vertexY[i])/(vertexY[j]-vertexY[i])+vertexX[i]&&(c=!c);c&&(totalValues+=d.value)}),totalValues};seriesInfo.push({id:"g"+i,valueAxis:"v"+i,valueField:"count"+i,type:"column",title:name,fillAlphas:1,lineThickness:2,balloonText:name+" :<b>[[value]]</b>"}),$.each(region.points,function(j,coordinates){vertexX.push(coordinates.x*width),vertexY.push(coordinates.y*height)}),$.each(events,function(j,evt){var totalValues=getTotalValues(evt.tracks),countItem={};countItem.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),countItem["count"+i]=isNaN(totalValues)?0:Math.floor(totalValues),countList.push(countItem)})})}(),function(){$.each(countList,function(i,cl){var timeIndex=kendo.toString(cl.time,data.timeFormat2);countTimeList[timeIndex]?countTimeList[timeIndex]=$.extend(!0,countTimeList[timeIndex],cl):countTimeList[timeIndex]=cl}),countList=[],$.each(countTimeList,function(i,ctl){countList.push(ctl)}),$.each(countList,function(i,cl){$.each(vcaList,function(j,vl){cl["count"+j]||(cl["count"+j]=0)})}),countList.sort(function(a,b){return a.time-b.time})}(),opt.selectedChartDataSource=countList,opt.selectedChartGraphs=seriesInfo}function setChartData(){var timeunit=data.currentTimeunitForChart,dataSource=angular.copy(data.selectedChartDataSource),selectedItemLength=reports.data.selectedSaveDataList.length,dataSourceByTimeunit=[];return function(){for(var tmp={},i=0;i<=selectedItemLength;i++)tmp["count"+i]=0;if("hours"==timeunit){for(var start=moment(reports.data.dateRange.startDate),end=moment(reports.data.dateRange.endDate),countList=[],i=start;i<=end;i=moment(i).add(1,"hours")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=i.format()}$.each(dataSource,function(index,ds){var index=moment(ds.time).diff(start,"hours");countList[index]=ds}),dataSourceByTimeunit=countList}if("days"==timeunit){for(var start=moment(reports.data.dateRange.startDate),end=moment(reports.data.dateRange.endDate),countList=[],i=start;i<=end;i=moment(i).add(1,"days")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=new Date(i)}$.each(dataSource,function(i,ds){for(var index=moment(ds.time).diff(start,"days"),j=0;j<=selectedItemLength;j++)countList[index]["count"+j]+=ds["count"+j]}),dataSourceByTimeunit=countList}if("weeks"==timeunit){for(var weekStart=kupOpt.dateOfWeekStart,start=moment(reports.data.dateRange.startDate).isoWeekday(weekStart),end=moment(reports.data.dateRange.endDate).isoWeekday(weekStart),countList=[],i=start;i<=end;i=moment(i).add(1,"weeks")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=new Date(i)}$.each(dataSource,function(i,ds){for(var index=moment(ds.time).diff(start,"weeks"),j=0;j<=selectedItemLength;j++)countList[index]["count"+j]+=ds["count"+j]}),dataSourceByTimeunit=countList}if("months"==timeunit){for(var start=moment(reports.data.dateRange.startDate).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),end=moment(reports.data.dateRange.endDate).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),countList=[],i=start;i<=end;i=moment(i).add(1,"month")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=i.format()}$.each(dataSource,function(i,ds){for(var index=moment(ds.time).diff(start,"months"),j=0;j<=selectedItemLength;j++)countList[index]["count"+j]+=ds["count"+j]}),dataSourceByTimeunit=countList}if("years"==timeunit){for(var start=moment(reports.data.dateRange.startDate).month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),end=moment(reports.data.dateRange.endDate).month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),countList=[],i=start;i<=end;i=moment(i).add(1,"years")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=i.format()}$.each(dataSource,function(i,ds){for(var index=moment(ds.time).diff(start,"year"),j=0;j<=selectedItemLength;j++)countList[index]["count"+j]+=ds["count"+j]}),dataSourceByTimeunit=countList}}(),data.selectedChartDataSourceByTimeunit=dataSourceByTimeunit,dataSourceByTimeunit}function setChartOptions(){var chartSetting=function(){var setting={};return $.each(data.uiTimeunit,function(i,unit){if(unit.name===data.currentTimeunitForChart)return setting.minPeriod=unit.chartPeriod,!1}),setting}(),chartOptions={dataProvider:angular.copy(data.selectedChartDataSourceByTimeunit),graphs:angular.copy(data.selectedChartGraphs),type:"serial",theme:AuthTokenFactory.getTheme(),zoomOutText:i18n("show-all"),valueAxes:[{axisColor:"chartCursor",axisThickness:2,axisAlpha:1,position:"left"}],chartScrollbar:{autoGridCount:!0,graph:"g0",scrollbarHeight:40},chartCursor:{cursorPosition:"mouse",categoryBalloonFunction:function(){var time=arguments[0];return setChartTimeunitLabel(time)}},categoryField:"time",categoryAxis:{firstDayOfWeek:kupOpt.dateOfWeekStart,gridAlpha:0,markPeriodChange:!0,boldLabels:!0,minPeriod:chartSetting.minPeriod,parseDates:!0,equalSpacing:!0,labelFunction:function(dateText){var time=arguments[1];switch(chartSetting.minPeriod){case"hh":dateText=moment(time).format(kupOpt["default"].formatAxisHourly);break;case"DD":dateText=moment(time).format(kupOpt["default"].formatAxisDaily);break;case"WW":dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatAxisWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatAxisWeekly);break;case"MM":dateText=moment(time).format(kupOpt["default"].formatAxisMonthly)}return dateText}},legend:{useGraphSettings:!1,valueWidth:0,valueFunction:function(){return""}}};return data.uiChart.options=chartOptions,chartOptions}function setChartForPdfOptions(){var chartSetting=function(){var setting={};return $.each(data.uiTimeunit,function(i,unit){if(unit.name===data.currentTimeunitForChart)return setting.minPeriod=unit.chartPeriod,!1}),setting}(),chartPeriod="hours",chartOptions={dataProvider:angular.copy(data.selectedChartDataSourceByTimeunit),graphs:angular.copy(data.selectedChartGraphs),type:"serial",theme:"white",fontFamily:"Verdana",fontSize:11,valueAxes:[{axisColor:"chartCursor",axisThickness:2,axisAlpha:1,position:"left"}],chartCursor:{cursorPosition:"mouse",categoryBalloonFunction:function(){var time=arguments[0];return setChartTimeunitLabel(time)}},categoryField:"time",categoryAxis:{firstDayOfWeek:kupOpt.dateOfWeekStart,gridAlpha:0,markPeriodChange:!0,boldLabels:!0,minPeriod:chartPeriod,parseDates:!0,equalSpacing:!0,dateFormats:[{period:"fff",format:"JJ:NN:SS"},{period:"ss",format:"JJ:NN:SS"},{period:"mm",format:"JJ:NN"},{period:"hh",format:"JJ:NN"},{period:"DD",format:"MMM DD"},{period:"WW",format:"MMM DD"},{period:"MM",format:"MMM"},{period:"YYYY",format:"YYYY"}],labelFunction:function(dateText){var time=arguments[1];switch(chartSetting.minPeriod){case"hh":dateText=moment(time).format(kupOpt["default"].formatAxisHourly);break;case"DD":dateText=moment(time).format(kupOpt["default"].formatAxisDaily);break;case"WW":dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatAxisWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatAxisWeekly);break;case"MM":dateText=moment(time).format(kupOpt["default"].formatAxisMonthly)}return dateText}},legend:{useGraphSettings:!1,valueWidth:0,valueFunction:function(){return""}}};return data.uiChartForPdf.options=chartOptions,chartOptions}function getAnalyticsReportApi(isDefer){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,instance=reportsOpt.selectedInstance[0],selectedDeviceId=instance.platformDeviceId,selectedChannelId=instance.channelId,fromDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),data.timeFormat2),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),data.timeFormat2),param={"event-type":vcaEventType,"device-id-list":JSON.stringify([selectedDeviceId]),"channel-id":selectedChannelId,from:fromDateUTC,to:toDateUTC,parameters:JSON.stringify({})},onSuccess=function(response){opt.apiAnalyticsReportList=response.data||[]},onFail=function(response){opt.apiAnalyticsReportList=[]},onError=function(){opt.apiAnalyticsReportList=[]};return ajaxPost("getanalyticsreport",param,onSuccess,onFail,onError,isDefer)}function getLiveVideoUrlApi(isDefer){var opt=data,reportsOpt=reports.data,instance=reportsOpt.selectedInstance[0],selectedChannelId=(instance.platformDeviceId,instance.channelId),coreDeviceId=instance.deviceId,streamType="http/jpeg",param={"device-id":coreDeviceId,"channel-id":selectedChannelId,"stream-type":streamType},onSuccess=function(response){opt.apiLiveVideoUrl=response.url||[]},onFail=function(response){opt.apiLiveVideoUrl=[]},onError=function(){opt.apiLiveVideoUrl=[]};return ajaxPost("getlivevideourl",param,onSuccess,onFail,onError,isDefer)}function listRunningAnalyticsApi(isDefer){var opt=data,reportsOpt=reports.data,vcaAnalyticsType=kupOpt.vca[reportsOpt.reportType].analyticsType,param={"analytics-type":vcaAnalyticsType},instance=reportsOpt.selectedInstance[0],selectedDeviceId=instance.platformDeviceId,selectedChannelId=instance.channelId,onSuccess=(instance.deviceId,function(response){var vcaData={};$.each(response.instances,function(i,inst){if(inst.platformDeviceId==selectedDeviceId&&inst.channelId==selectedChannelId)return vcaData=inst,!1}),opt.apiRunningAnalyticsList=response.instances||[],opt.selectedVcaData=vcaData}),onFail=function(response){opt.apiRunningAnalyticsList=[],opt.selectedVcaData={},opt.selectedRegions={}},onError=function(){opt.apiRunningAnalyticsList=[],opt.selectedVcaData={},opt.selectedRegions={}};return ajaxPost("listrunninganalytics",param,onSuccess,onFail,onError,isDefer)}function exportAggregatedCsvReportApi(periodType){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,dvcId=reportsOpt.selectedInstance,fromDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),opt.timeFormat2),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),opt.timeFormat2),param={"file-format":"csv","event-type":vcaEventType,from:fromDateUTC,to:toDateUTC,"time-zone-offset":KupApiService.data.timeZoneOffset,"device-id":dvcId[0].platformDeviceId,"channel-id":dvcId[0].channelId};return KupApiService.exportDoc(param,"exportdatalogs")}function exportCrowdDensityPdfApi(){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,dvcId=reportsOpt.selectedInstance,fromDateUTC=kendo.toString(reportsOpt.dateRange.startDate,opt.timeFormat1),toDateUTC=kendo.toString(reportsOpt.dateRange.endDate,opt.timeFormat1),base64Image=function(){var canvas=$(opt.$heatmap).find("canvas").get(0),canvasData=canvas.toDataURL();return canvasData.substring(canvasData.indexOf(",")+1).trim()}(),base64RegionImage=function(){var svgList=$(".leaflet-map-pane").find("svg"),xmlSerializer=new XMLSerializer,svg=xmlSerializer.serializeToString(svgList[0]),encodedData=window.btoa(svg);return encodedData}(),chartSvgTitle="<svg version='1.1' width='900' height='30'><text y='15' x='0' transform='translate(450)' text-anchor='middle' font-size='20' font-weight='bold'>"+i18n("activity-level-zone")+"</text></svg>",chartOpt=setChartForPdfOptions(),svgData=(window.AmCharts.makeChart(opt.$chartForPdf.slice(1),chartOpt),function(){var svgData=[];return"chart"==opt.currentTab&&(svgData.push(chartSvgTitle),$.each($(opt.$chartForPdf).find("svg"),function(i,el){svgData.push("<svg version='1.1' width='"+$(el).css("width")+"' height='"+$(el).css("height")+"'>"+$(el).html()+"</svg>")})),svgData}()),reportInfo={"event-type":vcaEventType,"device-name":dvcId[0].deviceName,channel:dvcId[0].channelName,from:fromDateUTC,to:toDateUTC},param={"device-id":dvcId[0].deviceId,"channel-id":dvcId[0].channelId,"time-zone-offset":KupApiService.data.timeZoneOffset,"base64-image":base64Image,"base64-region-image":base64RegionImage,"svg-image":svgData.join(""),"report-info":angular.toJson(reportInfo)};return KupApiService.exportDoc(param,"exportcrowddensitypdf")}function setChartTimeunitLabel(dateFormat){var dateText="",time=new Date(dateFormat),dateLang=(kupOpt.dateOfWeekStart,"en-us"),dateOpt={weekday:"short",month:"short",day:"numeric",year:"numeric"};return"hours"==data.currentTimeunitForChart&&(dateText=moment(time).format(kupOpt["default"].formatHourly)),"days"==data.currentTimeunitForChart&&(dateText=moment(time).format(kupOpt["default"].formatDaily)),"weeks"==data.currentTimeunitForChart&&(dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatWeekly)),"months"==data.currentTimeunitForChart&&(dateText=moment(time).format(kupOpt["default"].formatMonthly)),"years"==data.currentTimeunitForChart&&(dateOpt={year:"numeric"},dateText=time.toLocaleDateString(dateLang,dateOpt)),dateText}function setChartTheme(){var theme=AuthTokenFactory.getTheme();window.AmCharts.themes[theme]=AmchartsTheme[theme]}function generateChart(){setChartTheme(),setChartData(),setChartOptions()}function generateHeatmap(){for(var opt=data,events=(reports.data,opt.apiAnalyticsReportList),vcaList=JSON.parse(opt.selectedVcaData.thresholds||"{}").regions||[],max=1,width=jQuery(opt.$heatmap).width(),height=jQuery(opt.$heatmap).height(),heatmapColumns=events[0].columns,heatmapRows=events[0].rows,colWidth=width/heatmapColumns||0,rowHeight=height/heatmapRows||0,radius=1.2*Math.max(colWidth,rowHeight),heatmap=jQuery(opt.$heatmap).empty()&&window.h337.create({container:jQuery(opt.$heatmap).get(0),maxOpacity:.5,radius:radius,blur:.75,onExtremaChange:function(data){}}),gridPoints=[],d=[],i=0;i<heatmapColumns;i++)gridPoints[i]=Array.apply(null,new Array(heatmapRows)).map(Number.prototype.valueOf,0);$.each(events,function(i,d){var tracks=d.tracks;$.each(tracks,function(i,t){gridPoints[t.x][t.y]+=t.value,max=Math.max(max,gridPoints[t.x][t.y])})});for(var i=0;i<gridPoints.length;i++)for(var j=0;j<gridPoints[i].length;j++)if(!(gridPoints[i][j]<=0)){var x=colWidth*i+colWidth/2,y=rowHeight*j+rowHeight/2;d.push({x:x,y:y,value:gridPoints[i][j]})}gridPoints.length=0,gridPoints=null,heatmap.setData({min:0,max:max,data:d}),CrowdSvgService.showHeatmapLegend(100),CrowdSvgService.drawRegions(opt.$heatmap.substring(1),vcaList),$(opt.$heatmap).css("background-image","url("+opt.apiLiveVideoUrl[0]+")")}function generateUiReport(){generateHeatmap(),generateChart()}function generateReport(){setInitData();var opt=data;if($.each(opt.requestForReport,function(i,request){request.cancel&&request.cancel()}),!reports.isSelectCamera())return notification("error",i18n("no-channel-selected")),reports.isSuccessReport(!1),!1;if(!reports.isSingleCamera())return notification("error",i18n("multiple-device-channel-not-supported")),reports.isSuccessReport(!1),!1;opt.requestForReport=[getAnalyticsReportApi(!0),getLiveVideoUrlApi(!0),listRunningAnalyticsApi(!0)];var dfd=$q.defer();return $timeout(function(){$q.all(opt.requestForReport)["finally"](function(){return setSelectedChartData(),opt.selectedChartDataSource.length<=0?(reports.isSuccessReport(!1),void dfd.reject()):(reports.isSuccessReport(!0),void dfd.resolve())})},500),dfd.promise}var kupOpt=KupOption,utils=UtilsService,i18n=UtilsService.i18n,notification=UtilsService.notification,ajaxPost=KupApiService.ajaxPost,reports=ReportsService,data={timeFormat0:"yyyy/MM/dd HH:mm:ss",timeFormat1:"dd/MM/yyyy HH:mm:ss",timeFormat2:"ddMMyyyyHHmmss",selectedGridList:{},selectedSitenameList:[],selectedVcaData:{},selectedChartDataSource:[],selectedChartDataSourceByTimeunit:[],selectedChartGraphs:[],selectedChartSortByDate:[],apiAnalyticsReportList:[],apiLiveVideoUrl:[],currentTab:"chart",currentTimeunitForChart:"hours",requestForReport:[],$report:"#crowdReport",$chart:"#crowdChart",$chartForPdf:"#crowdChartForPdf",$heatmap:"#heatmapSnapshot",uiTab:[{name:"chart",text:"charts",isActive:!0}],uiTimeunit:[{name:"hours",text:"hourly",isActiveForChart:!0,isShowForChart:!0,chartPeriod:"hh"},{name:"days",text:"daily",isActiveForChart:!1,isShowForChart:!0,chartPeriod:"DD"},{name:"weeks",text:"weekly",isActiveForChart:!1,isShowForChart:!0,chartPeriod:"WW"},{name:"months",text:"monthly",isActiveForChart:!1,isShowForChart:!0,chartPeriod:"MM"},{name:"years",text:"yearly",isActiveForChart:!1,isShowForChart:!1,chartPeriod:"YYYY"}],uiExport:{isOpen:!1},uiNodata:{isShow:!0},uiChart:{options:{}},uiChartForPdf:{width:"900px",height:"400px",options:{}}};return{data:data,setInitData:setInitData,setInitTab:setInitTab,setInitTimeunit:setInitTimeunit,setSelectedChartData:setSelectedChartData,setChartTimeunitLabel:setChartTimeunitLabel,setChartTheme:setChartTheme,setChartData:setChartData,setChartOptions:setChartOptions,setChartForPdfOptions:setChartForPdfOptions,listRunningAnalyticsApi:listRunningAnalyticsApi,getAnalyticsReportApi:getAnalyticsReportApi,getLiveVideoUrlApi:getLiveVideoUrlApi,exportAggregatedCsvReportApi:exportAggregatedCsvReportApi,exportCrowdDensityPdfApi:exportCrowdDensityPdfApi,generateReport:generateReport,generateChart:generateChart,generateUiReport:generateUiReport}}]),angular.module("kai.reports.crowd").factory("CrowdDensityService",["UtilsService","CrowdMapManagerService",function(UtilsService,CrowdMapManagerService){var mapManager=CrowdMapManagerService,utils=UtilsService,i18n=UtilsService.i18n,crowddensity={};return crowddensity.areaLimit=10,crowddensity.START_NUMBER=1,crowddensity.polygonStyle=null,crowddensity.$regionList=null,crowddensity.recentRegionName=null,crowddensity.recentRegion=null,crowddensity.regionNames=[],crowddensity.initDrawingCanvas=function(canvasId,regionListDivId,options){utils.isNullOrEmpty(regionListDivId)||(crowddensity.$regionList=$("#"+regionListDivId)),mapManager.initialize(canvasId,20,!1,!1),mapManager.map.doubleClickZoom.disable(),mapManager.map.scrollWheelZoom.disable();var polygonOptions=options;null==options&&(polygonOptions={stroke:!0,color:"#ddd",opacity:.8,weight:1,fillColor:"#2E8DEF",fillOpacity:.4,clickable:!1});var polygonOptions={title:i18n("draw"),allowIntersection:!1,shapeOptions:polygonOptions};crowddensity.polygonStyle=polygonOptions.shapeOptions,utils.isNullOrEmpty(regionListDivId)?mapManager.initializeDrawingTools(!1,!1,polygonOptions,!1,!1,!1):(mapManager.initializeDrawingTools(!1,!1,polygonOptions,!1,!1,!0),mapManager.setEmptyBackground(),crowddensity._initDrawingEvents())},crowddensity._initDrawingEvents=function(){mapManager.map.on("draw:created",function(e){var boxArray=crowddensity.$regionList.data("kendoListView").dataSource.data();if(boxArray.length!=crowddensity.areaLimit){var contentPage="/vca/crowdregionname",winTitle=i18n("region-name"),layer=e.layer;mapManager.drawnItems.addLayer(layer),mapManager.drawnItems.addLayer(layer),crowddensity.recentRegion=layer,utils.openPopup(winTitle,contentPage,null,null,!0,function(){if(utils.isNullOrEmpty(crowddensity.recentRegionName))console.log("Name not assigned for region"),mapManager.removeDrawnLayerByLayer(crowddensity.recentRegion);else{var layer=e.layer;mapManager.drawnItems.addLayer(layer),mapManager.drawnItems.addLayer(layer),layer.name=crowddensity.recentRegionName,layer.label=mapManager.addLabel(layer.name,mapManager.getEstimatedCenter(layer),"polygon_label"),crowddensity.$regionList.data("kendoListView").dataSource.read()}crowddensity.recentRegion=null})}}),mapManager.map.on("draw:edited",function(e){e.layers;crowddensity.$regionList.data("kendoListView").dataSource.read()}),mapManager.map.on("draw:deleted",function(e){e.layers;crowddensity.$regionList.data("kendoListView").dataSource.read()}),mapManager.map.on("draw:drawstart",function(e){var boxArray=crowddensity.$regionList.data("kendoListView").dataSource.data();boxArray.length==crowddensity.areaLimit&&utils.popupAlert(i18n("msg-crowd-flow-region-limit"))}),mapManager.map.on("draw:drawstop",function(e){mapManager.map.dragging.disable()})},crowddensity.getBoxesDrawn=function(){var boxes=[];return mapManager.drawnItems.eachLayer(function(layer){var polygonPoints=[];$.each(layer._originalPoints,function(index,point){var nX=point.x/mapManager.mapWidth,nY=point.y/mapManager.mapHeight;nX=nX<0?0:nX,nX=nX>1?1:nX,nY=nY<0?0:nY,nY=nY>1?1:nY,polygonPoints.push({x:nX.toFixed(3),y:nY.toFixed(3)})});var box={name:layer.name,points:polygonPoints};boxes.push(box)}),boxes},crowddensity.addExistingAreas=function(areas){void 0!=areas&&$.each(areas,function(index,area){var latLngPoints=[];$.each(area.points,function(f,p){p.x=p.x*mapManager.mapWidth,p.y=p.y*mapManager.mapHeight;var latLng=mapManager.map.containerPointToLatLng(new L.Point(p.x,p.y));latLngPoints.push(latLng)});var polygon=L.polygon(latLngPoints,crowddensity.polygonStyle),layer=polygon.addTo(mapManager.map);layer.name=area.name,layer.label=mapManager.addLabel(area.name,mapManager.getEstimatedCenter(layer),"polygon_label"),mapManager.drawnItems.addLayer(layer)})},crowddensity.getRectangles=function(){if(null==mapManager.drawnItems)return[];var areaList=[];return mapManager.drawnItems.eachLayer(function(layer){var data={name:layer.name};areaList.push(data)}),areaList},crowddensity.mapLayersRemoved=function(){try{crowddensity.$regionList.data("kendoListView").dataSource.read()}catch(e){console.log(e)}},crowddensity.removeLayer=function(regionName){mapManager.removeDrawnLayerByLayerName(regionName)},crowddensity}]),angular.module("kai.reports.crowd").controller("CrowdController",["KupOption","RouterStateService","UtilsService","PromiseFactory","AuthTokenFactory","ReportsService","CrowdService","$scope","$timeout","$q","CrowdSvgService","$rootScope",function(KupOption,RouterStateService,UtilsService,PromiseFactory,AuthTokenFactory,ReportsService,CrowdService,$scope,$timeout,$q,CrowdSvgService,$rootScope){function init(){$scope.$watch(function(){return angular.toJson(reports.data)},function(newVal,oldVal){var opt=crowdCtrl.data,reportsOpt=angular.fromJson(newVal),generateUiReport=function(){$timeout(function(){return $(opt.$report).is(":visible")?void CrowdService.generateUiReport():(generateUiReport(),!1)},300)};crowdCtrl.data.uiNodata.isShow=!reportsOpt.isSuccessReport,crowdCtrl.data.uiNodata.isShow||generateUiReport()},!0),$scope.$watch(function(){return AuthTokenFactory.getTheme()},function(newVal,oldVal){return newVal!=oldVal&&(CrowdService.setChartTheme(),void CrowdService.generateChart())},!0)}function setTab(tabName){var opt=crowdCtrl.data,tabData=opt.uiTab;$.each(tabData,function(i,data){data.isActive=tabName===data.name}),opt.currentTab=tabName}function setTimeunitForChart(unitName){var opt=crowdCtrl.data,timeunitData=opt.uiTimeunit;$.each(timeunitData,function(i,data){data.isActiveForChart=unitName===data.name}),opt.currentTimeunitForChart=unitName,CrowdService.generateChart()}function exportCsv(periodType){if(!reports.isSuccessReport())return notification("error",i18n("please-generate-reports")),!1;var warningNotify=notification("warning",i18n("exporting-to-csv"),0);CrowdService.exportAggregatedCsvReportApi(periodType)["finally"](function(){warningNotify.close()})}function exportPdf(){if(!reports.isSuccessReport())return notification("error",i18n("please-generate-reports")),!1;var warningNotify=notification("warning",i18n("exporting-to-pdf"),0);CrowdService.exportCrowdDensityPdfApi()["finally"](function(){warningNotify.close()})}function showRegion(isShow){crowdCtrl.region.data.isShow=isShow,CrowdSvgService.toggleRegions()}var i18n=UtilsService.i18n,notification=UtilsService.notification,reports=ReportsService,crowdCtrl=this;crowdCtrl.data=CrowdService.data,crowdCtrl.fn={setTab:setTab,setTimeunitForChart:setTimeunitForChart,exportPdf:exportPdf,exportCsv:exportCsv,showRegion:showRegion},crowdCtrl.region={},crowdCtrl.region.data={isShow:!0},init()}]);