angular.module("kai.reports.intrusion",["ui.amcharts"]),angular.module("kai.reports.intrusion").factory("IntrusionService",["KupOption","AmchartsTheme","UtilsService","PromiseFactory","KupApiService","ReportsService","AuthTokenFactory","$q","$timeout",function(KupOption,AmchartsTheme,UtilsService,PromiseFactory,KupApiService,ReportsService,AuthTokenFactory,$q,$timeout){function setInitData(){data.currentTab="chart",data.currentTimeunitForChart="hours",data.uiNodata.isShow=!0,setInitTab(),setInitTimeunit()}function setInitTab(){$.each(data.uiTab,function(i,tab){0==i?tab.isActive=!0:tab.isActive=!1})}function setInitTimeunit(){$.each(data.uiTimeunit,function(i,unit){0==i?unit.isActiveForChart=!0:unit.isActiveForChart=!1})}function setSelectedChartData(){var opt=data,reportsOpt=reports.data,selectedItemDataList=reportsOpt.selectedItemDataList||{},events=opt.apiAnalyticsReportList,seriesInfo=(reports.data.dateRange.startDate,reports.data.dateRange.endDate,[]),eventDetails=[],count=0,totalPlpVisit=0,countList=[],filterEvents=[],sitenameList=[];return function(){$.each(selectedItemDataList,function(uid,itemData){var totalInPerSelection=0;if($.isEmptyObject(itemData))return!0;if(itemData.isAll||itemData.isLabel){var name=itemData.text,deviceTimeList={};$.each(itemData.items,function(i,device){var deviceList=[];$.each(device.items,function(j,camera){var cameraData=camera.data,cameraList=[];$.each(events,function(k,evt){if(evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId){var countItem={};countItem.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),countItem["count"+count]=parseInt(evt.count,10),cameraList.push(countItem),totalPlpVisit+=parseInt(evt.count,10),totalInPerSelection+=parseInt(evt.count,10),filterEvents.push(evt)}}),deviceList.push(cameraList)}),$.each(deviceList,function(j,cameraList){$.each(cameraList,function(j,camera){var timeIndex=kendo.toString(camera.time,data.timeFormat2);deviceTimeList[timeIndex]?deviceTimeList[timeIndex]["count"+count]+=camera["count"+count]:(deviceTimeList[timeIndex]={},deviceTimeList[timeIndex]["count"+count]=camera["count"+count],deviceTimeList[timeIndex].time=camera.time)})})}),$.each(deviceTimeList,function(i,deviceList){countList.push(deviceList)})}if(itemData.isDevice){var name=itemData.labelName+" - "+itemData.text,deviceList=[],deviceTimeList={};$.each(itemData.items,function(i,camera){var cameraData=camera.data,cameraList=[];$.each(events,function(j,evt){if(evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId){var countItem={};countItem.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),countItem["count"+count]=parseInt(evt.count,10),cameraList.push(countItem),totalPlpVisit+=parseInt(evt.count,10),totalInPerSelection+=parseInt(evt.count,10),filterEvents.push(evt)}}),deviceList.push(cameraList)}),$.each(deviceList,function(i,cameraList){$.each(cameraList,function(j,camera){var timeIndex=kendo.toString(camera.time,data.timeFormat2);deviceTimeList[timeIndex]?deviceTimeList[timeIndex]["count"+count]+=camera["count"+count]:(deviceTimeList[timeIndex]={},deviceTimeList[timeIndex]["count"+count]=camera["count"+count],deviceTimeList[timeIndex].time=camera.time)})}),$.each(deviceTimeList,function(i,deviceList){countList.push(deviceList)})}if(itemData.isCamera){var cameraData=itemData.data,name=cameraData.deviceName+" - "+cameraData.channelName;$.each(events,function(i,evt){if(evt.deviceId==cameraData.deviceId&&evt.channelId==cameraData.channelId){var countItem={};countItem.time=utils.convertUTCtoLocal(kendo.parseDate(evt.date+" "+evt.hour+":00:00",data.timeFormat0)),countItem["count"+count]=parseInt(evt.count,10),totalPlpVisit+=parseInt(evt.count,10),totalInPerSelection+=parseInt(evt.count,10),countList.push(countItem),filterEvents.push(evt)}})}sitenameList.push(name),eventDetails.push({uid:uid,totalPerSelection:totalInPerSelection}),seriesInfo.push({id:"g"+count,valueAxis:"v"+count,valueField:"count"+count,type:"smoothedLine",bullet:"round",bulletBorderThickness:1,hideBulletsCount:30,title:name,fillAlphas:0,lineThickness:2,balloonText:name+" :<b>[[value]]</b>"}),count++})}(),function(){$.each(reports.data.selectedItemDataList,function(uid,item){$.each(eventDetails,function(i,grid){return grid.uid!=uid||((item.isLabel||item.isAll)&&(grid.labelText=item.text),item.isDevice&&(grid.labelText=item.labelName,grid.deviceText=item.text),void(item.isCamera&&(grid.labelText=item.labelName,grid.deviceText=item.deviceName,grid.cameraText=item.text)))})})}(),function(){var mergeCountList={};$.each(countList,function(i,ds){var timeIndex=kendo.toString(ds.time,data.timeFormat2);mergeCountList[timeIndex]?mergeCountList[timeIndex]=$.extend(!0,mergeCountList[timeIndex],ds):(mergeCountList[timeIndex]={},mergeCountList[timeIndex]=ds)}),$.each(mergeCountList,function(time,ds){$.each(eventDetails,function(i,grid){ds["count"+i]||(ds["count"+i]=0,ds["count"+i]=0)})}),countList=[],$.each(mergeCountList,function(time,ds){countList.push(ds)}),countList.sort(function(a,b){return a.time-b.time})}(),opt.selectedGridList=eventDetails,opt.selectedChartDataSource=countList,opt.selectedChartGraphs=seriesInfo,opt.selectedSitenameList=sitenameList,opt}function setGridData(){var opt=data,totalVisits=function(){var count=0;return $.each(opt.selectedGridList,function(i,grid){count+=grid.totalPerSelection}),count}(),selectedDeviceLength=opt.selectedGridList.length,selectedChartSortByDate=(angular.copy(opt.selectedChartDataSource),angular.copy(opt.selectedChartDataSourceByTimeunit));return function(){$.each(selectedChartSortByDate,function(i,ds){ds.aggregate=function(){for(var count=0,j=0;j<selectedDeviceLength;j++)ds["count"+j]=ds["count"+j]||0,count+=ds["count"+j];return count}()}),selectedChartSortByDate.sort(function(a,b){return b.aggregate-a.aggregate}),opt.selectedChartSortByDate=selectedChartSortByDate}(),function(){var highestInfo=angular.copy(opt.selectedChartSortByDate).shift(),lowestInfo=function(){var ds=angular.copy(opt.selectedChartSortByDate),lowestInfo={};return $.each(ds,function(i,info){if(info.aggregate&&(lowestInfo=info),!info.aggregate)return!1}),lowestInfo}();opt.uiGrid.topEventBox=function(){var data=angular.copy(opt.selectedGridList);return data.sort(function(a,b){return b.totalPerSelection-a.totalPerSelection})}(),opt.uiGrid.leastEventBox=function(){var data=angular.copy(opt.selectedGridList);return data.sort(function(a,b){return a.totalPerSelection-b.totalPerSelection})}(),opt.uiGrid.totalEventBox=function(){var data=angular.copy(opt.selectedGridList);return data}(),opt.uiGrid.totalVisit=kendo.toString(totalVisits,"n0"),opt.uiGrid.avgVisit=kendo.toString(Math.round(totalVisits/selectedDeviceLength),"n0"),opt.uiGrid.highestVisit=highestInfo?kendo.toString(highestInfo.aggregate,"n0"):0,opt.uiGrid.lowestVisit=lowestInfo?kendo.toString(lowestInfo.aggregate,"n0"):0,opt.uiGrid.highestVisitDate=function(){var returnData="";return returnData=highestInfo?i18n("on")+" "+setChartTimeunitLabel(highestInfo.time):"..."}(),opt.uiGrid.lowestVisitDate=function(){var returnData="";return returnData=lowestInfo?i18n("on")+" "+setChartTimeunitLabel(lowestInfo.time):"..."}()}(),opt.uiGrid}function setChartData(){var timeunit=data.currentTimeunitForChart,dataSource=angular.copy(data.selectedChartDataSource),selectedItemLength=reports.data.selectedSaveDataList.length,dataSourceByTimeunit=[];return function(){for(var tmp={},i=0;i<selectedItemLength;i++)tmp["count"+i]=0;if("hours"==timeunit){for(var start=moment(reports.data.dateRange.startDate),end=moment(reports.data.dateRange.endDate),countList=[],i=start;i<=end;i=moment(i).add(1,"hours")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=i.format()}$.each(dataSource,function(index,ds){var index=moment(ds.time).diff(start,"hours");countList[index]=ds}),dataSourceByTimeunit=countList}if("days"==timeunit){for(var start=moment(reports.data.dateRange.startDate),end=moment(reports.data.dateRange.endDate),countList=[],i=start;i<=end;i=moment(i).add(1,"days")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=new Date(i)}$.each(dataSource,function(i,ds){for(var index=moment(ds.time).diff(start,"days"),j=0;j<selectedItemLength;j++)countList[index]["count"+j]+=ds["count"+j]}),dataSourceByTimeunit=countList}if("weeks"==timeunit){for(var weekStart=kupOpt.dateOfWeekStart,start=moment(reports.data.dateRange.startDate).isoWeekday(weekStart),end=moment(reports.data.dateRange.endDate).isoWeekday(weekStart),countList=[],i=start;i<=end;i=moment(i).add(1,"weeks")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=new Date(i)}$.each(dataSource,function(i,ds){for(var index=moment(ds.time).diff(start,"weeks"),j=0;j<selectedItemLength;j++)countList[index]["count"+j]+=ds["count"+j]}),dataSourceByTimeunit=countList}if("months"==timeunit){for(var start=moment(reports.data.dateRange.startDate).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),end=moment(reports.data.dateRange.endDate).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),countList=[],i=start;i<=end;i=moment(i).add(1,"month")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=i.format()}$.each(dataSource,function(i,ds){for(var index=moment(ds.time).diff(start,"months"),j=0;j<selectedItemLength;j++)void 0!=ds["count"+j]&&(countList[index]["count"+j]+=ds["count"+j])}),dataSourceByTimeunit=countList}if("years"==timeunit){for(var start=moment(reports.data.dateRange.startDate).month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),end=moment(reports.data.dateRange.endDate).month(0).date(1).hours(0).minutes(0).seconds(0).milliseconds(0),countList=[],i=start;i<=end;i=moment(i).add(1,"years")){var index=countList.length;countList[index]={},countList[index]=angular.copy(tmp),countList[index].time=i.format()}$.each(dataSource,function(i,ds){for(var index=moment(ds.time).diff(start,"year"),j=0;j<selectedItemLength;j++)void 0!=ds["count"+j]&&(countList[index]["count"+j]+=ds["count"+j])}),dataSourceByTimeunit=countList}}(),data.selectedChartDataSourceByTimeunit=dataSourceByTimeunit,dataSourceByTimeunit}function setChartOptions(){var chartSetting=function(){var setting={};return $.each(data.uiTimeunit,function(i,unit){if(unit.name===data.currentTimeunitForChart)return setting.minPeriod=unit.chartPeriod,!1}),setting}(),chartOptions={dataProvider:angular.copy(data.selectedChartDataSourceByTimeunit),graphs:angular.copy(data.selectedChartGraphs),type:"serial",theme:AuthTokenFactory.getTheme(),zoomOutText:i18n("show-all"),valueAxes:[{axisColor:"chartCursor",axisThickness:2,axisAlpha:1,position:"left"}],chartScrollbar:{autoGridCount:!0,graph:"g0",scrollbarHeight:40},chartCursor:{cursorPosition:"mouse",categoryBalloonFunction:function(){var time=arguments[0];return setChartTimeunitLabel(time)}},categoryField:"time",categoryAxis:{firstDayOfWeek:kupOpt.dateOfWeekStart,gridAlpha:0,markPeriodChange:!0,boldLabels:!0,minPeriod:chartSetting.minPeriod,parseDates:!0,equalSpacing:!0,dateFormats:[{period:"fff",format:"JJ:NN:SS"},{period:"ss",format:"JJ:NN:SS"},{period:"mm",format:"JJ:NN"},{period:"hh",format:"JJ:NN"},{period:"DD",format:"MMM DD"},{period:"WW",format:"MMM DD"},{period:"MM",format:"MMM"},{period:"YYYY",format:"YYYY"}],labelFunction:function(dateText){var time=arguments[1];switch(chartSetting.minPeriod){case"hh":dateText=moment(time).format(kupOpt["default"].formatAxisHourly);break;case"DD":dateText=moment(time).format(kupOpt["default"].formatAxisDaily);break;case"WW":dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatAxisWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatAxisWeekly);break;case"MM":dateText=moment(time).format(kupOpt["default"].formatAxisMonthly)}return dateText}},legend:{useGraphSettings:!1,valueWidth:0,valueFunction:function(){return""}}};return data.uiChart.options=chartOptions,chartOptions}function setChartForPdfOptions(){var chartSetting=function(){var setting={};return $.each(data.uiTimeunit,function(i,unit){if(unit.name===data.currentTimeunitForChart)return setting.minPeriod=unit.chartPeriod,!1}),setting}(),chartOptions={dataProvider:angular.copy(data.selectedChartDataSourceByTimeunit),graphs:angular.copy(data.selectedChartGraphs),type:"serial",theme:"white",fontFamily:"Verdana",fontSize:11,valueAxes:[{axisColor:"chartCursor",axisThickness:2,axisAlpha:1,position:"left"}],chartCursor:{cursorPosition:"mouse",categoryBalloonFunction:function(){var time=arguments[0];return setChartTimeunitLabel(time)}},categoryField:"time",categoryAxis:{firstDayOfWeek:kupOpt.dateOfWeekStart,gridAlpha:0,markPeriodChange:!0,boldLabels:!0,minPeriod:chartSetting.minPeriod,parseDates:!0,equalSpacing:!0,dateFormats:[{period:"fff",format:"JJ:NN:SS"},{period:"ss",format:"JJ:NN:SS"},{period:"mm",format:"JJ:NN"},{period:"hh",format:"JJ:NN"},{period:"DD",format:"MMM DD"},{period:"WW",format:"MMM DD"},{period:"MM",format:"MMM"},{period:"YYYY",format:"YYYY"}],labelFunction:function(dateText){var time=arguments[1];switch(chartSetting.minPeriod){case"hh":dateText=moment(time).format(kupOpt["default"].formatAxisHourly);break;case"DD":dateText=moment(time).format(kupOpt["default"].formatAxisDaily);break;case"WW":dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatAxisWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatAxisWeekly);break;case"MM":dateText=moment(time).format(kupOpt["default"].formatAxisMonthly)}return dateText}},legend:{useGraphSettings:!1,valueWidth:0,valueFunction:function(){return""}}};return data.uiChartForPdf.options=chartOptions,chartOptions}function getAnalyticsReportApi(isDefer){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,selectedDeviceList=reportsOpt.selectedDevices[0].platformDeviceId,fromDateUTC=(reportsOpt.selectedDevices[0].channelId,kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),data.timeFormat2)),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),data.timeFormat2),param={"event-type":vcaEventType,"device-id":JSON.stringify(selectedDeviceList),"channel-id":"",from:fromDateUTC,to:toDateUTC,parameters:JSON.stringify({})},onSuccess=function(response){opt.apiAnalyticsReportList=response.data||[]},onFail=function(response){opt.apiAnalyticsReportList=[]},onError=function(){opt.apiAnalyticsReportList=[]};return ajaxPost("getanalyticsreport",param,onSuccess,onFail,onError,isDefer)}function exportAggregatedCsvReportApi(periodType){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,fromDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),opt.timeFormat2),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),opt.timeFormat2),baseUnit=periodType,selectedGroups=[],type=(AuthTokenFactory.getApiRootUrl(),"");$.each(reportsOpt.selectedItemDataList,function(uid,itemData){var devices=[];if($.isEmptyObject(itemData))return!0;if(itemData.isAll||itemData.isLabel){var device=itemData.items||[];$.each(device,function(i,deviceData){var camera=deviceData.items||[];$.each(camera,function(j,cameraData){devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId})})}),type="labels"}else if(itemData.isDevice){var camera=itemData.items||[];$.each(camera,function(i,cameraData){devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId})}),type="devices"}else if(itemData.isCamera){if(itemData.hasChildren)return;var cameraData=itemData;devices.push({coreDeviceId:cameraData.data.platformDeviceId+"",channelId:cameraData.data.channelId}),type="devices"}!function(){var groupname="";(itemData.isLabel||itemData.isAll)&&(groupname=itemData.labelName),itemData.isDevice&&(groupname=itemData.labelName+" - "+itemData.text),itemData.isCamera&&(groupname=itemData.labelName+" - "+itemData.deviceName+" - "+itemData.text),selectedGroups.push({groupName:groupname,devicePairs:devices,type:type})}()});var param={"event-type":vcaEventType,"selected-groups":JSON.stringify(selectedGroups),"time-zone-offset":KupApiService.data.timeZoneOffset,from:fromDateUTC,to:toDateUTC,"base-unit":baseUnit};return KupApiService.exportDoc(param,"exportaggregatedcsvreport")}function exportVcaSecurityPdfApi(){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,chartSvgTitle=(AuthTokenFactory.getApiRootUrl(),"<svg version='1.1' width='900' height='30'><text y='15' x='0' transform='translate(450)' text-anchor='middle' font-size='20' font-weight='bold'>"+i18n("occurrence-vs-time")+"</text></svg>"),chartOpt=setChartForPdfOptions(),svgData=(window.AmCharts.makeChart(opt.$chartForPdf.slice(1),chartOpt),function(){var svgData=[];return"chart"==opt.currentTab&&(svgData.push(chartSvgTitle),$.each($(opt.$chartForPdf).find("svg"),function(i,el){svgData.push("<svg version='1.1' width='"+$(el).css("width")+"' height='"+$(el).css("height")+"'>"+$(el).html()+"</svg>")})),svgData}()),totalVisits=function(){var count=0;return $.each(opt.selectedGridList,function(i,grid){count+=grid.totalPerSelection}),count}(),reportInfo={"event-type":vcaEventType,"site-name":opt.selectedSitenameList.toString(),from:kendo.toString(reportsOpt.dateRange.startDate,opt.timeFormat1),to:kendo.toString(reportsOpt.dateRange.endDate,opt.timeFormat1),"total-results":totalVisits+""},param={"time-zone-offset":KupApiService.data.timeZoneOffset,"svg-string":svgData.join(""),"report-info":JSON.stringify(reportInfo)};return KupApiService.exportDoc(param,"exportvcasecuritypdf")}function setChartTimeunitLabel(dateFormat){var dateText="",time=new Date(dateFormat),dateLang=(kupOpt.dateOfWeekStart,"en-us"),dateOpt={weekday:"short",month:"short",day:"numeric",year:"numeric"};return"hours"==data.currentTimeunitForChart&&(dateText=moment(time).format(kupOpt["default"].formatHourly)),"days"==data.currentTimeunitForChart&&(dateText=moment(time).format(kupOpt["default"].formatDaily)),"weeks"==data.currentTimeunitForChart&&(dateText=moment(time).startOf("week").isoWeekday(kupOpt["default"].isoWeekStart).format(kupOpt["default"].formatWeekly)+" - \n"+moment(time).endOf("week").format(kupOpt["default"].formatWeekly)),"months"==data.currentTimeunitForChart&&(dateText=moment(time).format(kupOpt["default"].formatMonthly)),"years"==data.currentTimeunitForChart&&(dateOpt={year:"numeric"},dateText=time.toLocaleDateString(dateLang,dateOpt)),dateText}function setChartTheme(){var theme=AuthTokenFactory.getTheme();window.AmCharts.themes[theme]=AmchartsTheme[theme]}function generateChart(){setChartTheme(),setChartData(),setChartOptions(),setGridData()}function generateReport(){setInitData();var opt=data;if($.each(opt.requestForReport,function(i,request){request.cancel&&request.cancel()}),!reports.isSelectCamera())return notification("error",i18n("no-channel-selected")),reports.isSuccessReport(!1),!1;opt.requestForReport=[getAnalyticsReportApi(!0)];var dfd=$q.defer();return $timeout(function(){$q.all(opt.requestForReport)["finally"](function(){return setSelectedChartData(),opt.selectedChartDataSource.length<=0?void dfd.reject():(reports.isSuccessReport(!0),generateChart(),void dfd.resolve())})},500),dfd.promise}var kupOpt=KupOption,utils=UtilsService,i18n=UtilsService.i18n,notification=UtilsService.notification,ajaxPost=KupApiService.ajaxPost,reports=ReportsService,data={timeFormat0:"yyyy/MM/dd HH:mm:ss",timeFormat1:"dd/MM/yyyy HH:mm:ss",timeFormat2:"ddMMyyyyHHmmss",selectedGridList:{},selectedSitenameList:[],selectedChartDataSource:[],selectedChartDataSourceByTimeunit:[],selectedChartGraphs:[],selectedChartSortByDate:[],apiAnalyticsReportList:[],currentTab:"chart",currentTimeunitForChart:"hours",$chart:"#intrusionChart",$chartForPdf:"#intrusionChartForPdf",requestForReport:[],uiTab:[{name:"chart",text:"charts",isActive:!0}],uiTimeunit:[{name:"hours",text:"hourly",isActiveForChart:!0,isShowForChart:!0,chartPeriod:"hh"},{name:"days",text:"daily",isActiveForChart:!1,isShowForChart:!0,chartPeriod:"DD"},{name:"weeks",text:"weekly",isActiveForChart:!1,isShowForChart:!0,chartPeriod:"WW"},{name:"months",text:"monthly",isActiveForChart:!1,isShowForChart:!0,chartPeriod:"MM"},{name:"years",text:"yearly",isActiveForChart:!1,isShowForChart:!1,chartPeriod:"YYYY"}],uiExport:{isOpen:!1},uiGrid:{isShow:!0,totalVisit:"...",avgVisit:"...",highestVisit:"...",lowestVisit:"...",leastEventBox:[],topEventBox:[],totalEventBox:[]},uiNodata:{isShow:!0},uiChart:{options:{}},uiChartForPdf:{width:"900px",height:"400px",options:{}}};return{data:data,setInitData:setInitData,setInitTab:setInitTab,setInitTimeunit:setInitTimeunit,setSelectedChartData:setSelectedChartData,setGridData:setGridData,setChartTimeunitLabel:setChartTimeunitLabel,setChartTheme:setChartTheme,setChartData:setChartData,setChartOptions:setChartOptions,setChartForPdfOptions:setChartForPdfOptions,getAnalyticsReportApi:getAnalyticsReportApi,exportAggregatedCsvReportApi:exportAggregatedCsvReportApi,exportVcaSecurityPdfApi:exportVcaSecurityPdfApi,generateReport:generateReport,generateChart:generateChart}}]),angular.module("kai.reports.intrusion").controller("IntrusionController",["KupOption","RouterStateService","UtilsService","PromiseFactory","AuthTokenFactory","ReportsService","IntrusionService","$scope","$timeout","$q","$rootScope",function(KupOption,RouterStateService,UtilsService,PromiseFactory,AuthTokenFactory,ReportsService,IntrusionService,$scope,$timeout,$q,$rootScope){function init(){$scope.$watch(function(){return angular.toJson(reports.data)},function(newVal,oldVal){var reportsOpt=angular.fromJson(newVal);intrusionCtrl.data.uiNodata.isShow=!reportsOpt.isSuccessReport},!0),$scope.$watch(function(){return AuthTokenFactory.getTheme()},function(newVal,oldVal){return newVal!=oldVal&&void IntrusionService.generateChart()},!0)}function setTab(tabName){var opt=intrusionCtrl.data,tabData=opt.uiTab;$.each(tabData,function(i,data){data.isActive=tabName===data.name}),opt.currentTab=tabName}function setTimeunitForChart(unitName){var opt=intrusionCtrl.data,timeunitData=opt.uiTimeunit;$.each(timeunitData,function(i,data){data.isActiveForChart=unitName===data.name}),opt.currentTimeunitForChart=unitName,IntrusionService.generateChart()}function exportCsv(periodType){if(!reports.isSuccessReport())return notification("error",i18n("please-generate-reports")),!1;var warningNotify=notification("warning",i18n("exporting-to-csv"),0);IntrusionService.exportAggregatedCsvReportApi(periodType)["finally"](function(){warningNotify.close()})}function exportPdf(){if(!reports.isSuccessReport())return notification("error",i18n("please-generate-reports")),!1;var warningNotify=notification("warning",i18n("exporting-to-pdf"),0);IntrusionService.exportVcaSecurityPdfApi()["finally"](function(){warningNotify.close()})}var i18n=UtilsService.i18n,notification=UtilsService.notification,reports=ReportsService,intrusionCtrl=this;intrusionCtrl.data=IntrusionService.data,intrusionCtrl.fn={setTab:setTab,setTimeunitForChart:setTimeunitForChart,exportPdf:exportPdf,exportCsv:exportCsv},init()}]);