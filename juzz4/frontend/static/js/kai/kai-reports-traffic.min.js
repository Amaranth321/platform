angular.module("kai.reports.traffic",[]),angular.module("kai.reports.traffic").factory("TrafficSvgService",["KupOption","UtilsService","AuthTokenFactory","$http",function(KupOption,UtilsService,AuthTokenFactory,$http){var utils=UtilsService,i18n=UtilsService.i18n,KaiFlow=(UtilsService.notification,{});return KaiFlow.paper=null,KaiFlow.cfg={cssSelector:null,width:null,height:null,showRegionsByDefault:!1},KaiFlow.style={region:{fill:"#F6AE40",opacity:"0.3",stroke:"#222","stroke-width":1},arrow:{opacity:"0.8",stroke:["#205FA4","#ff2a3f","#8dc051","#fe642f","#f6ae40","#428bca","#32a8ad","#ffe400","#b777d5"],end:"short",resizeFactor:.7},label:{"font-size":"18px","font-weight":"550",fill:"#f5f5f5",stroke:"#ddd","stroke-width":0,bgFill:"#000",bgOpacity:.5}},KaiFlow.current={regionName:null,showRegions:null,regions:[],curveArrows:[],labels:[]},KaiFlow.data={sourceName:null,regionMap:{},flowMap:{}},KaiFlow.generate=function(configs,regions,flowData,bgImageUrl){KaiFlow.remove(),KaiFlow.cfg=$.extend(KaiFlow.cfg,configs),KaiFlow.initRaphael(),KaiFlow.prepareData(regions,flowData),KaiFlow.setBgImage(bgImageUrl),KaiFlow.drawRegions()},KaiFlow.remove=function(){$("#"+KaiFlow.cfg.cssSelector).empty();var prevShowRegions=KaiFlow.cfg.showRegionsByDefault;null!=KaiFlow.current.showRegions&&(prevShowRegions=KaiFlow.current.showRegions),KaiFlow.current={regionName:null,showRegions:prevShowRegions,regions:[],curveArrows:[],labels:[]},KaiFlow.data={sourceName:null,regionMap:{},flowMap:{}}},KaiFlow.toggleRegions=function(){KaiFlow.setRegionsVisibility(!KaiFlow.current.showRegions)},KaiFlow.setRegionsVisibility=function(visible){if(visible)for(var i=0;i<KaiFlow.current.regions.length;i++)KaiFlow.current.regions[i].attr(KaiFlow.style.region),KaiFlow.current.showRegions=!0;else for(var i=0;i<KaiFlow.current.regions.length;i++)KaiFlow.current.regions[i].attr({opacity:"0"}),KaiFlow.current.showRegions=!1},KaiFlow.getSerializedSVG=function(){var svgList=$("#"+KaiFlow.cfg.cssSelector+" svg");svgList&&0!=svgList.length||console.error("no svg image found");var xmlSerializer=new XMLSerializer;return xmlSerializer.serializeToString(svgList[0])},KaiFlow.openInNewWin=function(){var svgString=KaiFlow.getSerializedSVG(),win=window.open();$(win.document.body).html(svgString)},KaiFlow.setBgImage=function(imageUrl){var emptyDataUrl="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAALklEQVQ4T2NUUlL6z4AH3Lt3D580A+OoAcMiDICRjDcdAKMZfzoYNYCBceiHAQDsuisx5wDZVAAAAABJRU5ErkJggg==";imageUrl&&0!=imageUrl.length||(imageUrl=emptyDataUrl),KaiFlow.paper.image(imageUrl,0,0,KaiFlow.cfg.width,KaiFlow.cfg.height)},KaiFlow.convertToFlowDataFromAnalyticsData=function(regionMap,trafficFlowOutput){var flowData=[],regionsCalculation=(regionMap.sourceName,{});return $.each(trafficFlowOutput,function(i,o){var region=regionsCalculation[o.from+"-"+o.to];"undefined"==typeof region?(region={from:o.from,to:o.to,count:o.count},regionsCalculation[o.from+"-"+o.to]=region):region.count+=o.count}),$.each(regionsCalculation,function(o,r){flowData.push(r)}),flowData},KaiFlow.convertToFlowData=function(regionMap,trafficFlowOutput){var flowData=[],tios=trafficFlowOutput.tios[0],orderedCountList=tios.src2dst,sourceName=regionMap.sourceName,listWithoutSource=[];return regionMap.regions.forEach(function(region,i){region.name!=sourceName&&listWithoutSource.push(region.name)}),listWithoutSource.forEach(function(name,i){var count=orderedCountList[i];flowData.push({from:sourceName,to:name,count:count})}),console.log("sourceName         : "+sourceName),console.log("listWithoutSource  : "+listWithoutSource),console.log("orderedCountList   : "+orderedCountList),console.log(flowData),flowData},KaiFlow.prepareData=function(flowRegions,flowData){KaiFlow.data.sourceName=flowRegions.sourceName;var allFlows=KaiFlow.populateMissingFlows(flowRegions.regions,flowData);KaiFlow.data.regionMap={},flowRegions.regions.forEach(function(region,i){KaiFlow.data.regionMap[region.name]=region});for(var i=0;i<allFlows.length;i++){var srcName=allFlows[i].from,dstName=allFlows[i].to,count=allFlows[i].count;KaiFlow.data.flowMap[srcName]||(KaiFlow.data.flowMap[srcName]={total:0,dstList:[]}),KaiFlow.data.flowMap[srcName].dstList.push({name:dstName,count:count}),KaiFlow.data.flowMap[srcName].total+=parseInt(count)}},KaiFlow.initUI=function(){var btnHtml='<div> <a href="javascript:KaiFlow.toggleRegions()" class="k-button">'+i18n("show-hide-regions")+"</a></div>";$("#"+KaiFlow.cfg.cssSelector).append(btnHtml)},KaiFlow.callback=function(){},KaiFlow.initRaphael=function(){KaiFlow.paper=Raphael(KaiFlow.cfg.cssSelector,"100%",KaiFlow.cfg.height),KaiFlow.paper.setViewBox(0,0,KaiFlow.cfg.width,KaiFlow.cfg.height),KaiFlow.paper.ca.arc=function(x){var length=this.attr("length"),path=this.attr("original"),subPath=Raphael.getSubpath(path,0,x*length);return{path:subPath}},KaiFlow.paper.ca.length=function(){},KaiFlow.paper.ca.original=function(){}},KaiFlow.drawRegions=function(){return KaiFlow.data.regionMap?($.each(KaiFlow.data.regionMap,function(name,region){var regionPath=KaiFlow.paper.path(KaiFlow.getPathString(region)).attr(KaiFlow.style.region).data("regionName",region.name).hover(function(){KaiFlow.drawTrafficFlows(this.data("regionName"))});region.path=regionPath,KaiFlow.data.regionMap[region.name]=region,KaiFlow.current.regions.push(regionPath)}),0==Object.keys(KaiFlow.data.flowMap).length?KaiFlow.handleAllZeroFlows():KaiFlow.drawTrafficFlows(KaiFlow.data.sourceName),KaiFlow.setRegionsVisibility(KaiFlow.current.showRegions),void $("tspan").attr("dy","0")):void console.log("No regions to draw")},KaiFlow.drawTrafficFlows=function(srcName){if(srcName!==KaiFlow.current.regionName){if(0==Object.keys(KaiFlow.data.flowMap).length)return void console.log("No flows to draw");KaiFlow.removeCurrentFlows(),KaiFlow.current.regionName=srcName;var srcRegion=KaiFlow.data.regionMap[srcName],srcCenter=KaiFlow.getPolygonCentroid(srcRegion),srcFlow=KaiFlow.data.flowMap[srcName];if(null==srcFlow)return void console.log("No flows for : "+srcName);var srcTotal=srcFlow.total,dstFlowList=srcFlow.dstList,accruedPercent=0;dstFlowList.forEach(function(dst,i){var percent=0;0!=srcTotal&&(percent=Math.round(dst.count/srcTotal*100)),accruedPercent+=percent,i==dstFlowList.length-1&&accruedPercent>100&&(console.log("accrued percent: "+accruedPercent),console.log("last percent: "+percent),percent-=accruedPercent-100,console.log("adjusted: "+percent));var dstCenter=KaiFlow.getPolygonCentroid(KaiFlow.data.regionMap[dst.name]);KaiFlow.drawArrow(srcCenter,dstCenter,percent,i);var labelLocation=dstCenter;KaiFlow.printLabel(percent,labelLocation)})}},KaiFlow.handleAllZeroFlows=function(){var srcRegion=KaiFlow.data.regionMap[KaiFlow.data.sourceName],srcCenter=KaiFlow.getPolygonCentroid(srcRegion),i=0;$.each(KaiFlow.data.regionMap,function(name,region){if(name===KaiFlow.data.sourceName)return!0;var dstCenter=KaiFlow.getPolygonCentroid(region);KaiFlow.drawArrow(srcCenter,dstCenter,0,i++);var labelLocation=dstCenter;KaiFlow.printLabel(0,labelLocation)})},KaiFlow.removeCurrentFlows=function(){for(var i=0;i<KaiFlow.current.curveArrows.length;i++)KaiFlow.current.curveArrows[i].remove();for(var i=0;i<KaiFlow.current.labels.length;i++)KaiFlow.current.labels[i].remove()},KaiFlow.drawArrow=function(srcCenter,dstCenter,percent,arrowIndex){var factor=KaiFlow.getCurveFactor(srcCenter,dstCenter),qPath=KaiFlow.qPath(srcCenter,KaiFlow.quadraticMidpointFromConnection(srcCenter,dstCenter,factor),dstCenter),length=Raphael.getTotalLength(qPath),width=KaiFlow.getArrowWidth(percent),curvePath=KaiFlow.paper.path(qPath);curvePath.attr({opacity:0,original:qPath,length:length,"arrow-end":KaiFlow.style.arrow.end,stroke:KaiFlow.style.arrow.stroke[arrowIndex],"stroke-width":width}),curvePath.attr({arc:.5}),KaiFlow.current.curveArrows.push(curvePath);var animation=Raphael.animation({arc:1.1,opacity:KaiFlow.style.arrow.opacity},500,">");curvePath.animate(animation.delay(0*arrowIndex))},KaiFlow.printLabel=function(percent,labelLocation){var group=KaiFlow.paper.set(),labelBg=KaiFlow.paper.rect(labelLocation.x,labelLocation.y,44,26).attr({fill:KaiFlow.style.label.bgFill,opacity:KaiFlow.style.label.bgOpacity,"stroke-width":0});group.push(labelBg);var arrowLabel=KaiFlow.paper.text(labelLocation.x+22,labelLocation.y+13,percent+"%").attr(KaiFlow.style.label);group.push(arrowLabel),KaiFlow.current.labels.push(group)},KaiFlow.getPathString=function(polygon){if(!polygon||polygon.points.length<3)return console.log("invalid polygon"),"";var firstPoint,pathString;return polygon.points.forEach(function(point,i){var xy=KaiFlow.getProjectedXY(point);0==i?(pathString+="M",firstPoint=xy):pathString+=" L",pathString+=xy.x+","+xy.y,i==polygon.points.length-1&&(pathString+=" L"+firstPoint.x+","+firstPoint.y+" Z")}),pathString},KaiFlow.getBoundsCenter=function(path){var bbox=path.getBBox(),cX=Math.floor(bbox.x+bbox.width/2),cY=Math.floor(bbox.y+bbox.height/2);return{x:cX,y:cY}},KaiFlow.getPolygonCentroid=function(polygon){for(var points=polygon.points,centroid={x:0,y:0},i=0;i<points.length;i++){var point=KaiFlow.getProjectedXY(points[i]);centroid.x+=point.x,centroid.y+=point.y}return centroid.x/=points.length,centroid.y/=points.length,centroid},KaiFlow.getProjectedXY=function(p){return{x:Math.round(parseFloat(p.x)*KaiFlow.cfg.width),y:Math.round(parseFloat(p.y)*KaiFlow.cfg.height)}},KaiFlow.normalizeXY=function(p){return{x:p.x/KaiFlow.cfg.width,y:p.y/KaiFlow.cfg.height}},KaiFlow.distance=function(p0,p1){return Math.sqrt(Math.pow(p1.x-p0.x,2)+Math.pow(p1.x-p0.x,2))},KaiFlow.midpoint=function(p0,p1){return{x:p0.x+(p1.x-p0.x)/2,y:p0.y+(p1.y-p0.y)/2}},KaiFlow.dir=function(p0,p1){var l=this.distance(p0,p1);return{x:(p1.x-p0.x)/l,y:(p1.y-p0.y)/l}},KaiFlow.orthogonal=function(dir){return{x:-dir.y,y:dir.x}},KaiFlow.quadraticMidpointFromConnection=function(p0,p1,k){var l=this.distance(p0,p1),d=this.dir(p0,p1),orth=this.orthogonal(d),mid=this.midpoint(p0,p1),kl=l*k;return{x:mid.x+kl*orth.x,y:mid.y+kl*orth.y}},KaiFlow.qPath=function(start,mid,end){var path="M"+start.x+" "+start.y;return path+=" Q"+mid.x+" "+mid.y,path+=" "+end.x+" "+end.y},KaiFlow.getCurveFactor=function(srcPoint,dstPoint){var curvature=.2,svgCenter={x:.5,y:.5},onLeftSide=KaiFlow.isLeft(KaiFlow.normalizeXY(srcPoint),svgCenter,KaiFlow.normalizeXY(dstPoint));return onLeftSide?-curvature:curvature},KaiFlow.isLeft=function(lineStart,lineEnd,checkPt){var a=lineStart,b=lineEnd,c=checkPt;return(b.x-a.x)*(c.y-a.y)-(b.y-a.y)*(c.x-a.x)>0},KaiFlow.getArrowWidth=function(percent){var width=percent*KaiFlow.style.arrow.resizeFactor;return width<20?20:width>60?60:width},KaiFlow.populateMissingFlows=function(regions,flowsWithData){var regionNames=[];$.each(regions,function(idx,r){regionNames.push(r.name)});var all=utils.permutate(regionNames,2),allFlowData=[];$.each(all,function(idx,pair){pair[0]!=pair[1]&&allFlowData.push({from:pair[0],to:pair[1],count:0})});var inputFlowMap={};return $.each(flowsWithData,function(i,flow){inputFlowMap[flow.from+""+flow.to]=flow.count}),$.each(allFlowData,function(i,flow){inputFlowMap[flow.from+""+flow.to]&&(flow.count=inputFlowMap[flow.from+""+flow.to])}),allFlowData},KaiFlow}]),angular.module("kai.reports.traffic").factory("TrafficService",["KupOption","UtilsService","PromiseFactory","KupApiService","ReportsService","AuthTokenFactory","TrafficSvgService","$q","$timeout",function(KupOption,UtilsService,PromiseFactory,KupApiService,ReportsService,AuthTokenFactory,TrafficSvgService,$q,$timeout){function getAnalyticsReportApi(isDefer){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,fromDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),data.timeFormat2),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),data.timeFormat2),instance=reportsOpt.selectedInstance[0],selectedDeviceId=instance.platformDeviceId,selectedChannelId=instance.channelId,param=(instance.deviceId,{"event-type":vcaEventType,"device-id-list":JSON.stringify([selectedDeviceId]),"channel-id":selectedChannelId,from:fromDateUTC,to:toDateUTC,parameters:JSON.stringify({})}),onSuccess=function(response){opt.apiAnalyticsReportList=response.data||[]},onFail=function(response){opt.apiAnalyticsReportList=[]},onError=function(){opt.apiAnalyticsReportList=[]};return ajaxPost("getanalyticsreport",param,onSuccess,onFail,onError,isDefer)}function exportSecurityCrossSiteCSVApi(periodType){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,dvcId=reportsOpt.selectedInstance,fromDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.startDate),opt.timeFormat2),toDateUTC=kendo.toString(utils.convertToUTC(reportsOpt.dateRange.endDate),opt.timeFormat2),param={"file-format":"csv","event-type":vcaEventType,from:fromDateUTC,to:toDateUTC,"time-zone-offset":KupApiService.data.timeZoneOffset,"device-id":dvcId[0].platformDeviceId,"channel-id":dvcId[0].channelId};return KupApiService.exportDoc(param,"exportdatalogs")}function exportTrafficFlowPdfApi(){var opt=data,reportsOpt=reports.data,vcaEventType=kupOpt.vca[reportsOpt.reportType].eventType,dvcId=reportsOpt.selectedInstance,fromDateUTC=kendo.toString(reportsOpt.dateRange.startDate,opt.timeFormat1),toDateUTC=kendo.toString(reportsOpt.dateRange.endDate,opt.timeFormat1),base64Image=function(){var svgList=$(opt.$flow).find("svg").attr({width:600}),xmlSerializer=new XMLSerializer,svg=xmlSerializer.serializeToString(svgList[0]);return $(opt.$flow).find("svg").attr({width:"100%"}),svg}(),reportInfo={"event-type":vcaEventType,"device-name":dvcId[0].deviceName,channel:dvcId[0].channelName,from:fromDateUTC,to:toDateUTC},param={"time-zone-offset":KupApiService.data.timeZoneOffset,"base64-image":base64Image,"report-info":JSON.stringify(reportInfo)};return KupApiService.exportDoc(param,"exporttrafficflowpdf")}function listRunningAnalyticsApi(isDefer){var opt=data,reportsOpt=reports.data,vcaAnalyticsType=kupOpt.vca[reportsOpt.reportType].analyticsType,param={"analytics-type":vcaAnalyticsType},instance=reportsOpt.selectedInstance[0],selectedDeviceId=instance.platformDeviceId,selectedChannelId=instance.channelId,onSuccess=(instance.deviceId,function(response){var vcaData={},regions={};$.each(response.instances,function(i,inst){if(inst.platformDeviceId==selectedDeviceId&&inst.channelId==selectedChannelId)return vcaData=inst,!1}),$.isEmptyObject(vcaData)||(regions=utils.tryParseJson(vcaData.thresholds)),opt.apiRunningAnalyticsList=response.instances||[],opt.selectedVcaData=vcaData,opt.selectedRegions=regions}),onFail=function(response){opt.apiRunningAnalyticsList=[],opt.selectedVcaData={},opt.selectedRegions={}},onError=function(){opt.apiRunningAnalyticsList=[],opt.selectedVcaData={},opt.selectedRegions={}};return ajaxPost("listrunninganalytics",param,onSuccess,onFail,onError,isDefer)}function getLiveVideoUrlApi(isDefer){var opt=data,reportsOpt=reports.data,instance=reportsOpt.selectedInstance[0],selectedChannelId=(instance.platformDeviceId,instance.channelId),coreDeviceId=instance.deviceId,streamType="http/jpeg",param={"device-id":coreDeviceId,"channel-id":selectedChannelId,"stream-type":streamType},onSuccess=function(response){opt.apiLiveVideoUrl=response.url||[]},onFail=function(response){opt.apiLiveVideoUrl=[]},onError=function(){opt.apiLiveVideoUrl=[]};return ajaxPost("getlivevideourl",param,onSuccess,onFail,onError,isDefer)}function generateSVGImage(imgH,imgW){imgW=imgW||600,imgH=imgH||450;var jsonOutput=data.apiAnalyticsReportList,regions=data.selectedRegions,imgDataUrl=data.apiLiveVideoUrl[0]||"",options={cssSelector:data.$flow.substring(1),width:imgW,height:imgH,showRegionsByDefault:!1};if(jsonOutput.length<=0||$.isEmptyObject(regions))return!1;var flowData=kaiFlow.convertToFlowDataFromAnalyticsData(regions,jsonOutput);kaiFlow.generate(options,regions,flowData,imgDataUrl)}function generateReport(){var opt=data;if($.each(opt.requestForReport,function(i,request){request.cancel&&request.cancel()}),!reports.isSelectCamera())return notification("error",i18n("no-channel-selected")),reports.isSuccessReport(!1),!1;if(!reports.isSingleCamera())return notification("error",i18n("multiple-device-channel-not-supported")),reports.isSuccessReport(!1),!1;opt.requestForReport=[listRunningAnalyticsApi(!0),getLiveVideoUrlApi(!0),getAnalyticsReportApi(!0)];var dfd=$q.defer();return $timeout(function(){$q.all(opt.requestForReport)["finally"](function(){return opt.apiRunningAnalyticsList.length&&opt.apiLiveVideoUrl.length&&opt.apiAnalyticsReportList.length?$.isEmptyObject(opt.selectedVcaData)?(reports.isSuccessReport(!1),void dfd.reject()):$.isEmptyObject(opt.selectedRegions)||!opt.selectedRegions.regions?(notification("error",i18n("corrupted-vca-configuration")),reports.isSuccessReport(!1),void dfd.reject()):(reports.isSuccessReport(!0),generateSVGImage(),void dfd.resolve()):(reports.isSuccessReport(!1),void dfd.reject())})},500),dfd.promise}var kupOpt=KupOption,utils=UtilsService,i18n=UtilsService.i18n,notification=UtilsService.notification,ajaxPost=KupApiService.ajaxPost,reports=ReportsService,kaiFlow=(AuthTokenFactory.getApiRootUrl(),TrafficSvgService),data={$flow:"#trafficSvg",timeFormat0:"yyyy/MM/dd HH:mm:ss",timeFormat1:"dd/MM/yyyy HH:mm:ss",timeFormat2:"ddMMyyyyHHmmss",selectedVcaData:{},selectedRegions:{},apiAnalyticsReportList:[],apiRunningAnalyticsList:[],apiLiveVideoUrl:[],requestForReport:[]};return{data:data,getAnalyticsReportApi:getAnalyticsReportApi,exportSecurityCrossSiteCSVApi:exportSecurityCrossSiteCSVApi,exportTrafficFlowPdfApi:exportTrafficFlowPdfApi,listRunningAnalyticsApi:listRunningAnalyticsApi,getLiveVideoUrlApi:getLiveVideoUrlApi,generateReport:generateReport,generateSVGImage:generateSVGImage}}]),angular.module("kai.reports.traffic").controller("TrafficController",["KupOption","RouterStateService","UtilsService","PromiseFactory","AuthTokenFactory","ReportsService","TrafficService","TrafficSvgService","$scope","$timeout","$q","$rootScope",function(KupOption,RouterStateService,UtilsService,PromiseFactory,AuthTokenFactory,ReportsService,TrafficService,TrafficSvgService,$scope,$timeout,$q,$rootScope){function init(){$scope.$watch(function(){return angular.toJson(reports.data)},function(newVal,oldVal){var reportsOpt=angular.fromJson(newVal);trafficCtrl.noData.data.isShow=!reportsOpt.isSuccessReport},!0)}function setTab(tabName){var opt=trafficCtrl.data,tabData=trafficCtrl.tab.data;$.each(tabData,function(i,data){data.isActive=tabName===data.name}),opt.currentTab=tabName}function exportCsv(periodType){if(!reports.isSuccessReport())return notification("error",i18n("please-generate-reports")),!1;if(!reports.isSingleCamera())return notification("error",i18n("multiple-device-channel-not-supported")),!1;var warningNotify=notification("warning",i18n("exporting-to-csv"),0);TrafficService.exportSecurityCrossSiteCSVApi(periodType)["finally"](function(){warningNotify.close()})}function exportPdf(){if(!reports.isSuccessReport())return notification("error",i18n("please-generate-reports")),!1;if(!reports.isSingleCamera())return notification("error",i18n("multiple-device-channel-not-supported")),!1;var warningNotify=notification("warning",i18n("exporting-to-pdf"),0);TrafficService.exportTrafficFlowPdfApi()["finally"](function(){warningNotify.close()})}function showRegion(isShow){trafficCtrl.region.data.isShow=isShow,kaiFlow.toggleRegions()}var i18n=UtilsService.i18n,notification=UtilsService.notification,reports=ReportsService,kaiFlow=TrafficSvgService,trafficCtrl=this;trafficCtrl.data=TrafficService.data,trafficCtrl.fn={setTab:setTab,exportPdf:exportPdf,exportCsv:exportCsv,showRegion:showRegion},trafficCtrl.tab={},trafficCtrl.tab.data=[{name:"chart",text:"charts",isActive:!0}],trafficCtrl["export"]={},trafficCtrl["export"].data={isShow:!1},trafficCtrl.noData={},trafficCtrl.noData.data={isShow:!0},trafficCtrl.region={},trafficCtrl.region.data={isShow:!1},init()}]);